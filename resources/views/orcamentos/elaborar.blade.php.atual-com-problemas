{{-- VERS√ÉO ATUALIZADA: 20251014_{{ date('His') }}_DEBUG_PRECO_VISIVEL --}}
@extends('layouts.app')

@section('title', 'Elabora√ß√£o do Or√ßamento - Cesta de Pre√ßos')

@push('head')
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="version" content="DEBUG_{{ now()->timestamp }}">
<!-- VERS√ÉO DA P√ÅGINA: {{ now()->format('Y-m-d H:i:s') }} -->
<style>
    /* ANTI-CACHE CSS */
    body::before {
        content: " VERS√ÉO: {{ now()->format('H:i:s') }}";
        position: fixed;
        top: 10px;
        right: 10px;
        background: #ef4444;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: bold;
        font-size: 11px;
        z-index: 99999;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
</style>
@endpush

@section('content')

<!-- Modal de Sucesso (aparece apenas uma vez ao criar or√ßamento) -->
<div id="modalSucesso" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 8px; max-width: 400px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
        <div style="width: 60px; height: 60px; background: #10b981; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
            <svg style="width: 35px; height: 35px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        <h3 style="margin: 0 0 10px 0; font-size: 20px; color: #1f2937;">Sucesso!</h3>
        <p style="margin: 0 0 25px 0; color: #6b7280; font-size: 15px;" id="modalSucessoMensagem">
            Or√ßamento criado com sucesso!
        </p>
        <button onclick="fecharModalSucesso()" style="background: #3b82f6; color: white; border: none; padding: 12px 40px; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer;">
            OK
        </button>
    </div>
</div>

<!-- Modal de Conclus√£o (aparece ao concluir or√ßamento) -->
<div id="modalConcluido" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 480px; text-align: center; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);">
        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; margin: 0 auto 25px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);">
            <svg style="width: 45px; height: 45px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        <h3 style="margin: 0 0 12px 0; font-size: 24px; color: #1f2937; font-weight: 700;">Or√ßamento Conclu√≠do!</h3>
        <p style="margin: 0 0 8px 0; color: #10b981; font-size: 16px; font-weight: 600;">
            ‚úì Seu or√ßamento foi criado com sucesso
        </p>
        <p style="margin: 0 0 30px 0; color: #6b7280; font-size: 14px;">
            O or√ßamento foi salvo e est√° dispon√≠vel em "Or√ßamentos Realizados"
        </p>
        <button onclick="irParaRealizados()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 14px 50px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.3s;">
            <i class="fas fa-check-circle" style="margin-right: 8px;"></i>OK
        </button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar se tem parmetro msg=success (vindo do redirect ap√≥s criar or√ßamento)
        const urlParams = new URLSearchParams(window.location.search);
        const msgParam = urlParams.get('msg');

        @if(session('success'))
        const sessionSuccess = true;
        const sessionMessage = '{{ session('success') }}';
        @else
        const sessionSuccess = false;
        const sessionMessage = '';
        @endif

        // Mostrar modal APENAS se tem msg=success na URL OU session success
        // E APENAS se n√£o foi mostrado ainda nesta sess√£o
        const modalJaMostrado = sessionStorage.getItem('modalSucessoMostrado_{{ $orcamento->id }}');

        if ((msgParam === 'success' || sessionSuccess) && !modalJaMostrado) {
            const modal = document.getElementById('modalSucesso');
            if (sessionMessage) {
                document.getElementById('modalSucessoMensagem').textContent = sessionMessage;
            }
            modal.style.display = 'flex';

            // Marcar que o modal j√° foi mostrado
            sessionStorage.setItem('modalSucessoMostrado_{{ $orcamento->id }}', 'true');

            // Remover parmetro msg da URL
            if (msgParam === 'success') {
                const url = new URL(window.location);
                url.searchParams.delete('msg');
                window.history.replaceState({}, '', url);
            }
        }
    });

    function fecharModalSucesso() {
        document.getElementById('modalSucesso').style.display = 'none';
    }

    /**
     * Redirecionar para p√°gina de Or√ßamentos Realizados
     * Usa URL relativa sem barra inicial (compat√≠vel com proxy e tag <base>)
     */
    function irParaRealizados() {
        const urlRealizados = window.APP_BASE_PATH + '/orcamentos/realizados';
        console.log('üîó Redirecionando para:', urlRealizados);
        window.location.href = urlRealizados;
    }
</script>

<style>
    /* Estilos para as se√ß√µes numeradas */
    .secao {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .secao-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
    }

    .secao-numero {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        margin-right: 15px;
        flex-shrink: 0;
    }

    .secao-titulo {
        font-size: 16px;
        font-weight: 700;
        color: #2563eb;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .dados-item {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .dados-label {
        font-weight: 600;
        color: #6b7280;
        font-size: 13px;
    }

    .dados-valor {
        color: #374151;
        font-size: 13px;
    }

    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        background: #3b82f6;
        color: white;
        margin-left: 8px;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        text-decoration: none;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background: #2563eb;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-outline {
        background: white;
        border: 1px solid #d1d5db;
        color: #374151;
    }

    .alert-empty {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #991b1b;
        padding: 15px 20px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        text-align: center;
    }

    .radio-group label {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 8px;
        cursor: pointer;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .radio-group label:hover {
        background: #f9fafb;
    }

    .radio-group input[type="radio"] {
        margin-right: 10px;
    }

    .linha-vertical {
        border-left: 4px solid #3b82f6;
        padding-left: 20px;
        margin: 15px 0;
        position: relative;
    }

    /* Bolinha azul √† esquerda de cada se√ß√£o de metodologia */
    .linha-vertical::before {
        content: '';
        position: absolute;
        left: -10px; /* Ajusta para ficar centralizado na linha (4px de largura / 2 = 2px, ent√£o -10px para bolinha de 16px) */
        top: 0;
        width: 16px;
        height: 16px;
        background: #3b82f6;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 0 1px #3b82f6;
    }

    /* Modais Bootstrap - Garantir centraliza√ß√£o correta */
    .modal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
    }

    .modal.show .modal-dialog {
        transform: none;
    }

    .modal-dialog-centered {
        display: flex;
        align-items: center;
        min-height: calc(100% - 1rem);
    }

    .modal.fade .modal-dialog-centered {
        transform: translate(0, -50px);
    }

    .modal.show .modal-dialog-centered {
        transform: none;
    }

    /* Modal de Confirma√ß√£o Customizado */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-overlay .modal-content {
        background: white;
        border-radius: 12px;
        padding: 0;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-overlay .modal-header-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        padding: 24px;
        border-radius: 12px 12px 0 0;
        text-align: center;
    }

    .modal-overlay .modal-icon-warning {
        width: 64px;
        height: 64px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
    }

    .modal-overlay .modal-title {
        color: white;
        font-size: 24px;
        font-weight: 700;
        margin: 0;
    }

    .modal-overlay .modal-body {
        padding: 32px 24px;
        text-align: center;
    }

    .modal-overlay .modal-message {
        color: #374151;
        font-size: 16px;
        line-height: 1.6;
        margin: 0;
    }

    .modal-overlay .modal-footer {
        padding: 0 24px 24px;
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .modal-overlay .modal-btn-confirm {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        padding: 14px 32px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
    }

    .modal-overlay .modal-btn-confirm:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 8px -1px rgba(16, 185, 129, 0.4);
    }

    .modal-overlay .modal-btn-cancel {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
        padding: 14px 32px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .modal-overlay .modal-btn-cancel:hover {
        background: #e5e7eb;
    }

    /* Modal de Edi√ß√£o Customizado */
    .modal-overlay .modal-header-edit {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        padding: 24px;
        border-radius: 12px 12px 0 0;
        text-align: center;
    }

    .modal-overlay .modal-icon-edit {
        width: 64px;
        height: 64px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
    }

    .modal-overlay .modal-form-group {
        margin-bottom: 20px;
        text-align: left;
    }

    .modal-overlay .modal-form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
        font-size: 13px;
    }

    .modal-overlay .modal-form-label .required {
        color: #dc2626;
        margin-left: 2px;
    }

    .modal-overlay .modal-form-input,
    .modal-overlay .modal-form-textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        color: #374151;
        transition: border-color 0.2s;
    }

    .modal-overlay .modal-form-input:focus,
    .modal-overlay .modal-form-textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .modal-overlay .modal-form-textarea {
        min-height: 120px;
        resize: vertical;
        font-family: inherit;
    }

    .modal-overlay .modal-body-form {
        padding: 24px;
        max-height: 60vh;
        overflow-y: auto;
    }

    /* Media query para telas com pouca altura (como 1440x900) */
    @media (max-height: 1000px) {
        .secao {
            padding: 15px;
            margin-bottom: 15px;
        }

        .secao-header {
            margin-bottom: 12px;
            padding-bottom: 10px;
        }

        .secao-numero {
            width: 36px;
            height: 36px;
            font-size: 16px;
            margin-right: 12px;
        }

        .secao-titulo {
            font-size: 14px;
        }

        .content {
            padding: 20px !important;
        }

        .btn {
            padding: 8px 16px;
            font-size: 12px;
        }
    }

    /* Bot√µes de a√ß√£o da CDF */
    .btn-icon-acao {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        padding: 6px 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-icon-acao:hover {
        background: #e5e7eb;
        border-color: #9ca3af;
        transform: scale(1.05);
    }

    .btn-icon-acao i {
        font-size: 14px;
    }

    /* Dropdown da engrenagem */
    .dropdown-menu-cdf {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        z-index: 1000;
        margin-top: 4px;
    }

    .dropdown-menu-cdf a {
        display: block;
        padding: 10px 15px;
        color: #374151;
        text-decoration: none;
        font-size: 13px;
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.2s;
    }

    .dropdown-menu-cdf a:last-child {
        border-bottom: none;
    }

    .dropdown-menu-cdf a:hover {
        background: #f9fafb;
        color: #2563eb;
    }

    /* Highlight do termo pesquisado - AMARELO FORTE */
    .highlight-termo,
    .termo-highlight {
        background: #fef08a !important;
        color: #854d0e !important;
        font-weight: 700 !important;
        padding: 2px 4px;
        border-radius: 3px;
        box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.3);
    }
</style>

<!-- Modal de Confirma√ß√£o -->
<div id="modal-confirmacao" style="display: none;">
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header-warning">
                <div class="modal-icon-warning">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white" style="width: 36px; height: 36px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h2 class="modal-title">Aten√ß√£o!</h2>
            </div>
            <div class="modal-body">
                <p class="modal-message">
                    <strong>Tem certeza que deseja concluir este or√ßamento?</strong><br><br>
                    Ao concluir este or√ßamento, ele n√£o poder√° ser alterado.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" id="modal-btn-confirmar" class="modal-btn-confirm">
                    SIM, CONCLUIR
                </button>
                <button type="button" id="modal-btn-cancelar" class="modal-btn-cancel">
                    CANCELAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edi√ß√£o -->
<div id="modal-edicao" style="display: none;">
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header-edit">
                <div class="modal-icon-edit">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white" style="width: 36px; height: 36px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                </div>
                <h2 class="modal-title">Editar Dados do Or√ßamento</h2>
            </div>
            <form id="form-editar-dados">
                @csrf
                <div class="modal-body-form">
                    <!-- Nome do Or√ßamento -->
                    <div class="modal-form-group">
                        <label for="edit_nome" class="modal-form-label">
                            Nome do Or√ßamento<span class="required">*</span>
                        </label>
                        <input
                            type="text"
                            id="edit_nome"
                            name="nome"
                            class="modal-form-input"
                            value="{{ $orcamento->nome }}"
                            required
                        >
                    </div>

                    <!-- Refer√™ncia Externa -->
                    <div class="modal-form-group">
                        <label for="edit_referencia_externa" class="modal-form-label">
                            Refer√™ncia Externa
                        </label>
                        <input
                            type="text"
                            id="edit_referencia_externa"
                            name="referencia_externa"
                            class="modal-form-input"
                            value="{{ $orcamento->referencia_externa }}"
                        >
                    </div>

                    <!-- Objeto -->
                    <div class="modal-form-group">
                        <label for="edit_objeto" class="modal-form-label">
                            Objeto<span class="required">*</span>
                        </label>
                        <textarea
                            id="edit_objeto"
                            name="objeto"
                            class="modal-form-textarea"
                            required
                        >{{ $orcamento->objeto }}</textarea>
                    </div>

                    <!-- √ìrg√£o Interessado -->
                    <div class="modal-form-group">
                        <label for="edit_orgao_interessado" class="modal-form-label">
                            √ìrg√£o Interessado
                        </label>
                        <input
                            type="text"
                            id="edit_orgao_interessado"
                            name="orgao_interessado"
                            class="modal-form-input"
                            value="{{ $orcamento->orgao_interessado }}"
                        >
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="modal-btn-confirm">
                        SALVAR
                    </button>
                    <button type="button" id="modal-edit-cancelar" class="modal-btn-cancel">
                        CANCELAR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: 1¬∫ Passo - Importar Comprovante de Solicita√ß√£o de CDF -->
<div class="modal fade" id="modalPrimeiroPasso" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document" style="max-width: 900px;">
        <div class="modal-content">
            <div class="modal-header" style="background: #1e40af; color: white;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 15px;">1¬∫ PASSO: IMPORTAR COMPROVANTE DE SOLICITA√á√ÉO DE COTA√á√ÉO DIRETA</h5>
                <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 1;">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <form id="formPrimeiroPasso">
                    <input type="hidden" id="primeiro_passo_cdf_id" name="cdf_id">

                    <!-- Se√ß√£o 1: Dados da CDF -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">1</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">DADOS DA COTA√á√ÉO DIRETA COM FORNECEDOR</h6>
                        </div>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 6px; border-left: 4px solid #2563eb;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                                <div><strong>CDF n¬∫:</strong> <span id="modal_cdf_numero"></span></div>
                                <div><strong>FORNECEDOR:</strong> <span id="modal_cdf_fornecedor"></span></div>
                                <div><strong>SITUA√á√ÉO:</strong> <span id="modal_cdf_situacao"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Se√ß√£o 2: Valida√ß√£o -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">2</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">VALIDA√á√ÉO DO COMPROVANTE DE SOLICITA√á√ÉO DA CDF</h6>
                        </div>
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151;">1) A cota√ß√£o direta com fornecedor foi coletada:</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="metodo_coleta" value="email" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <i class="fas fa-envelope" style="font-size: 32px; color: #2563eb; display: block; margin-bottom: 8px;"></i>
                                    <span style="font-size: 13px; font-weight: 600;">Por e-mail</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="metodo_coleta" value="presencial" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <i class="fas fa-store" style="font-size: 32px; color: #ea580c; display: block; margin-bottom: 8px;"></i>
                                    <span style="font-size: 13px; font-weight: 600;">Diretamente perante o fornecedor</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Se√ß√£o 3: Importa√ß√£o -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">3</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">IMPORTA√á√ÉO DO COMPROVANTE DE SOLICITA√á√ÉO DE COTA√á√ÉO DIRETA</h6>
                        </div>
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151;">1) Importar o comprovante do envio do e-mail ou do recebimento do of√≠cio de solicita√ß√£o, no caso de cota√ß√£o diretamente no estabelecimento comercial:</p>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                                Selecione o arquivo para envio:<span style="color: #dc2626;">*</span>
                            </label>
                            <input type="file" name="comprovante_file" accept=".pdf" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                        </div>
                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 4px;">
                            <p style="margin: 0; font-size: 12px; color: #92400e; font-weight: 600;">ORIENTA√á√ïES PARA UPLOAD DO COMPROVANTE</p>
                            <ul style="margin: 8px 0 0 20px; font-size: 12px; color: #92400e;">
                                <li>Tamanho m√°ximo do arquivo: 2MB.</li>
                                <li>Orienta√ß√£o de todas as p√°ginas do documento: RETRATO.</li>
                                <li>Formato de arquivo aceito: *.pdf</li>
                            </ul>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="background: #f9fafb; padding: 15px 25px;">
                <button type="button" class="btn btn-primary" id="btnEnviarPrimeiroPasso">
                    <i class="fas fa-check"></i> ENVIAR
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> FECHAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Gerenciamento da CDF -->
<div class="modal fade" id="modalGerenciarCDF" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document" style="max-width: 900px;">
        <div class="modal-content">
            <div class="modal-header" style="background: #1e40af; color: white;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 15px;">GERENCIAMENTO DA SOLICITA√á√ÉO DA CDF</h5>
                <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 1;">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <form id="formGerenciarCDF">
                    <input type="hidden" id="gerenciar_cdf_id" name="cdf_id">

                    <!-- Se√ß√£o 1: Dados da CDF -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">1</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">DADOS DA COTA√á√ÉO DIRETA COM FORNECEDOR</h6>
                        </div>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 6px; border-left: 4px solid #2563eb;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                                <div><strong>CDF n¬∫:</strong> <span id="modal_ger_cdf_numero"></span></div>
                                <div><strong>FORNECEDOR:</strong> <span id="modal_ger_cdf_fornecedor"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Se√ß√£o 2: Cancelamento -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">2</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">CANCELAMENTO</h6>
                        </div>
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151;">Cancelar a CDF pois:</p>
                        <div style="margin-left: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="cancelamento_motivo[]" value="nao_enviado" style="margin-right: 8px;">
                                o arquivo foi gerado mas n√£o foi enviado ao fornecedor;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="cancelamento_motivo[]" value="outros" style="margin-right: 8px;">
                                outros:
                            </label>
                            <textarea name="cancelamento_obs" rows="2" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;" placeholder="Descreva o motivo..."></textarea>
                        </div>
                    </div>

                    <!-- Se√ß√£o 3: Descarte -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">3</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">DESCARTE</h6>
                        </div>
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151;">Descartar a CDF pois:</p>
                        <div style="margin-left: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="sem_resposta" style="margin-right: 8px;">
                                n√£o houve resposta √† solicita√ß√£o at√© a conclus√£o do or√ßamento estimativo;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="fora_prazo" style="margin-right: 8px;">
                                n√£o houve resposta √† solicita√ß√£o dentro do prazo concedido;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="fora_prazo_resposta" style="margin-right: 8px;">
                                a resposta √† solicita√ß√£o deu-se fora do prazo concedido;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="desacordo" style="margin-right: 8px;">
                                a especifica√ß√£o ou condi√ß√µes de fornecimento informadas est√£o em desacordo com o teor da solicita√ß√£o;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="responsavel_nao_identificado" style="margin-right: 8px;">
                                o respons√°vel pela apresenta√ß√£o da cota√ß√£o de pre√ßos n√£o est√° devidamente identificado (nome leg√≠vel, CPF e/ou cargo/fun√ß√£o);
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="cnpj_incompativel" style="margin-right: 8px;">
                                o c√≥digo e descri√ß√£o da atividade econ√¥mica principal ou secund√°ria do fornecedor, indicado no comprovante de inscri√ß√£o e situa√ß√£o cadastral do CNPJ, √© incompat√≠vel com o objeto da solicita√ß√£o da CDF;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="vinculo" style="margin-right: 8px;">
                                existem ind√≠cios de v√≠nculo entre o respons√°vel pela presente CDF e com outro fornecedor consultado;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="outros_desc" style="margin-right: 8px;">
                                outros:
                            </label>
                            <textarea name="descarte_obs" rows="2" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;" placeholder="Descreva o motivo..."></textarea>
                        </div>
                    </div>

                    <!-- Se√ß√£o 4: Juntar Documento -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">4</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">JUNTAR DOCUMENTO</h6>
                        </div>
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151;">Caso entenda necess√°rio, o or√ßamentista pode juntar documento:</p>
                        <div style="margin-bottom: 15px;">
                            <input type="file" name="documento_file" accept=".pdf" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                        </div>
                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 4px;">
                            <p style="margin: 0; font-size: 12px; color: #92400e; font-weight: 600;">INFORMA√á√ïES SOBRE UPLOAD</p>
                            <ul style="margin: 8px 0 0 20px; font-size: 12px; color: #92400e;">
                                <li>Tamanho m√°ximo do arquivo: 2MB</li>
                                <li>Orienta√ß√£o de todas as p√°ginas do documento: RETRATO</li>
                                <li>Formato de arquivo aceito: *.pdf</li>
                            </ul>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="background: #f9fafb; padding: 15px 25px;">
                <button type="button" class="btn btn-primary" id="btnConcluirGerenciamento">
                    <i class="fas fa-check"></i> CONCLUIR
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> FECHAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: 2¬∫ Passo - Validar Cota√ß√£o Direta com Fornecedor -->
<div class="modal fade" id="modalSegundoPasso" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document" style="max-width: 900px;">
        <div class="modal-content">
            <div class="modal-header" style="background: #1e40af; color: white;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 15px;">2¬∫ PASSO: VALIDAR COTA√á√ÉO DIRETA COM FORNECEDOR (CDF)</h5>
                <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 1;">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <form id="formSegundoPasso">
                    <input type="hidden" id="segundo_passo_cdf_id" name="cdf_id">

                    <!-- Se√ß√£o 1: Dados da CDF -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">1</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">DADOS DA COTA√á√ÉO DIRETA COM FORNECEDOR</h6>
                        </div>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 6px; border-left: 4px solid #2563eb;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                                <div><strong>CDF n¬∫:</strong> <span id="modal_2p_cdf_numero"></span></div>
                                <div><strong>FORNECEDOR:</strong> <span id="modal_2p_cdf_fornecedor"></span></div>
                                <div><strong>SITUA√á√ÉO:</strong> <span id="modal_2p_cdf_situacao"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Quest√£o 1 -->
                    <div style="margin-bottom: 25px;">
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151; font-weight: 600;">
                            1) A cota√ß√£o foi recebida em at√© 5 (cinco) dias √∫teis da solicita√ß√£o, ou no prazo de resposta acordado com o fornecedor?
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q1" value="sim" style="margin-right: 10px;" required>
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #22c55e; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-check" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 13px; font-weight: 600;">Sim</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q1" value="nao_descartar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ef4444; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-times" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">N√£o (Descartar CDF)</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Quest√£o 2 -->
                    <div style="margin-bottom: 25px;">
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151; font-weight: 600;">
                            2) Na cota√ß√£o apresentada, a empresa est√° devidamente identificada, com raz√£o social ou nome fantasia, CNPJ, endere√ßo, telefone, e-mail, timbre etc?
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q2" value="sim" style="margin-right: 10px;" required>
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ea580c; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-store" style="font-size: 20px; color: white;"></i>
                                        <i class="fas fa-check" style="font-size: 16px; color: white; position: absolute; bottom: 0; right: 0; background: #22c55e; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;"></i>
                                    </div>
                                    <span style="font-size: 13px; font-weight: 600;">Sim</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q2" value="nao_justificar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ea580c; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-store" style="font-size: 20px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">N√£o (justificar o uso)</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q2" value="nao_descartar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ef4444; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-times" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">N√£o (Descartar CDF)</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Quest√£o 3 -->
                    <div style="margin-bottom: 25px;">
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151; font-weight: 600;">
                            3) O respons√°vel pela apresenta√ß√£o da cota√ß√£o de pre√ßos est√° devidamente identificado (nome leg√≠vel, CPF e/ou cargo/fun√ß√£o):
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q3" value="sim" style="margin-right: 10px;" required>
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; position: relative;">
                                        <i class="fas fa-user" style="font-size: 32px; color: #3b82f6;"></i>
                                        <i class="fas fa-check" style="font-size: 16px; color: white; position: absolute; bottom: -4px; right: -4px; background: #22c55e; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center;"></i>
                                    </div>
                                    <span style="font-size: 13px; font-weight: 600;">Sim</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q3" value="nao_justificar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-user" style="font-size: 32px; color: #f97316;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">N√£o (justificar o uso)</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q3" value="nao_descartar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ef4444; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-times" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">N√£o (Descartar CDF)</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Quest√£o 4 -->
                    <div style="margin-bottom: 25px;">
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151; font-weight: 600;">
                            4) Os itens cotados pelo fornecedor est√£o em conformidade com a solicita√ß√£o:
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q4" value="sim" style="margin-right: 10px;" required>
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #22c55e; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-check" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 13px; font-weight: 600;">Sim</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q4" value="nao_descartar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ef4444; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-times" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">N√£o (Descartar CDF)</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Quest√£o 5 -->
                    <div style="margin-bottom: 25px;">
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151; font-weight: 600;">
                            5) Existem ind√≠cios de v√≠nculo entre o respons√°vel pela presente CDF e outros fornecedores consultados, como s√≥cios conhecidos em comum, mesmo endere√ßo, mesmo padr√£o gr√°fico das cota√ß√µes, mesmos erros de grafia, itens com valores exatamente iguais etc.:
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q5" value="nao" style="margin-right: 10px;" required>
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ef4444; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-times" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 13px; font-weight: 600;">N√£o</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q5" value="sim_justificar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; position: relative;">
                                        <i class="fas fa-search" style="font-size: 28px; color: #f59e0b;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">Sim (justificar o uso)</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q5" value="sim_descartar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; position: relative;">
                                        <i class="fas fa-search" style="font-size: 28px; color: #f59e0b;"></i>
                                        <i class="fas fa-times" style="font-size: 14px; color: white; position: absolute; bottom: 0; right: 0; background: #ef4444; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">Sim (Descartar CDF)</span>
                                </div>
                            </label>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer" style="background: #f9fafb; padding: 15px 25px;">
                <button type="button" class="btn btn-primary" id="btnEnviarSegundoPasso">
                    <i class="fas fa-check"></i> CONCLUIR
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> FECHAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cabe√ßalho da P√°gina -->
<div class="welcome-section">
    <h1 class="welcome-title">ELABORA√á√ÉO DO OR√áAMENTO ESTIMATIVO</h1>
    <p class="welcome-subtitle">Preencha as informa√ß√µes abaixo para concluir o or√ßamento</p>
</div>

<!-- SE√á√ÉO 1: DADOS CADASTRAIS DO OR√áAMENTO -->
<div class="secao">
    <div class="secao-header">
        <div class="secao-numero">1</div>
        <div class="secao-titulo">DADOS CADASTRAIS DO OR√áAMENTO</div>
    </div>

    <div>
        <div class="dados-item">
            <div class="dados-label">N√∫mero do or√ßamento:</div>
            <div class="dados-valor">{{ $orcamento->numero ?? 'N√£o gerado' }}</div>
        </div>
        <div class="dados-item">
            <div class="dados-label">Nome do or√ßamento:</div>
            <div class="dados-valor">{{ $orcamento->nome }}</div>
        </div>
        <div class="dados-item">
            <div class="dados-label">Refer√™ncia externa:</div>
            <div class="dados-valor">{{ $orcamento->referencia_externa ?? '-' }}</div>
        </div>
        <div class="dados-item">
            <div class="dados-label">Objeto:</div>
            <div class="dados-valor">{{ $orcamento->objeto }}</div>
        </div>
        <div class="dados-item">
            <div class="dados-label">√ìrg√£o interessado:</div>
            <div class="dados-valor">{{ $orcamento->orgao_interessado ?? 'Prefeitura municipal de Barbacena' }}</div>
        </div>
        <div class="dados-item">
            <div class="dados-label">Or√ßamentista:</div>
            <div class="dados-valor">{{ $orcamento->user->name }} (CPF: 000.000.000-00 - PORTARIA: 00000/0000)</div>
        </div>
    </div>

    <div style="margin-top: 20px;">
        <button type="button" id="btn-alterar-dados" class="btn btn-secondary">
            <i class="fas fa-edit"></i>
            ALTERAR
        </button>
    </div>
</div>

<!-- SE√á√ÉO 2: METODOLOGIAS E PADR√ïES -->
<div class="secao">
    <div class="secao-header">
        <div class="secao-numero">2</div>
        <div class="secao-titulo">METODOLOGIAS E PADR√ïES</div>
    </div>

    <div class="linha-vertical">
        <h3 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 15px;">
            M√âTODO DO JU√çZO CR√çTICO (EXPURGO DE SOBREPRE√áO E PRE√áO INEXEQU√çVEL)
        </h3>
        <div class="radio-group">
            <label>
                <input type="radio" name="metodo_juizo_critico" value="saneamento_desvio_padrao" checked>
                <span style="font-size: 13px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 5px;"></i>
                    Saneamento das amostras pelo desvio-padr√£o
                </span>
            </label>
            <label>
                <input type="radio" name="metodo_juizo_critico" value="saneamento_percentual">
                <span style="font-size: 13px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 5px;"></i>
                    Saneamento das amostras com base em percentual
                </span>
            </label>
        </div>
    </div>

    <div class="linha-vertical">
        <h3 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 15px;">
            M√âTODO DE OBTEN√á√ÉO DO PRE√áO ESTIMADO
        </h3>
        <div class="radio-group">
            <label>
                <input type="radio" name="metodo_obtencao_preco" value="media_mediana" checked>
                <span style="font-size: 13px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 5px;"></i>
                    M√©dia ou mediana a partir do coeficiente de varia√ß√£o (padr√£o do sistema)
                </span>
            </label>
            <label>
                <input type="radio" name="metodo_obtencao_preco" value="mediana_todas">
                <span style="font-size: 13px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 5px;"></i>
                    Mediana aplicada a todas as amostras
                </span>
            </label>
            <label>
                <input type="radio" name="metodo_obtencao_preco" value="media_todas">
                <span style="font-size: 13px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 5px;"></i>
                    M√©dia aritm√©tica aplicada a todas as amostras
                </span>
            </label>
            <label>
                <input type="radio" name="metodo_obtencao_preco" value="menor_preco">
                <span style="font-size: 13px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 5px;"></i>
                    Menor pre√ßo aplicado a todas as amostras
                </span>
            </label>
        </div>
    </div>

    <div class="linha-vertical">
        <h3 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 15px;">
            PADR√ÉO DE CASAS DECIMAIS
        </h3>
        <div class="radio-group">
            <label>
                <input type="radio" name="casas_decimais" value="duas" checked>
                <span style="font-size: 13px;">Usar duas casas decimais</span>
            </label>
            <label>
                <input type="radio" name="casas_decimais" value="quatro">
                <span style="font-size: 13px;">Usar quatro casas decimais</span>
            </label>
        </div>
    </div>
</div>

<!-- SE√á√ÉO 3: CADASTRAMENTO DE ITENS DO OR√áAMENTO -->
<div class="secao">
    <div class="secao-header">
        <div class="secao-numero">3</div>
        <div class="secao-titulo">
            CADASTRAMENTO DE ITENS DO OR√áAMENTO
            <span class="badge">{{ $orcamento->itens->count() }}</span>
        </div>
        <div style="margin-left: auto;">
            <select class="form-select" style="width: 200px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                <option>ORDEM DE ITENS</option>
            </select>
        </div>
    </div>

    @if($orcamento->itens->count() == 0)
    <div class="alert-empty">
        SEU OR√áAMENTO EST√Å VAZIO<br>
        Voc√™ pode come√ßar usando uma das op√ß√µes abaixo.
    </div>

    <div style="margin-top: 20px; display: flex; gap: 12px;">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAdicionarItem">
            <i class="fas fa-plus"></i>
            CRIAR UM ITEM
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCriarLote">
            <i class="fas fa-layer-group"></i>
            CRIAR UM LOTE
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalImportarPlanilha">
            <i class="fas fa-file-upload"></i>
            IMPORTAR ITENS DE UMA PLANILHA
        </button>
    </div>    @else
    <!-- Listagem de itens cadastrados -->
    <div style="margin-top: 20px; margin-bottom: 25px;">
        <table class="data-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f9fafb;">
                    <th style="padding: 8px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; border-bottom: 1px solid #e5e7eb; width: 40px;">
                        <input type="checkbox" id="checkbox-select-all" style="cursor: pointer;">
                    </th>
                    <th style="padding: 12px; text-align: left; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; width: 50px;">Lote/Item</th>
                    <th style="padding: 12px; text-align: left; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb;">Descri√ß√£o</th>
                    <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; width: 120px;">Medida de fornecimento</th>
                    <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; width: 80px;">Qnt</th>
                    <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; width: 120px;">Pre√ßo unit√°rio (R$)</th>
                    <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; width: 120px;">Pre√ßo total (R$)</th>
                    <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; width: 100px;">Curva ABC</th>
                    <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; border-bottom: 1px solid #e5e7eb; width: 200px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach($orcamento->itens as $index => $item)
                <tr style="border-bottom: 1px solid #f3f4f6;">
                    <td style="padding: 8px; text-align: center;">
                        <input type="checkbox" class="checkbox-item" data-item-id="{{ $item->id }}" style="cursor: pointer;">
                    </td>
                    <td style="padding: 12px; font-size: 13px; color: #374151; text-align: center; font-weight: 600;">{{ str_pad($index + 1, 2, '0', STR_PAD_LEFT) }}/{{ str_pad($index + 1, 3, '0', STR_PAD_LEFT) }}</td>
                    <td style="padding: 12px; font-size: 13px; color: #374151;">{{ strtoupper($item->descricao) }}</td>
                    <td style="padding: 12px; font-size: 13px; color: #374151; text-align: center;">{{ $item->medida_fornecimento }}</td>
                    <td style="padding: 12px; font-size: 13px; color: #374151; text-align: right;">{{ rtrim(rtrim(number_format($item->quantidade, 2, ',', '.'), '0'), ',') }}</td>
                    <td style="padding: 12px; font-size: 13px; color: {{ $item->preco_unitario ? '#16a34a' : '#6b7280' }}; text-align: right; font-weight: {{ $item->preco_unitario ? '600' : '400' }};">
                        @if($item->preco_unitario)
                            R$ {{ number_format($item->preco_unitario, 2, ',', '.') }}
                        @else
                            <span style="color: #9ca3af; font-style: italic;">Sem pre√ßo</span>
                        @endif
                    </td>
                    <td style="padding: 12px; font-size: 13px; color: {{ $item->preco_unitario ? '#16a34a' : '#6b7280' }}; text-align: right; font-weight: {{ $item->preco_unitario ? '700' : '400' }};">
                        @if($item->preco_unitario)
                            R$ {{ number_format($item->preco_unitario * $item->quantidade, 2, ',', '.') }}
                        @else
                            <span style="color: #9ca3af; font-style: italic;">-</span>
                        @endif
                    </td>
                    <td style="padding: 12px; font-size: 11px; color: #6b7280; text-align: center;">
                        <span style="font-weight: 600;">SEM CLASSE</span>
                    </td>
                    <td style="padding: 8px; text-align: center;">
                        <!-- Bot√£o 1: LUPA (Cota√ß√£o de Pre√ßos) -->
                        <button type="button" class="btn-cotacao" data-item-id="{{ $item->id }}" data-item-descricao="{{ $item->descricao }}" title="Cota√ß√£o de Pre√ßos" style="background: #6b7280; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 3px;">
                            <i class="fas fa-search"></i>
                        </button>
                        <!-- Bot√£o 2: AN√ÅLISE (An√°lise Cr√≠tica) -->
                        <button type="button" class="btn-analise" data-item-id="{{ $item->id }}" title="An√°lise Cr√≠tica dos Dados" style="background: #6b7280; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 3px;">
                            <i class="fas fa-clipboard-check"></i>
                        </button>
                        <!-- Bot√£o 3: ALTERAR (Editar Item) -->
                        <button type="button" class="btn-editar-item" data-item-id="{{ $item->id }}" title="Alterar Item" style="background: #3b82f6; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 3px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <!-- Bot√£o 4: ENGRENAGEM (Outras Op√ß√µes) -->
                        <div style="display: inline-block; position: relative;">
                            <button type="button" class="btn-outras-opcoes" data-item-id="{{ $item->id }}" title="Outras op√ß√µes" style="background: #6b7280; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                <i class="fas fa-cog"></i>
                            </button>
                            <!-- Dropdown (ser√° criado via JavaScript) -->
                        </div>
                    </td>
                </tr>
                @endforeach
            </tbody>
        </table>

        <!-- Bot√µes de Apagar (abaixo da tabela) -->
        <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
            <button type="button" id="btn-apagar-marcados" class="btn" style="background: #dc2626; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">
                <i class="fas fa-times"></i> APAGAR ITENS MARCADOS
            </button>
            <button type="button" id="btn-apagar-todos" class="btn" style="background: #dc2626; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">
                <i class="fas fa-times"></i> APAGAR TODOS OS ITENS
            </button>
        </div>
    </div>

    <!-- Bot√µes para adicionar mais itens -->
    <div style="margin-top: 20px; display: flex; gap: 12px;">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAdicionarItem">
            <i class="fas fa-plus"></i>
            CRIAR UM ITEM
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCriarLote">
            <i class="fas fa-layer-group"></i>
            CRIAR UM LOTE
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalImportarPlanilha">
            <i class="fas fa-file-upload"></i>
            IMPORTAR ITENS DE UMA PLANILHA
        </button>
    </div>
    @endif
</div>

<!-- SE√á√ÉO 4: COLETA DE AMOSTRAS -->
<div class="secao">
    <div class="secao-header">
        <div class="secao-numero">4</div>
        <div class="secao-titulo">COLETA DE AMOSTRAS</div>
    </div>

    <!-- COTA√á√ÉO DIRETA COM FORNECEDORES (CDF) -->
    <div class="linha-vertical" style="margin-bottom: 30px;">
        <h3 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 10px;">
            COTA√á√ÉO DIRETA COM FORNECEDORES (CDF)
        </h3>
        <table class="data-table" style="margin: 15px 0;">
            <thead>
                <tr>
                    <th>N√∫mero</th>
                    <th>Fornecedor</th>
                    <th>Gerada</th>
                    <th>Solicitada</th>
                    <th>Respondida</th>
                    <th>Validade</th>
                    <th>Situa√ß√£o</th>
                    <th style="width: 450px;">A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                @if($orcamento->solicitacoesCDF->count() > 0)
                    @foreach($orcamento->solicitacoesCDF as $cdf)
                    <tr>
                        <td>{{ str_pad($cdf->id, 2, '0', STR_PAD_LEFT) }}/2025</td>
                        <td>{{ $cdf->razao_social }}</td>
                        <td>{{ $cdf->created_at->format('d/m/Y') }}</td>
                        <td>{{ $cdf->created_at->format('d/m/Y') }}</td>
                        <td>-</td>
                        <td>-</td>
                        <td><span style="background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ $cdf->status }}</span></td>
                        <td>
                            <div style="display: flex; gap: 4px; align-items: center;">
                                <!-- 1. Baixar Of√≠cio (Word) -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="baixar-oficio" title="Baixar Of√≠cio de Solicita√ß√£o (Word)">
                                    <i class="fas fa-file-word" style="color: #2563eb;"></i>
                                </button>

                                <!-- 2. Baixar Formul√°rio (Excel) -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="baixar-formulario" title="Baixar Formul√°rio de Cota√ß√£o (Excel)">
                                    <i class="fas fa-file-excel" style="color: #16a34a;"></i>
                                </button>

                                <!-- 3. Primeiro Passo -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="primeiro-passo" title="1¬∫ Passo: Validar Solicita√ß√£o e Importar Comprovante">
                                    <i class="fas fa-check-circle" style="color: #059669;"></i>
                                </button>

                                <!-- 4. Engrenagem (Dropdown) -->
                                <div style="position: relative;">
                                    <button class="btn-icon-acao btn-dropdown-cdf" data-cdf-id="{{ $cdf->id }}" title="Mais op√ß√µes">
                                        <i class="fas fa-cog" style="color: #6b7280;"></i>
                                    </button>
                                    <div class="dropdown-menu-cdf" id="dropdown-cdf-{{ $cdf->id }}" style="display: none;">
                                        <a href="#" data-action="alterar-primeiro-passo" data-cdf-id="{{ $cdf->id }}">Alterar 1¬∫ Passo</a>
                                        <a href="#" data-action="segundo-passo" data-cdf-id="{{ $cdf->id }}">2¬∫ Passo: Validar Cota√ß√£o</a>
                                    </div>
                                </div>

                                <!-- 5. Baixar Espelho CNPJ -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="baixar-cnpj" title="Baixar Espelho CNPJ">
                                    <i class="fas fa-id-card" style="color: #7c3aed;"></i>
                                </button>

                                <!-- 6. Baixar Comprovante -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="baixar-comprovante" title="Baixar Comprovante da Solicita√ß√£o">
                                    <i class="fas fa-file-pdf" style="color: #dc2626;"></i>
                                </button>

                                <!-- 7. Baixar Cota√ß√£o -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="baixar-cotacao" title="Baixar Cota√ß√£o Direta com Fornecedor">
                                    <i class="fas fa-download" style="color: #ea580c;"></i>
                                </button>

                                <!-- 8. Gerenciar -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="gerenciar" title="Gerenciar a CDF">
                                    <i class="fas fa-tasks" style="color: #0891b2;"></i>
                                </button>

                                <!-- 9. Remover -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="remover" title="Remover a CDF">
                                    <i class="fas fa-trash" style="color: #dc2626;"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    @endforeach
                @else
                <tr>
                    <td colspan="8" style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                        Este or√ßamento ainda n√£o possui cota√ß√µes diretas com fornecedor
                    </td>
                </tr>
                @endif
            </tbody>
        </table>
        <button class="btn btn-outline" id="btn-solicitar-cdf">
            <i class="fas fa-file-invoice"></i>
            SOLICITAR CDF
        </button>
    </div>

    <!-- CONTRATA√á√ïES SIMILARES FEITAS PELA ADMINISTRA√á√ÉO P√öBLICA -->
    <div class="linha-vertical" style="margin-bottom: 30px;">
        <h3 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 10px;">
            CONTRATA√á√ïES SIMILARES FEITAS PELA ADMINISTRA√á√ÉO P√öBLICA
        </h3>
        <table class="data-table" style="margin: 15px 0;">
            <thead>
                <tr>
                    <th>N√∫mero do preg√£o</th>
                    <th>Data</th>
                    <th>Publica√ß√£o</th>
                    <th>Ente p√∫blico</th>
                </tr>
            </thead>
            <tbody>
                @if($orcamento->contratacoesSimilares->count() > 0)
                    @foreach($orcamento->contratacoesSimilares as $contratacao)
                    <tr>
                        <td>{{ $contratacao->numero_processo }}</td>
                        <td>{{ $contratacao->data_publicacao ? \Carbon\Carbon::parse($contratacao->data_publicacao)->format('d/m/Y') : '-' }}</td>
                        <td>{{ $contratacao->local_publicacao ?? '-' }}</td>
                        <td>{{ $contratacao->ente_publico }}</td>
                    </tr>
                    @endforeach
                @else
                <tr>
                    <td colspan="4" style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                        Este or√ßamento ainda n√£o possui contrata√ß√µes similares de outros entes p√∫blicos
                    </td>
                </tr>
                @endif
            </tbody>
        </table>
        <button class="btn btn-outline" id="btn-contratacoes-similares">
            <i class="fas fa-plus-circle"></i>
            INCLUIR CONTRATA√á√ïES SIMILARES DE OUTROS ENTES P√öBLICOS
        </button>
    </div>

    <!-- S√çTIOS DE COM√âRCIO ELETR√îNICO -->
    <div class="linha-vertical">
        <h3 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 10px;">
            S√çTIOS DE COM√âRCIO ELETR√îNICO
        </h3>
        <table class="data-table" style="margin: 15px 0;">
            <thead>
                <tr>
                    <th>N√∫mero</th>
                    <th>Nome</th>
                    <th>Data da consulta</th>
                </tr>
            </thead>
            <tbody>
                @if($orcamento->coletasEcommerce->count() > 0)
                    @foreach($orcamento->coletasEcommerce as $coleta)
                    <tr>
                        <td>{{ str_pad($coleta->id, 2, '0', STR_PAD_LEFT) }}/2025</td>
                        <td>{{ $coleta->nome_site }}</td>
                        <td>{{ $coleta->data_consulta ? \Carbon\Carbon::parse($coleta->data_consulta)->format('d/m/Y') : '-' }}</td>
                    </tr>
                    @endforeach
                @else
                <tr>
                    <td colspan="3" style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                        Este or√ßamento ainda n√£o possui coletas em s√≠tios de com√©rcio eletr√¥nico.
                    </td>
                </tr>
                @endif
            </tbody>
        </table>
        <button class="btn btn-outline" id="btn-incluir-sitio-ecommerce">
            <i class="fas fa-shopping-cart"></i>
            INCLUIR COLETA EM S√çTIO DE COM√âRCIO ELETR√îNICO
        </button>
    </div>
</div>

<!-- SE√á√ÉO 6: DADOS DO OR√áAMENTISTA (para Preview) -->
<div class="secao">
    <div class="secao-header">
        <div class="secao-numero">6</div>
        <div class="secao-titulo">DADOS DO OR√áAMENTISTA</div>
    </div>

    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 16px; margin-bottom: 20px; border-radius: 6px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-info-circle" style="color: #f59e0b; font-size: 16px;"></i>
            <span style="color: #92400e; font-size: 13px; font-weight: 500;">
                Preencha os dados do or√ßamentista para emiss√£o do preview do or√ßamento. Ao informar um CNPJ, os dados ser√£o preenchidos automaticamente.
            </span>
        </div>
    </div>

    <form id="form-orcamentista" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- Nome do Or√ßamentista -->
        <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Nome do Or√ßamentista: <span style="color: #dc2626;">*</span>
            </label>
            <input
                type="text"
                id="orcamentista_nome"
                name="orcamentista_nome"
                value="{{ $orcamento->orcamentista_nome ?? '' }}"
                required
                class="form-input"
                placeholder="Digite o nome completo do or√ßamentista"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
        </div>

        <!-- CPF/CNPJ -->
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                CPF/CNPJ: <span style="color: #dc2626;">*</span>
            </label>
            <input
                type="text"
                id="orcamentista_cpf_cnpj"
                name="orcamentista_cpf_cnpj"
                value="{{ $orcamento->orcamentista_cpf_cnpj ?? '' }}"
                required
                class="form-input"
                placeholder="Digite CPF ou CNPJ"
                maxlength="18"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
            <small id="cpf-cnpj-feedback" style="display: block; margin-top: 4px; font-size: 11px;"></small>
        </div>

        <!-- CEP -->
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                CEP: <span style="color: #9ca3af; font-weight: 400;">(opcional)</span>
            </label>
            <input
                type="text"
                id="orcamentista_cep_manual"
                name="orcamentista_cep_manual"
                value="{{ $orcamento->orcamentista_cep ?? '' }}"
                class="form-input"
                placeholder="Ex: 00.000-000"
                maxlength="10"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
        </div>

        <!-- Estado (UF) -->
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Estado (UF): <span style="color: #9ca3af; font-weight: 400;">(opcional)</span>
            </label>
            <select
                id="orcamentista_uf_manual"
                name="orcamentista_uf_manual"
                class="form-input"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
                <option value="">Selecione o Estado</option>
                <option value="AC" {{ ($orcamento->orcamentista_uf ?? '') == 'AC' ? 'selected' : '' }}>AC - Acre</option>
                <option value="AL" {{ ($orcamento->orcamentista_uf ?? '') == 'AL' ? 'selected' : '' }}>AL - Alagoas</option>
                <option value="AP" {{ ($orcamento->orcamentista_uf ?? '') == 'AP' ? 'selected' : '' }}>AP - Amap√°</option>
                <option value="AM" {{ ($orcamento->orcamentista_uf ?? '') == 'AM' ? 'selected' : '' }}>AM - Amazonas</option>
                <option value="BA" {{ ($orcamento->orcamentista_uf ?? '') == 'BA' ? 'selected' : '' }}>BA - Bahia</option>
                <option value="CE" {{ ($orcamento->orcamentista_uf ?? '') == 'CE' ? 'selected' : '' }}>CE - Cear√°</option>
                <option value="DF" {{ ($orcamento->orcamentista_uf ?? '') == 'DF' ? 'selected' : '' }}>DF - Distrito Federal</option>
                <option value="ES" {{ ($orcamento->orcamentista_uf ?? '') == 'ES' ? 'selected' : '' }}>ES - Esp√≠rito Santo</option>
                <option value="GO" {{ ($orcamento->orcamentista_uf ?? '') == 'GO' ? 'selected' : '' }}>GO - Goi√°s</option>
                <option value="MA" {{ ($orcamento->orcamentista_uf ?? '') == 'MA' ? 'selected' : '' }}>MA - Maranh√£o</option>
                <option value="MT" {{ ($orcamento->orcamentista_uf ?? '') == 'MT' ? 'selected' : '' }}>MT - Mato Grosso</option>
                <option value="MS" {{ ($orcamento->orcamentista_uf ?? '') == 'MS' ? 'selected' : '' }}>MS - Mato Grosso do Sul</option>
                <option value="MG" {{ ($orcamento->orcamentista_uf ?? '') == 'MG' ? 'selected' : '' }}>MG - Minas Gerais</option>
                <option value="PA" {{ ($orcamento->orcamentista_uf ?? '') == 'PA' ? 'selected' : '' }}>PA - Par√°</option>
                <option value="PB" {{ ($orcamento->orcamentista_uf ?? '') == 'PB' ? 'selected' : '' }}>PB - Para√≠ba</option>
                <option value="PR" {{ ($orcamento->orcamentista_uf ?? '') == 'PR' ? 'selected' : '' }}>PR - Paran√°</option>
                <option value="PE" {{ ($orcamento->orcamentista_uf ?? '') == 'PE' ? 'selected' : '' }}>PE - Pernambuco</option>
                <option value="PI" {{ ($orcamento->orcamentista_uf ?? '') == 'PI' ? 'selected' : '' }}>PI - Piau√≠</option>
                <option value="RJ" {{ ($orcamento->orcamentista_uf ?? '') == 'RJ' ? 'selected' : '' }}>RJ - Rio de Janeiro</option>
                <option value="RN" {{ ($orcamento->orcamentista_uf ?? '') == 'RN' ? 'selected' : '' }}>RN - Rio Grande do Norte</option>
                <option value="RS" {{ ($orcamento->orcamentista_uf ?? '') == 'RS' ? 'selected' : '' }}>RS - Rio Grande do Sul</option>
                <option value="RO" {{ ($orcamento->orcamentista_uf ?? '') == 'RO' ? 'selected' : '' }}>RO - Rond√¥nia</option>
                <option value="RR" {{ ($orcamento->orcamentista_uf ?? '') == 'RR' ? 'selected' : '' }}>RR - Roraima</option>
                <option value="SC" {{ ($orcamento->orcamentista_uf ?? '') == 'SC' ? 'selected' : '' }}>SC - Santa Catarina</option>
                <option value="SP" {{ ($orcamento->orcamentista_uf ?? '') == 'SP' ? 'selected' : '' }}>SP - S√£o Paulo</option>
                <option value="SE" {{ ($orcamento->orcamentista_uf ?? '') == 'SE' ? 'selected' : '' }}>SE - Sergipe</option>
                <option value="TO" {{ ($orcamento->orcamentista_uf ?? '') == 'TO' ? 'selected' : '' }}>TO - Tocantins</option>
            </select>
        </div>

        <!-- Endere√ßo/Rua -->
        <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Endere√ßo/Rua: <span style="color: #9ca3af; font-weight: 400;">(opcional)</span>
            </label>
            <input
                type="text"
                id="orcamentista_endereco_manual"
                name="orcamentista_endereco_manual"
                value="{{ $orcamento->orcamentista_endereco ?? '' }}"
                class="form-input"
                placeholder="Ex: Rua Principal, n¬∫ 123, Centro"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
        </div>

        <!-- Setor/Departamento -->
        <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Setor/Departamento: <span style="color: #9ca3af; font-weight: 400;">(opcional)</span>
            </label>
            <input
                type="text"
                id="orcamentista_setor"
                name="orcamentista_setor"
                value="{{ $orcamento->orcamentista_setor ?? '' }}"
                class="form-input"
                placeholder="Ex: SETOR DE COMPRAS"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
        </div>

        <!-- Campos ocultos para dados da ReceitaWS (ser√£o sobrescritos pelos campos manuais se preenchidos) -->
        <input type="hidden" id="orcamentista_razao_social" name="orcamentista_razao_social" value="{{ $orcamento->orcamentista_razao_social ?? '' }}">
        <input type="hidden" id="orcamentista_endereco" name="orcamentista_endereco" value="{{ $orcamento->orcamentista_endereco ?? '' }}">
        <input type="hidden" id="orcamentista_cep" name="orcamentista_cep" value="{{ $orcamento->orcamentista_cep ?? '' }}">
        <input type="hidden" id="orcamentista_cidade" name="orcamentista_cidade" value="{{ $orcamento->orcamentista_cidade ?? '' }}">
        <input type="hidden" id="orcamentista_uf" name="orcamentista_uf" value="{{ $orcamento->orcamentista_uf ?? '' }}">

        <!-- Upload de Bras√£o -->
        <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Bras√£o/Logo do √ìrg√£o: <span style="color: #9ca3af; font-weight: 400;">(opcional)</span>
            </label>
            <div style="background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; text-align: center;">
                <input
                    type="file"
                    id="brasao_file"
                    name="brasao_file"
                    accept="image/png,image/jpeg,image/jpg,image/svg+xml"
                    style="display: none;"
                    onchange="previewBrasao(this)"
                >
                <button type="button" onclick="document.getElementById('brasao_file').click()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">
                    <i class="fas fa-upload"></i> Selecionar Bras√£o/Logo
                </button>
                <p style="margin-top: 8px; font-size: 12px; color: #64748b;">
                    Formatos aceitos: PNG, JPG, SVG | Tamanho recomendado: 300x300px | M√°x: 2MB
                </p>
                <p style="margin-top: 4px; font-size: 11px; color: #94a3b8;">
                    A imagem ser√° automaticamente redimensionada para caber perfeitamente no documento
                </p>

                @if($orcamento->brasao_path)
                    <div id="brasao-preview" style="margin-top: 16px; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; display: inline-block;">
                        <img src="{{ asset('storage/' . $orcamento->brasao_path) }}" alt="Bras√£o" style="max-width: 120px; max-height: 120px; object-fit: contain;">
                        <p style="margin-top: 8px; font-size: 11px; color: #10b981; font-weight: 600;">‚úì Bras√£o atual</p>
                    </div>
                @else
                    <div id="brasao-preview" style="margin-top: 16px; display: none;">
                        <div style="padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; display: inline-block;">
                            <img id="brasao-preview-img" src="" alt="Preview" style="max-width: 120px; max-height: 120px; object-fit: contain;">
                            <p style="margin-top: 8px; font-size: 11px; color: #10b981; font-weight: 600;">‚úì Novo bras√£o selecionado</p>
                        </div>
                    </div>
                @endif
            </div>
        </div>

        <!-- Bot√£o Salvar Dados -->
        <div style="grid-column: 1 / -1; margin-top: 10px;">
            <button type="button" id="btn-salvar-orcamentista" class="btn btn-primary">
                <i class="fas fa-save"></i>
                SALVAR DADOS DO OR√áAMENTISTA
            </button>
        </div>
    </form>
</div>

<!-- SE√á√ÉO 7: GERAR OR√áAMENTO ESTIMATIVO -->
<div class="secao">
    <div class="secao-header">
        <div class="secao-numero">7</div>
        <div class="secao-titulo">GERAR OR√áAMENTO ESTIMATIVO</div>
    </div>

    <form id="form-concluir" method="POST" action="/orcamentos/{{ $orcamento->id }}/concluir" enctype="multipart/form-data">
        @csrf

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Observa√ß√£o/Justificativa geral:
            </label>
            <textarea
                name="observacao_justificativa"
                class="form-textarea"
                rows="6"
                placeholder="Digite aqui observa√ß√µes ou justificativas gerais sobre o or√ßamento..."
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: inherit; resize: vertical;"
            >{{ $orcamento->observacao_justificativa ?? '' }}</textarea>
        </div>

        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Anexar PDF <span style="color: #6b7280; font-weight: 400;">(Opcional - M√°x. 2MB):</span>
            </label>
            <input
                type="file"
                name="anexo_pdf"
                accept=".pdf"
                class="form-input"
                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
            @if($orcamento->anexo_pdf)
                <div style="margin-top: 8px; font-size: 12px; color: #059669;">
                    <i class="fas fa-file-pdf"></i> Arquivo anexado: {{ basename($orcamento->anexo_pdf) }}
                </div>
            @endif
            <div style="margin-top: 6px; font-size: 11px; color: #6b7280; line-height: 1.5;">
                <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
                O PDF √© opcional. Voc√™ pode concluir a cota√ß√£o sem anexar arquivo ou anexar depois.
            </div>
        </div>

        <div style="display: flex; gap: 12px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-check-circle"></i>
                CONCLUIR COTA√á√ÉO
            </button>
            <button type="button" class="btn btn-secondary" id="btn-preview">
                <i class="fas fa-eye"></i>
                PREVIEW DA COTA√á√ÉO
            </button>
        </div>
    </form>
</div>

<script>
// Fun√ß√£o global para preview do bras√£o
function previewBrasao(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];

        // Validar tamanho (m√°x 2MB)
        if (file.size > 2 * 1024 * 1024) {
            alert('[AVISO] O arquivo √© muito grande. O tamanho m√°ximo √© 2MB.');
            input.value = '';
            return;
        }

        // Validar tipo
        const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
        if (!validTypes.includes(file.type)) {
            alert('[AVISO] Formato inv√°lido. Use PNG, JPG ou SVG.');
            input.value = '';
            return;
        }

        // Mostrar preview
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewDiv = document.getElementById('brasao-preview');
            const previewImg = document.getElementById('brasao-preview-img');

            if (previewImg) {
                previewImg.src = e.target.result;
                previewDiv.style.display = 'block';
            }
        };
        reader.readAsDataURL(file);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Bot√£o Preview
    const btnPreview = document.getElementById('btn-preview');
    if (btnPreview) {
        btnPreview.addEventListener('click', function() {
            // Verificar se h√° bras√£o selecionado mas n√£o salvo
            const brasaoFile = document.getElementById('brasao_file');
            const brasaoAtual = {{ $orcamento->brasao_path ? 'true' : 'false' }};

            if (brasaoFile && brasaoFile.files.length > 0 && !brasaoAtual) {
                const confirmar = confirm('[AVISO] ATENCAO!\n\n' +
                    'Voce selecionou um novo BRASAO/LOGO mas ainda NAO salvou.\n\n' +
                    'Para que o brasao apareca no Preview:\n' +
                    '1. Clique em "SALVAR DADOS DO ORCAMENTISTA" (Secao 6)\n' +
                    '2. Depois clique em "PREVIEW DA COTACAO"\n\n' +
                    'Deseja abrir o preview mesmo assim?\n' +
                    '(O brasao NAO aparecera se voce nao salvou)');

                if (!confirmar) {
                    return;
                }
            }

            // Abrir preview em nova janela - usar URL relativa (sem /) para funcionar com tag <base>
            window.open('orcamentos/{{ $orcamento->id }}/preview', '_blank');
        });
    }

    // Controle do Modal de Confirma√ß√£o
    const form = document.getElementById('form-concluir');
    const modal = document.getElementById('modal-confirmacao');
    const btnConfirmar = document.getElementById('modal-btn-confirmar');
    const btnCancelar = document.getElementById('modal-btn-cancelar');

    if (form && modal && btnConfirmar && btnCancelar) {
        let submitAllowed = false;

        // Interceptar submit do formul√°rio
        form.addEventListener('submit', function(e) {
            if (!submitAllowed) {
                e.preventDefault();
                // Mostrar modal
                modal.style.display = 'block';
            }
        });

        // Bot√£o Confirmar - submete o formul√°rio via AJAX
        btnConfirmar.addEventListener('click', async function() {
            submitAllowed = true;
            modal.style.display = 'none';

            // Desabilitar bot√£o e mostrar loading
            btnConfirmar.disabled = true;
            btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Concluindo...';

            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.success) {
                    // Mostrar mensagem de sucesso
                    alert(data.message || 'Or√ßamento conclu√≠do com sucesso!');
                    // Redirecionar usando URL absoluta para evitar problema com localhost
                    const redirectUrl = data.redirect || (window.location.origin + '/module-proxy/price_basket/orcamentos/realizados');
                    window.location.href = redirectUrl;
                } else {
                    alert('Erro: ' + (data.message || 'Erro ao concluir or√ßamento'));
                    btnConfirmar.disabled = false;
                    btnConfirmar.innerHTML = '<i class="fas fa-check-circle"></i> CONFIRMAR';
                }
            } catch (error) {
                console.error('Erro ao concluir or√ßamento:', error);
                alert('Erro ao concluir or√ßamento. Por favor, tente novamente.');
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = '<i class="fas fa-check-circle"></i> CONFIRMAR';
            }
        });

        // Bot√£o Cancelar - fecha o modal
        btnCancelar.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        // Fechar modal ao clicar fora dele
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }

    // Controle do Modal de Edi√ß√£o
    const btnAlterarDados = document.getElementById('btn-alterar-dados');
    const modalEdicao = document.getElementById('modal-edicao');
    const btnEditCancelar = document.getElementById('modal-edit-cancelar');
    const formEditarDados = document.getElementById('form-editar-dados');

    if (btnAlterarDados && modalEdicao && btnEditCancelar && formEditarDados) {
        // Abrir modal de edi√ß√£o
        btnAlterarDados.addEventListener('click', function() {
            modalEdicao.style.display = 'block';
        });

        // Fechar modal de edi√ß√£o
        btnEditCancelar.addEventListener('click', function() {
            modalEdicao.style.display = 'none';
        });

        // Fechar modal ao clicar fora
        modalEdicao.addEventListener('click', function(e) {
            if (e.target === modalEdicao) {
                modalEdicao.style.display = 'none';
            }
        });

        // Submit do formul√°rio de edi√ß√£o via AJAX
        formEditarDados.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            formData.append('_method', 'PUT');

            // Mostrar loading no bot√£o
            const btnSubmit = this.querySelector('button[type="submit"]');
            const textoOriginal = btnSubmit.innerHTML;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
            btnSubmit.disabled = true;

            fetch(`${window.APP_BASE_PATH}/orcamentos/{{ $orcamento->id }}`, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Atualizar os valores na p√°gina
                    document.querySelector('.dados-item:nth-child(2) .dados-valor').textContent = formData.get('nome');
                    document.querySelector('.dados-item:nth-child(3) .dados-valor').textContent = formData.get('referencia_externa') || '-';
                    document.querySelector('.dados-item:nth-child(4) .dados-valor').textContent = formData.get('objeto');
                    document.querySelector('.dados-item:nth-child(5) .dados-valor').textContent = formData.get('orgao_interessado') || 'Prefeitura municipal de Barbacena';

                    // Fechar modal
                    modalEdicao.style.display = 'none';

                    // Mensagem de sucesso (opcional)
                    alert('Dados atualizados com sucesso!');
                } else {
                    alert('Erro ao atualizar dados: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao atualizar dados. Tente novamente.');
            })
            .finally(() => {
                // Restaurar bot√£o
                btnSubmit.innerHTML = textoOriginal;
                btnSubmit.disabled = false;
            });
        });
    }

    // =================================================================
    // CONTROLE DOS MODAIS - ADICIONAR ITEM, CRIAR LOTE, IMPORTAR PLANILHA
    // =================================================================

    // Os modais s√£o abertos automaticamente pelo Bootstrap atrav√©s do data-bs-toggle="modal"
    // Apenas precisamos configurar os event listeners dos bot√µes SALVAR/ENVIAR

    // =================================================================
    // MODAL 1: ADICIONAR ITEM
    // =================================================================

    const btnSalvarItem = document.getElementById('btnSalvarItem');
    if (btnSalvarItem) {
        btnSalvarItem.addEventListener('click', function() {
        const form = document.getElementById('formAdicionarItem');
    
        // Validar campos obrigat√≥rios
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
    
        // Preparar dados do formul√°rio
        const formData = new FormData(form);
    
        // Pegar o valor do radio button selecionado e ajustar para o backend
        const tipoItemSelecionado = document.querySelector('input[name="tipo_item"]:checked');
        const alterarCdfsSelecionado = document.querySelector('input[name="alterar_cdfs"]:checked');
    
        // Backend espera 'tipo' (n√£o 'tipo_item') com valores lowercase: 'produto' ou 'servico'
        if (tipoItemSelecionado) {
            formData.set('tipo', tipoItemSelecionado.value.toLowerCase().replace('√ß', 'c'));
        }
    
        // Backend espera 'alterar_cdf' (n√£o 'alterar_cdfs') como boolean
        if (alterarCdfsSelecionado) {
            formData.set('alterar_cdf', alterarCdfsSelecionado.value === 'SIM' ? '1' : '0');
        }
    
        // Mostrar loading no bot√£o
        const btnSalvar = this;
        const textoOriginal = btnSalvar.innerHTML;
        btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
        btnSalvar.disabled = true;
    
        // Enviar via AJAX
        fetch(`${window.APP_BASE_PATH}/orcamentos/{{ $orcamento->id }}/itens`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fechar modal
                const modalEl = document.getElementById('modalAdicionarItem');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
    
                // Limpar formul√°rio
                form.reset();
    
                // Mostrar mensagem de sucesso
                alert('Item adicionado com sucesso!');
    
                // Recarregar p√°gina para mostrar o novo item
                window.location.reload();
            } else {
                alert('Erro ao adicionar item: ' + (data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao adicionar item. Tente novamente.');
        })
        .finally(() => {
            // Restaurar bot√£o
            btnSalvar.innerHTML = textoOriginal;
            btnSalvar.disabled = false;
        });
        });
    }
    
    // =================================================================
    // MODAL 2: CRIAR LOTE
    // =================================================================
    
    const btnSalvarLote = document.getElementById('btnSalvarLote');
    if (btnSalvarLote) {
        btnSalvarLote.addEventListener('click', function() {
        const form = document.getElementById('formCriarLote');
    
        // Validar campos obrigat√≥rios
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
    
        // Validar n√∫mero maior que 1
        const numeroLote = document.getElementById('lote_numero').value;
        if (parseInt(numeroLote) < 1) {
            alert('O n√∫mero do lote deve ser maior ou igual a 1');
            return;
        }
    
        // Preparar dados do formul√°rio
        const formData = new FormData(form);
    
        // Mostrar loading no bot√£o
        const btnSalvar = this;
        const textoOriginal = btnSalvar.innerHTML;
        btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
        btnSalvar.disabled = true;
    
        // Enviar via AJAX
        fetch(`${window.APP_BASE_PATH}/orcamentos/{{ $orcamento->id }}/lotes`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fechar modal
                const modalEl = document.getElementById('modalCriarLote');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
    
                // Limpar formul√°rio
                form.reset();
    
                // Mostrar mensagem de sucesso
                alert('Lote criado com sucesso!');
    
                // Recarregar p√°gina
                window.location.reload();
            } else {
                alert('Erro ao criar lote: ' + (data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao criar lote. Tente novamente.');
        })
        .finally(() => {
            // Restaurar bot√£o
            btnSalvar.innerHTML = textoOriginal;
            btnSalvar.disabled = false;
        });
        });
    }
    
    // =================================================================
    // MODAL 3: IMPORTAR PLANILHA
    // =================================================================
    
    const btnEnviarPlanilha = document.getElementById('btnEnviarPlanilha');
    if (btnEnviarPlanilha) {
        btnEnviarPlanilha.addEventListener('click', function() {
        const form = document.getElementById('formImportarPlanilha');
        const arquivoInput = document.getElementById('arquivo_planilha');
    
        // Validar se arquivo foi selecionado
        if (!arquivoInput.files || arquivoInput.files.length === 0) {
            alert('Por favor, selecione um arquivo para importar.');
            return;
        }
    
        // Validar extens√£o do arquivo
        const arquivo = arquivoInput.files[0];
        const extensao = arquivo.name.split('.').pop().toLowerCase();
        if (!['xlsx', 'xls', 'csv'].includes(extensao)) {
            alert('Por favor, selecione um arquivo Excel v√°lido (.xlsx, .xls ou .csv)');
            return;
        }
    
        // Preparar dados do formul√°rio
        const formData = new FormData(form);
    
        // Mostrar loading no bot√£o
        const btnEnviar = this;
        const textoOriginal = btnEnviar.innerHTML;
        btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ENVIANDO...';
        btnEnviar.disabled = true;
    
        // Enviar via AJAX
        // IMPORTANTE: N√£o definir Content-Type - deixar browser definir automaticamente com boundary
        fetch(`${window.APP_BASE_PATH}/orcamentos/{{ $orcamento->id }}/importar-planilha`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || form.querySelector('input[name="_token"]')?.value,
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fechar modal
                const modalEl = document.getElementById('modalImportarPlanilha');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
    
                // Limpar formul√°rio
                form.reset();
    
                // Mostrar mensagem de sucesso
                alert('Planilha importada com sucesso!' + (data.message ? '\n' + data.message : ''));
    
                // Recarregar p√°gina
                window.location.reload();
            } else {
                alert('Erro ao importar planilha: ' + (data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao importar planilha. Verifique o formato do arquivo e tente novamente.');
        })
        .finally(() => {
            // Restaurar bot√£o
            btnEnviar.innerHTML = textoOriginal;
            btnEnviar.disabled = false;
        });
        });
    }
    
    // =================================================================
    // C√ÅLCULO AUTOM√ÅTICO DO PRE√áO TOTAL NO MODAL ADICIONAR ITEM
    // =================================================================

    function calcularPrecoTotalModal() {
        const quantidade = parseFloat(document.getElementById('item_quantidade')?.value) || 0;
        const precoUnitario = parseFloat(document.getElementById('item_preco_unitario')?.value) || 0;
        const precoTotal = quantidade * precoUnitario;

        const precoTotalEl = document.getElementById('preco_total_calculado');
        if (precoTotalEl) {
            precoTotalEl.textContent = 'R$ ' + precoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    }

    // Adicionar listeners para calcular automaticamente
    const itemQuantidade = document.getElementById('item_quantidade');
    const itemPrecoUnitario = document.getElementById('item_preco_unitario');

    if (itemQuantidade) {
        itemQuantidade.addEventListener('input', calcularPrecoTotalModal);
        itemQuantidade.addEventListener('change', calcularPrecoTotalModal);
    }

    if (itemPrecoUnitario) {
        itemPrecoUnitario.addEventListener('input', calcularPrecoTotalModal);
        itemPrecoUnitario.addEventListener('change', calcularPrecoTotalModal);
    }

    // =================================================================
    // LIMPAR FORMUL√ÅRIOS QUANDO MODAIS S√ÉO FECHADOS
    // =================================================================

    const modalAdicionarItemEl = document.getElementById('modalAdicionarItem');
    if (modalAdicionarItemEl) {
        modalAdicionarItemEl.addEventListener('hidden.bs.modal', function() {
            document.getElementById('formAdicionarItem')?.reset();
            // Reset do pre√ßo total calculado
            const precoTotalEl = document.getElementById('preco_total_calculado');
            if (precoTotalEl) {
                precoTotalEl.textContent = 'R$ 0,00';
            }
        });
    }

    const modalCriarLoteEl = document.getElementById('modalCriarLote');
    if (modalCriarLoteEl) {
        modalCriarLoteEl.addEventListener('hidden.bs.modal', function() {
            document.getElementById('formCriarLote')?.reset();
        });
    }

    const modalImportarPlanilhaEl = document.getElementById('modalImportarPlanilha');
    if (modalImportarPlanilhaEl) {
        modalImportarPlanilhaEl.addEventListener('hidden.bs.modal', function() {
            document.getElementById('formImportarPlanilha')?.reset();
        });
    }

}); // Fim do DOMContentLoaded
</script>

<!-- Bot√£o para voltar -->
<div style="margin-top: 30px;">
    <a href="/orcamentos/pendentes" class="btn btn-outline" style="text-decoration: none;">
        <i class="fas fa-arrow-left"></i>
        VOLTAR PARA A LISTA DE OR√áAMENTOS PENDENTES
    </a>
</div>

<!-- Modal 1: Adicionar Item -->
<div class="modal fade" id="modalAdicionarItem" tabindex="-1" aria-labelledby="modalAdicionarItemLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                <h5 class="modal-title" id="modalAdicionarItemLabel" style="font-weight: 700; text-transform: uppercase;">Adicionar Novo Item do Or√ßamento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form id="formAdicionarItem">
                    @csrf
                    <!-- Descri√ß√£o -->
                    <div class="mb-3">
                        <label for="item_descricao" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                            Descri√ß√£o<span style="color: #dc2626;">*</span>
                        </label>
                        <textarea
                            class="form-control"
                            id="item_descricao"
                            name="descricao"
                            rows="4"
                            placeholder="Descri√ß√£o do item"
                            required
                            style="font-size: 13px; resize: vertical;"
                        ></textarea>
                        <small class="form-text text-muted" style="font-size: 11px;">Apresentar a descri√ß√£o constante do termo de refer√™ncia ou do projeto b√°sico.</small>
                    </div>

                    <div class="row">
                        <!-- Medida de fornecimento -->
                        <div class="col-md-4 mb-3">
                            <label for="item_medida" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Medida de fornecimento<span style="color: #dc2626;">*</span>
                            </label>
                            <select
                                class="form-select"
                                id="item_medida"
                                name="medida_fornecimento"
                                required
                                style="font-size: 13px;"
                            >
                                <option value="">Selecione...</option>
                                <option value="Unidade">Unidade</option>
                                <option value="Caixa">Caixa</option>
                                <option value="Metro">Metro</option>
                                <option value="Litro">Litro</option>
                                <option value="Kg">Kg</option>
                            </select>
                        </div>

                        <!-- Quantidade -->
                        <div class="col-md-4 mb-3">
                            <label for="item_quantidade" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Quantidade<span style="color: #dc2626;">*</span>
                            </label>
                            <input
                                type="number"
                                class="form-control"
                                id="item_quantidade"
                                name="quantidade"
                                min="0.0001"
                                step="0.0001"
                                value="0"
                                required
                                style="font-size: 13px;"
                            >
                            <div style="margin-top: 6px;">
                                <label style="font-size: 11px; color: #6b7280;">
                                    <input type="radio" name="quantidade_tipo" value="inteiro" checked style="margin-right: 5px;">
                                    N¬∫ INTEIRO
                                </label>
                                <label style="font-size: 11px; color: #6b7280; margin-left: 15px;">
                                    <input type="radio" name="quantidade_tipo" value="fracionado" style="margin-right: 5px;">
                                    FRACIONADO
                                </label>
                            </div>
                        </div>

                        <!-- Pre√ßo Unit√°rio -->
                        <div class="col-md-4 mb-3">
                            <label for="item_preco_unitario" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Pre√ßo Unit√°rio (R$)
                            </label>
                            <input
                                type="number"
                                class="form-control"
                                id="item_preco_unitario"
                                name="preco_unitario"
                                min="0"
                                step="0.01"
                                placeholder="0,00"
                                style="font-size: 13px;"
                            >
                            <small class="form-text text-muted" style="font-size: 11px;">Opcional. Ser√° calculado o pre√ßo total automaticamente.</small>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Indica√ß√£o de marca -->
                        <div class="col-md-12 mb-3">
                            <label for="item_marca" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Indica√ß√£o de marca:
                            </label>
                            <input
                                type="text"
                                class="form-control"
                                id="item_marca"
                                name="indicacao_marca"
                                placeholder="Opcional"
                                style="font-size: 13px;"
                            >
                            <div style="margin-top: 6px;">
                                <label style="font-size: 11px; color: #6b7280;">
                                    <input type="radio" name="marca_referencia" value="referencia" checked style="margin-right: 5px;">
                                    DE REFER√äNCIA
                                </label>
                                <label style="font-size: 11px; color: #6b7280; margin-left: 10px;">
                                    <input type="radio" name="marca_referencia" value="vinculativa" style="margin-right: 5px;">
                                    VINCULATIVA
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Pre√ßo Total Calculado -->
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; padding: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px; font-weight: 600; color: #1e40af;">
                                        <i class="fas fa-calculator"></i> PRE√áO TOTAL:
                                    </span>
                                    <span id="preco_total_calculado" style="font-size: 16px; font-weight: 700; color: #1e40af;">
                                        R$ 0,00
                                    </span>
                                </div>
                                <small style="font-size: 11px; color: #6b7280; display: block; margin-top: 6px;">
                                    Calculado automaticamente: Quantidade √ó Pre√ßo Unit√°rio
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Este item √© um -->
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                            Este item √© um:<span style="color: #dc2626;">*</span>
                        </label>
                        <div style="display: flex; gap: 20px;">
                            <label style="cursor: pointer; font-size: 13px;">
                                <input type="radio" name="tipo_item" value="PRODUTO" required style="margin-right: 8px;">
                                PRODUTO
                            </label>
                            <label style="cursor: pointer; font-size: 13px;">
                                <input type="radio" name="tipo_item" value="SERVICO" checked style="margin-right: 8px;">
                                SERVI√áO
                            </label>
                        </div>
                    </div>

                    <!-- Alterar dados em CDFs -->
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                            Alterar dados do item em CDFs, Entes P√∫blicos e Sites de com√©rcio eletr√¥nico?<span style="color: #dc2626;">*</span>
                        </label>
                        <div style="display: flex; gap: 20px;">
                            <label style="cursor: pointer; font-size: 13px;">
                                <input type="radio" name="alterar_cdfs" value="SIM" required style="margin-right: 8px;">
                                SIM
                            </label>
                            <label style="cursor: pointer; font-size: 13px;">
                                <input type="radio" name="alterar_cdfs" value="NAO" checked style="margin-right: 8px;">
                                N√ÉO
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 24px; font-size: 13px; font-weight: 600;">
                    <i class="fas fa-times"></i> FECHAR
                </button>
                <button type="button" id="btnSalvarItem" class="btn btn-primary" style="padding: 10px 24px; font-size: 13px; font-weight: 600;">
                    <i class="fas fa-save"></i> SALVAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal 2: Criar Lote -->
<div class="modal fade" id="modalCriarLote" tabindex="-1" aria-labelledby="modalCriarLoteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                <h5 class="modal-title" id="modalCriarLoteLabel" style="font-weight: 700; text-transform: uppercase;">Criar Novo Lote</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form id="formCriarLote">
                    @csrf
                    <div class="row">
                        <!-- N√∫mero -->
                        <div class="col-md-6 mb-3">
                            <label for="lote_numero" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                N√∫mero<span style="color: #dc2626;">*</span>
                            </label>
                            <input
                                type="number"
                                class="form-control"
                                id="lote_numero"
                                name="numero"
                                min="1"
                                step="1"
                                placeholder="Digite apenas n√∫meros maiores que 1"
                                required
                                style="font-size: 13px;"
                            >
                            <small class="form-text text-muted" style="font-size: 11px;">Digite apenas n√∫meros maiores que 1</small>
                        </div>

                        <!-- Nome -->
                        <div class="col-md-6 mb-3">
                            <label for="lote_nome" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Nome<span style="color: #dc2626;">*</span>
                            </label>
                            <input
                                type="text"
                                class="form-control"
                                id="lote_nome"
                                name="nome"
                                maxlength="255"
                                placeholder="Titulo ou nome usado para identificar o conte√∫do do lote"
                                required
                                style="font-size: 13px;"
                            >
                            <small class="form-text text-muted" style="font-size: 11px;">Titulo ou nome usado para identificar o conte√∫do do lote</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 24px; font-size: 13px; font-weight: 600;">
                    <i class="fas fa-times"></i> FECHAR
                </button>
                <button type="button" id="btnSalvarLote" class="btn btn-primary" style="padding: 10px 24px; font-size: 13px; font-weight: 600;">
                    <i class="fas fa-save"></i> SALVAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal 3: Importar Planilha -->
<div class="modal fade" id="modalImportarPlanilha" tabindex="-1" aria-labelledby="modalImportarPlanilhaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                <h5 class="modal-title" id="modalImportarPlanilhaLabel" style="font-weight: 700; text-transform: uppercase;">Importar Planilha de Itens</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <!-- Mensagem informativa -->
                <div class="alert alert-info" style="background: #e0f2fe; border: 1px solid #7dd3fc; color: #0369a1; margin-bottom: 20px; padding: 15px; border-radius: 6px; font-size: 13px;">
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    <strong>ATEN√á√ÉO:</strong> O sistema s√≥ reconhece planilhas que estejam na formata√ß√£o padr√£o dispon√≠vel na p√°gina de Downloads de nosso site.
                    Para mais informa√ß√µes <a href="#" style="color: #0369a1; text-decoration: underline; font-weight: 600;">clique aqui</a>
                </div>

                <form id="formImportarPlanilha" enctype="multipart/form-data">
                    @csrf
                    <div class="mb-3">
                        <label for="arquivo_planilha" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                            Selecionar arquivo:
                        </label>
                        <div style="position: relative;">
                            <input
                                type="file"
                                class="form-control"
                                id="arquivo_planilha"
                                name="planilha"
                                accept=".xlsx,.xls,.csv"
                                required
                                style="font-size: 13px; padding: 10px;"
                            >
                            <button type="button" class="btn btn-outline-secondary" style="position: absolute; right: 0; top: 0; border-radius: 0 6px 6px 0; padding: 10px 20px; font-size: 13px; font-weight: 600;">
                                SELECIONAR ARQUIVO
                            </button>
                        </div>
                        <small class="form-text text-muted" style="font-size: 11px;">Selecione apenas arquivos do tipo excel (*.xls ou *.xlsx)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 24px; font-size: 13px; font-weight: 600;">
                    <i class="fas fa-times"></i> FECHAR
                </button>
                <button type="button" id="btnEnviarPlanilha" class="btn btn-primary" style="padding: 10px 24px; font-size: 13px; font-weight: 600;">
                    <i class="fas fa-upload"></i> ENVIAR
                </button>
            </div>
        </div>
    </div>
</div>

@include('orcamentos._modal-cotacao')

{{-- JavaScript do Modal de Cota√ß√£o --}}
<script>
    console.log('üìÑ [ELABORAR.BLADE.PHP] P√°gina carregada - Or√ßamento ID: {{ $orcamento->id }}');
    console.log('üì¶ [ELABORAR.BLADE.PHP] Total de itens: {{ $orcamento->itens->count() }}');
    console.log('[DEBUG] [ELABORAR.BLADE.PHP] Carregando modal-cotacao.js...');
</script>
<script src="{{ asset('js/modal-cotacao.js') }}?v={{ time() }}"></script>
<script>
    console.log('[OK] [ELABORAR.BLADE.PHP] modal-cotacao.js carregado!');
</script>

<!-- Modal: Detalhes da Fonte Consultada -->
<div class="modal fade" id="modalDetalhesFonte" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 900px;">
        <div class="modal-content">
            <div class="modal-header" style="background: #3b82f6; color: white; padding: 16px 24px;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 16px; text-transform: uppercase;">
                    DETALHES DA FONTE CONSULTADA
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <table class="table table-sm table-bordered" style="font-size: 12px;">
                    <tbody>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600; width: 180px;">FONTE:</td>
                            <td id="detalhe-fonte"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">IDENTIFICA√á√ÉO:</td>
                            <td id="detalhe-identificacao"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">N¬∫ DO PREG√ÉO:</td>
                            <td id="detalhe-pregao"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">N¬∫ DA ATA:</td>
                            <td id="detalhe-ata"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">DATA/HOMOLOGA√á√ÉO:</td>
                            <td id="detalhe-data-homologacao"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">√ìRG√ÉO:</td>
                            <td id="detalhe-orgao"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">OBJETO:</td>
                            <td id="detalhe-objeto" style="font-size: 11px;"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">LOTE/ITEM/SUBITEM:</td>
                            <td id="detalhe-lote"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">VENCEDOR:</td>
                            <td id="detalhe-vencedor"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">DESCRI√á√ÉO:</td>
                            <td id="detalhe-descricao" style="font-size: 11px;"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">MARCA:</td>
                            <td id="detalhe-marca"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">UNIDADE:</td>
                            <td id="detalhe-unidade"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">QUANTIDADE:</td>
                            <td id="detalhe-quantidade"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">VALOR UNIT√ÅRIO</td>
                            <td id="detalhe-valor-unitario" style="font-weight: 600; color: #0891b2;"></td>
                        </tr>
                    </tbody>
                </table>

                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <a id="btn-download-arp" href="#" target="_blank" class="btn" style="background: #3b82f6; color: white; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-download"></i> DOWNLOAD DA ARP
                    </a>
                    <button type="button" class="btn" data-bs-dismiss="modal" style="background: #9ca3af; color: white; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-times"></i> FECHAR
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Ajuste de Embalagem -->
<div class="modal fade" id="modalAjusteEmbalagem" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 900px;">
        <div class="modal-content">
            <div class="modal-header" style="background: #3b82f6; color: white; padding: 16px 24px;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 16px; text-transform: uppercase;">
                    AJUSTE DE EMBALAGEM
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <!-- Descri√ß√£o da Amostra -->
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 4px;">DESCRI√á√ÉO DA AMOSTRA:</label>
                    <div id="ajuste-descricao" style="font-size: 12px; color: #374151; padding: 8px; background: #f9fafb; border-radius: 4px;"></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Coluna Esquerda: Dados Originais -->
                    <div style="background: #e5e7eb; padding: 20px; border-radius: 6px;">
                        <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 16px; text-transform: uppercase;">Medida de Fornecimento Original</h6>

                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">MED. DE FORNECIMENTO:</label>
                            <input type="text" id="ajuste-original-unidade" class="form-control" readonly style="background: #f3f4f6; font-size: 13px;">
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">A EMBALAGEM √â:</label>
                            <select id="ajuste-original-embalagem" class="form-select" disabled style="background: #f3f4f6; font-size: 13px;">
                                <option value="primaria">PRIM√ÅRIA</option>
                                <option value="secundaria">SECUND√ÅRIA</option>
                            </select>
                        </div>

                        <div>
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">PRE√áO UNIT√ÅRIO ORIGINAL:</label>
                            <input type="text" id="ajuste-original-preco" class="form-control" readonly style="background: #f3f4f6; font-size: 13px; font-weight: 600;">
                        </div>
                    </div>

                    <!-- Coluna Direita: Dados Desejados -->
                    <div style="background: #dbeafe; padding: 20px; border-radius: 6px;">
                        <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 16px; text-transform: uppercase;">Medida de Fornecimento Desejada</h6>

                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">MEDIDA DESEJADA:</label>
                            <input type="text" id="ajuste-desejado-unidade" class="form-control" placeholder="Ex: UNIDADE, CAIXA, PACOTE" style="font-size: 13px;">
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">ESSA EMBALAGEM √â:</label>
                            <select id="ajuste-desejado-embalagem" class="form-select" style="font-size: 13px;">
                                <option value="primaria">PRIM√ÅRIA</option>
                                <option value="secundaria">SECUND√ÅRIA</option>
                            </select>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">FATOR DE MULTIPLICA√á√ÉO:</label>
                            <input type="number" id="ajuste-fator" class="form-control" placeholder="0,00" step="0.01" style="font-size: 13px;">
                        </div>

                        <div>
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">PRE√áO UNIT√ÅRIO AJUSTADO:</label>
                            <input type="text" id="ajuste-desejado-preco" class="form-control" readonly style="background: #f3f4f6; font-size: 13px; font-weight: 600; color: #0891b2;">
                        </div>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; margin-top: 24px;">
                    <button type="button" id="btn-concluir-ajuste" class="btn" style="background: #0891b2; color: white; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-check"></i> CONCLUIR
                    </button>
                    <button type="button" class="btn" data-bs-dismiss="modal" style="background: #9ca3af; color: white; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-times"></i> FECHAR
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal NOVO: An√°lise Cr√≠tica dos Dados Coletados (Bot√£o An√°lise) -->
<div class="modal fade" id="modalAnaliseCritica" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 1200px;">
        <div class="modal-content">
            <div class="modal-header" style="background: #0891b2; color: white; padding: 16px 24px;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 16px; text-transform: uppercase;">
                    AN√ÅLISE CR√çTICA DOS DADOS COLETADOS
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <!-- Item Pesquisado -->
                <div style="background: #f3f4f6; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
                    <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 4px; display: block;">ITEM PESQUISADO</label>
                    <div id="analise-item-descricao" style="font-size: 14px; font-weight: 600; color: #1f2937;">-</div>
                </div>

                <!-- Ju√≠zo Cr√≠tico -->
                <div style="margin-bottom: 24px;">
                    <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 12px;">JU√çZO CR√çTICO</h6>
                    <table class="table table-sm table-bordered" style="font-size: 12px;">
                        <thead style="background: #f3f4f6;">
                            <tr>
                                <th>N¬∫ DE AMOSTRAS COLETADAS</th>
                                <th>M√âDIA</th>
                                <th>DESVIO-PADR√ÉO</th>
                                <th>LIMITE INFERIOR</th>
                                <th>LIMITE SUPERIOR</th>
                                <th>CR√çTICAS</th>
                                <th>AMOSTRAS EXPURGADAS</th>
                            </tr>
                        </thead>
                        <tbody id="analise-juizo-critico-tbody">
                            <tr style="text-align: center;">
                                <td id="analise-juizo-num-amostras">0</td>
                                <td id="analise-juizo-media">R$ 0,00</td>
                                <td id="analise-juizo-desvio">0,00</td>
                                <td id="analise-juizo-limite-inf">R$ 0,00 (DP - m√©dia)</td>
                                <td id="analise-juizo-limite-sup">R$ 0,00 (DP + m√©dia)</td>
                                <td><span class="badge bg-danger" id="analise-juizo-criticas">0</span></td>
                                <td><span class="badge bg-secondary" id="analise-juizo-expurgadas">0</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- M√©todo Estat√≠stico -->
                <div style="margin-bottom: 24px;">
                    <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 12px;">M√âTODO ESTAT√çSTICO APLICADO √ÄS AMOSTRAS SANEADAS</h6>
                    <table class="table table-sm table-bordered" style="font-size: 12px;">
                        <thead style="background: #f3f4f6;">
                            <tr>
                                <th>N¬∫ DE AMOSTRAS V√ÅLIDAS</th>
                                <th>DESVIO-PADR√ÉO</th>
                                <th>COEFICIENTE DE VARIA√á√ÉO</th>
                                <th>MENOR PRE√áO</th>
                                <th>M√âDIA</th>
                                <th>MEDIANA</th>
                            </tr>
                        </thead>
                        <tbody id="analise-metodo-estatistico-tbody">
                            <tr style="text-align: center;">
                                <td id="analise-metodo-num-validas">0</td>
                                <td id="analise-metodo-desvio">0,00</td>
                                <td id="analise-metodo-coef-var">0,00%</td>
                                <td id="analise-metodo-menor">R$ 0,00</td>
                                <td id="analise-metodo-media">R$ 0,00</td>
                                <td id="analise-metodo-mediana">R$ 0,00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- S√©rie de Pre√ßos Coletados -->
                <div style="margin-bottom: 24px;">
                    <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 12px; text-transform: uppercase;">S√©rie de Pre√ßos Coletados</h6>

                    <!-- Mensagem quando n√£o tem amostras -->
                    <div id="analise-serie-vazia" style="font-size: 12px; color: #6b7280; padding: 12px; background: #f9fafb; border-radius: 4px;">
                        VOC√ä N√ÉO POSSUI AMOSTRAS DE PRE√áOS PARA ESTE ITEM
                    </div>

                    <!-- Tabela de amostras selecionadas -->
                    <div id="analise-serie-tabela" style="display: none;">
                        <div class="table-responsive-custom" style="max-height: 400px;">
                            <table class="table table-sm table-bordered" style="font-size: 11px; margin: 0;">
                                <thead class="sticky-header">
                                    <tr>
                                        <th style="width: 60px;">AMOSTRA</th>
                                        <th style="width: 100px;">SITUA√á√ÉO</th>
                                        <th style="min-width: 300px;">FONTE</th>
                                        <th style="width: 100px;">MARCA</th>
                                        <th style="width: 100px;">DATA</th>
                                        <th style="width: 80px;">MEDIDA</th>
                                        <th style="width: 100px; text-align: right;">QNT ORIGINAL</th>
                                        <th style="width: 120px; text-align: right;">VALOR UNIT√ÅRIO</th>
                                        <th style="width: 100px; text-align: center;">A√á√ïES</th>
                                    </tr>
                                </thead>
                                <tbody id="analise-serie-tbody">
                                    <!-- Ser√° preenchido via JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Bot√£o remover todas -->
                        <div style="text-align: right; margin-top: 12px;">
                            <button id="analise-btn-remover-todas-amostras" class="btn btn-sm" style="background: #dc2626; color: white; font-size: 11px; font-weight: 600;">
                                <i class="fas fa-times"></i> REMOVER TODAS AS AMOSTRAS
                            </button>
                        </div>
                    </div>
                </div>

                <!-- M√©todo Estat√≠stico Final -->
                <div style="margin-bottom: 24px;">
                    <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 12px;">M√âTODO ESTAT√çSTICO APLICADO √ÄS AMOSTRAS SANEADAS</h6>
                    <div style="background: #f3f4f6; padding: 16px; border-radius: 4px;">
                        <table style="width: 100%; font-size: 13px;">
                            <tr>
                                <td style="text-align: right; font-weight: 600; padding: 4px;">MEDIANA</td>
                                <td style="width: 150px; text-align: right; padding: 4px;" id="analise-final-mediana">R$ 0,00</td>
                            </tr>
                            <tr>
                                <td style="text-align: right; font-weight: 600; padding: 4px;">M√âDIA</td>
                                <td style="text-align: right; padding: 4px;" id="analise-final-media">R$ 0,00</td>
                            </tr>
                            <tr>
                                <td style="text-align: right; font-weight: 600; padding: 4px;">MENOR PRE√áO</td>
                                <td style="text-align: right; padding: 4px;" id="analise-final-menor">R$ 0,00</td>
                            </tr>
                            <tr style="border-top: 2px solid #0891b2;">
                                <td style="text-align: right; font-weight: 700; padding: 8px 4px; color: #0891b2;">MEDIDA DE TEND√äNCIA CENTRAL</td>
                                <td style="text-align: right; font-weight: 700; padding: 8px 4px; color: #0891b2; font-size: 16px;" id="analise-final-tendencia">R$ 0,00</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Cr√≠tica dos Dados -->
                <div>
                    <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 12px; text-transform: uppercase;">Cr√≠tica dos Dados</h6>
                    <button id="analise-btn-adicionar-justificativa" type="button" class="btn btn-outline-secondary btn-sm" onclick="abrirModalJustificativa()" style="font-size: 12px; font-weight: 600; margin-bottom: 12px;">
                        <i class="fas fa-pencil-alt"></i> ADICIONAR JUSTIFICATIVA OU OBSERVA√á√ÉO
                    </button>

                    <!-- Checkboxes de Cr√≠ticas -->
                    <div style="margin-top: 12px;">
                        <div style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="analise-critica-medidas-desiguais" style="width: 16px; height: 16px;">
                            <label for="analise-critica-medidas-desiguais" style="font-size: 12px; margin: 0; cursor: pointer;">
                                1. Existem amostras com medidas de fornecimentos desiguais.
                            </label>
                            <button class="btn btn-sm" style="padding: 2px 8px; background: #6b7280; color: white; font-size: 10px;">+</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="analise-critica-valores-discrepantes" style="width: 16px; height: 16px;">
                            <label for="analise-critica-valores-discrepantes" style="font-size: 12px; margin: 0; cursor: pointer;">
                                2. Existem amostras com valores muito discrepantes.
                            </label>
                            <button class="btn btn-sm" style="padding: 2px 8px; background: #6b7280; color: white; font-size: 10px;">+</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 13px; font-weight: 600;">
                    <i class="fas fa-times"></i> FECHAR
                </button>
            </div>
        </div>
    </div>
</div>

{{-- ========================================
     MODAL DE JUSTIFICATIVAS E OBSERVA√á√ïES
     Usado quando h√° menos de 3 amostras v√°lidas
     ======================================== --}}
<div class="modal fade" id="modalJustificativa" tabindex="-1" aria-labelledby="modalJustificativaLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border-radius: 8px; overflow: hidden;">

            {{-- Cabe√ßalho Azul --}}
            <div class="modal-header" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 18px 24px; border-bottom: none;">
                <h5 class="modal-title" id="modalJustificativaLabel" style="font-weight: 700; font-size: 16px; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="fas fa-file-alt" style="margin-right: 8px;"></i>
                    JUSTIFICATIVAS E OBSERVA√á√ïES
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            {{-- Corpo do Modal --}}
            <div class="modal-body" style="padding: 24px; background: #f9fafb;">

                <p style="font-size: 14px; color: #374151; margin-bottom: 20px; font-weight: 500;">
                    Marque uma ou mais op√ß√µes e preencha os campos correspondentes.
                </p>

                <form id="formJustificativa">

                    {{-- Op√ß√£o 1: SCP n√£o retornou nenhum resultado --}}
                    <div class="mb-4">
                        <div class="form-check" style="padding-left: 0;">
                            <input class="form-check-input" type="checkbox" id="justif_scp_sem_resultado" name="justificativas[]" value="scp_sem_resultado" style="width: 18px; height: 18px; margin-top: 2px;">
                            <label class="form-check-label" for="justif_scp_sem_resultado" style="margin-left: 28px; font-size: 13px; color: #374151; font-weight: 600; cursor: pointer;">
                                Ap√≥s a pesquisa de pre√ßos, em 09/10/2025, o SCP n√£o retornou nenhum resultado com as palavras-chave
                            </label>
                        </div>
                        <textarea
                            id="textarea_scp_sem_resultado"
                            class="form-control mt-2"
                            rows="2"
                            placeholder="Digite as palavras-chave utilizadas..."
                            style="font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; padding: 10px; display: none;"
                            disabled
                        ></textarea>
                    </div>

                    {{-- Op√ß√£o 2: SCP retornou menos de 3 amostras --}}
                    <div class="mb-4">
                        <div class="form-check" style="padding-left: 0;">
                            <input class="form-check-input" type="checkbox" id="justif_scp_poucas_amostras" name="justificativas[]" value="scp_poucas_amostras" style="width: 18px; height: 18px; margin-top: 2px;">
                            <label class="form-check-label" for="justif_scp_poucas_amostras" style="margin-left: 28px; font-size: 13px; color: #374151; font-weight: 600; cursor: pointer;">
                                O SCP n√£o retornou tr√™s ou mais amostras. Utilizei as palavras-chave
                            </label>
                        </div>
                        <textarea
                            id="textarea_scp_poucas_amostras"
                            class="form-control mt-2"
                            rows="2"
                            placeholder="Digite as palavras-chave utilizadas..."
                            style="font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; padding: 10px; display: none;"
                            disabled
                        ></textarea>
                    </div>

                    {{-- Op√ß√£o 3: Expedi pedido de proposta --}}
                    <div class="mb-4">
                        <div class="form-check" style="padding-left: 0;">
                            <input class="form-check-input" type="checkbox" id="justif_expedi_pedido" name="justificativas[]" value="expedi_pedido" style="width: 18px; height: 18px; margin-top: 2px;">
                            <label class="form-check-label" for="justif_expedi_pedido" style="margin-left: 28px; font-size: 13px; color: #374151; font-weight: 600; cursor: pointer;">
                                Expedi o(s) pedido(s) de proposta(s) n¬∫
                            </label>
                        </div>
                        <div class="row mt-2" id="container_expedi_pedido" style="display: none;">
                            <div class="col-md-6">
                                <input
                                    type="text"
                                    id="input_numero_pedido"
                                    class="form-control"
                                    placeholder="N√∫mero(s) do(s) pedido(s)"
                                    style="font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; padding: 10px;"
                                    disabled
                                />
                            </div>
                            <div class="col-md-12 mt-2">
                                <textarea
                                    id="textarea_expedi_pedido"
                                    class="form-control"
                                    rows="2"
                                    placeholder="e, mesmo ap√≥s o prazo de resposta, n√£o foi poss√≠vel conseguir tr√™s ou mais amostras."
                                    style="font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; padding: 10px;"
                                    disabled
                                ></textarea>
                            </div>
                        </div>
                    </div>

                    {{-- Op√ß√£o 4: Justificativa livre --}}
                    <div class="mb-4">
                        <div class="form-check" style="padding-left: 0;">
                            <input class="form-check-input" type="checkbox" id="justif_livre" name="justificativas[]" value="justificativa_livre" style="width: 18px; height: 18px; margin-top: 2px;">
                            <label class="form-check-label" for="justif_livre" style="margin-left: 28px; font-size: 13px; color: #374151; font-weight: 600; cursor: pointer;">
                                Justificativa livre:
                            </label>
                        </div>
                        <textarea
                            id="textarea_justif_livre"
                            class="form-control mt-2"
                            rows="4"
                            placeholder="Digite sua justificativa..."
                            style="font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; padding: 10px; display: none;"
                            disabled
                        ></textarea>
                    </div>

                </form>

            </div>

            {{-- Rodap√© --}}
            <div class="modal-footer" style="background: #f3f4f6; padding: 14px 24px; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 13px; font-weight: 600; padding: 9px 20px;">
                    <i class="fas fa-times-circle"></i> FECHAR
                </button>
                <button type="button" class="btn btn-primary" id="btnEnviarJustificativa" style="font-size: 13px; font-weight: 600; padding: 9px 20px; background: #3b82f6; border: none;">
                    <i class="fas fa-check-circle"></i> ENVIAR JUSTIFICATIVA
                </button>
            </div>

        </div>
    </div>
</div>

<script>
// ========================================
// MODAL DE JUSTIFICATIVAS E OBSERVA√á√ïES
// ========================================

// Habilitar/desabilitar campos conforme checkboxes
document.getElementById('justif_scp_sem_resultado') && document.getElementById('justif_scp_sem_resultado').addEventListener('change', function() {
    const textarea = document.getElementById('textarea_scp_sem_resultado');
    if (this.checked) {
        textarea.style.display = 'block';
        textarea.disabled = false;
    } else {
        textarea.style.display = 'none';
        textarea.disabled = true;
        textarea.value = '';
    }
});

document.getElementById('justif_scp_poucas_amostras') && document.getElementById('justif_scp_poucas_amostras').addEventListener('change', function() {
    const textarea = document.getElementById('textarea_scp_poucas_amostras');
    if (this.checked) {
        textarea.style.display = 'block';
        textarea.disabled = false;
    } else {
        textarea.style.display = 'none';
        textarea.disabled = true;
        textarea.value = '';
    }
});

document.getElementById('justif_expedi_pedido') && document.getElementById('justif_expedi_pedido').addEventListener('change', function() {
    const container = document.getElementById('container_expedi_pedido');
    const input = document.getElementById('input_numero_pedido');
    const textarea = document.getElementById('textarea_expedi_pedido');

    if (this.checked) {
        container.style.display = 'block';
        input.disabled = false;
        textarea.disabled = false;
    } else {
        container.style.display = 'none';
        input.disabled = true;
        textarea.disabled = true;
        input.value = '';
        textarea.value = '';
    }
});

document.getElementById('justif_livre') && document.getElementById('justif_livre').addEventListener('change', function() {
    const textarea = document.getElementById('textarea_justif_livre');
    if (this.checked) {
        textarea.style.display = 'block';
        textarea.disabled = false;
    } else {
        textarea.style.display = 'none';
        textarea.disabled = true;
        textarea.value = '';
    }
});

// Fun√ß√£o para abrir o modal de justificativa
function abrirModalJustificativa() {
    const modal = new bootstrap.Modal(document.getElementById('modalJustificativa'));
    modal.show();
}

// Bot√£o "Enviar Justificativa"
document.getElementById('btnEnviarJustificativa') && document.getElementById('btnEnviarJustificativa').addEventListener('click', function() {
    const checkboxes = document.querySelectorAll('#formJustificativa input[type="checkbox"]:checked');

    if (checkboxes.length === 0) {
        alert('[AVISO] Selecione ao menos uma op√ß√£o antes de enviar.');
        return;
    }

    // Coletar dados do formul√°rio
    const justificativas = [];

    if (document.getElementById('justif_scp_sem_resultado').checked) {
        const texto = document.getElementById('textarea_scp_sem_resultado').value.trim();
        if (!texto) {
            alert('[AVISO] Preencha as palavras-chave para a op√ß√£o "SCP n√£o retornou nenhum resultado".');
            return;
        }
        justificativas.push({
            tipo: 'scp_sem_resultado',
            texto: `Ap√≥s a pesquisa de pre√ßos, em ${new Date().toLocaleDateString('pt-BR')}, o SCP n√£o retornou nenhum resultado com as palavras-chave: ${texto}`
        });
    }

    if (document.getElementById('justif_scp_poucas_amostras').checked) {
        const texto = document.getElementById('textarea_scp_poucas_amostras').value.trim();
        if (!texto) {
            alert('[AVISO] Preencha as palavras-chave para a op√ß√£o "SCP retornou menos de 3 amostras".');
            return;
        }
        justificativas.push({
            tipo: 'scp_poucas_amostras',
            texto: `O SCP n√£o retornou tr√™s ou mais amostras. Utilizei as palavras-chave: ${texto}`
        });
    }

    if (document.getElementById('justif_expedi_pedido').checked) {
        const numero = document.getElementById('input_numero_pedido').value.trim();
        const observacao = document.getElementById('textarea_expedi_pedido').value.trim();

        if (!numero) {
            alert('[AVISO] Preencha o n√∫mero do pedido para a op√ß√£o "Expedi pedido de proposta".');
            return;
        }

        let textoCompleto = `Expedi o(s) pedido(s) de proposta(s) n¬∫ ${numero}`;
        if (observacao) {
            textoCompleto += `, ${observacao}`;
        } else {
            textoCompleto += `, e mesmo ap√≥s o prazo de resposta, n√£o foi poss√≠vel conseguir tr√™s ou mais amostras.`;
        }

        justificativas.push({
            tipo: 'expedi_pedido',
            numero_pedido: numero,
            texto: textoCompleto
        });
    }

    if (document.getElementById('justif_livre').checked) {
        const texto = document.getElementById('textarea_justif_livre').value.trim();
        if (!texto) {
            alert('[AVISO] Preencha a justificativa livre.');
            return;
        }
        justificativas.push({
            tipo: 'justificativa_livre',
            texto: texto
        });
    }

    console.log('[DADOS] Justificativas coletadas:', justificativas);

    // Montar texto final para exibir no modal de an√°lise cr√≠tica
    const textoFinal = justificativas.map(j => j.texto).join('\n\n');

    // Substituir a mensagem de alerta no modal de an√°lise cr√≠tica
    const alertCriticaDados = document.querySelector('.alert-info');
    if (alertCriticaDados) {
        alertCriticaDados.innerHTML = `
            <i class="fas fa-check-circle" style="color: #10b981;"></i>
            <strong>JUSTIFICATIVA ADICIONADA:</strong>
            <br><br>
            <div style="white-space: pre-wrap; font-size: 12px; line-height: 1.6; color: #1f2937;">
                ${textoFinal}
            </div>
        `;
        alertCriticaDados.style.background = '#d1fae5';
        alertCriticaDados.style.border = '1px solid #10b981';
        alertCriticaDados.style.color = '#065f46';
    }

    // TODO: Enviar para backend via AJAX
    // fetch('/orcamentos/item/justificativa', {
    //     method: 'POST',
    //     headers: {
    //         'Content-Type': 'application/json',
    //         'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
    //     },
    //     body: JSON.stringify({
    //         orcamento_id: {{ $orcamento->id }},
    //         item_id: window.currentItemId,
    //         justificativas: justificativas
    //     })
    // });

    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalJustificativa'));
    modal.hide();

    // Limpar formul√°rio
    document.getElementById('formJustificativa').reset();
    document.querySelectorAll('#formJustificativa textarea, #formJustificativa input[type="text"]').forEach(el => {
        el.style.display = 'none';
        el.disabled = true;
    });
    document.getElementById('container_expedi_pedido').style.display = 'none';

    alert('[OK] Justificativa adicionada com sucesso!');
});

</script>

<!-- Modal 4: S√≠tio de Com√©rcio Eletr√¥nico (Wizard 4 etapas) -->
<div class="modal fade" id="modalSitioEcommerce" tabindex="-1" aria-labelledby="modalSitioEcommerceLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 20px 24px;">
                <h5 class="modal-title" id="modalSitioEcommerceLabel" style="font-weight: 700; text-transform: uppercase; font-size: 16px;">
                    <i class="fas fa-shopping-cart"></i> S√çTIO DE COM√âRCIO ELETR√îNICO <span style="background: #10b981; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 8px;">‚úì VERS√ÉO 18:15 - TODAS URLs CORRIGIDAS</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Stepper (indicador de passos) -->
            <div style="background: #f9fafb; padding: 20px 24px; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; position: relative;">
                    <!-- Linha de conex√£o -->
                    <div style="position: absolute; top: 20px; left: 40px; right: 40px; height: 2px; background: #e5e7eb; z-index: 0;"></div>
                    <div id="progress-line" style="position: absolute; top: 20px; left: 40px; height: 2px; background: #3b82f6; z-index: 0; width: 0%; transition: width 0.3s;"></div>

                    <!-- Step 1 -->
                    <div class="wizard-step active" data-step="1" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 700; font-size: 14px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
                            1
                        </div>
                        <div class="step-label" style="font-size: 11px; font-weight: 600; color: #3b82f6; text-transform: uppercase;">
                            DADOS DO S√çTIO CONSULTADO
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div class="wizard-step" data-step="2" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 700; font-size: 14px;">
                            2
                        </div>
                        <div class="step-label" style="font-size: 11px; font-weight: 600; color: #9ca3af; text-transform: uppercase;">
                            DADOS DA CONSULTA
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div class="wizard-step" data-step="3" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 700; font-size: 14px;">
                            3
                        </div>
                        <div class="step-label" style="font-size: 11px; font-weight: 600; color: #9ca3af; text-transform: uppercase;">
                            COLETA DE AMOSTRAS
                        </div>
                    </div>

                    <!-- Step 4 -->
                    <div class="wizard-step" data-step="4" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 700; font-size: 14px;">
                            4
                        </div>
                        <div class="step-label" style="font-size: 11px; font-weight: 600; color: #9ca3af; text-transform: uppercase;">
                            ANEXAR "PRINT" DA TELA DA CONSULTA
                        </div>
                    </div>
                </div>
            </div>

            <!-- Body do Modal com Form -->
            <form id="formSitioEcommerce" enctype="multipart/form-data">
                @csrf
                <input type="hidden" name="orcamento_id" value="{{ $orcamento->id }}">

                <div class="modal-body" style="padding: 30px 24px; min-height: 400px;">

                    <!-- ETAPA 1: DADOS DA CONTRATA√á√ÉO -->
                    <div class="wizard-content" id="step-1" style="display: block;">
                        <h6 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 20px; text-transform: uppercase;">
                            <span style="background: #dbeafe; padding: 4px 12px; border-radius: 4px;">1</span>
                            DADOS DA CONTRATA√á√ÉO
                        </h6>
                        <div style="font-size: 13px; color: #dc2626; margin-bottom: 20px; font-weight: 600;">
                            * Itens de preenchimento obrigat√≥rio
                        </div>

                        <!-- Nome do site -->
                        <div class="mb-4">
                            <label class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Nome do site*
                            </label>
                            <input
                                type="text"
                                class="form-control"
                                name="nome_site"
                                placeholder="Ex.: Magazine Luiza, Amazon, Kalunga"
                                required
                                style="font-size: 13px; padding: 10px;"
                            >
                        </div>

                        <!-- Endere√ßo eletr√¥nico -->
                        <div class="mb-4">
                            <label class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Endere√ßo eletr√¥nico (URL)*
                            </label>
                            <input
                                type="url"
                                class="form-control"
                                name="url_site"
                                placeholder="https://"
                                required
                                style="font-size: 13px; padding: 10px;"
                            >
                            <small class="form-text text-muted" style="font-size: 11px;">
                                Cole o link direto da p√°gina onde encontrou o produto
                            </small>
                        </div>

                        <!-- Site de intermedia√ß√£o -->
                        <div class="mb-4">
                            <label class="form-label d-block" style="font-weight: 600; color: #374151; font-size: 13px; margin-bottom: 12px;">
                                O s√≠tio eletr√¥nico se dedica √† intermedia√ß√£o de vendas de bens (marketplace, OLX, eBay, etc.)?*
                            </label>
                            <div style="display: flex; gap: 15px;">
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="eh_intermediacao" value="1" required style="cursor: pointer;">
                                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border: 2px solid #10b981; border-radius: 8px; background: #d1fae5; color: #065f46; font-weight: 600; font-size: 12px;">
                                        <i class="fas fa-check-circle" style="font-size: 18px;"></i>
                                        SIM
                                    </div>
                                </label>
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="eh_intermediacao" value="0" required style="cursor: pointer;">
                                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border: 2px solid #ef4444; border-radius: 8px; background: #fee2e2; color: #991b1b; font-weight: 600; font-size: 12px;">
                                        <i class="fas fa-times-circle" style="font-size: 18px;"></i>
                                        N√ÉO
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- ETAPA 2: DADOS DA CONSULTA -->
                    <div class="wizard-content" id="step-2" style="display: none;">
                        <h6 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 20px; text-transform: uppercase;">
                            <span style="background: #dbeafe; padding: 4px 12px; border-radius: 4px;">2</span>
                            DADOS DA CONSULTA
                        </h6>

                        <!-- Data da consulta -->
                        <div class="mb-4">
                            <label class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Data da consulta*
                            </label>
                            <input
                                type="date"
                                class="form-control"
                                name="data_consulta"
                                required
                                style="font-size: 13px; padding: 10px;"
                            >
                        </div>

                        <!-- Hora da consulta -->
                        <div class="mb-4">
                            <label class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Hora da consulta*
                            </label>
                            <input
                                type="time"
                                class="form-control"
                                name="hora_consulta"
                                required
                                style="font-size: 13px; padding: 10px;"
                            >
                        </div>

                        <!-- Pre√ßo inclui frete -->
                        <div class="mb-4">
                            <label class="form-label d-block" style="font-weight: 600; color: #374151; font-size: 13px; margin-bottom: 12px;">
                                Pre√ßo inclui frete?*
                            </label>
                            <div style="display: flex; gap: 15px;">
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="inclui_frete" value="1" required style="cursor: pointer;">
                                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border: 2px solid #10b981; border-radius: 8px; background: #d1fae5; color: #065f46; font-weight: 600; font-size: 12px;">
                                        <i class="fas fa-check-circle" style="font-size: 18px;"></i>
                                        SIM
                                    </div>
                                </label>
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="inclui_frete" value="0" required style="cursor: pointer;">
                                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border: 2px solid #ef4444; border-radius: 8px; background: #fee2e2; color: #991b1b; font-weight: 600; font-size: 12px;">
                                        <i class="fas fa-times-circle" style="font-size: 18px;"></i>
                                        N√ÉO
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- ETAPA 3: COLETA DE AMOSTRAS -->
                    <div class="wizard-content" id="step-3" style="display: none;">
                        <h6 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 20px; text-transform: uppercase;">
                            <span style="background: #dbeafe; padding: 4px 12px; border-radius: 4px;">3</span>
                            COLETA DE AMOSTRAS
                        </h6>
                        <div style="font-size: 13px; color: #374151; margin-bottom: 20px; font-weight: 500;">
                            Selecione os itens do or√ßamento e informe os pre√ßos encontrados no site consultado.
                        </div>

                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <table class="table table-sm" style="margin-bottom: 0; font-size: 12px;">
                                <thead style="background: #f9fafb; position: sticky; top: 0; z-index: 10;">
                                    <tr>
                                        <th style="width: 40px; padding: 12px 8px;"></th>
                                        <th style="padding: 12px; font-weight: 700; color: #374151;">LOTE/ITEM</th>
                                        <th style="padding: 12px; font-weight: 700; color: #374151;">DESCRI√á√ÉO</th>
                                        <th style="padding: 12px; font-weight: 700; color: #374151; width: 120px;">UNIDADE</th>
                                        <th style="padding: 12px; font-weight: 700; color: #374151; width: 80px;">QNT</th>
                                        <th style="padding: 12px; font-weight: 700; color: #374151; width: 140px;">PRE√áO UNIT√ÅRIO</th>
                                        <th style="padding: 12px; font-weight: 700; color: #374151; width: 140px;">PRE√áO TOTAL</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-itens-coleta">
                                    @foreach($orcamento->itens as $item)
                                    <tr>
                                        <td style="padding: 10px 8px; text-align: center;">
                                            <input
                                                type="checkbox"
                                                name="itens_selecionados[]"
                                                value="{{ $item->id }}"
                                                class="form-check-input item-checkbox"
                                                style="cursor: pointer;"
                                                data-item-id="{{ $item->id }}"
                                                {{ $item->preco_unitario ? 'checked data-cotacao-preenchida="true"' : '' }}
                                            >
                                        </td>
                                        <td style="padding: 10px; color: #6b7280;">
                                            {{ $item->lote_id ? 'Lote ' . $item->lote->numero : 'Item' }}
                                        </td>
                                        <td style="padding: 10px; color: #111827; font-weight: 500;">
                                            {{ $item->descricao }}
                                        </td>
                                        <td style="padding: 10px; color: #6b7280;">
                                            {{ $item->medida_fornecimento }}
                                        </td>
                                        <td style="padding: 10px; color: #6b7280; text-align: right;">
                                            {{ number_format($item->quantidade, 2, ',', '.') }}
                                        </td>
                                        <td style="padding: 10px;">
                                            <!-- [DEBUG BLADE] Item #{{ $item->id }} | Preco={{ $item->preco_unitario ?? 'NULL' }} | IsNull={{ is_null($item->preco_unitario) ? 'YES' : 'NO' }} -->
                                            @if($item->preco_unitario)
                                            <div style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-bottom: 4px; font-weight: bold;">
                                                [OK] BLADE: Preco = R$ {{ $item->preco_unitario }}
                                            </div>
                                            @else
                                            <div style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-bottom: 4px; font-weight: bold;">
                                                [ERRO] BLADE: SEM PRECO
                                            </div>
                                            @endif
                                            <input
                                                type="number"
                                                name="preco_unitario[{{ $item->id }}]"
                                                class="form-control form-control-sm preco-input"
                                                placeholder="R$ 0,00"
                                                step="0.01"
                                                min="0"
                                                value="{{ $item->preco_unitario ?? '' }}"
                                                data-item-id="{{ $item->id }}"
                                                data-quantidade="{{ $item->quantidade }}"
                                                data-preco-debug="{{ $item->preco_unitario ?? 'NULL' }}"
                                                data-preco-blade-rendered="{{ $item->preco_unitario ?? 'BLADE_NULL' }}"
                                                style="font-size: 12px; padding: 6px 10px; {{ $item->preco_unitario ? 'border: 3px solid #10b981 !important;' : '' }}"
                                            >
                                        </td>
                                        <td style="padding: 10px; color: #059669; font-weight: 600; text-align: right;">
                                            <span class="preco-total" data-item-id="{{ $item->id }}">
                                                @if($item->preco_unitario)
                                                    R$ {{ number_format($item->preco_unitario * $item->quantidade, 2, ',', '.') }}
                                                @else
                                                    R$ 0,00
                                                @endif
                                            </span>
                                        </td>
                                    </tr>
                                    @endforeach
                                </tbody>
                            </table>
                        </div>

                        <div style="margin-top: 15px; padding: 12px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; font-size: 12px; color: #92400e;">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                            <strong>Aten√ß√£o:</strong> Selecione o checkbox do item para poder informar o pre√ßo.
                        </div>
                    </div>

                    <!-- ETAPA 4: ANEXAR PRINT -->
                    <div class="wizard-content" id="step-4" style="display: none;">
                        <h6 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 20px; text-transform: uppercase;">
                            <span style="background: #dbeafe; padding: 4px 12px; border-radius: 4px;">4</span>
                            ANEXAR "PRINT" DA TELA DA CONSULTA
                        </h6>
                        <div style="font-size: 13px; color: #374151; margin-bottom: 25px;">
                            Fa√ßa upload do arquivo do print da tela da consulta, se for imagem.
                        </div>

                        <div style="border: 2px dashed #d1d5db; border-radius: 12px; padding: 40px; text-align: center; background: #f9fafb; margin-bottom: 25px;">
                            <div style="margin-bottom: 20px;">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #9ca3af;"></i>
                            </div>
                            <input
                                type="file"
                                id="arquivo_print"
                                name="arquivo_print"
                                accept=".pdf,.png,.jpg,.jpeg"
                                style="display: none;"
                            >
                            <button
                                type="button"
                                id="btn-selecionar-arquivo"
                                class="btn btn-primary"
                                style="padding: 12px 32px; font-size: 13px; font-weight: 600;"
                            >
                                <i class="fas fa-folder-open"></i> SELECIONAR ARQUIVO
                            </button>
                            <div id="nome-arquivo" style="margin-top: 15px; font-size: 13px; color: #059669; font-weight: 600;"></div>
                        </div>

                        <div style="background: #f0f9ff; border: 1px solid #7dd3fc; border-radius: 8px; padding: 20px;">
                            <h6 style="font-size: 13px; font-weight: 700; color: #0369a1; margin-bottom: 12px;">
                                <i class="fas fa-info-circle"></i> ORIENTA√á√ïES PARA UPLOAD:
                            </h6>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #0c4a6e; line-height: 1.8;">
                                <li>Tamanho m√°ximo do arquivo: <strong>2GB</strong></li>
                                <li>Orienta√ß√£o da imagem: <strong>RETRATO</strong> (preferencial)</li>
                                <li>Formato do arquivo: <strong>*.pdf, *.png, *.jpg, *.jpeg</strong></li>
                            </ul>
                        </div>
                    </div>

                </div>

                <!-- Footer com bot√µes de navega√ß√£o -->
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between;">
                    <button
                        type="button"
                        id="btn-anterior"
                        class="btn btn-secondary"
                        style="padding: 10px 24px; font-size: 13px; font-weight: 600; display: none;"
                    >
                        <i class="fas fa-chevron-left"></i> ANTERIOR
                    </button>
                    <div style="flex: 1;"></div>
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                        style="padding: 10px 24px; font-size: 13px; font-weight: 600; margin-right: 10px;"
                    >
                        CANCELAR
                    </button>
                    <button
                        type="button"
                        id="btn-proximo"
                        class="btn btn-primary"
                        style="padding: 10px 24px; font-size: 13px; font-weight: 600;"
                    >
                        PR√ìXIMO <i class="fas fa-chevron-right"></i>
                    </button>
                    <button
                        type="submit"
                        id="btn-concluir"
                        class="btn btn-success"
                        style="padding: 10px 24px; font-size: 13px; font-weight: 600; display: none;"
                    >
                        <i class="fas fa-heart"></i> CONCLUIR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ===== MODAL S√çTIO DE COM√âRCIO ELETR√îNICO =====
(function() {
    let currentStep = 1;
    const totalSteps = 4;
    const modal = document.getElementById('modalSitioEcommerce');
    const form = document.getElementById('formSitioEcommerce');
    const btnAbrir = document.getElementById('btn-incluir-sitio-ecommerce');
    const btnAnterior = document.getElementById('btn-anterior');
    const btnProximo = document.getElementById('btn-proximo');
    const btnConcluir = document.getElementById('btn-concluir');
    const btnSelecionarArquivo = document.getElementById('btn-selecionar-arquivo');
    const inputArquivo = document.getElementById('arquivo_print');

    // IMPORTANTE: Remover atributo required do input de arquivo para evitar erro
    if (inputArquivo) {
        inputArquivo.removeAttribute('required');
    }

    // Abrir modal
    if (btnAbrir) {
        btnAbrir.addEventListener('click', function() {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            resetWizard();

            // Garantir que required foi removido
            if (inputArquivo) {
                inputArquivo.removeAttribute('required');
            }
        });
    }

    // Navega√ß√£o entre etapas
    if (btnProximo) {
        btnProximo.addEventListener('click', function() {
            if (validateCurrentStep()) {
                goToStep(currentStep + 1);
            }
        });
    }

    if (btnAnterior) {
        btnAnterior.addEventListener('click', function() {
            goToStep(currentStep - 1);
        });
    }

    // Upload de arquivo
    if (btnSelecionarArquivo) {
        btnSelecionarArquivo.addEventListener('click', function() {
            inputArquivo.click();
        });
    }

    if (inputArquivo) {
        inputArquivo.addEventListener('change', function() {
            const nomeArquivo = document.getElementById('nome-arquivo');
            if (this.files.length > 0) {
                nomeArquivo.textContent = `‚úì Arquivo selecionado: ${this.files[0].name}`;
            } else {
                nomeArquivo.textContent = '';
            }
        });
    }

    // Habilitar/desabilitar campos de pre√ßo ao marcar checkbox
    document.querySelectorAll('.item-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const itemId = this.getAttribute('data-item-id');
            const precoInput = document.querySelector(`.preco-input[data-item-id="${itemId}"]`);

            if (precoInput) {
                // HABILITAR campo quando marcado
                if (this.checked) {
                    precoInput.disabled = false;
                    console.log(`[OK] Checkbox marcado - campo habilitado (Item #${itemId})`);
                }
                // DESABILITAR campo quando DESMARCADO
                else {
                    // PROTECAO: Se tem flag de cota√ß√£o preenchida, N√ÉO permitir desmarcar!
                    const temCotacao = this.getAttribute('data-cotacao-preenchida') === 'true';
                    const valorAtual = parseFloat(precoInput.value) || 0;

                    if (temCotacao || valorAtual > 0) {
                        console.log(`[BLOQUEADO] IMPEDINDO desmarcacao: cotacao preenchida (Item #${itemId}, valor: ${valorAtual})`);
                        // FOR√áAR checkbox a permanecer marcado!
                        this.checked = true;
                        precoInput.disabled = false;
                        return; // Sair sem processar
                    }

                    // Se n√£o tem cota√ß√£o e n√£o tem valor, pode desabilitar e limpar
                    precoInput.disabled = true;
                    precoInput.value = '';
                    atualizarPrecoTotal(itemId, 0);
                    console.log(`[LIMPAR] Checkbox desmarcado e sem cotacao - limpando (Item #${itemId})`);
                }
            }
        });
    });

    // Calcular pre√ßo total ao digitar pre√ßo unit√°rio
    document.querySelectorAll('.preco-input').forEach(input => {
        input.addEventListener('input', function() {
            const itemId = this.getAttribute('data-item-id');
            const quantidade = parseFloat(this.getAttribute('data-quantidade'));
            const precoUnitario = parseFloat(this.value) || 0;
            const precoTotal = quantidade * precoUnitario;
            atualizarPrecoTotal(itemId, precoTotal);
        });
    });

    function atualizarPrecoTotal(itemId, valor) {
        const span = document.querySelector(`.preco-total[data-item-id="${itemId}"]`);
        if (span) {
            span.textContent = `R$ ${valor.toFixed(2).replace('.', ',')}`;
        }
    }

    function goToStep(step) {
        if (step < 1 || step > totalSteps) return;

        // Esconder todas as etapas
        document.querySelectorAll('.wizard-content').forEach(content => {
            content.style.display = 'none';
        });

        // Mostrar etapa atual
        document.getElementById(`step-${step}`).style.display = 'block';

        // Atualizar indicadores visuais
        updateStepIndicators(step);

        // Atualizar bot√µes
        btnAnterior.style.display = step === 1 ? 'none' : 'inline-block';
        btnProximo.style.display = step === totalSteps ? 'none' : 'inline-block';
        btnConcluir.style.display = step === totalSteps ? 'inline-block' : 'none';

        currentStep = step;
    }

    function updateStepIndicators(step) {
        document.querySelectorAll('.wizard-step').forEach((stepEl, index) => {
            const stepNumber = index + 1;
            const circle = stepEl.querySelector('.step-circle');
            const label = stepEl.querySelector('.step-label');

            if (stepNumber < step) {
                // Passos conclu√≠dos
                circle.style.background = '#10b981';
                circle.style.color = 'white';
                label.style.color = '#10b981';
                stepEl.classList.remove('active');
            } else if (stepNumber === step) {
                // Passo atual
                circle.style.background = '#3b82f6';
                circle.style.color = 'white';
                circle.style.boxShadow = '0 2px 8px rgba(59, 130, 246, 0.3)';
                label.style.color = '#3b82f6';
                stepEl.classList.add('active');
            } else {
                // Passos futuros
                circle.style.background = '#e5e7eb';
                circle.style.color = '#9ca3af';
                circle.style.boxShadow = 'none';
                label.style.color = '#9ca3af';
                stepEl.classList.remove('active');
            }
        });

        // Atualizar linha de progresso
        const progress = ((step - 1) / (totalSteps - 1)) * 100;
        document.getElementById('progress-line').style.width = `${progress}%`;
    }

    function validateCurrentStep() {
        const stepElement = document.getElementById(`step-${currentStep}`);
        const inputs = stepElement.querySelectorAll('input[required], select[required], textarea[required]');

        for (let input of inputs) {
            if (!input.value || (input.type === 'radio' && !stepElement.querySelector(`input[name="${input.name}"]:checked`))) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                input.focus();
                return false;
            }
        }

        // Valida√ß√£o espec√≠fica da etapa 3: pelo menos 1 item selecionado
        if (currentStep === 3) {
            const checkboxes = stepElement.querySelectorAll('.item-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Por favor, selecione pelo menos um item para coletar o pre√ßo.');
                return false;
            }

            // Validar se todos os itens selecionados t√™m pre√ßo informado
            for (let checkbox of checkboxes) {
                const itemId = checkbox.getAttribute('data-item-id');
                const precoInput = document.querySelector(`.preco-input[data-item-id="${itemId}"]`);
                if (!precoInput.value || parseFloat(precoInput.value) <= 0) {
                    alert('Por favor, informe o pre√ßo unit√°rio de todos os itens selecionados.');
                    precoInput.focus();
                    return false;
                }
            }
        }

        // Valida√ß√£o espec√≠fica da etapa 4: arquivo obrigat√≥rio
        if (currentStep === 4) {
            const arquivoInput = document.getElementById('arquivo_print');
            if (!arquivoInput.files || arquivoInput.files.length === 0) {
                alert('Por favor, selecione um arquivo (print da p√°gina consultada).');
                return false;
            }
        }

        return true;
    }

    function resetWizard() {
        currentStep = 1;
        form.reset();
        goToStep(1);

        // Limpar sele√ß√µes e desabilitar inputs de pre√ßo
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        document.querySelectorAll('.preco-input').forEach(input => {
            input.disabled = true;
            input.value = '';
        });
        document.querySelectorAll('.preco-total').forEach(span => {
            span.textContent = 'R$ 0,00';
        });
        document.getElementById('nome-arquivo').textContent = '';
    }

    // Validar todos os steps antes de submeter
    function validateAllSteps() {
        // Validar step 1: radio buttons obrigat√≥rios
        if (!document.querySelector('input[name="eh_intermediacao"]:checked')) {
            alert('Por favor, informe se o s√≠tio eletr√¥nico se dedica √† intermedia√ß√£o de vendas.');
            goToStep(1);
            return false;
        }

        // Validar step 2: campos e radio buttons
        const nomeSite = document.querySelector('input[name="nome_site"]');
        const urlSite = document.querySelector('input[name="url_site"]');
        const dataConsulta = document.querySelector('input[name="data_consulta"]');
        const horaConsulta = document.querySelector('input[name="hora_consulta"]');

        if (!nomeSite.value) {
            alert('Por favor, informe o nome do site.');
            goToStep(1);
            nomeSite.focus();
            return false;
        }

        if (!urlSite.value) {
            alert('Por favor, informe o endere√ßo eletr√¥nico (URL).');
            goToStep(1);
            urlSite.focus();
            return false;
        }

        if (!dataConsulta.value) {
            alert('Por favor, informe a data da consulta.');
            goToStep(2);
            dataConsulta.focus();
            return false;
        }

        if (!horaConsulta.value) {
            alert('Por favor, informe a hora da consulta.');
            goToStep(2);
            horaConsulta.focus();
            return false;
        }

        if (!document.querySelector('input[name="inclui_frete"]:checked')) {
            alert('Por favor, informe se o pre√ßo inclui frete.');
            goToStep(2);
            return false;
        }

        // Validar step 3: itens e pre√ßos
        const checkboxes = document.querySelectorAll('.item-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Por favor, selecione pelo menos um item para coletar o pre√ßo.');
            goToStep(3);
            return false;
        }

        for (let checkbox of checkboxes) {
            const itemId = checkbox.getAttribute('data-item-id');
            const precoInput = document.querySelector(`.preco-input[data-item-id="${itemId}"]`);
            if (!precoInput.value || parseFloat(precoInput.value) <= 0) {
                alert('Por favor, informe o pre√ßo unit√°rio de todos os itens selecionados.');
                goToStep(3);
                precoInput.focus();
                return false;
            }
        }

        // Validar step 4: arquivo
        const arquivoInput = document.getElementById('arquivo_print');
        if (!arquivoInput.files || arquivoInput.files.length === 0) {
            alert('Por favor, selecione um arquivo (print da p√°gina consultada).');
            goToStep(4);
            return false;
        }

        return true;
    }

    // Submit do formul√°rio
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            console.log('[ACAO] VERS√ÉO 15:05 - E-commerce Modal - COM PROXY');
            console.log('üì° URL COMPLETA:', window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/coleta-ecommerce');

            if (!validateAllSteps()) {
                return;
            }

            const formData = new FormData(this);

            // Mostrar loading no bot√£o
            btnConcluir.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
            btnConcluir.disabled = true;

            fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/coleta-ecommerce', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úì Coleta de s√≠tio de com√©rcio eletr√¥nico salva com sucesso!');
                    bootstrap.Modal.getInstance(modal).hide();
                    location.reload();
                } else {
                    alert('Erro: ' + (data.message || 'N√£o foi poss√≠vel salvar a coleta.'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar coleta. Tente novamente.');
            })
            .finally(() => {
                btnConcluir.innerHTML = '<i class="fas fa-heart"></i> CONCLUIR';
                btnConcluir.disabled = false;
            });
        });
    }
})();

// ===============================================================================
// INICIALIZACAO GLOBAL: Sincronizar estado disabled dos campos com checkboxes
// ESTE CODIGO RODA AO CARREGAR A PAGINA (FORA DE QUALQUER MODAL/IIFE)
//  ===============================================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log(' [ELABORAR.BLADE.PHP] Inicializando estado dos campos de pre√ßo...');

    document.querySelectorAll('.item-checkbox').forEach(checkbox => {
        const itemId = checkbox.getAttribute('data-item-id');
        const precoInput = document.querySelector(`.preco-input[data-item-id="${itemId}"]`);

        if (precoInput) {
            // CRUCIAL: Ler o valor que o BLADE renderizou (no atributo data-preco-blade-rendered)
            const valorDoBlade = precoInput.getAttribute('data-preco-blade-rendered');
            const valorAtual = precoInput.value;

            console.log(`[BUSCA] Item #${itemId}:`, {
                checkbox_checked: checkbox.checked,
                valor_blade: valorDoBlade,
                valor_atual_campo: valorAtual,
                campo_disabled: precoInput.disabled
            });

            // Se checkbox est√° marcado, HABILITAR o campo
            if (checkbox.checked) {
                precoInput.disabled = false;

                // IMPORTANTE: Se o campo est√° vazio mas o Blade tinha valor, RESTAURAR!
                if (valorDoBlade && valorDoBlade !== 'BLADE_NULL' && valorDoBlade !== '' && !valorAtual) {
                    console.log(`  [RESTAURAR] RESTAURANDO valor do Blade: ${valorDoBlade}`);
                    precoInput.value = valorDoBlade;
                }

                console.log(`  [OK] Item #${itemId}: checkbox MARCADO -> campo HABILITADO (valor final: ${precoInput.value || 'vazio'})`);
            }
            // Se checkbox N√ÉO est√° marcado, DESABILITAR o campo
            else {
                precoInput.disabled = true;
                console.log(`  [INFO] Item #${itemId}: checkbox DESMARCADO -> campo DESABILITADO`);
            }
        }
    });

    console.log('[OK] [ELABORAR.BLADE.PHP] Inicializa√ß√£o de campos conclu√≠da!');
});
</script>

<!-- Modal 5: Solicitar CDF (Wizard 5 etapas) -->
<div class="modal fade" id="modalSolicitarCDF" tabindex="-1" aria-labelledby="modalSolicitarCDFLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 20px 24px;">
                <h5 class="modal-title" id="modalSolicitarCDFLabel" style="font-weight: 700; text-transform: uppercase; font-size: 16px;">
                    <i class="fas fa-file-invoice"></i> SOLICITAR COTA√á√ÉO DIRETA COM FORNECEDOR (CDF)
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Stepper (indicador de passos) -->
            <div style="background: #f9fafb; padding: 15px 20px; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; position: relative;">
                    <!-- Linha de conex√£o -->
                    <div style="position: absolute; top: 18px; left: 30px; right: 30px; height: 2px; background: #e5e7eb; z-index: 0;"></div>
                    <div id="cdf-progress-line" style="position: absolute; top: 18px; left: 30px; height: 2px; background: #3b82f6; z-index: 0; width: 0%; transition: width 0.3s;"></div>

                    <!-- Step 1 -->
                    <div class="cdf-wizard-step active" data-step="1" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="cdf-step-circle" style="width: 36px; height: 36px; border-radius: 50%; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px; font-weight: 700; font-size: 13px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
                            1
                        </div>
                        <div class="cdf-step-label" style="font-size: 10px; font-weight: 600; color: #3b82f6; text-transform: uppercase; line-height: 1.2;">
                            SELE√á√ÉO DE ITENS
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div class="cdf-wizard-step" data-step="2" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="cdf-step-circle" style="width: 36px; height: 36px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px; font-weight: 700; font-size: 13px;">
                            2
                        </div>
                        <div class="cdf-step-label" style="font-size: 10px; font-weight: 600; color: #9ca3af; text-transform: uppercase; line-height: 1.2;">
                            DADOS DO FORNECEDOR
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div class="cdf-wizard-step" data-step="3" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="cdf-step-circle" style="width: 36px; height: 36px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px; font-weight: 700; font-size: 13px;">
                            3
                        </div>
                        <div class="cdf-step-label" style="font-size: 10px; font-weight: 600; color: #9ca3af; text-transform: uppercase; line-height: 1.2;">
                            CONDI√á√ïES COMERCIAIS
                        </div>
                    </div>

                    <!-- Step 4 -->
                    <div class="cdf-wizard-step" data-step="4" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="cdf-step-circle" style="width: 36px; height: 36px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px; font-weight: 700; font-size: 13px;">
                            4
                        </div>
                        <div class="cdf-step-label" style="font-size: 10px; font-weight: 600; color: #9ca3af; text-transform: uppercase; line-height: 1.2;">
                            VALIDAR EMPRESA
                        </div>
                    </div>

                    <!-- Step 5 -->
                    <div class="cdf-wizard-step" data-step="5" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="cdf-step-circle" style="width: 36px; height: 36px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px; font-weight: 700; font-size: 13px;">
                            5
                        </div>
                        <div class="cdf-step-label" style="font-size: 10px; font-weight: 600; color: #9ca3af; text-transform: uppercase; line-height: 1.2;">
                            GERAR COTA√á√ÉO
                        </div>
                    </div>
                </div>
            </div>

            <!-- Body do Modal com Form -->
            <form id="formSolicitarCDF" enctype="multipart/form-data">
                @csrf
                <input type="hidden" name="orcamento_id" value="{{ $orcamento->id }}">

                <div class="modal-body" style="padding: 25px 20px; min-height: 400px;">

                    <!-- ETAPA 1: SELE√á√ÉO DE ITENS -->
                    <div class="cdf-wizard-content" id="cdf-step-1" style="display: block;">
                        <h6 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 15px;">
                            <span style="background: #dbeafe; padding: 4px 12px; border-radius: 4px; margin-right: 8px;">1</span>
                            SELE√á√ÉO DE ITENS
                        </h6>
                        <p style="font-size: 13px; color: #374151; margin-bottom: 15px; font-weight: 500;">
                            Selecione os itens cuja cota√ß√£o ser√° solicitada.
                        </p>

                        <!-- Campo de pesquisa (opcional) -->
                        <div class="mb-3">
                            <input
                                type="text"
                                id="cdf-pesquisa-item"
                                class="form-control"
                                placeholder="Pesquisar por parte da descri√ß√£o..."
                                style="font-size: 12px; padding: 8px 12px;"
                            >
                        </div>

                        <!-- Tabela de itens -->
                        <div style="max-height: 350px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <table class="table table-sm" style="margin-bottom: 0; font-size: 12px;">
                                <thead style="background: #f9fafb; position: sticky; top: 0; z-index: 10;">
                                    <tr>
                                        <th style="width: 40px; padding: 10px 8px;"></th>
                                        <th style="padding: 10px; font-weight: 700; color: #374151;">LOTE/ITEM</th>
                                        <th style="padding: 10px; font-weight: 700; color: #374151;">DESCRI√á√ÉO</th>
                                        <th style="padding: 10px; font-weight: 700; color: #374151; width: 100px;">QUANTIDADE</th>
                                        <th style="padding: 10px; font-weight: 700; color: #374151; width: 120px;">UNIDADE</th>
                                    </tr>
                                </thead>
                                <tbody id="cdf-tbody-itens">
                                    @foreach($orcamento->itens as $item)
                                    <tr class="cdf-item-row">
                                        <td style="padding: 8px; text-align: center;">
                                            <input
                                                type="checkbox"
                                                name="itens_selecionados[]"
                                                value="{{ $item->id }}"
                                                class="form-check-input cdf-item-checkbox"
                                                style="cursor: pointer;"
                                            >
                                        </td>
                                        <td style="padding: 8px; color: #6b7280;">
                                            {{ $item->lote_id ? 'Lote ' . $item->lote->numero : 'Item' }}
                                        </td>
                                        <td style="padding: 8px; color: #111827; font-weight: 500;">
                                            {{ $item->descricao }}
                                        </td>
                                        <td style="padding: 8px; color: #6b7280; text-align: right;">
                                            {{ number_format($item->quantidade, 2, ',', '.') }}
                                        </td>
                                        <td style="padding: 8px; color: #6b7280;">
                                            {{ $item->medida_fornecimento }}
                                        </td>
                                    </tr>
                                    @endforeach
                                </tbody>
                            </table>
                        </div>

                        <div style="margin-top: 12px; padding: 10px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; font-size: 11px; color: #92400e;">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 6px;"></i>
                            <strong>Aten√ß√£o:</strong> Selecione pelo menos 1 item para solicitar a cota√ß√£o.
                        </div>
                    </div>

                    <!-- ETAPA 2: DADOS DO FORNECEDOR + JUSTIFICATIVA -->
                    <div class="cdf-wizard-content" id="cdf-step-2" style="display: none;">
                        <h6 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 15px;">
                            <span style="background: #dbeafe; padding: 4px 12px; border-radius: 4px; margin-right: 8px;">2</span>
                            DADOS DO FORNECEDOR
                        </h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                    CNPJ*
                                </label>
                                <div style="display: flex; gap: 8px;">
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="cdf-cnpj-input"
                                        name="cnpj"
                                        placeholder="00.000.000/0000-00"
                                        required
                                        maxlength="18"
                                        style="font-size: 12px; padding: 8px; flex: 1;"
                                    >
                                    <button
                                        type="button"
                                        id="cdf-btn-buscar-cnpj"
                                        class="btn btn-primary"
                                        style="padding: 8px 16px; font-size: 12px; white-space: nowrap;"
                                    >
                                        <i class="fas fa-search"></i> BUSCAR
                                    </button>
                                </div>
                                <small style="font-size: 11px; color: #374151; margin-top: 4px; display: block; font-weight: 500;">
                                    <i class="fas fa-info-circle" style="color: #3b82f6;"></i> Digite o CNPJ e clique em BUSCAR para preencher automaticamente
                                </small>
                                <button
                                    type="button"
                                    id="cdf-btn-baixar-espelho"
                                    class="btn btn-success btn-sm"
                                    style="margin-top: 8px; font-size: 11px; padding: 6px 12px; display: none;"
                                >
                                    <i class="fas fa-download"></i> BAIXAR ESPELHO CNPJ (PDF)
                                </button>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                    Raz√£o Social*
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="cdf-razao-social-input"
                                    name="razao_social"
                                    placeholder="Nome da empresa"
                                    required
                                    style="font-size: 12px; padding: 8px;"
                                >
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                    E-mail* (para envio da cota√ß√£o)
                                </label>
                                <input
                                    type="email"
                                    class="form-control"
                                    id="cdf-email-input"
                                    name="email"
                                    placeholder="contato@empresa.com"
                                    required
                                    style="font-size: 12px; padding: 8px;"
                                >
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                    Telefone (opcional)
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="cdf-telefone-input"
                                    name="telefone"
                                    placeholder="(00) 0000-0000"
                                    style="font-size: 12px; padding: 8px;"
                                >
                            </div>
                        </div>

                        <!-- BOT√ïES DE IMPORTAR FORNECEDOR -->
                        <div style="margin: 20px 0;">
                            <p style="font-size: 12px; color: #1e40af; font-weight: 600; margin-bottom: 12px;">
                                <i class="fas fa-lightbulb" style="color: #3b82f6;"></i>
                                N√£o sabe qual fornecedor escolher? Busque em nosso banco de dados:
                            </p>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button
                                    type="button"
                                    id="btn-importar-fornecedor-pncp"
                                    class="btn btn-primary"
                                    style="flex: 1; min-width: 200px; padding: 12px; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none;"
                                >
                                    <i class="fas fa-search-dollar"></i>
                                    BUSQUE O MELHOR FORNECEDOR
                                </button>
                                <button
                                    type="button"
                                    id="btn-importar-fornecedor-local"
                                    class="btn btn-primary"
                                    style="flex: 1; min-width: 200px; padding: 12px; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none;"
                                >
                                    <i class="fas fa-database"></i>
                                    IMPORTAR - CADASTRO LOCAL
                                </button>
                            </div>
                            <small style="font-size: 11px; color: #374151; margin-top: 8px; display: block; font-weight: 500;">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                Busque por nome, CNPJ, produto ou palavra-chave (ex: "caneta", "papel")
                            </small>
                        </div>

                        <!-- Justificativa -->
                        <hr style="margin: 20px 0;">
                        <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 12px;">
                            JUSTIFICAR ESCOLHA DO FORNECEDOR <span style="color: #dc2626;">*</span>
                        </h6>
                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <p style="font-size: 11px; color: #92400e; margin: 0; font-weight: 600;">
                                <i class="fas fa-exclamation-triangle" style="color: #f59e0b; margin-right: 6px;"></i>
                                Campo obrigat√≥rio: Selecione pelo menos uma justificativa predefinida OU preencha a justificativa livre.
                            </p>
                        </div>
                        <p style="font-size: 12px; color: #374151; margin-bottom: 12px; font-weight: 500;">
                            Selecione uma ou mais justificativas predefinidas. Voc√™ tamb√©m pode incluir uma justificativa personalizada.
                        </p>

                        <div class="mb-2">
                            <label style="display: flex; align-items: start; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;">
                                <input type="checkbox" name="justificativas[]" value="reconhecida_regiao" class="form-check-input" style="margin-top: 2px;">
                                <span style="font-size: 11px; color: #374151; line-height: 1.4;">
                                    A empresa √© reconhecida da regi√£o como fornecedor dessa linha de materiais/servi√ßos.
                                </span>
                            </label>
                        </div>

                        <div class="mb-2">
                            <label style="display: flex; align-items: start; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;">
                                <input type="checkbox" name="justificativas[]" value="forneceu_anteriormente" class="form-check-input" style="margin-top: 2px;">
                                <span style="font-size: 11px; color: #374151; line-height: 1.4;">
                                    A empresa j√° forneceu anteriormente, sem problemas na execu√ß√£o.
                                </span>
                            </label>
                        </div>

                        <div class="mb-2">
                            <label style="display: flex; align-items: start; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;">
                                <input type="checkbox" name="justificativas[]" value="outro_municipio" class="form-check-input" style="margin-top: 2px;">
                                <span style="font-size: 11px; color: #374151; line-height: 1.4;">
                                    A empresa √© de outro munic√≠pio, pois h√° restri√ß√£o de fornecedores na pra√ßa local.
                                </span>
                            </label>
                        </div>

                        <div class="mb-2">
                            <label style="display: flex; align-items: start; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;">
                                <input type="checkbox" name="justificativas[]" value="mais_competitivo" class="form-check-input" style="margin-top: 2px;">
                                <span style="font-size: 11px; color: #374151; line-height: 1.4;">
                                    O mercado fornecedor √© mais competitivo na pra√ßa pesquisada.
                                </span>
                            </label>
                        </div>

                        <div class="mb-3" style="margin-top: 15px;">
                            <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                Justificativa Livre (opcional)
                            </label>
                            <textarea
                                class="form-control"
                                name="justificativa_outro"
                                rows="3"
                                placeholder="Adicione informa√ß√µes adicionais se necess√°rio..."
                                style="font-size: 12px; padding: 8px;"
                            ></textarea>
                        </div>
                    </div>

                    <!-- ETAPA 3: CONDI√á√ïES COMERCIAIS -->
                    <div class="cdf-wizard-content" id="cdf-step-3" style="display: none;">
                        <h6 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 15px;">
                            <span style="background: #dbeafe; padding: 4px 12px; border-radius: 4px; margin-right: 8px;">3</span>
                            CONDI√á√ïES COMERCIAIS
                        </h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                    Prazo de resposta (dias)*
                                </label>
                                <input
                                    type="number"
                                    class="form-control"
                                    name="prazo_resposta_dias"
                                    placeholder="Ex: 5"
                                    min="1"
                                    required
                                    style="font-size: 12px; padding: 8px;"
                                >
                                <small style="font-size: 11px; color: #374151; font-weight: 500;">Prazo para o fornecedor responder</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                    Prazo de entrega (dias)*
                                </label>
                                <input
                                    type="number"
                                    class="form-control"
                                    name="prazo_entrega_dias"
                                    placeholder="Ex: 10"
                                    min="1"
                                    required
                                    style="font-size: 12px; padding: 8px;"
                                >
                                <small style="font-size: 11px; color: #374151; font-weight: 500;">Prazo ap√≥s autoriza√ß√£o de fornecimento</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label d-block" style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 10px;">
                                Frete*
                            </label>
                            <div style="display: flex; gap: 12px;">
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1;">
                                    <input type="radio" name="frete" value="CIF" required style="cursor: pointer;">
                                    <div style="padding: 10px 14px; border: 2px solid #d1d5db; border-radius: 8px; background: white; font-size: 11px; text-align: center; width: 100%;">
                                        <div style="font-weight: 700; color: #374151;">CIF</div>
                                        <div style="color: #6b7280; margin-top: 4px; font-size: 10px;">Entregue na sede do comprador</div>
                                    </div>
                                </label>
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1;">
                                    <input type="radio" name="frete" value="FOB" required style="cursor: pointer;">
                                    <div style="padding: 10px 14px; border: 2px solid #d1d5db; border-radius: 8px; background: white; font-size: 11px; text-align: center; width: 100%;">
                                        <div style="font-weight: 700; color: #374151;">FOB</div>
                                        <div style="color: #6b7280; margin-top: 4px; font-size: 10px;">Entregue no fornecedor</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                Observa√ß√µes (opcional)
                            </label>
                            <textarea
                                class="form-control"
                                name="observacao"
                                rows="4"
                                placeholder="Ex: marca/modelo desejado, SLA, garantias, montagem, etc."
                                style="font-size: 12px; padding: 8px;"
                            ></textarea>
                        </div>
                    </div>

                    <!-- ETAPA 4: VALIDAR EMPRESA -->
                    <div class="cdf-wizard-content" id="cdf-step-4" style="display: none;">
                        <h6 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 15px;">
                            <span style="background: #dbeafe; padding: 4px 12px; border-radius: 4px; margin-right: 8px;">4</span>
                            VALIDAR EMPRESA
                        </h6>

                        <div class="mb-4">
                            <div style="background: #f0f9ff; border: 1px solid #7dd3fc; border-radius: 8px; padding: 15px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input
                                        type="checkbox"
                                        name="fornecedor_valido"
                                        required
                                        class="form-check-input"
                                        style="width: 20px; height: 20px; cursor: pointer;"
                                    >
                                    <span style="font-size: 13px; font-weight: 600; color: #0369a1;">
                                        <i class="fas fa-check-circle" style="margin-right: 6px;"></i>
                                        Confirmo que o fornecedor √© v√°lido para este processo
                                    </span>
                                </label>
                            </div>
                        </div>

                        <!-- Upload espelho CNPJ (opcional) -->
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                Upload do Espelho do CNPJ (opcional)
                            </label>
                            <div style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 25px; text-align: center; background: #f9fafb;">
                                <i class="fas fa-file-pdf" style="font-size: 32px; color: #9ca3af; margin-bottom: 10px;"></i>
                                <input
                                    type="file"
                                    id="cdf-arquivo-cnpj"
                                    name="arquivo_cnpj"
                                    accept=".pdf"
                                    style="display: none;"
                                >
                                <button
                                    type="button"
                                    id="cdf-btn-selecionar-cnpj"
                                    class="btn btn-outline-primary btn-sm"
                                    style="font-size: 12px; padding: 6px 20px;"
                                >
                                    <i class="fas fa-folder-open"></i> SELECIONAR ARQUIVO
                                </button>
                                <div id="cdf-nome-arquivo-cnpj" style="margin-top: 10px; font-size: 11px; color: #059669; font-weight: 600;"></div>
                            </div>
                            <small style="font-size: 11px; color: #374151; display: block; margin-top: 6px; font-weight: 500;">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i> M√°x. 2MB ‚Ä¢ Formato: PDF ‚Ä¢ Orienta√ß√£o: Retrato
                            </small>
                        </div>
                    </div>

                    <!-- ETAPA 5: GERAR COTA√á√ÉO -->
                    <div class="cdf-wizard-content" id="cdf-step-5" style="display: none;">
                        <h6 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 15px;">
                            <span style="background: #dbeafe; padding: 4px 12px; border-radius: 4px; margin-right: 8px;">5</span>
                            GERAR COTA√á√ÉO
                        </h6>

                        <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h6 style="font-size: 13px; font-weight: 700; color: #92400e; margin-bottom: 12px;">
                                <i class="fas fa-exclamation-triangle"></i> RECOMENDA√á√ïES IMPORTANTES
                            </h6>
                            <p style="font-size: 11px; color: #78350f; line-height: 1.6; margin-bottom: 0;">
                                A solicita√ß√£o de CDF est√° pronta para ser gerada. Ao concluir, o sistema ir√° registrar a cota√ß√£o e voc√™ poder√°:
                            </p>
                        </div>

                        <div style="background: #f0f9ff; border: 1px solid #7dd3fc; border-radius: 8px; padding: 18px; margin-bottom: 15px;">
                            <h6 style="font-size: 12px; font-weight: 700; color: #0369a1; margin-bottom: 10px;">
                                <i class="fas fa-file-alt"></i> 1. DOCUMENTOS GERADOS
                            </h6>
                            <p style="font-size: 11px; color: #0c4a6e; line-height: 1.6; margin-bottom: 0;">
                                ‚Ä¢ <strong>Of√≠cio de solicita√ß√£o</strong> em formato DOC/PDF<br>
                                ‚Ä¢ <strong>Formul√°rio de cota√ß√£o</strong> em formato Excel (XLS)
                            </p>
                        </div>

                        <div style="background: #f0f9ff; border: 1px solid #7dd3fc; border-radius: 8px; padding: 18px; margin-bottom: 15px;">
                            <h6 style="font-size: 12px; font-weight: 700; color: #0369a1; margin-bottom: 10px;">
                                <i class="fas fa-envelope"></i> 2. ENVIO DA SOLICITA√á√ÉO
                            </h6>
                            <p style="font-size: 11px; color: #0c4a6e; line-height: 1.6; margin-bottom: 0;">
                                A solicita√ß√£o deve ser enviada <strong>por e-mail</strong> para o fornecedor informado. Em anexo, envie o formul√°rio de cota√ß√£o e, se aplic√°vel, o termo de refer√™ncia.
                            </p>
                        </div>

                        <div style="background: #f0f9ff; border: 1px solid #7dd3fc; border-radius: 8px; padding: 18px;">
                            <h6 style="font-size: 12px; font-weight: 700; color: #0369a1; margin-bottom: 10px;">
                                <i class="fas fa-users"></i> 3. V√çNCULOS ENTRE FORNECEDORES
                            </h6>
                            <p style="font-size: 11px; color: #0c4a6e; line-height: 1.6; margin-bottom: 0;">
                                Verifique se h√° ind√≠cios de v√≠nculo entre fornecedores consultados (parentesco, mesmo endere√ßo, grupo empresarial). Caso haja, as CDFs devem ser descartadas.
                            </p>
                        </div>
                    </div>

                </div>

                <!-- Footer com bot√µes de navega√ß√£o -->
                <div class="modal-footer" style="padding: 14px 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between;">
                    <button
                        type="button"
                        id="cdf-btn-anterior"
                        class="btn btn-secondary"
                        style="padding: 8px 20px; font-size: 12px; font-weight: 600; display: none;"
                    >
                        <i class="fas fa-chevron-left"></i> ANTERIOR
                    </button>
                    <div style="flex: 1;"></div>
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                        style="padding: 8px 20px; font-size: 12px; font-weight: 600; margin-right: 8px;"
                    >
                        CANCELAR
                    </button>
                    <button
                        type="button"
                        id="cdf-btn-proximo"
                        class="btn btn-primary"
                        style="padding: 8px 20px; font-size: 12px; font-weight: 600;"
                    >
                        PR√ìXIMO <i class="fas fa-chevron-right"></i>
                    </button>
                    <button
                        type="submit"
                        id="cdf-btn-gerar"
                        class="btn btn-success"
                        style="padding: 8px 20px; font-size: 12px; font-weight: 600; display: none;"
                    >
                        <i class="fas fa-check-circle"></i> GERAR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ===== MODAL SOLICITAR CDF =====
(function() {
    let cdfCurrentStep = 1;
    const cdfTotalSteps = 5;
    const cdfModal = document.getElementById('modalSolicitarCDF');
    const cdfForm = document.getElementById('formSolicitarCDF');
    const cdfBtnAbrir = document.getElementById('btn-solicitar-cdf');
    const cdfBtnAnterior = document.getElementById('cdf-btn-anterior');
    const cdfBtnProximo = document.getElementById('cdf-btn-proximo');
    const cdfBtnGerar = document.getElementById('cdf-btn-gerar');
    const cdfBtnSelecionarCNPJ = document.getElementById('cdf-btn-selecionar-cnpj');
    const cdfInputCNPJ = document.getElementById('cdf-arquivo-cnpj');
    const cdfPesquisaItem = document.getElementById('cdf-pesquisa-item');

    // IMPORTANTE: Remover atributo required dos inputs de arquivo
    if (cdfInputCNPJ) {
        cdfInputCNPJ.removeAttribute('required');
    }

    // Abrir modal
    if (cdfBtnAbrir) {
        cdfBtnAbrir.addEventListener('click', function() {
            const bsModal = new bootstrap.Modal(cdfModal);
            bsModal.show();
            cdfResetWizard();

            // Garantir que required foi removido
            if (cdfInputCNPJ) {
                cdfInputCNPJ.removeAttribute('required');
            }
        });
    }

    // Navega√ß√£o entre etapas
    if (cdfBtnProximo) {
        cdfBtnProximo.addEventListener('click', function() {
            if (cdfValidateCurrentStep()) {
                cdfGoToStep(cdfCurrentStep + 1);
            }
        });
    }

    if (cdfBtnAnterior) {
        cdfBtnAnterior.addEventListener('click', function() {
            cdfGoToStep(cdfCurrentStep - 1);
        });
    }

    // Upload arquivo CNPJ
    if (cdfBtnSelecionarCNPJ) {
        cdfBtnSelecionarCNPJ.addEventListener('click', function() {
            cdfInputCNPJ.click();
        });
    }

    if (cdfInputCNPJ) {
        cdfInputCNPJ.addEventListener('change', function() {
            const nomeArquivo = document.getElementById('cdf-nome-arquivo-cnpj');
            if (this.files.length > 0) {
                nomeArquivo.textContent = `‚úì ${this.files[0].name}`;
            } else {
                nomeArquivo.textContent = '';
            }
        });
    }

    // Pesquisa de itens
    if (cdfPesquisaItem) {
        cdfPesquisaItem.addEventListener('input', function() {
            const termo = this.value.toLowerCase();
            const rows = document.querySelectorAll('.cdf-item-row');

            rows.forEach(row => {
                const descricao = row.cells[2].textContent.toLowerCase();
                if (termo === '' || descricao.includes(termo)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }

    // Buscar CNPJ automaticamente
    const cdfBtnBuscarCNPJ = document.getElementById('cdf-btn-buscar-cnpj');
    const cdfCnpjInput = document.getElementById('cdf-cnpj-input');
    const cdfRazaoSocialInput = document.getElementById('cdf-razao-social-input');
    const cdfEmailInput = document.getElementById('cdf-email-input');
    const cdfTelefoneInput = document.getElementById('cdf-telefone-input');

    if (cdfBtnBuscarCNPJ && cdfCnpjInput) {
        cdfBtnBuscarCNPJ.addEventListener('click', async function() {
            const cnpj = cdfCnpjInput.value.replace(/\D/g, ''); // Remover formata√ß√£o

            if (cnpj.length !== 14) {
                alert('[ERRO] CNPJ Inv√°lido\n\nDigite um CNPJ v√°lido com 14 d√≠gitos.');
                return;
            }

            // Desabilitar bot√£o durante busca
            cdfBtnBuscarCNPJ.disabled = true;
            cdfBtnBuscarCNPJ.innerHTML = '<i class="fas fa-spinner fa-spin"></i> BUSCANDO...';

            try {
                // Buscar na API da Receita Federal via backend
                const response = await fetch(`${window.APP_BASE_PATH}/api/cnpj/consultar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ cnpj: cnpj })
                });

                const result = await response.json();

                if (result.success) {
                    // Preencher campos automaticamente com dados da Receita Federal
                    if (cdfRazaoSocialInput) cdfRazaoSocialInput.value = result.razao_social || '';
                    if (cdfEmailInput) cdfEmailInput.value = result.email || '';
                    if (cdfTelefoneInput) cdfTelefoneInput.value = result.telefone || '';

                    // MOSTRAR BOT√ÉO DE BAIXAR ESPELHO CNPJ
                    const btnBaixarEspelho = document.getElementById('cdf-btn-baixar-espelho');
                    if (btnBaixarEspelho) {
                        btnBaixarEspelho.style.display = 'inline-block';
                        console.log('[OK] Bot√£o de baixar espelho CNPJ exibido');
                    }

                    // Mensagem de sucesso
                    let mensagem = `‚úì CNPJ Encontrado!\n\n` +
                                   `Raz√£o Social: ${result.razao_social}\n` +
                                   `Situa√ß√£o: ${result.situacao}\n\n` +
                                   `Dados preenchidos automaticamente!`;

                    // Avisar se n√£o tem email
                    if (!result.email) {
                        mensagem += `\n\n Email n√£o encontrado no cadastro da Receita Federal.\nPor favor, preencha manualmente.`;
                        // Focar no campo email
                        if (cdfEmailInput) {
                            setTimeout(() => cdfEmailInput.focus(), 100);
                        }
                    }

                    // Avisar se empresa n√£o est√° ativa
                    if (result.warning) {
                        mensagem += `\n\n ${result.warning}`;
                    }

                    alert(mensagem);

                } else {
                    // Erro: CNPJ n√£o encontrado ou inv√°lido
                    alert(` ${result.message || 'Erro ao buscar CNPJ'}\n\nVerifique o CNPJ digitado ou preencha os dados manualmente.`);

                    // ESCONDER BOT√ÉO DE BAIXAR ESPELHO CNPJ
                    const btnBaixarEspelho = document.getElementById('cdf-btn-baixar-espelho');
                    if (btnBaixarEspelho) {
                        btnBaixarEspelho.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Erro ao buscar CNPJ:', error);
                alert('[ERRO] Erro ao Buscar CNPJ\n\nN√£o foi poss√≠vel consultar a Receita Federal.\nVerifique sua conex√£o e tente novamente.\n\nVoc√™ pode preencher os dados manualmente.');
            } finally {
                // Reabilitar bot√£o
                cdfBtnBuscarCNPJ.disabled = false;
                cdfBtnBuscarCNPJ.innerHTML = '<i class="fas fa-search"></i> BUSCAR';
            }
        });

        // Adicionar m√°scara ao campo CNPJ do CDF
        cdfCnpjInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 14) {
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
            }
            e.target.value = value;
        });

        // Permitir buscar ao pressionar Enter no campo CNPJ
        cdfCnpjInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                cdfBtnBuscarCNPJ.click();
            }
        });
    }

    // ========== BOT√ÉO BAIXAR ESPELHO CNPJ ==========
    const btnBaixarEspelhoCNPJ = document.getElementById('cdf-btn-baixar-espelho');
    if (btnBaixarEspelhoCNPJ && cdfCnpjInput) {
        btnBaixarEspelhoCNPJ.addEventListener('click', function() {
            const cnpj = cdfCnpjInput.value.replace(/\D/g, ''); // Remover formata√ß√£o

            if (cnpj.length !== 14) {
                alert('[ERRO] CNPJ Inv√°lido\n\nDigite um CNPJ v√°lido com 14 d√≠gitos antes de baixar o espelho.');
                return;
            }

            console.log('üì• Iniciando download do espelho CNPJ:', cnpj);

            // SOLU√á√ÉO: Usar um FORM invis√≠vel para fazer download via POST
            // Isso evita problemas com blob URLs em contextos de proxy/iframe

            // Criar form tempor√°rio
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `${window.APP_BASE_PATH}/baixar-espelho-cnpj`;
            form.target = '_blank'; // Abrir em nova aba (o servidor for√ßar√° download)
            form.style.display = 'none';

            // Adicionar CSRF token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_token';
            csrfInput.value = document.querySelector('meta[name="csrf-token"]').content;
            form.appendChild(csrfInput);

            // Adicionar CNPJ
            const cnpjInput = document.createElement('input');
            cnpjInput.type = 'hidden';
            cnpjInput.name = 'cnpj';
            cnpjInput.value = cnpj;
            form.appendChild(cnpjInput);

            // Adicionar ao DOM
            document.body.appendChild(form);

            console.log('[ACAO] Enviando formul√°rio para download...');

            // Submeter form
            form.submit();

            // Remover form ap√≥s um delay
            setTimeout(() => {
                document.body.removeChild(form);
                console.log('[OK] Download iniciado! Formul√°rio removido.');
            }, 1000);
        });
    }

    // M√°scara CNPJ (outro campo)
    const cnpjInput = document.querySelector('input[name="fornecedor_cnpj"]');
    if (cnpjInput) {
        cnpjInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 14) {
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
            }
            e.target.value = value;
        });
    }

    // M√°scara telefone
    const telInput = document.querySelector('input[name="fornecedor_telefone"]');
    if (telInput) {
        telInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/^(\d{2})(\d)/, '($1) $2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
                if (value.length === 14) {
                    value = value.replace(/(\d{5})-(\d{4})/, '$1-$2');
                }
            }
            e.target.value = value;
        });
    }

    function cdfGoToStep(step) {
        if (step < 1 || step > cdfTotalSteps) return;

        // Esconder todas as etapas
        document.querySelectorAll('.cdf-wizard-content').forEach(content => {
            content.style.display = 'none';
        });

        // Mostrar etapa atual
        document.getElementById(`cdf-step-${step}`).style.display = 'block';

        // Atualizar indicadores visuais
        cdfUpdateStepIndicators(step);

        // Atualizar bot√µes
        cdfBtnAnterior.style.display = step === 1 ? 'none' : 'inline-block';
        cdfBtnProximo.style.display = step === cdfTotalSteps ? 'none' : 'inline-block';
        cdfBtnGerar.style.display = step === cdfTotalSteps ? 'inline-block' : 'none';

        cdfCurrentStep = step;
    }

    function cdfUpdateStepIndicators(step) {
        document.querySelectorAll('.cdf-wizard-step').forEach((stepEl, index) => {
            const stepNumber = index + 1;
            const circle = stepEl.querySelector('.cdf-step-circle');
            const label = stepEl.querySelector('.cdf-step-label');

            if (stepNumber < step) {
                circle.style.background = '#10b981';
                circle.style.color = 'white';
                label.style.color = '#10b981';
                stepEl.classList.remove('active');
            } else if (stepNumber === step) {
                circle.style.background = '#3b82f6';
                circle.style.color = 'white';
                circle.style.boxShadow = '0 2px 8px rgba(59, 130, 246, 0.3)';
                label.style.color = '#3b82f6';
                stepEl.classList.add('active');
            } else {
                circle.style.background = '#e5e7eb';
                circle.style.color = '#9ca3af';
                circle.style.boxShadow = 'none';
                label.style.color = '#9ca3af';
                stepEl.classList.remove('active');
            }
        });

        const progress = ((step - 1) / (cdfTotalSteps - 1)) * 100;
        document.getElementById('cdf-progress-line').style.width = `${progress}%`;
    }

    function cdfValidateCurrentStep() {
        const stepElement = document.getElementById(`cdf-step-${cdfCurrentStep}`);
        const inputs = stepElement.querySelectorAll('input[required], select[required], textarea[required]');

        for (let input of inputs) {
            if (input.type === 'checkbox' && input.hasAttribute('required')) {
                if (!input.checked) {
                    alert(' Campo Obrigat√≥rio\n\nPor favor, marque o checkbox obrigat√≥rio para continuar.');
                    input.focus();
                    return false;
                }
            } else if (input.type === 'radio') {
                const radioName = input.name;
                if (!stepElement.querySelector(`input[name="${radioName}"]:checked`)) {
                    // Descobrir qual o label do radio
                    const radioGroup = stepElement.querySelector(`input[name="${radioName}"]`);
                    const label = radioGroup ? radioGroup.closest('.mb-3, .row, div')?.querySelector('label')?.textContent?.trim() : '';

                    alert(` Sele√ß√£o Obrigat√≥ria\n\nPor favor, selecione uma op√ß√£o${label ? ' para: ' + label : '.'}`);
                    return false;
                }
            } else if (!input.value) {
                // Pegar o label do campo
                const label = input.closest('.mb-3, .col-md-6')?.querySelector('label')?.textContent?.trim().replace('*', '') || 'Este campo';

                alert(` Campo Obrigat√≥rio\n\nPor favor, preencha o campo: ${label}`);
                input.focus();
                return false;
            }
        }

        // Valida√ß√£o espec√≠fica etapa 1: pelo menos 1 item selecionado
        if (cdfCurrentStep === 1) {
            const checkboxes = stepElement.querySelectorAll('.cdf-item-checkbox:checked');
            if (checkboxes.length === 0) {
                alert(' Nenhum Item Selecionado\n\nPor favor, selecione pelo menos um item para solicitar cota√ß√£o.');
                return false;
            }
        }

        // Valida√ß√£o espec√≠fica etapa 2: pelo menos 1 justificativa selecionada
        if (cdfCurrentStep === 2) {
            const justificativasCheckboxes = stepElement.querySelectorAll('input[name="justificativas[]"]:checked');
            const justificativaOutro = stepElement.querySelector('textarea[name="justificativa_outro"]');
            const hasJustificativaOutro = justificativaOutro && justificativaOutro.value.trim() !== '';

            if (justificativasCheckboxes.length === 0 && !hasJustificativaOutro) {
                alert(' Justificativa Obrigat√≥ria\n\nPor favor, selecione pelo menos uma justificativa predefinida OU preencha a justificativa livre para continuar.');
                return false;
            }
        }

        return true;
    }

    function cdfResetWizard() {
        cdfCurrentStep = 1;
        cdfForm.reset();
        cdfGoToStep(1);
        document.getElementById('cdf-nome-arquivo-cnpj').textContent = '';
        if (cdfPesquisaItem) cdfPesquisaItem.value = '';
        document.querySelectorAll('.cdf-item-row').forEach(row => row.style.display = '');
    }

    // Submit do formul√°rio
    if (cdfForm) {
        cdfForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('[ACAO] CDF FORM SUBMIT - Iniciando envio da CDF...');

            if (!cdfValidateCurrentStep()) {
                console.error(' CDF FORM SUBMIT - Valida√ß√£o falhou');
                return;
            }

            console.log('[OK] CDF FORM SUBMIT - Valida√ß√£o passou, preparando requisi√ß√£o...');

            const formData = new FormData(this);

            console.log('[VALIDACAO] CDF FORM SUBMIT - FormData criado:', Array.from(formData.entries()));

            cdfBtnGerar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GERANDO...';
            cdfBtnGerar.disabled = true;

            const url = window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/solicitar-cdf';
            console.log('üåê CDF FORM SUBMIT - URL:', url);
            console.log('üì§ CDF FORM SUBMIT - Iniciando requisi√ß√£o fetch...');

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                }
            })
            .then(response => {
                console.log('üì• CDF FORM SUBMIT - Resposta recebida:', response.status);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('‚úì Solicita√ß√£o Gerada\n\nSolicita√ß√£o de CDF gerada com sucesso!');

                    setTimeout(() => {
                        bootstrap.Modal.getInstance(cdfModal).hide();
                        location.reload();
                    }, 1000);
                } else {
                    let detalhes = '';
                    if (data.errors) {
                        detalhes = 'Erros de valida√ß√£o:\n';
                        Object.keys(data.errors).forEach(key => {
                            detalhes += `- ${key}: ${data.errors[key].join(', ')}\n`;
                        });
                    }
                    if (data.error_details) {
                        detalhes += `\nDetalhes t√©cnicos:\n`;
                        detalhes += `Arquivo: ${data.error_details.file}\n`;
                        detalhes += `Linha: ${data.error_details.line}\n`;
                    }

                    alert(` Erro ao Gerar Solicita√ß√£o\n\n${data.message || 'N√£o foi poss√≠vel gerar a solicita√ß√£o.'}${detalhes ? '\n\n' + detalhes : ''}`);
                }
            })
            .catch(error => {
                console.error(' CDF FORM SUBMIT - ERRO NO FETCH:', error);

                let detalhes = `URL: orcamentos/{{ $orcamento->id }}/solicitar-cdf\n`;
                detalhes += `Erro: ${error.message}\n\n`;
                if (error.stack) {
                    detalhes += `Stack Trace:\n${error.stack}`;
                }

                alert(` Erro ao Gerar Solicita√ß√£o\n\nOcorreu um erro ao enviar o formul√°rio.\n\n${detalhes}`);
            })
            .finally(() => {
                console.log('üèÅ CDF FORM SUBMIT - Finalizando...');
                cdfBtnGerar.innerHTML = '<i class="fas fa-check-circle"></i> GERAR';
                cdfBtnGerar.disabled = false;
            });
        });
    }
})();
</script>

<!-- Modal 6: Contrata√ß√µes Similares (Wizard 3 etapas) -->
<div class="modal fade" id="modalContratacoesSimilares" tabindex="-1" aria-labelledby="modalContratacoesSimilaresLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; padding: 20px 24px;">
                <h5 class="modal-title" id="modalContratacoesSimilaresLabel" style="font-weight: 700; text-transform: uppercase; font-size: 16px;">
                    <i class="fas fa-building"></i> CONTRATA√á√ïES SIMILARES DE OUTROS ENTES P√öBLICOS <span style="background: #10b981; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 8px;">‚úì v18:50 - PREFIX DIN√ÇMICO OK</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Stepper (indicador de passos) -->
            <div style="background: #f0fdfa; padding: 15px 20px; border-bottom: 1px solid #99f6e4;">
                <div style="display: flex; justify-content: space-between; position: relative;">
                    <!-- Linha de progresso -->
                    <div style="position: absolute; top: 18px; left: 0; right: 0; height: 2px; background: #d1d5db; z-index: 0;"></div>
                    <div id="cs-progress-line" style="position: absolute; top: 18px; left: 0; height: 2px; background: #0891b2; z-index: 0; width: 0%; transition: width 0.3s;"></div>

                    <!-- Step 1 -->
                    <div class="cs-wizard-step" data-step="1" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="cs-step-circle" style="width: 36px; height: 36px; border-radius: 50%; background: #0891b2; color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px; font-weight: 700; font-size: 13px;">
                            1
                        </div>
                        <div class="cs-step-label" style="font-size: 10px; font-weight: 600; color: #0891b2; text-transform: uppercase; line-height: 1.2;">
                            DADOS DA CONTRATA√á√ÉO
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div class="cs-wizard-step" data-step="2" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="cs-step-circle" style="width: 36px; height: 36px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px; font-weight: 700; font-size: 13px;">
                            2
                        </div>
                        <div class="cs-step-label" style="font-size: 10px; font-weight: 600; color: #9ca3af; text-transform: uppercase; line-height: 1.2;">
                            COLETA DE AMOSTRAS
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div class="cs-wizard-step" data-step="3" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="cs-step-circle" style="width: 36px; height: 36px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px; font-weight: 700; font-size: 13px;">
                            3
                        </div>
                        <div class="cs-step-label" style="font-size: 10px; font-weight: 600; color: #9ca3af; text-transform: uppercase; line-height: 1.2;">
                            ANEXAR PDF
                        </div>
                    </div>
                </div>
            </div>

            <!-- Body do Modal com Form -->
            <form id="formContratacoesSimilares" enctype="multipart/form-data">
                @csrf
                <input type="hidden" name="orcamento_id" value="{{ $orcamento->id }}">

                <div class="modal-body" style="padding: 25px 20px; min-height: 450px;">

                    <!-- ETAPA 1: DADOS DA CONTRATA√á√ÉO -->
                    <div class="cs-wizard-content" id="cs-step-1" style="display: block;">
                        <h6 style="font-size: 14px; font-weight: 700; color: #0891b2; margin-bottom: 15px;">
                            <span style="background: #cffafe; padding: 4px 12px; border-radius: 4px; margin-right: 8px;">1</span>
                            DADOS DA CONTRATA√á√ÉO
                        </h6>

                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                Ente p√∫blico* (√≥rg√£o/UASG/CNPJ)
                            </label>
                            <input
                                type="text"
                                class="form-control"
                                name="ente_publico"
                                placeholder="Ex: Prefeitura de Barbacena, UASG 123456, CNPJ 00.000.000/0001-00"
                                required
                                style="font-size: 12px; padding: 8px;"
                            >
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                    Tipo*
                                </label>
                                <select
                                    class="form-control"
                                    name="tipo"
                                    required
                                    style="font-size: 12px; padding: 8px;"
                                >
                                    <option value="">Selecione...</option>
                                    <option value="Preg√£o">Preg√£o</option>
                                    <option value="Contrato">Contrato</option>
                                    <option value="Ata de Registro de Pre√ßos">Ata de Registro de Pre√ßos</option>
                                    <option value="Dispensa">Dispensa</option>
                                    <option value="Inexigibilidade">Inexigibilidade</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                    N√∫mero do processo*
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="numero_processo"
                                    placeholder="Ex: 0001/2019 ou 123456"
                                    required
                                    style="font-size: 12px; padding: 8px;"
                                >
                                <small style="font-size: 11px; color: #374151; font-weight: 500;">Preencha no formato num√©rico/ano. Por exemplo: 0001/2019.</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label d-block" style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 10px;">
                                √â um registro de pre√ßos?*
                            </label>
                            <div style="display: flex; gap: 12px;">
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1;">
                                    <input type="radio" name="eh_registro_precos" value="1" required style="position: absolute; opacity: 0; pointer-events: none;">
                                    <div class="cs-radio-card" data-value="1" style="padding: 15px; border: 2px solid #d1d5db; border-radius: 8px; background: white; text-align: center; width: 100%; cursor: pointer; transition: all 0.2s;">
                                        <i class="fas fa-check-circle" style="font-size: 32px; color: #10b981; margin-bottom: 8px;"></i>
                                        <div style="font-weight: 700; color: #374151; font-size: 12px;">Sim</div>
                                    </div>
                                </label>
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1;">
                                    <input type="radio" name="eh_registro_precos" value="0" required style="position: absolute; opacity: 0; pointer-events: none;">
                                    <div class="cs-radio-card" data-value="0" style="padding: 15px; border: 2px solid #d1d5db; border-radius: 8px; background: white; text-align: center; width: 100%; cursor: pointer; transition: all 0.2s;">
                                        <i class="fas fa-times-circle" style="font-size: 32px; color: #ef4444; margin-bottom: 8px;"></i>
                                        <div style="font-weight: 700; color: #374151; font-size: 12px;">N√£o</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <hr style="margin: 20px 0;">

                        <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 12px;">
                            DADOS DA PUBLICA√á√ÉO
                        </h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                    Data da publica√ß√£o*
                                </label>
                                <input
                                    type="date"
                                    class="form-control"
                                    name="data_publicacao"
                                    required
                                    style="font-size: 12px; padding: 8px;"
                                >
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                    Local de publica√ß√£o (opcional)
                                </label>
                                <select
                                    class="form-control"
                                    name="local_publicacao"
                                    style="font-size: 12px; padding: 8px;"
                                >
                                    <option value="">Selecione...</option>
                                    <option value="Di√°rio Oficial">Di√°rio Oficial</option>
                                    <option value="Portal da Transpar√™ncia">Portal da Transpar√™ncia</option>
                                    <option value="PNCP">PNCP</option>
                                    <option value="ComprasGov">ComprasGov</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                Link oficial* (PNCP/ComprasGov/Di√°rio Oficial)
                            </label>
                            <input
                                type="url"
                                class="form-control"
                                name="link_oficial"
                                placeholder="https://..."
                                required
                                style="font-size: 12px; padding: 8px;"
                            >
                            <small style="font-size: 11px; color: #374151; font-weight: 500;">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i> Este link comprova a origem da contrata√ß√£o
                            </small>
                        </div>
                    </div>

                    <!-- ETAPA 2: COLETA DE AMOSTRAS -->
                    <div class="cs-wizard-content" id="cs-step-2" style="display: none;">
                        <h6 style="font-size: 14px; font-weight: 700; color: #0891b2; margin-bottom: 15px;">
                            <span style="background: #cffafe; padding: 4px 12px; border-radius: 4px; margin-right: 8px;">2</span>
                            COLETA DE AMOSTRAS
                        </h6>
                        <p style="font-size: 13px; color: #374151; margin-bottom: 15px; font-weight: 500;">
                            Preencha cada item com o pre√ßo coletado. Ser√£o ignorados itens com valor R$ 0,00 ou desmarcados.
                        </p>

                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <table class="table table-sm mb-0" style="font-size: 11px;">
                                <thead style="background: #f9fafb; position: sticky; top: 0; z-index: 10;">
                                    <tr>
                                        <th style="width: 40px; padding: 8px;"></th>
                                        <th style="width: 80px; padding: 8px;">LOTE/ITEM</th>
                                        <th style="padding: 8px;">DESCRI√á√ÉO</th>
                                        <th style="width: 100px; padding: 8px;">UNIDADE</th>
                                        <th style="width: 80px; padding: 8px;">QNT REF.</th>
                                        <th style="width: 120px; padding: 8px;">PRE√áO UNIT.</th>
                                        <th style="width: 120px; padding: 8px;">N√çVEL CONF.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach($orcamento->itens as $item)
                                    <tr>
                                        <td style="padding: 8px;">
                                            <input type="checkbox" name="itens_selecionados[]" value="{{ $item->id }}" class="form-check-input cs-item-check">
                                        </td>
                                        <td style="padding: 8px; font-weight: 600;">
                                            {{ str_pad($item->numero_item ?? '', 2, '0', STR_PAD_LEFT) }}/001
                                        </td>
                                        <td style="padding: 8px;">
                                            <textarea
                                                name="descricao[{{ $item->id }}]"
                                                class="form-control form-control-sm"
                                                rows="2"
                                                style="font-size: 10px;"
                                                placeholder="Descri√ß√£o do item..."
                                            >{{ $item->descricao }}</textarea>
                                        </td>
                                        <td style="padding: 8px;">
                                            <input
                                                type="text"
                                                name="unidade[{{ $item->id }}]"
                                                class="form-control form-control-sm"
                                                value="{{ $item->unidade }}"
                                                style="font-size: 10px;"
                                            >
                                        </td>
                                        <td style="padding: 8px;">
                                            <input
                                                type="number"
                                                name="quantidade_referencia[{{ $item->id }}]"
                                                class="form-control form-control-sm"
                                                value="1"
                                                min="0.01"
                                                step="0.01"
                                                style="font-size: 10px;"
                                            >
                                        </td>
                                        <td style="padding: 8px;">
                                            <input
                                                type="number"
                                                name="preco_unitario[{{ $item->id }}]"
                                                class="form-control form-control-sm cs-preco-input"
                                                data-item-id="{{ $item->id }}"
                                                placeholder="0,00"
                                                min="0"
                                                step="0.01"
                                                style="font-size: 10px;"
                                            >
                                        </td>
                                        <td style="padding: 8px;">
                                            <select
                                                name="nivel_confianca[{{ $item->id }}]"
                                                class="form-control form-control-sm"
                                                style="font-size: 10px;"
                                            >
                                                <option value="Unit√°rio">üü¢ Unit√°rio</option>
                                                <option value="Estimado">üü° Estimado</option>
                                                <option value="Global">üî¥ Global</option>
                                            </select>
                                        </td>
                                    </tr>
                                    @endforeach
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ETAPA 3: ANEXAR PDF -->
                    <div class="cs-wizard-content" id="cs-step-3" style="display: none;">
                        <h6 style="font-size: 14px; font-weight: 700; color: #0891b2; margin-bottom: 15px;">
                            <span style="background: #cffafe; padding: 4px 12px; border-radius: 4px; margin-right: 8px;">3</span>
                            ANEXAR PDF DA ARP
                        </h6>
                        <p style="font-size: 13px; color: #374151; margin-bottom: 20px; font-weight: 500;">
                            Para concluir a importa√ß√£o da ARP, √© preciso anexar o documento PDF dela.
                        </p>

                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: #374151; font-size: 12px;">
                                Selecione o arquivo PDF da ARP para envio:*
                            </label>
                            <div style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 30px; text-align: center; background: #f9fafb;">
                                <i class="fas fa-file-pdf" style="font-size: 48px; color: #9ca3af; margin-bottom: 15px;"></i>
                                <input
                                    type="file"
                                    id="cs-arquivo-pdf"
                                    name="arquivo_pdf"
                                    accept=".pdf"
                                    style="display: none;"
                                >
                                <button
                                    type="button"
                                    id="cs-btn-selecionar-arquivo"
                                    class="btn btn-outline-primary"
                                    style="font-size: 12px; padding: 8px 24px;"
                                >
                                    <i class="fas fa-folder-open"></i> SELECIONAR ARQUIVO
                                </button>
                                <div id="cs-nome-arquivo" style="margin-top: 15px; font-size: 12px; color: #059669; font-weight: 600;"></div>
                            </div>
                        </div>

                        <div style="background: #fffbeb; border: 1px solid #fbbf24; border-radius: 8px; padding: 15px; margin-top: 20px;">
                            <h6 style="font-size: 12px; font-weight: 700; color: #92400e; margin-bottom: 10px;">
                                <i class="fas fa-info-circle"></i> ORIENTA√á√ïES PARA UPLOAD
                            </h6>
                            <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #78350f; line-height: 1.8;">
                                <li>Tamanho m√°ximo do arquivo: 2MB.</li>
                                <li>Orienta√ß√£o de todas as p√°ginas do documento: RETRATO.</li>
                                <li>Formato de arquivo: *.pdf</li>
                            </ul>
                        </div>
                    </div>

                </div>

                <!-- Footer com bot√µes de navega√ß√£o -->
                <div class="modal-footer" style="background: #f9fafb; padding: 15px 20px; border-top: 1px solid #e5e7eb;">
                    <button type="button" id="cs-btn-anterior" class="btn btn-outline-secondary" style="display: none; font-size: 12px; padding: 8px 20px;">
                        <i class="fas fa-arrow-left"></i> ANTERIOR
                    </button>
                    <button type="button" id="cs-btn-proximo" class="btn btn-primary" style="font-size: 12px; padding: 8px 20px; background: #0891b2; border: none;">
                        PR√ìXIMO <i class="fas fa-arrow-right"></i>
                    </button>
                    <button type="submit" id="cs-btn-concluir" class="btn btn-success" style="display: none; font-size: 12px; padding: 8px 20px;">
                        <i class="fas fa-check-circle"></i> CONCLUIR
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="font-size: 12px; padding: 8px 20px;">
                        <i class="fas fa-times"></i> CANCELAR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Script do modal Contrata√ß√µes Similares
// Usar window.onload ao inves de DOMContentLoaded para garantir que Bootstrap esta carregado
window.addEventListener('load', function() {
    console.log('[CONTRATACOES] Inicializando modal de Contratacoes Similares...');

    const csModal = document.getElementById('modalContratacoesSimilares');
    const csBtnOpen = document.getElementById('btn-contratacoes-similares');
    const csForm = document.getElementById('formContratacoesSimilares');
    const csBtnAnterior = document.getElementById('cs-btn-anterior');
    const csBtnProximo = document.getElementById('cs-btn-proximo');
    const csBtnConcluir = document.getElementById('cs-btn-concluir');

    console.log('[CONTRATACOES] Elementos encontrados:', {
        csModal: !!csModal,
        csBtnOpen: !!csBtnOpen,
        csForm: !!csForm,
        csBtnAnterior: !!csBtnAnterior,
        csBtnProximo: !!csBtnProximo,
        csBtnConcluir: !!csBtnConcluir
    });

    if (csModal && csBtnOpen && csForm) {
        console.log('[CONTRATACOES] Todos elementos necessarios encontrados - adicionando listeners...');
        let csCurrentStep = 1;

        // IMPORTANTE: Remover atributo required do input de arquivo PDF
        const csArquivoPdfInput = document.getElementById('cs-arquivo-pdf');
        if (csArquivoPdfInput) {
            csArquivoPdfInput.removeAttribute('required');
        }

        // Abrir modal
        csBtnOpen.addEventListener('click', () => {
            console.log('[CONTRATACOES] Botao clicado - abrindo modal...');
            const modalInstance = new bootstrap.Modal(csModal);
            modalInstance.show();
            console.log('[CONTRATACOES] Modal.show() chamado');
            csGoToStep(1);

            // Garantir que required foi removido
            if (csArquivoPdfInput) {
                csArquivoPdfInput.removeAttribute('required');
            }
        });

        // Navega√ß√£o
        csBtnProximo.addEventListener('click', () => {
            if (csValidateCurrentStep()) {
                csGoToStep(csCurrentStep + 1);
            }
        });

        csBtnAnterior.addEventListener('click', () => {
            csGoToStep(csCurrentStep - 1);
        });

        // Fun√ß√£o para ir para uma etapa espec√≠fica
        function csGoToStep(step) {
            // Esconder todos os conte√∫dos
            document.querySelectorAll('.cs-wizard-content').forEach(content => {
                content.style.display = 'none';
            });

            // Mostrar conte√∫do da etapa atual
            const currentContent = document.getElementById('cs-step-' + step);
            if (currentContent) currentContent.style.display = 'block';

            // Atualizar stepper visual
            document.querySelectorAll('.cs-wizard-step').forEach((stepEl, index) => {
                const stepNum = index + 1;
                const circle = stepEl.querySelector('.cs-step-circle');
                const label = stepEl.querySelector('.cs-step-label');

                if (stepNum < step) {
                    // Etapa completada
                    circle.style.background = '#0891b2';
                    circle.style.color = 'white';
                    label.style.color = '#0891b2';
                } else if (stepNum === step) {
                    // Etapa atual
                    circle.style.background = '#0891b2';
                    circle.style.color = 'white';
                    label.style.color = '#0891b2';
                } else {
                    // Etapa futura
                    circle.style.background = '#e5e7eb';
                    circle.style.color = '#9ca3af';
                    label.style.color = '#9ca3af';
                }
            });

            // Atualizar linha de progresso
            const progressLine = document.getElementById('cs-progress-line');
            const progress = ((step - 1) / 2) * 100; // 3 etapas = 0%, 50%, 100%
            progressLine.style.width = progress + '%';

            // Atualizar bot√µes
            csBtnAnterior.style.display = step > 1 ? 'inline-block' : 'none';
            csBtnProximo.style.display = step < 3 ? 'inline-block' : 'none';
            csBtnConcluir.style.display = step === 3 ? 'inline-block' : 'none';

            csCurrentStep = step;
        }

        // Valida√ß√£o da etapa atual
        function csValidateCurrentStep() {
            const currentContent = document.getElementById('cs-step-' + csCurrentStep);
            const requiredFields = currentContent.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value || (field.type === 'radio' && !currentContent.querySelector('[name="' + field.name + '"]:checked'))) {
                    isValid = false;
                    field.classList.add('is-invalid');
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            // Valida√ß√£o espec√≠fica da etapa 2 (pelo menos 1 item selecionado)
            if (csCurrentStep === 2) {
                const itensSelecionados = currentContent.querySelectorAll('.cs-item-check:checked');
                if (itensSelecionados.length === 0) {
                    alert('Selecione pelo menos 1 item para continuar.');
                    return false;
                }
            }

            // Valida√ß√£o espec√≠fica da etapa 3 (arquivo obrigat√≥rio)
            if (csCurrentStep === 3) {
                const arquivoInput = document.getElementById('cs-arquivo-pdf');
                if (!arquivoInput.files || arquivoInput.files.length === 0) {
                    alert('Por favor, selecione o arquivo PDF da ARP.');
                    return false;
                }
            }

            if (!isValid) {
                alert('Preencha todos os campos obrigat√≥rios.');
            }

            return isValid;
        }

        // Radio cards interativos
        document.querySelectorAll('.cs-radio-card').forEach(card => {
            card.addEventListener('click', function() {
                const input = this.previousElementSibling;
                const name = input.name;

                // Desmarcar todos os cards do mesmo grupo
                document.querySelectorAll('input[name="' + name + '"]').forEach(radio => {
                    radio.nextElementSibling.style.borderColor = '#d1d5db';
                    radio.nextElementSibling.style.background = 'white';
                });

                // Marcar o selecionado
                input.checked = true;
                this.style.borderColor = '#0891b2';
                this.style.background = '#ecfeff';
            });
        });

        // Upload de arquivo
        const csArquivoPdf = document.getElementById('cs-arquivo-pdf');
        const csBtnSelecionarArquivo = document.getElementById('cs-btn-selecionar-arquivo');
        const csNomeArquivo = document.getElementById('cs-nome-arquivo');

        csBtnSelecionarArquivo.addEventListener('click', () => {
            csArquivoPdf.click();
        });

        csArquivoPdf.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                const maxSize = 2 * 1024 * 1024; // 2MB

                if (file.size > maxSize) {
                    alert('Arquivo muito grande! O tamanho m√°ximo √© 2MB.');
                    this.value = '';
                    csNomeArquivo.textContent = '';
                    return;
                }

                if (file.type !== 'application/pdf') {
                    alert('Formato inv√°lido! Apenas arquivos PDF s√£o aceitos.');
                    this.value = '';
                    csNomeArquivo.textContent = '';
                    return;
                }

                const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                csNomeArquivo.innerHTML = `<i class="fas fa-check-circle"></i> ${file.name} (${sizeInMB} MB)`;
            }
        });

        // Submiss√£o do formul√°rio
        // Validar todos os steps antes de submeter
        function csValidateAllSteps() {
            console.log('[BUSCA] INICIANDO VALIDA√á√ÉO - Contrata√ß√µes Similares');

            // Validar step 1: campos obrigat√≥rios
            const entePublico = document.querySelector('input[name="ente_publico"]');
            const tipo = document.querySelector('select[name="tipo"]');
            const numeroProcesso = document.querySelector('input[name="numero_processo"]');
            const dataPublicacao = document.querySelector('input[name="data_publicacao"]');
            const linkOficial = document.querySelector('input[name="link_oficial"]');

            console.log('[VALIDACAO] Validando Step 1 - Campos:', {
                entePublico: entePublico?.value,
                tipo: tipo?.value,
                numeroProcesso: numeroProcesso?.value,
                dataPublicacao: dataPublicacao?.value,
                linkOficial: linkOficial?.value
            });

            if (!entePublico || !entePublico.value) {
                console.error(' FALHOU: ente_publico vazio ou n√£o encontrado');
                alert('Por favor, informe o ente p√∫blico.');
                csGoToStep(1);
                entePublico?.focus();
                return false;
            }

            if (!tipo || !tipo.value) {
                console.error(' FALHOU: tipo vazio ou n√£o encontrado');
                alert('Por favor, selecione o tipo.');
                csGoToStep(1);
                tipo?.focus();
                return false;
            }

            if (!numeroProcesso || !numeroProcesso.value) {
                console.error(' FALHOU: numero_processo vazio ou n√£o encontrado');
                alert('Por favor, informe o n√∫mero do processo.');
                csGoToStep(1);
                numeroProcesso?.focus();
                return false;
            }

            const registroPrecos = document.querySelector('input[name="eh_registro_precos"]:checked');
            console.log('[VALIDACAO] Registro de pre√ßos checked:', registroPrecos?.value);
            if (!registroPrecos) {
                console.error(' FALHOU: eh_registro_precos n√£o selecionado');
                alert('Por favor, informe se √© um registro de pre√ßos.');
                csGoToStep(1);
                return false;
            }

            if (!dataPublicacao || !dataPublicacao.value) {
                console.error(' FALHOU: data_publicacao vazia ou n√£o encontrada');
                alert('Por favor, informe a data da publica√ß√£o.');
                csGoToStep(1);
                dataPublicacao?.focus();
                return false;
            }

            if (!linkOficial || !linkOficial.value) {
                console.error(' FALHOU: link_oficial vazio ou n√£o encontrado');
                alert('Por favor, informe o link oficial.');
                csGoToStep(1);
                linkOficial?.focus();
                return false;
            }

            console.log('[OK] Step 1 validado com sucesso');

            // Validar step 2: pelo menos 1 item selecionado
            const itensSelecionados = document.querySelectorAll('.cs-item-check:checked');
            console.log('[VALIDACAO] Itens selecionados:', itensSelecionados.length);
            if (itensSelecionados.length === 0) {
                console.error(' FALHOU: nenhum item selecionado');
                alert('Selecione pelo menos 1 item para continuar.');
                csGoToStep(2);
                return false;
            }

            console.log('[OK] Step 2 validado com sucesso');

            // Validar step 3: arquivo obrigat√≥rio
            const arquivoInput = document.getElementById('cs-arquivo-pdf');
            console.log('[VALIDACAO] Arquivo PDF:', arquivoInput?.files?.length, 'arquivo(s)');
            if (!arquivoInput || !arquivoInput.files || arquivoInput.files.length === 0) {
                console.error(' FALHOU: nenhum arquivo PDF selecionado');
                alert('Por favor, selecione o arquivo PDF da ARP.');
                csGoToStep(3);
                return false;
            }

            console.log('[OK] Step 3 validado com sucesso');
            console.log('üéâ TODAS AS VALIDA√á√ïES PASSARAM - Enviando formul√°rio...');
            return true;
        }

        csForm.addEventListener('submit', function(e) {
            e.preventDefault();

            if (!csValidateAllSteps()) return;

            const formData = new FormData(this);

            csBtnConcluir.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
            csBtnConcluir.disabled = true;

            fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/contratacoes-similares', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                }
            })
            .then(response => {
                console.log('üì° Resposta recebida:', {
                    status: response.status,
                    statusText: response.statusText,
                    contentType: response.headers.get('content-type')
                });

                // Se n√£o for 2xx, mostrar erro detalhado
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error(' Erro HTTP:', text.substring(0, 500));
                        throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}`);
                    });
                }

                // Verificar se √© JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        console.error(' Resposta n√£o √© JSON:', text.substring(0, 500));
                        throw new Error('Servidor retornou HTML ao inv√©s de JSON. Veja o console para detalhes.');
                    });
                }

                return response.json();
            })
            .then(data => {
                console.log('[OK] Dados recebidos:', data);
                if (data.success) {
                    alert('‚úì Contrata√ß√£o similar salva com sucesso!');
                    bootstrap.Modal.getInstance(csModal).hide();
                    location.reload();
                } else {
                    alert('Erro: ' + (data.message || 'N√£o foi poss√≠vel salvar a contrata√ß√£o.'));
                }
            })
            .catch(error => {
                console.error(' Erro completo:', error);
                alert('Erro ao salvar contrata√ß√£o:\n\n' + error.message + '\n\nVeja o console (F12) para mais detalhes.');
            })
            .finally(() => {
                csBtnConcluir.innerHTML = '<i class="fas fa-check-circle"></i> CONCLUIR';
                csBtnConcluir.disabled = false;
            });
        });
    } else {
        console.error('[CONTRATACOES] ERRO: Elementos nao encontrados!', {
            csModal: !!csModal,
            csBtnOpen: !!csBtnOpen,
            csForm: !!csForm
        });
    }

    // ========================================
    // GAP #3: AUTO-SAVE METODOLOGIAS (Se√ß√£o 2)
    // ========================================
    const radioMetodologias = document.querySelectorAll(
        'input[name="metodo_juizo_critico"], input[name="metodo_obtencao_preco"], input[name="casas_decimais"]'
    );

    radioMetodologias.forEach(radio => {
        radio.addEventListener('change', function() {
            const metodoJuizoCritico = document.querySelector('input[name="metodo_juizo_critico"]:checked')?.value;
            const metodoObtencaoPreco = document.querySelector('input[name="metodo_obtencao_preco"]:checked')?.value;
            const casasDecimais = document.querySelector('input[name="casas_decimais"]:checked')?.value;

            if (!metodoJuizoCritico || !metodoObtencaoPreco || !casasDecimais) return;

            fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/metodologias', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    metodo_juizo_critico: metodoJuizoCritico,
                    metodo_obtencao_preco: metodoObtencaoPreco,
                    casas_decimais: casasDecimais
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úì Metodologias salvas automaticamente');
                } else {
                    console.error('Erro ao salvar metodologias:', data.message);
                }
            })
            .catch(error => {
                console.error('Erro na requisi√ß√£o:', error);
            });
        });
    });

    // ========================================
    // GAP #2: EXCLUIR ITEM
    // ========================================
    document.querySelectorAll('.btn-excluir-item').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');

            if (!confirm('Tem certeza que deseja excluir este item?')) {
                return;
            }

            // Mostrar loading no bot√£o
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            this.disabled = true;

            fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/itens/' + itemId, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Recarregar para atualizar a lista
                } else {
                    alert('Erro: ' + data.message);
                    this.innerHTML = originalHTML;
                    this.disabled = false;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao excluir item. Tente novamente.');
                this.innerHTML = originalHTML;
                this.disabled = false;
            });
        });
    });

    // ========================================
    // GAP #1: EDITAR ITEM
    // ========================================
    let modalEditarItem = null;
    let currentEditItemId = null;

    // Criar modal de edi√ß√£o dinamicamente
    function criarModalEditarItem() {
        if (document.getElementById('modalEditarItem')) return;

        const modalHTML = `
        <div class="modal fade" id="modalEditarItem" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content" style="border-radius: 8px; border: none;">
                    <div class="modal-header" style="background: #0891b2; color: white; border-radius: 8px 8px 0 0;">
                        <h5 class="modal-title" style="font-weight: 700; font-size: 15px;">ALTERAR ITEM DO OR√áAMENTO</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="padding: 25px;">
                        <form id="formEditarItem">
                            <div class="mb-3">
                                <label class="form-label" style="font-weight: 600; font-size: 13px;">Descri√ß√£o*</label>
                                <textarea id="edit-descricao" class="form-control" rows="3" required style="font-size: 13px;"></textarea>
                                <small style="color: #6b7280; font-size: 11px;">Reproduza a descri√ß√£o constante do termo de refer√™ncia ou do projeto b√°sico.</small>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" style="font-weight: 600; font-size: 13px;">Medida de fornecimento*</label>
                                    <select id="edit-medida" class="form-select" required style="font-size: 13px;">
                                        <option value="">Selecione...</option>
                                        <option value="UNIDADE">Unidade</option>
                                        <option value="CAIXA">Caixa</option>
                                        <option value="METRO">Metro</option>
                                        <option value="LITRO">Litro</option>
                                        <option value="KG">Quilograma</option>
                                        <option value="PACOTE">Pacote</option>
                                        <option value="RESMA">Resma</option>
                                        <option value="M√äS">M√™s</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" style="font-weight: 600; font-size: 13px;">Quantidade*</label>
                                    <input type="number" id="edit-quantidade" class="form-control" step="0.0001" min="0.0001" required style="font-size: 13px;">
                                    <div style="margin-top: 8px;">
                                        <label style="font-size: 12px; margin-right: 15px;">
                                            <input type="radio" name="edit-tipo-quantidade" value="inteiro" checked> N¬∞ INTEIRO
                                        </label>
                                        <label style="font-size: 12px;">
                                            <input type="radio" name="edit-tipo-quantidade" value="fracionado"> FRACIONADO
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" style="font-weight: 600; font-size: 13px;">Indica√ß√£o de marca:</label>
                                <div>
                                    <label style="font-size: 12px; margin-right: 15px;">
                                        <input type="radio" name="edit-tipo-marca" value="referencia" checked> DE REFER√äNCIA
                                    </label>
                                    <label style="font-size: 12px;">
                                        <input type="radio" name="edit-tipo-marca" value="vinculativa"> VINCULATIVA
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" style="font-weight: 600; font-size: 13px;">Este item √© um:*</label>
                                <div>
                                    <label style="font-size: 12px; margin-right: 15px;">
                                        <input type="radio" name="edit-tipo" value="produto" required> PRODUTO
                                    </label>
                                    <label style="font-size: 12px;">
                                        <input type="radio" name="edit-tipo" value="servico" required> SERVI√áO
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" style="font-weight: 600; font-size: 13px;">Alterar os dados do item em CDFs, Entes P√∫blicos e Sites de com√©rcio eletr√¥nico?</label>
                                <div>
                                    <label style="font-size: 12px; margin-right: 15px;">
                                        <input type="radio" name="edit-alterar-cdf" value="1" required> SIM
                                    </label>
                                    <label style="font-size: 12px;">
                                        <input type="radio" name="edit-alterar-cdf" value="0" required checked> N√ÉO
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 15px 25px;">
                        <button type="button" id="btnSalvarEdicao" class="btn btn-primary" style="font-size: 13px; background: #0891b2; border: none; padding: 8px 24px;">
                            <i class="fas fa-save"></i> SALVAR
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 13px; padding: 8px 24px;">
                            <i class="fas fa-times"></i> FECHAR
                        </button>
                    </div>
                </div>
            </div>
        </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modalEditarItem = new bootstrap.Modal(document.getElementById('modalEditarItem'));
    }

    // Abrir modal ao clicar em editar
    document.querySelectorAll('.btn-editar-item').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            currentEditItemId = itemId;

            // Criar modal se n√£o existir
            criarModalEditarItem();

            // Buscar dados do item
            fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}', {
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                const item = data.itens.find(i => i.id == itemId);
                if (!item) {
                    alert('Item n√£o encontrado');
                    return;
                }

                // Preencher formul√°rio
                document.getElementById('edit-descricao').value = item.descricao || '';
                document.getElementById('edit-medida').value = item.medida_fornecimento || '';
                document.getElementById('edit-quantidade').value = item.quantidade || '';

                // Tipo de quantidade (inteiro/fracionado)
                const tipoQuantidade = item.tipo_quantidade || 'inteiro';
                document.querySelector(`input[name="edit-tipo-quantidade"][value="${tipoQuantidade}"]`).checked = true;

                // Tipo de marca (referencia/vinculativa)
                const tipoMarca = item.tipo_marca || 'referencia';
                document.querySelector(`input[name="edit-tipo-marca"][value="${tipoMarca}"]`).checked = true;

                // Tipo (produto/servi√ßo)
                document.querySelector(`input[name="edit-tipo"][value="${item.tipo}"]`).checked = true;

                // Alterar CDF
                document.querySelector(`input[name="edit-alterar-cdf"][value="${item.alterar_cdf ? '1' : '0'}"]`).checked = true;

                // Mostrar modal
                modalEditarItem.show();
            })
            .catch(error => {
                console.error('Erro ao buscar item:', error);
                alert('Erro ao carregar dados do item');
            });
        });
    });

    // Salvar edi√ß√£o
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'btnSalvarEdicao') {
            const form = document.getElementById('formEditarItem');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const btnSalvar = e.target;
            const originalHTML = btnSalvar.innerHTML;
            btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
            btnSalvar.disabled = true;

            const data = {
                descricao: document.getElementById('edit-descricao').value,
                medida_fornecimento: document.getElementById('edit-medida').value,
                quantidade: parseFloat(document.getElementById('edit-quantidade').value),
                tipo_quantidade: document.querySelector('input[name="edit-tipo-quantidade"]:checked').value,
                tipo_marca: document.querySelector('input[name="edit-tipo-marca"]:checked').value,
                tipo: document.querySelector('input[name="edit-tipo"]:checked').value,
                alterar_cdf: document.querySelector('input[name="edit-alterar-cdf"]:checked').value === '1'
            };

            fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/itens/' + currentEditItemId, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    modalEditarItem.hide();
                    location.reload(); // Recarregar para atualizar a lista
                } else {
                    alert('Erro: ' + data.message);
                    btnSalvar.innerHTML = originalHTML;
                    btnSalvar.disabled = false;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar. Tente novamente.');
                btnSalvar.innerHTML = originalHTML;
                btnSalvar.disabled = false;
            });
        }
    });
}); // Fim do DOMContentLoaded - CONTRATA√á√ïES SIMILARES

// ========================================
// FUNCIONALIDADE: SELECT ALL CHECKBOXES
// ========================================
(function() {
    const checkboxSelectAll = document.getElementById('checkbox-select-all');
    const checkboxesItems = document.querySelectorAll('.checkbox-item');

    if (!checkboxSelectAll || checkboxesItems.length === 0) return;

    // Evento no checkbox "selecionar todos"
    checkboxSelectAll.addEventListener('change', function() {
        const isChecked = this.checked;
        checkboxesItems.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    });

    // Evento nos checkboxes individuais (para desmarcar o "selecionar todos" se algum for desmarcado)
    checkboxesItems.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Se algum checkbox n√£o estiver marcado, desmarcar o "selecionar todos"
            const allChecked = Array.from(checkboxesItems).every(cb => cb.checked);
            checkboxSelectAll.checked = allChecked;
        });
    });
})();

// ========================================
// FUNCIONALIDADE: DROPDOWN ENGRENAGEM (Duplicar, Renumerar, Apagar)
// ========================================
(function() {
    const botoesEngrenagem = document.querySelectorAll('.btn-outras-opcoes');
    let dropdownAtual = null;

    // Criar dropdown para cada bot√£o engrenagem
    botoesEngrenagem.forEach(btn => {
        const itemId = btn.getAttribute('data-item-id');
        const container = btn.parentElement;

        // Criar menu dropdown
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-engrenagem';
        dropdown.style.cssText = `
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            z-index: 1000;
            display: none;
        `;

        dropdown.innerHTML = `
            <div style="padding: 4px 0;">
                <button type="button" class="dropdown-item-duplicar" data-item-id="${itemId}" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: white; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-copy" style="color: #3b82f6; width: 16px;"></i>
                    <span>Duplicar Item</span>
                </button>
                <button type="button" class="dropdown-item-renumerar" data-item-id="${itemId}" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: white; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-sort-numeric-down" style="color: #10b981; width: 16px;"></i>
                    <span>Renumerar</span>
                </button>
                <button type="button" class="dropdown-item-apagar" data-item-id="${itemId}" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: white; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #f3f4f6;">
                    <i class="fas fa-trash" style="color: #dc2626; width: 16px;"></i>
                    <span style="color: #dc2626;">Apagar</span>
                </button>
            </div>
        `;

        // Adicionar hover effect
        const items = dropdown.querySelectorAll('button[class^="dropdown-item"]');
        items.forEach(item => {
            item.addEventListener('mouseenter', function() {
                this.style.background = '#f3f4f6';
            });
            item.addEventListener('mouseleave', function() {
                this.style.background = 'white';
            });
        });

        container.appendChild(dropdown);

        // Toggle dropdown ao clicar no bot√£o
        btn.addEventListener('click', function(e) {
            e.stopPropagation();

            // Fechar dropdown atual se houver
            if (dropdownAtual && dropdownAtual !== dropdown) {
                dropdownAtual.style.display = 'none';
            }

            // Toggle do dropdown
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                dropdownAtual = dropdown;
            } else {
                dropdown.style.display = 'none';
                dropdownAtual = null;
            }
        });
    });

    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function() {
        if (dropdownAtual) {
            dropdownAtual.style.display = 'none';
            dropdownAtual = null;
        }
    });

    // ========================================
    // A√á√ïES DO DROPDOWN
    // ========================================

    // DUPLICAR ITEM
    document.addEventListener('click', function(e) {
        if (e.target.closest('.dropdown-item-duplicar')) {
            const itemId = e.target.closest('.dropdown-item-duplicar').getAttribute('data-item-id');
            console.log(' Duplicar item ID:', itemId);

            if (!confirm('Deseja duplicar este item?')) return;

            // Buscar dados do item atual
            fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}', {
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                const item = data.itens.find(i => i.id == itemId);
                if (!item) {
                    alert('Item n√£o encontrado');
                    return;
                }

                // Criar novo item duplicado
                const novoItem = {
                    descricao: item.descricao + ' (C√ìPIA)',
                    medida_fornecimento: item.medida_fornecimento,
                    quantidade: item.quantidade,
                    tipo_quantidade: item.tipo_quantidade || 'inteiro',
                    tipo_marca: item.tipo_marca || 'referencia',
                    tipo: item.tipo,
                    alterar_cdf: item.alterar_cdf || false,
                    lote_id: item.lote_id || null
                };

                // Enviar requisi√ß√£o para criar item duplicado
                fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/itens', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(novoItem)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success || result.item) {
                        alert('‚úì Item duplicado com sucesso!');
                        location.reload();
                    } else {
                        alert('Erro ao duplicar item: ' + (result.message || 'Erro desconhecido'));
                    }
                })
                .catch(error => {
                    console.error('Erro ao duplicar item:', error);
                    alert('Erro ao duplicar item. Tente novamente.');
                });
            })
            .catch(error => {
                console.error('Erro ao buscar item:', error);
                alert('Erro ao buscar dados do item.');
            });

            // Fechar dropdown
            if (dropdownAtual) {
                dropdownAtual.style.display = 'none';
                dropdownAtual = null;
            }
        }
    });

    // RENUMERAR
    document.addEventListener('click', async function(e) {
        if (e.target.closest('.dropdown-item-renumerar')) {
            const itemId = e.target.closest('.dropdown-item-renumerar').getAttribute('data-item-id');
            console.log('üî¢ Renumerar item ID:', itemId);

            const novoNumero = prompt('Digite o novo n√∫mero do item:');
            if (!novoNumero) return;

            // Validar se √© um n√∫mero
            const numeroInt = parseInt(novoNumero);
            if (isNaN(numeroInt) || numeroInt < 1) {
                alert('Digite um n√∫mero v√°lido maior que zero.');
                return;
            }

            // Fechar dropdown imediatamente
            if (dropdownAtual) {
                dropdownAtual.style.display = 'none';
                dropdownAtual = null;
            }

            try {
                const response = await fetch(`orcamentos/${orcamentoId}/itens/${itemId}/renumerar`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content || ''
                    },
                    body: JSON.stringify({ novo_numero: numeroInt })
                });

                const result = await response.json();

                if (result.success) {
                    // Mostrar mensagem de sucesso
                    if (window.mostrarNotificacao) {
                        window.mostrarNotificacao(result.message, 'success');
                    } else {
                        alert(result.message);
                    }

                    // Recarregar p√°gina ap√≥s 1 segundo
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    // Mostrar mensagem de erro
                    if (window.mostrarNotificacao) {
                        window.mostrarNotificacao(result.message, 'error');
                    } else {
                        alert(result.message);
                    }
                }
            } catch (error) {
                console.error('Erro ao renumerar item:', error);
                if (window.mostrarNotificacao) {
                    window.mostrarNotificacao('Erro ao renumerar item. Tente novamente.', 'error');
                } else {
                    alert('Erro ao renumerar item. Tente novamente.');
                }
            }
        }
    });

    // APAGAR ITEM
    document.addEventListener('click', function(e) {
        if (e.target.closest('.dropdown-item-apagar')) {
            const itemId = e.target.closest('.dropdown-item-apagar').getAttribute('data-item-id');
            console.log('[LIMPAR] Apagar item ID:', itemId);

            if (!confirm('[AVISO] Tem certeza que deseja APAGAR este item?\n\nEsta a√ß√£o n√£o pode ser desfeita.')) return;

            // Excluir item
            fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/itens/' + itemId, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úì Item exclu√≠do com sucesso!');
                    location.reload();
                } else {
                    alert('Erro ao excluir item: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro ao excluir item:', error);
                alert('Erro ao excluir item. Tente novamente.');
            });

            // Fechar dropdown
            if (dropdownAtual) {
                dropdownAtual.style.display = 'none';
                dropdownAtual = null;
            }
        }
    });
})();

// ========================================
// FUNCIONALIDADE: APAGAR ITENS MARCADOS
// ========================================
(function() {
    const btnApagarMarcados = document.getElementById('btn-apagar-marcados');
    if (!btnApagarMarcados) return;

    btnApagarMarcados.addEventListener('click', function() {
        const checkboxesMarcados = document.querySelectorAll('.checkbox-item:checked');

        if (checkboxesMarcados.length === 0) {
            alert('[AVISO] Nenhum item selecionado!\n\nMarque pelo menos um item para apagar.');
            return;
        }

        const quantidade = checkboxesMarcados.length;
        const confirmacao = confirm(` ATEN√á√ÉO!\n\nVoc√™ est√° prestes a APAGAR ${quantidade} item(ns) selecionado(s).\n\nEsta a√ß√£o n√£o pode ser desfeita.\n\nDeseja continuar?`);

        if (!confirmacao) return;

        // Mostrar loading
        const originalHTML = btnApagarMarcados.innerHTML;
        btnApagarMarcados.innerHTML = '<i class="fas fa-spinner fa-spin"></i> APAGANDO...';
        btnApagarMarcados.disabled = true;

        // Coletar IDs dos itens marcados
        const idsParaApagar = Array.from(checkboxesMarcados).map(cb => cb.getAttribute('data-item-id'));
        let itensApagados = 0;
        let erros = 0;

        // Apagar cada item
        const promises = idsParaApagar.map(itemId => {
            return fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/itens/' + itemId, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    itensApagados++;
                } else {
                    erros++;
                }
            })
            .catch(error => {
                console.error('Erro ao apagar item:', error);
                erros++;
            });
        });

        // Aguardar todas as requisi√ß√µes
        Promise.all(promises).then(() => {
            if (erros === 0) {
                alert(`‚úì Sucesso!\n\n${itensApagados} item(ns) apagado(s) com sucesso!`);
            } else {
                alert(` Aten√ß√£o!\n\nItens apagados: ${itensApagados}\nErros: ${erros}\n\nA p√°gina ser√° recarregada.`);
            }
            location.reload();
        });
    });
})();

// ========================================
// FUNCIONALIDADE: APAGAR TODOS OS ITENS
// ========================================
(function() {
    const btnApagarTodos = document.getElementById('btn-apagar-todos');
    if (!btnApagarTodos) return;

    btnApagarTodos.addEventListener('click', function() {
        const todosCheckboxes = document.querySelectorAll('.checkbox-item');

        if (todosCheckboxes.length === 0) {
            alert('[AVISO] N√£o h√° itens para apagar!');
            return;
        }

        const quantidade = todosCheckboxes.length;
        const confirmacao1 = confirm(` ATEN√á√ÉO M√ÅXIMA! \n\nVoc√™ est√° prestes a APAGAR TODOS OS ${quantidade} ITENS deste or√ßamento!\n\nEsta √© uma a√ß√£o IRREVERS√çVEL e PERIGOSA!\n\nTem CERTEZA ABSOLUTA?`);

        if (!confirmacao1) return;

        // Segunda confirma√ß√£o
        const confirmacao2 = confirm(`üõë √öLTIMA CONFIRMA√á√ÉO!\n\nDigite OK na pr√≥xima tela para confirmar a exclus√£o de TODOS OS ${quantidade} ITENS.\n\nContinuar?`);

        if (!confirmacao2) return;

        const digitacao = prompt('Digite "APAGAR TUDO" (sem aspas) para confirmar:');

        if (digitacao !== 'APAGAR TUDO') {
            alert('[ERRO] Opera√ß√£o cancelada!\n\nTexto de confirma√ß√£o incorreto.');
            return;
        }

        // Mostrar loading
        const originalHTML = btnApagarTodos.innerHTML;
        btnApagarTodos.innerHTML = '<i class="fas fa-spinner fa-spin"></i> APAGANDO TUDO...';
        btnApagarTodos.disabled = true;

        // Coletar IDs de todos os itens
        const idsParaApagar = Array.from(todosCheckboxes).map(cb => cb.getAttribute('data-item-id'));
        let itensApagados = 0;
        let erros = 0;

        // Apagar cada item
        const promises = idsParaApagar.map(itemId => {
            return fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/itens/' + itemId, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    itensApagados++;
                } else {
                    erros++;
                }
            })
            .catch(error => {
                console.error('Erro ao apagar item:', error);
                erros++;
            });
        });

        // Aguardar todas as requisi√ß√µes
        Promise.all(promises).then(() => {
            if (erros === 0) {
                alert(`‚úì Opera√ß√£o conclu√≠da!\n\nTODOS os ${itensApagados} itens foram apagados com sucesso!`);
            } else {
                alert(` Opera√ß√£o conclu√≠da com erros!\n\nItens apagados: ${itensApagados}\nErros: ${erros}\n\nA p√°gina ser√° recarregada.`);
            }
            location.reload();
        });
    });
})();


// ========================================
// FUNCIONALIDADE: MODAL AN√ÅLISE CR√çTICA
// ========================================
(function() {
    const modalAnalise = document.getElementById('modalAnaliseCritica');
    const btnsAnalise = document.querySelectorAll('.btn-analise');

    if (!modalAnalise) return;

    let itemAtualAnalise = null;

    // Abrir modal ao clicar no bot√£o an√°lise
    btnsAnalise.forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            itemAtualAnalise = itemId;

            // Buscar descri√ß√£o do item E amostras salvas
            Promise.all([
                fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}', {
                    headers: { 'Accept': 'application/json' }
                }).then(r => r.json()),
                fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/itens/' + itemId + '/amostras', {
                    headers: { 'Accept': 'application/json' }
                }).then(r => r.json())
            ])
            .then(([orcamentoData, amostrasData]) => {
                const item = orcamentoData.itens.find(i => i.id == itemId);
                if (item) {
                    document.getElementById('analise-item-descricao').textContent = item.descricao;
                }

                // Processar e exibir amostras salvas
                if (amostrasData.success && amostrasData.amostras && amostrasData.amostras.length > 0) {
                    const amostras = amostrasData.amostras;
                    console.log('[OK] Amostras carregadas do banco:', amostras.length);

                    // Calcular estat√≠sticas
                    const valores = amostras.map(a => parseFloat(a.valor_unitario || a.preco_unitario || 0));
                    const valoresOrdenados = valores.slice().sort((a,b) => a - b);
                    const total = valores.reduce((sum, v) => sum + v, 0);
                    const media = total / valores.length;
                    const mediana = calcularMediana(valoresOrdenados);
                    const minimo = Math.min(...valores);

                    // Calcular desvio padr√£o
                    const variancia = valores.reduce((sum, v) => sum + Math.pow(v - media, 2), 0) / valores.length;
                    const desvioPadrao = Math.sqrt(variancia);
                    const coefVariacao = (desvioPadrao / media) * 100;

                    // Fun√ß√£o auxiliar segura para atualizar elemento
                    const atualizarElemento = (id, valor) => {
                        const elem = document.getElementById(id);
                        if (elem) elem.textContent = valor;
                    };

                    // Atualizar "Ju√≠zo Cr√≠tico"
                    atualizarElemento('analise-juizo-num-amostras', amostras.length);
                    atualizarElemento('analise-juizo-media', 'R$ ' + media.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-juizo-desvio', desvioPadrao.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-juizo-limite-inf', 'R$ ' + (media - desvioPadrao).toFixed(2).replace('.', ',') + ' (DP - m√©dia)');
                    atualizarElemento('analise-juizo-limite-sup', 'R$ ' + (media + desvioPadrao).toFixed(2).replace('.', ',') + ' (DP + m√©dia)');

                    // Atualizar "M√©todo Estat√≠stico"
                    atualizarElemento('analise-metodo-num-validas', amostras.length);
                    atualizarElemento('analise-metodo-desvio', desvioPadrao.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-metodo-coef-var', coefVariacao.toFixed(2).replace('.', ',') + '%');
                    atualizarElemento('analise-metodo-menor', 'R$ ' + minimo.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-metodo-media', 'R$ ' + media.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-metodo-mediana', 'R$ ' + mediana.toFixed(2).replace('.', ','));

                    // Atualizar "M√©todo Estat√≠stico Final"
                    atualizarElemento('analise-final-mediana', 'R$ ' + mediana.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-final-media', 'R$ ' + media.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-final-menor', 'R$ ' + minimo.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-final-tendencia', 'R$ ' + mediana.toFixed(2).replace('.', ','));

                    // Mostrar tabela e ocultar mensagem vazia
                    const serieVazia = document.getElementById('analise-serie-vazia');
                    const serieTabela = document.getElementById('analise-serie-tabela');
                    if (serieVazia) serieVazia.style.display = 'none';
                    if (serieTabela) serieTabela.style.display = 'block';

                    // Exibir tabela de amostras
                    const tbody = document.getElementById('analise-serie-tbody');
                    if (tbody) {
                        tbody.innerHTML = '';
                        amostras.forEach((a, idx) => {
                            const tr = document.createElement('tr');
                            tr.style.textAlign = 'center';
                            tr.innerHTML = `
                                <td>${idx + 1}</td>
                                <td><span class="badge bg-success">V√ÅLIDA</span></td>
                                <td style="text-align: left;">${a.fonte || 'N√£o especificada'} - ${a.orgao || 'N/A'}</td>
                                <td>${a.marca || '-'}</td>
                                <td>${a.data_cotacao || a.data || '-'}</td>
                                <td>${a.medida_fornecimento || 'UN'}</td>
                                <td style="text-align: right;">${a.quantidade || 1}</td>
                                <td style="text-align: right;">R$ ${parseFloat(a.valor_unitario || a.preco_unitario || 0).toFixed(2).replace('.', ',')}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" style="font-size: 10px; padding: 2px 6px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                } else {
                    console.log('[AVISO] Nenhuma amostra salva para este item');

                    // VERIFICAR SE O ITEM TEM PRE√áO UNIT√ÅRIO
                    const precoUnitario = parseFloat(amostrasData.item?.preco_unitario || 0);

                    // Fun√ß√£o auxiliar segura para atualizar elemento
                    const zerarElemento = (id, valor) => {
                        const elem = document.getElementById(id);
                        if (elem) elem.textContent = valor;
                    };

                    if (precoUnitario > 0) {
                        // TEM PRE√áO UNIT√ÅRIO ‚Üí Mostrar 1 amostra com o valor do pr√≥prio item
                        console.log('[OK] Item tem pre√ßo unit√°rio: R$', precoUnitario.toFixed(2));

                        const precoFormatado = 'R$ ' + precoUnitario.toFixed(2).replace('.', ',');

                        // Atualizar estat√≠sticas com 1 amostra (o pr√≥prio item)
                        zerarElemento('analise-juizo-num-amostras', '1');
                        zerarElemento('analise-juizo-media', precoFormatado);
                        zerarElemento('analise-juizo-desvio', '0,00');
                        zerarElemento('analise-juizo-limite-inf', precoFormatado + ' (DP - m√©dia)');
                        zerarElemento('analise-juizo-limite-sup', precoFormatado + ' (DP + m√©dia)');

                        zerarElemento('analise-metodo-num-validas', '1');
                        zerarElemento('analise-metodo-desvio', '0,00');
                        zerarElemento('analise-metodo-coef-var', '0,00%');
                        zerarElemento('analise-metodo-menor', precoFormatado);
                        zerarElemento('analise-metodo-media', precoFormatado);
                        zerarElemento('analise-metodo-mediana', precoFormatado);

                        zerarElemento('analise-final-mediana', precoFormatado);
                        zerarElemento('analise-final-media', precoFormatado);
                        zerarElemento('analise-final-menor', precoFormatado);
                        zerarElemento('analise-final-tendencia', precoFormatado);

                        // Mostrar tabela com 1 amostra (o pr√≥prio item)
                        const serieVazia = document.getElementById('analise-serie-vazia');
                        const serieTabela = document.getElementById('analise-serie-tabela');
                        if (serieVazia) serieVazia.style.display = 'none';
                        if (serieTabela) serieTabela.style.display = 'block';

                        const tbody = document.getElementById('analise-serie-tbody');
                        if (tbody) {
                            tbody.innerHTML = '';
                            const tr = document.createElement('tr');
                            tr.style.textAlign = 'center';
                            tr.innerHTML = `
                                <td>1</td>
                                <td><span class="badge bg-success">V√ÅLIDA</span></td>
                                <td style="text-align: left;">Valor do pr√≥prio item (j√° cadastrado)</td>
                                <td>-</td>
                                <td>${new Date().toLocaleDateString('pt-BR')}</td>
                                <td>${amostrasData.item?.medida_fornecimento || 'UN'}</td>
                                <td style="text-align: right;">${amostrasData.item?.quantidade || 1}</td>
                                <td style="text-align: right;">${precoFormatado}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" disabled style="font-size: 10px; padding: 2px 6px;">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        }
                    } else {
                        // N√ÉO TEM PRE√áO UNIT√ÅRIO ‚Üí Zerar tudo
                        console.log('[AVISO] Item n√£o tem pre√ßo unit√°rio');

                        zerarElemento('analise-juizo-num-amostras', '0');
                        zerarElemento('analise-juizo-media', 'R$ 0,00');
                        zerarElemento('analise-juizo-desvio', '0,00');
                        zerarElemento('analise-juizo-limite-inf', 'R$ 0,00 (DP - m√©dia)');
                        zerarElemento('analise-juizo-limite-sup', 'R$ 0,00 (DP + m√©dia)');
                        zerarElemento('analise-metodo-num-validas', '0');
                        zerarElemento('analise-metodo-desvio', '0,00');
                        zerarElemento('analise-metodo-coef-var', '0,00%');
                        zerarElemento('analise-metodo-menor', 'R$ 0,00');
                        zerarElemento('analise-metodo-media', 'R$ 0,00');
                        zerarElemento('analise-metodo-mediana', 'R$ 0,00');
                        zerarElemento('analise-final-mediana', 'R$ 0,00');
                        zerarElemento('analise-final-media', 'R$ 0,00');
                        zerarElemento('analise-final-menor', 'R$ 0,00');
                        zerarElemento('analise-final-tendencia', 'R$ 0,00');

                        // Mostrar mensagem vazia e ocultar tabela
                        const serieVazia = document.getElementById('analise-serie-vazia');
                        const serieTabela = document.getElementById('analise-serie-tabela');
                        if (serieVazia) serieVazia.style.display = 'block';
                        if (serieTabela) serieTabela.style.display = 'none';
                    }
                }
            })
            .catch(err => {
                console.error(' Erro ao carregar dados:', err);
                alert('Erro ao carregar dados da an√°lise cr√≠tica.');
            });

            // Abrir modal
            const modalInstance = new bootstrap.Modal(modalAnalise);
            modalInstance.show();
        });
    });

    // Fun√ß√£o auxiliar para calcular mediana
    function calcularMediana(valores) {
        const meio = Math.floor(valores.length / 2);
        if (valores.length % 2 === 0) {
            return (valores[meio - 1] + valores[meio]) / 2;
        }
        return valores[meio];
    }

    // Bot√£o Justificativa/Observa√ß√£o
    const btnJustificativa = document.getElementById('analise-btn-justificativa');
    if (btnJustificativa) {
        btnJustificativa.addEventListener('click', function() {
            const justificativa = prompt('Digite a justificativa ou observa√ß√£o para este item:');

            if (justificativa && justificativa.trim()) {
                console.log('[DADOS] Justificativa salva:', justificativa);
                alert('‚úì Justificativa salva com sucesso!');

                // Em produ√ß√£o, salvar no backend
                // fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/itens/' + itemAtualAnalise + '/justificativa', ...)
            }
        });
    }

    // ============================================================
    // SE√á√ÉO 6: DADOS DO OR√áAMENTISTA - CPF/CNPJ e ReceitaWS
    // ============================================================

// Usar window.onload ao inves de DOMContentLoaded para garantir que tudo esta carregado
window.addEventListener('load', function() {
    console.log('[ORCAMENTISTA] Window load disparado - inicializando...');

    const inputCpfCnpj = document.getElementById('orcamentista_cpf_cnpj');
    const feedbackCpfCnpj = document.getElementById('cpf-cnpj-feedback');
    const brasaoContainer = document.getElementById('brasao-upload-container');
    const btnSalvarOrcamentista = document.getElementById('btn-salvar-orcamentista');

    console.log('[ORCAMENTISTA] Elementos encontrados:', {
        inputCpfCnpj: !!inputCpfCnpj,
        feedbackCpfCnpj: !!feedbackCpfCnpj,
        brasaoContainer: !!brasaoContainer,
        btnSalvarOrcamentista: !!btnSalvarOrcamentista
    });

    // Fun√ß√£o para aplicar m√°scara de CPF/CNPJ
    function aplicarMascaraCpfCnpj(valor) {
        // Remove tudo que n√£o √© n√∫mero
        valor = valor.replace(/\D/g, '');

        if (valor.length <= 11) {
            // M√°scara de CPF: 000.000.000-00
            valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
            valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
            valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        } else {
            // M√°scara de CNPJ: 00.000.000/0000-00
            valor = valor.replace(/^(\d{2})(\d)/, '$1.$2');
            valor = valor.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            valor = valor.replace(/\.(\d{3})(\d)/, '.$1/$2');
            valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
        }

        return valor;
    }

    // Fun√ß√£o para validar CPF
    function validarCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');

        if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) {
            return false;
        }

        let soma = 0;
        let resto;

        for (let i = 1; i <= 9; i++) {
            soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
        }

        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.substring(9, 10))) return false;

        soma = 0;
        for (let i = 1; i <= 10; i++) {
            soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
        }

        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.substring(10, 11))) return false;

        return true;
    }

    // Fun√ß√£o para validar CNPJ
    function validarCNPJ(cnpj) {
        cnpj = cnpj.replace(/\D/g, '');

        if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) {
            return false;
        }

        let tamanho = cnpj.length - 2;
        let numeros = cnpj.substring(0, tamanho);
        let digitos = cnpj.substring(tamanho);
        let soma = 0;
        let pos = tamanho - 7;

        for (let i = tamanho; i >= 1; i--) {
            soma += numeros.charAt(tamanho - i) * pos--;
            if (pos < 2) pos = 9;
        }

        let resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
        if (resultado != digitos.charAt(0)) return false;

        tamanho = tamanho + 1;
        numeros = cnpj.substring(0, tamanho);
        soma = 0;
        pos = tamanho - 7;

        for (let i = tamanho; i >= 1; i--) {
            soma += numeros.charAt(tamanho - i) * pos--;
            if (pos < 2) pos = 9;
        }

        resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
        if (resultado != digitos.charAt(1)) return false;

        return true;
    }

    // =================================================================
    // BUSCA AUTOM√ÅTICA POR CEP (ViaCEP API)
    // =================================================================
    async function buscarCEP(cep) {
        const cepLimpo = cep.replace(/\D/g, '');

        // Validar CEP (8 d√≠gitos)
        if (cepLimpo.length !== 8) {
            return;
        }

        console.log('[BUSCA] Buscando CEP:', cepLimpo);

        try {
            const response = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
            const data = await response.json();

            if (data.erro) {
                console.warn(' CEP n√£o encontrado');
                return;
            }

            console.log('[OK] CEP encontrado:', data);

            // Preencher campos VIS√çVEIS automaticamente
            if (data.uf) {
                document.getElementById('orcamentista_uf_manual').value = data.uf;
                document.getElementById('orcamentista_uf').value = data.uf; // hidden
            }

            if (data.logradouro) {
                const enderecoCompleto = `${data.logradouro}, ${data.bairro}, ${data.localidade}`;
                document.getElementById('orcamentista_endereco_manual').value = enderecoCompleto;
                document.getElementById('orcamentista_endereco').value = enderecoCompleto; // hidden
            }

            if (data.localidade) {
                document.getElementById('orcamentista_cidade').value = data.localidade; // hidden
            }

            console.log('[OK] Campos preenchidos automaticamente via CEP!');

        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
        }
    }

    // =================================================================
    // BUSCA AUTOM√ÅTICA POR CNPJ (ReceitaWS via Backend)
    // =================================================================
    async function buscarDadosCNPJ(cnpj) {
        const cnpjLimpo = cnpj.replace(/\D/g, '');

        feedbackCpfCnpj.innerHTML = '<span style="color: #2563eb;"><i class="fas fa-spinner fa-spin"></i> Consultando CNPJ...</span>';

        try {
            // Chamar endpoint do backend ao inv√©s de ReceitaWS direto
            const response = await fetch(window.APP_BASE_PATH + '/orcamentos/consultar-cnpj/' + cnpjLimpo);
            const result = await response.json();

            if (!response.ok || !result.success) {
                feedbackCpfCnpj.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> ' + (result.message || 'CNPJ n√£o encontrado') + '</span>';
                limparDadosReceitaWS();
                return;
            }

            const data = result.data;

            console.log('üìÑ Dados CNPJ recebidos:', data);

            // Preencher campo VIS√çVEL de nome com a raz√£o social
            document.getElementById('orcamentista_nome').value = data.razao_social || data.nome || '';

            //  PREENCHER CAMPOS VIS√çVEIS (novos!)
            if (data.cep) {
                document.getElementById('orcamentista_cep_manual').value = data.cep;
                document.getElementById('orcamentista_cep').value = data.cep; // hidden
            }

            if (data.uf) {
                document.getElementById('orcamentista_uf_manual').value = data.uf;
                document.getElementById('orcamentista_uf').value = data.uf; // hidden
            }

            if (data.endereco) {
                document.getElementById('orcamentista_endereco_manual').value = data.endereco;
                document.getElementById('orcamentista_endereco').value = data.endereco; // hidden
            }

            // Preencher campos hidden com dados da ReceitaWS
            document.getElementById('orcamentista_razao_social').value = data.razao_social || '';
            document.getElementById('orcamentista_cidade').value = data.municipio || '';

            // Mostrar container de bras√£o (se existir)
            if (brasaoContainer) {
                brasaoContainer.style.display = 'block';
            }

            feedbackCpfCnpj.innerHTML = '<span style="color: #16a34a;"><i class="fas fa-check-circle"></i> CNPJ v√°lido - Dados preenchidos automaticamente!</span>';

            console.log('[OK] Campos preenchidos automaticamente via CNPJ!');

            // Auto-salvar os dados do or√ßamentista ap√≥s consultar CNPJ
            await salvarDadosAutomaticamente(true); // true = mostrar modal ap√≥s salvar

        } catch (error) {
            console.error('Erro ao consultar CNPJ:', error);
            feedbackCpfCnpj.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-exclamation-triangle"></i> Erro ao consultar CNPJ. Tente novamente.</span>';
            limparDadosReceitaWS();
        }
    }

    // Fun√ß√£o para salvar dados automaticamente ap√≥s buscar CNPJ ou preencher campos
    async function salvarDadosAutomaticamente(exibirModal = false) {
        try {
            // Validar se nome est√° preenchido
            const nome = document.getElementById('orcamentista_nome').value.trim();
            if (!nome) {
                console.log('[INFO] Nome do orcamentista nao preenchido. Salvamento automatico cancelado.');
                return;
            }

            // Preparar FormData
            const formData = new FormData(document.getElementById('form-orcamentista'));

            // Fazer requisi√ß√£o silenciosa
            const response = await fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/salvar-orcamentista', {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                },
                body: formData
            });

            const result = await response.json();

            if (response.ok && result.success) {
                console.log('[OK] Dados do or√ßamentista salvos automaticamente:', result.data);

                //  NOVO: Exibir modal de confirma√ß√£o se solicitado
                if (exibirModal) {
                    const modalElement = document.getElementById('modalSucessoSalvamento');
                    if (modalElement) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                        // Auto-fechar ap√≥s 2 segundos
                        setTimeout(() => modal.hide(), 2000);
                    } else {
                        console.error('[ERRO] Modal modalSucessoSalvamento nao encontrado!');
                        // Fallback: alert simples se modal n√£o existir
                        alert('[OK] Dados do or√ßamentista salvos com sucesso!');
                    }
                }

                feedbackCpfCnpj.innerHTML = '<span style="color: #16a34a;"><i class="fas fa-check-circle"></i> CNPJ v√°lido - Dados salvos com sucesso!</span>';
            } else {
                console.warn(' Erro ao salvar dados automaticamente:', result.message);
            }

        } catch (error) {
            console.error('Erro ao salvar dados automaticamente:', error);
        }
    }

    // Fun√ß√£o para limpar dados da ReceitaWS
    function limparDadosReceitaWS() {
        document.getElementById('orcamentista_razao_social').value = '';
        document.getElementById('orcamentista_endereco').value = '';
        document.getElementById('orcamentista_cep').value = '';
        document.getElementById('orcamentista_cidade').value = '';
        document.getElementById('orcamentista_uf').value = '';
        if (brasaoContainer) {
            brasaoContainer.style.display = 'none';
        }
    }

    // Event listener para CPF/CNPJ input
    if (inputCpfCnpj) {
        console.log('[ORCAMENTISTA] Event listener adicionado ao campo CPF/CNPJ');

        inputCpfCnpj.addEventListener('input', function(e) {
            console.log('[ORCAMENTISTA] Evento input disparado. Valor:', this.value);

            // Aplicar m√°scara
            this.value = aplicarMascaraCpfCnpj(this.value);

            const valorLimpo = this.value.replace(/\D/g, '');
            console.log('[ORCAMENTISTA] Valor limpo:', valorLimpo, 'Tamanho:', valorLimpo.length);

            // Limpar feedback se estiver digitando
            if (valorLimpo.length < 11) {
                feedbackCpfCnpj.innerHTML = '';
                limparDadosReceitaWS();
                return;
            }

            // Validar CPF (11 d√≠gitos)
            if (valorLimpo.length === 11) {
                if (validarCPF(this.value)) {
                    feedbackCpfCnpj.innerHTML = '<span style="color: #16a34a;"><i class="fas fa-check-circle"></i> CPF v√°lido - Digite o nome completo abaixo</span>';
                    limparDadosReceitaWS(); // CPF n√£o tem dados da ReceitaWS

                    // Focar automaticamente no campo de nome para facilitar
                    const campoNome = document.getElementById('orcamentista_nome');
                    if (campoNome) {
                        setTimeout(() => {
                            campoNome.focus();
                            campoNome.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Destacar campo temporariamente
                            const originalBorder = campoNome.style.border;
                            campoNome.style.border = '2px solid #16a34a';
                            campoNome.style.transition = 'border 0.3s';
                            setTimeout(() => {
                                campoNome.style.border = originalBorder;
                            }, 2000);
                        }, 300);
                    }
                } else {
                    feedbackCpfCnpj.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> CPF inv√°lido</span>';
                    limparDadosReceitaWS();
                }
                return;
            }

            // Validar CNPJ (14 d√≠gitos)
            if (valorLimpo.length === 14) {
                console.log('[ORCAMENTISTA] 14 digitos detectados - validando CNPJ...');
                const cnpjValido = validarCNPJ(this.value);
                console.log('[ORCAMENTISTA] CNPJ valido?', cnpjValido);

                if (cnpjValido) {
                    feedbackCpfCnpj.innerHTML = '<span style="color: #16a34a;"><i class="fas fa-check-circle"></i> CNPJ v√°lido</span>';
                    // Buscar dados automaticamente
                    console.log('[ORCAMENTISTA] Iniciando busca de dados do CNPJ...');
                    buscarDadosCNPJ(this.value);
                } else {
                    feedbackCpfCnpj.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> CNPJ inv√°lido</span>';
                    limparDadosReceitaWS();
                }
                return;
            }

            // Mais de 14 d√≠gitos
            if (valorLimpo.length > 14) {
                feedbackCpfCnpj.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> N√∫mero inv√°lido</span>';
                limparDadosReceitaWS();
            }
        });
    }

    // =================================================================
    // EVENT LISTENERS: AUTO-SAVE NOS CAMPOS DO OR√áAMENTISTA
    // =================================================================
    // Auto-save silencioso quando o usu√°rio preencher qualquer campo e sair dele (blur)
    const camposAutoSave = ['orcamentista_nome', 'orcamentista_cep_manual', 'orcamentista_uf_manual', 'orcamentista_endereco_manual'];

    camposAutoSave.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            let autoSaveTimeout;

            // Evento blur: quando o usu√°rio sai do campo
            field.addEventListener('blur', function() {
                clearTimeout(autoSaveTimeout);

                // Debounce de 500ms para evitar m√∫ltiplas chamadas
                autoSaveTimeout = setTimeout(async () => {
                    const valorCampo = this.value.trim();

                    // S√≥ salvar se o campo tiver conte√∫do
                    if (valorCampo.length > 0) {
                        console.log(`[LOG]ÔøΩÔøΩÔøΩ Auto-salvando dados do or√ßamentista (campo: ${fieldId})...`);
                        await salvarDadosAutomaticamente(false); // false = salvamento silencioso, sem modal
                    }
                }, 500);
            });
        }
    });

    // =================================================================
    // EVENT LISTENER: BUSCA AUTOM√ÅTICA POR CEP
    // =================================================================
    const inputCep = document.getElementById('orcamentista_cep_manual');
    if (inputCep) {
        inputCep.addEventListener('input', function(e) {
            // Aplicar m√°scara de CEP (00.000-000 ou 00000-000)
            let valor = this.value.replace(/\D/g, '');
            if (valor.length > 8) {
                valor = valor.substring(0, 8);
            }

            // Aplicar m√°scara
            if (valor.length > 5) {
                this.value = valor.substring(0, 5) + '-' + valor.substring(5);
            } else {
                this.value = valor;
            }

            // Buscar automaticamente quando tiver 8 d√≠gitos
            if (valor.length === 8) {
                buscarCEP(valor);
            }
        });
    }

    // Salvar dados do or√ßamentista via AJAX
    if (btnSalvarOrcamentista) {
        btnSalvarOrcamentista.addEventListener('click', async function(e) {
            e.preventDefault();

            // Validar campos obrigat√≥rios
            const nome = document.getElementById('orcamentista_nome').value.trim();
            const cpfCnpj = document.getElementById('orcamentista_cpf_cnpj').value.trim();

            if (!nome) {
                alert('[ERRO] Por favor, preencha o nome do or√ßamentista.');
                document.getElementById('orcamentista_nome').focus();
                return;
            }

            if (!cpfCnpj) {
                alert('[ERRO] Por favor, preencha o CPF ou CNPJ.');
                document.getElementById('orcamentista_cpf_cnpj').focus();
                return;
            }

            // Validar CPF/CNPJ
            const cpfCnpjLimpo = cpfCnpj.replace(/\D/g, '');
            if (cpfCnpjLimpo.length === 11) {
                if (!validarCPF(cpfCnpj)) {
                    alert('[ERRO] CPF inv√°lido. Por favor, verifique.');
                    document.getElementById('orcamentista_cpf_cnpj').focus();
                    return;
                }
            } else if (cpfCnpjLimpo.length === 14) {
                if (!validarCNPJ(cpfCnpj)) {
                    alert('[ERRO] CNPJ inv√°lido. Por favor, verifique.');
                    document.getElementById('orcamentista_cpf_cnpj').focus();
                    return;
                }
            } else {
                alert('[ERRO] CPF/CNPJ inv√°lido. CPF deve ter 11 d√≠gitos e CNPJ 14 d√≠gitos.');
                document.getElementById('orcamentista_cpf_cnpj').focus();
                return;
            }

            // Preparar FormData
            const formData = new FormData(document.getElementById('form-orcamentista'));

            // Sobrescrever campos com valores manuais se preenchidos
            const cepManual = document.getElementById('orcamentista_cep_manual')?.value.trim();
            const ufManual = document.getElementById('orcamentista_uf_manual')?.value.trim();
            const enderecoManual = document.getElementById('orcamentista_endereco_manual')?.value.trim();

            if (cepManual) {
                formData.set('orcamentista_cep', cepManual);
            }
            if (ufManual) {
                formData.set('orcamentista_uf', ufManual);
            }
            if (enderecoManual) {
                formData.set('orcamentista_endereco', enderecoManual);
            }

            // Adicionar arquivo de bras√£o se houver
            const brasaoFile = document.getElementById('brasao_file');
            if (brasaoFile && brasaoFile.files.length > 0) {
                formData.append('brasao_file', brasaoFile.files[0]);
            }

            // Desabilitar bot√£o
            this.disabled = true;
            const textoOriginal = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

            try {
                const response = await fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/salvar-orcamentista', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    //  Exibir modal de sucesso ao inv√©s de alert
                    const modalElement = document.getElementById('modalSucessoSalvamento');
                    if (modalElement) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                        // Auto-fechar e recarregar ap√≥s 2 segundos
                        setTimeout(() => {
                            modal.hide();
                            window.location.reload();
                        }, 2000);
                    } else {
                        console.error('[ERRO] Modal modalSucessoSalvamento nao encontrado!');
                        alert('[OK] Dados do or√ßamentista salvos com sucesso!');
                        window.location.reload();
                    }

                    console.log('[OK] Dados do or√ßamentista salvos:', result.data);
                } else {
                    alert('[ERRO] ' + (result.message || 'Erro ao salvar dados do or√ßamentista'));
                }

            } catch (error) {
                console.error('Erro ao salvar or√ßamentista:', error);
                alert('[ERRO] Erro ao salvar dados. Verifique sua conex√£o e tente novamente.');
            } finally {
                // Reabilitar bot√£o
                this.disabled = false;
                this.innerHTML = textoOriginal;
            }
        });
    }
}); // Fim do DOMContentLoaded - SE√á√ÉO OR√áAMENTISTA

// ===== BOT√ïES DE A√á√ÉO DA CDF =====
(function() {
    // Toggle dropdown da engrenagem
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-dropdown-cdf')) {
            const btn = e.target.closest('.btn-dropdown-cdf');
            const cdfId = btn.getAttribute('data-cdf-id');
            const dropdown = document.getElementById('dropdown-cdf-' + cdfId);

            // Fechar outros dropdowns
            document.querySelectorAll('.dropdown-menu-cdf').forEach(d => {
                if (d !== dropdown) d.style.display = 'none';
            });

            // Toggle dropdown atual
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            e.stopPropagation();
        }
    });

    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown-menu-cdf') && !e.target.closest('.btn-dropdown-cdf')) {
            document.querySelectorAll('.dropdown-menu-cdf').forEach(d => d.style.display = 'none');
        }
    });

    // Handler dos bot√µes de a√ß√£o
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.btn-icon-acao');
        if (!btn) return;

        const action = btn.getAttribute('data-action');
        const cdfId = btn.getAttribute('data-cdf-id');

        console.log('A√ß√£o CDF:', action, 'ID:', cdfId);

        switch(action) {
            case 'baixar-oficio':
                baixarOficioCDF(cdfId);
                break;
            case 'baixar-formulario':
                baixarFormularioCDF(cdfId);
                break;
            case 'primeiro-passo':
                abrirModalPrimeiroPasso(cdfId);
                break;
            case 'baixar-cnpj':
                baixarEspelhoCNPJ(cdfId);
                break;
            case 'baixar-comprovante':
                baixarComprovanteCDF(cdfId);
                break;
            case 'baixar-cotacao':
                baixarCotacaoCDF(cdfId);
                break;
            case 'gerenciar':
                abrirModalGerenciar(cdfId);
                break;
            case 'remover':
                removerCDF(cdfId);
                break;
        }
    });

    // Fun√ß√µes de a√ß√£o
    function baixarOficioCDF(cdfId) {
        window.location.href = window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/cdf/' + cdfId + '/baixar-oficio';
    }

    function baixarFormularioCDF(cdfId) {
        window.location.href = window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/cdf/' + cdfId + '/baixar-formulario';
    }

    function abrirModalPrimeiroPasso(cdfId) {
        // Buscar dados da CDF
        fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/cdf/' + cdfId, {
            headers: { 'Accept': 'application/json' }
        })
        .then(response => response.json())
        .then(cdf => {
            // Preencher dados no modal
            document.getElementById('primeiro_passo_cdf_id').value = cdf.id;
            document.getElementById('modal_cdf_numero').textContent = String(cdf.id).padStart(2, '0') + '/2025';
            document.getElementById('modal_cdf_fornecedor').textContent = cdf.razao_social || cdf.fornecedor_nome || 'N/A';
            document.getElementById('modal_cdf_situacao').textContent = cdf.status || 'Pendente';

            // Abrir modal usando Bootstrap 5 API (sem jQuery)
            const modal = new bootstrap.Modal(document.getElementById('modalPrimeiroPasso'));
            modal.show();
        })
        .catch(error => {
            console.error('Erro ao buscar CDF:', error);
            alert('[ERRO] Erro ao carregar dados da CDF');
        });
    }

    function baixarEspelhoCNPJ(cdfId) {
        window.location.href = window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/cdf/' + cdfId + '/baixar-cnpj';
    }

    function baixarComprovanteCDF(cdfId) {
        window.location.href = window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/cdf/' + cdfId + '/baixar-comprovante';
    }

    function baixarCotacaoCDF(cdfId) {
        window.location.href = window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/cdf/' + cdfId + '/baixar-cotacao';
    }

    function abrirModalGerenciar(cdfId) {
        // Buscar dados da CDF
        fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/cdf/' + cdfId, {
            headers: { 'Accept': 'application/json' }
        })
        .then(response => response.json())
        .then(cdf => {
            // Preencher dados no modal
            document.getElementById('gerenciar_cdf_id').value = cdf.id;
            document.getElementById('modal_ger_cdf_numero').textContent = String(cdf.id).padStart(2, '0') + '/2025';
            document.getElementById('modal_ger_cdf_fornecedor').textContent = cdf.razao_social || cdf.fornecedor_nome || 'N/A';

            // Abrir modal usando Bootstrap 5 API (sem jQuery)
            const modal = new bootstrap.Modal(document.getElementById('modalGerenciarCDF'));
            modal.show();
        })
        .catch(error => {
            console.error('Erro ao buscar CDF:', error);
            alert('[ERRO] Erro ao carregar dados da CDF');
        });
    }

    function removerCDF(cdfId) {
        if (!confirm('Tem certeza que deseja remover esta CDF?')) return;

        fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/cdf/' + cdfId, {
            method: 'DELETE',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('[OK] CDF removida com sucesso!');
                location.reload();
            } else {
                alert('[ERRO] ' + (result.message || 'Erro ao remover CDF'));
            }
        })
        .catch(error => {
            console.error('Erro ao remover CDF:', error);
            alert('[ERRO] Erro ao remover CDF');
        });
    }

    // Handler do dropdown
    document.addEventListener('click', function(e) {
        if (e.target.closest('[data-action="alterar-primeiro-passo"]')) {
            e.preventDefault();
            const cdfId = e.target.getAttribute('data-cdf-id');
            alert('Alterar 1¬∫ Passo - CDF ID: ' + cdfId);
            document.querySelectorAll('.dropdown-menu-cdf').forEach(d => d.style.display = 'none');
        }

        if (e.target.closest('[data-action="segundo-passo"]')) {
            e.preventDefault();
            const cdfId = e.target.getAttribute('data-cdf-id');
            abrirModalSegundoPasso(cdfId);
            document.querySelectorAll('.dropdown-menu-cdf').forEach(d => d.style.display = 'none');
        }
    });

    // Handler: Enviar Primeiro Passo
    document.getElementById('btnEnviarPrimeiroPasso') && document.getElementById('btnEnviarPrimeiroPasso').addEventListener('click', function() {
        const form = document.getElementById('formPrimeiroPasso');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const cdfId = document.getElementById('primeiro_passo_cdf_id').value;

        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ENVIANDO...';

        fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/cdf/' + cdfId + '/primeiro-passo', {
            method: 'POST',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('[OK] Primeiro passo conclu√≠do com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('modalPrimeiroPasso')).hide();
                location.reload();
            } else {
                alert('[ERRO] ' + (result.message || 'Erro ao processar primeiro passo'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('[ERRO] Erro ao enviar dados');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check"></i> ENVIAR';
        });
    });

    // Handler: Concluir Gerenciamento
    document.getElementById('btnConcluirGerenciamento') && document.getElementById('btnConcluirGerenciamento').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('formGerenciarCDF'));
        const cdfId = document.getElementById('gerenciar_cdf_id').value;

        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PROCESSANDO...';

        fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/cdf/' + cdfId + '/gerenciar', {
            method: 'POST',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('[OK] Gerenciamento conclu√≠do com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('modalGerenciarCDF')).hide();
                location.reload();
            } else {
                alert('[ERRO] ' + (result.message || 'Erro ao gerenciar CDF'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('[ERRO] Erro ao processar gerenciamento');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check"></i> CONCLUIR';
        });
    });

    // Fun√ß√£o: Abrir Modal Segundo Passo
    function abrirModalSegundoPasso(cdfId) {
        fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/cdf/' + cdfId)
            .then(response => response.json())
            .then(cdf => {
                document.getElementById('segundo_passo_cdf_id').value = cdf.id;
                document.getElementById('modal_2p_cdf_numero').textContent = cdf.numero_cdf || cdf.id;
                document.getElementById('modal_2p_cdf_fornecedor').textContent = cdf.fornecedor_nome || cdf.razao_social || 'N/A';

                // Limpar todas as sele√ß√µes
                document.querySelectorAll('#formSegundoPasso input[type="radio"]').forEach(r => r.checked = false);

                // Abrir modal usando Bootstrap 5 API (sem jQuery)
                const modal = new bootstrap.Modal(document.getElementById('modalSegundoPasso'));
                modal.show();
            })
            .catch(error => {
                console.error('Erro ao buscar CDF:', error);
                alert('[ERRO] Erro ao carregar dados do CDF');
            });
    }

    // Handler: Enviar Segundo Passo
    document.getElementById('btnEnviarSegundoPasso') && document.getElementById('btnEnviarSegundoPasso').addEventListener('click', function() {
        const form = document.getElementById('formSegundoPasso');

        // Validar se todas as quest√µes foram respondidas
        const questoes = ['q1', 'q2', 'q3', 'q4', 'q5'];
        let todasRespondidas = true;

        questoes.forEach(q => {
            const respondida = document.querySelector(`input[name="${q}"]:checked`);
            if (!respondida) {
                todasRespondidas = false;
            }
        });

        if (!todasRespondidas) {
            alert('[ERRO] Por favor, responda todas as quest√µes antes de enviar.');
            return;
        }

        const formData = new FormData(form);
        const cdfId = document.getElementById('segundo_passo_cdf_id').value;

        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ENVIANDO...';

        fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/cdf/' + cdfId + '/segundo-passo', {
            method: 'POST',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('[OK] Valida√ß√£o conclu√≠da com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('modalSegundoPasso')).hide();
                location.reload();
            } else {
                alert('[ERRO] ' + (result.message || 'Erro ao processar valida√ß√£o'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('[ERRO] Erro ao enviar valida√ß√£o');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check"></i> ENVIAR';
        });
    });
})();

// ========================================
// MODAL DE COTA√á√ÉO DE PRE√áOS - JAVASCRIPT
// Carregado do arquivo externo: /public/js/modal-cotacao.js
// ========================================

// ========================================
// INTERCEPTAR SUBMIT DO FORMUL√ÅRIO "CONCLUIR COTA√á√ÉO"
// ========================================
(function() {
    'use strict';

    const formConcluir = document.getElementById('form-concluir');

    if (!formConcluir) {
        console.warn(' Formul√°rio de conclus√£o n√£o encontrado');
        return;
    }

    formConcluir.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevenir submit padr√£o

        console.log('[ACAO] Interceptando submit de CONCLUIR COTA√á√ÉO');

        // VALIDAR TAMANHO DO PDF ANTES DE ENVIAR
        const pdfInput = document.querySelector('input[name="anexo_pdf"]');
        if (pdfInput && pdfInput.files && pdfInput.files[0]) {
            const fileSizeKB = pdfInput.files[0].size / 1024;
            const fileSizeMB = fileSizeKB / 1024;
            console.log('üìé PDF selecionado:', pdfInput.files[0].name);
            console.log('üìä Tamanho:', fileSizeKB.toFixed(2) + ' KB (' + fileSizeMB.toFixed(2) + ' MB)');

            if (fileSizeKB > 100) { // M√°ximo 100KB devido ao timeout extremo do Caddy proxy
                alert('[AVISO] ARQUIVO MUITO GRANDE!\n\n' +
                      'O PDF tem ' + fileSizeKB.toFixed(0) + ' KB (' + fileSizeMB.toFixed(2) + ' MB)\n\n' +
                      ' M√°ximo permitido: 100 KB (0.1 MB)\n\n' +
                      'üí° SOLU√á√ÉO:\n' +
                      '1. Comprima o PDF online (use https://smallpdf.com/pt/comprimir-pdf)\n' +
                      '2. OU conclua SEM anexar PDF (√© opcional)\n\n' +
                      ' LIMITA√á√ÉO T√âCNICA: O proxy tem timeout muito curto para arquivos grandes.');
                return; // N√£o enviar!
            }
        }

        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');

        // Salvar texto original do bot√£o
        const btnOriginalHTML = submitBtn.innerHTML;

        // Desabilitar bot√£o e mostrar loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> FINALIZANDO...';

        // Fazer requisi√ß√£o AJAX
        fetch(window.APP_BASE_PATH + '/orcamentos/{{ $orcamento->id }}/concluir', {
            method: 'POST',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                'Accept': 'application/json'
            },
            body: formData
        })
        .then(response => {
            console.log('üì° Resposta recebida:', response.status);
            return response.json();
        })
        .then(result => {
            console.log('[OK] Resultado:', result);

            if (result.success) {
                // Sucesso! Mostrar modal de conclus√£o
                console.log('üéâ Or√ßamento conclu√≠do com sucesso!');
                document.getElementById('modalConcluido').style.display = 'flex';
            } else {
                // Erro retornado pela API
                console.error(' Erro na API:', result.message);
                alert('[ERRO] Erro ao concluir or√ßamento: ' + (result.message || 'Erro desconhecido'));

                // Re-habilitar bot√£o
                submitBtn.disabled = false;
                submitBtn.innerHTML = btnOriginalHTML;
            }
        })
        .catch(error => {
            console.error(' Erro na requisi√ß√£o:', error);
            alert('[ERRO] Erro ao concluir or√ßamento. Por favor, tente novamente.');

            // Re-habilitar bot√£o
            submitBtn.disabled = false;
            submitBtn.innerHTML = btnOriginalHTML;
        });
    });

    console.log('[OK] Listener de submit registrado para formul√°rio de conclus√£o');
})();

// ========================================
// IMPORTAR FORNECEDOR - PNCP (BUSCA) E LOCAL (CADASTRADOS)
// ========================================
window.addEventListener('load', function() {
    'use strict';

    console.log('[FORNECEDOR] Inicializando modulo de importacao de fornecedores...');

    // Bot√µes de importar fornecedor
    const btnImportarPNCP = document.getElementById('btn-importar-fornecedor-pncp');
    const btnImportarLocal = document.getElementById('btn-importar-fornecedor-local');

    console.log('[FORNECEDOR] Botao PNCP:', btnImportarPNCP);
    console.log('[FORNECEDOR] Botao LOCAL:', btnImportarLocal);

    // Event listeners
    if (btnImportarPNCP) {
        btnImportarPNCP.addEventListener('click', function() {
            console.log('[OK] Bot√£o PNCP clicado!');
            abrirModalBuscaFornecedor('pncp');
        });
    } else {
        console.error(' Bot√£o PNCP n√£o encontrado!');
    }

    if (btnImportarLocal) {
        btnImportarLocal.addEventListener('click', function() {
            console.log('[OK] Bot√£o LOCAL clicado!');
            abrirModalBuscaFornecedor('local');
        });
    } else {
        console.error(' Bot√£o LOCAL n√£o encontrado!');
    }

    // Fun√ß√£o para abrir o modal de busca
    function abrirModalBuscaFornecedor(tipo) {
        const modalId = tipo === 'pncp' ? 'modalBuscaFornecedorPNCP' : 'modalBuscaFornecedorLocal';
        const modal = new bootstrap.Modal(document.getElementById(modalId));
        modal.show();

        // Limpar campo de busca
        const inputId = tipo === 'pncp' ? 'busca-fornecedor-pncp-input' : 'busca-fornecedor-local-input';
        document.getElementById(inputId).value = '';

        //  NOVO: Se for CADASTRO LOCAL, carregar automaticamente TODOS os fornecedores
        if (tipo === 'local') {
            console.log(' Modal LOCAL aberto - carregando fornecedores automaticamente...');

            // Mostrar loading
            document.getElementById(inputId + '-results').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #3b82f6; margin-bottom: 15px;"></i>
                    <p style="color: #1e40af; font-size: 14px; font-weight: 600;">Carregando fornecedores cadastrados...</p>
                    <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">Aguarde...</p>
                </div>
            `;

            // Carregar fornecedores (chamada sem parmetro de busca)
            setTimeout(() => {
                carregarTodosFornecedoresLocais();
            }, 300);
        } else {
            // PNCP: Mostrar mensagem de busca
            document.getElementById(inputId + '-results').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #9ca3af;">
                    <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                    <p style="font-size: 14px;">Digite um termo e clique em BUSCAR para encontrar fornecedores.</p>
                </div>
            `;
        }
    }

    //  NOVA FUN√á√ÉO: Carregar todos os fornecedores locais
    async function carregarTodosFornecedoresLocais() {
        const resultsId = 'busca-fornecedor-local-input-results';
        const resultsArea = document.getElementById(resultsId);

        try {
            console.log('[BUSCA] Buscando TODOS os fornecedores locais (sem filtro)...');

            // Fazer requisi√ß√£o SEM parmetro descricao (backend retorna todos)
            const response = await fetch(window.APP_BASE_PATH + '/fornecedores/buscar-por-item', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });

            const result = await response.json();
            console.log('üìä Fornecedores carregados:', result);

            if (result.success && result.fornecedores && result.fornecedores.length > 0) {
                renderizarFornecedores(result.fornecedores, resultsArea, 'local');
            } else {
                resultsArea.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-database" style="font-size: 48px; color: #6b7280; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="color: #374151; font-size: 14px; font-weight: 600;">Nenhum fornecedor cadastrado</p>
                        <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">
                            Cadastre fornecedores na guia "Fornecedores" do menu principal.
                        </p>
                    </div>
                `;
            }
        } catch (error) {
            console.error(' Erro ao carregar fornecedores:', error);
            resultsArea.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc2626; margin-bottom: 15px;"></i>
                    <p style="color: #374151; font-size: 14px; font-weight: 600;">Erro ao carregar fornecedores</p>
                    <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">${error.message}</p>
                </div>
            `;
        }
    }

    //  FUN√á√ÉO AUXILIAR: Renderizar lista de fornecedores
    function renderizarFornecedores(fornecedores, resultsArea, tipo) {
        let html = `
            <div style="background: #ecfdf5; border-left: 4px solid #10b981; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                <p style="margin: 0; font-size: 13px; color: #065f46; font-weight: 600;">
                    <i class="fas fa-check-circle"></i> ${fornecedores.length} fornecedor(es) encontrado(s)
                </p>
            </div>
        `;

        fornecedores.forEach((fornecedor, index) => {
            // Normalizar estrutura de dados
            const razaoSocial = fornecedor.razao_social || fornecedor.nome_fantasia || 'Nome n√£o informado';
            const cnpj = fornecedor.cnpj || 'N√£o informado';
            const telefone = fornecedor.telefone || fornecedor.telefone_contato || '';
            const email = fornecedor.email || fornecedor.email_contato || '';

            console.log(`[LOG]ÔøΩÔøΩÔøΩ Fornecedor ${index + 1}:`, {
                razaoSocial,
                cnpj,
                telefone: telefone || '(vazio)',
                email: email || '(vazio)',
                fornecedorOriginal: fornecedor
            });

            // Badge de origem
            let origemBadge = '';
            if (tipo === 'local' || fornecedor.origem === 'LOCAL') {
                origemBadge = `<span style="display: inline-block; background: #dbeafe; color: #1e40af; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-top: 5px;"> CADASTRO LOCAL</span>`;
            } else if (fornecedor.origem && fornecedor.origem.includes('PNCP')) {
                origemBadge = `<span style="display: inline-block; background: #fef3c7; color: #92400e; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-top: 5px;">üåê PNCP</span>`;
            }

            // Escapar aspas nos data-attributes
            const emailEscaped = email.replace(/"/g, '&quot;');
            const telefoneEscaped = telefone.replace(/"/g, '&quot;');
            const razaoEscaped = razaoSocial.replace(/"/g, '&quot;');

            html += `
                <div class="card-fornecedor-selecionavel"
                     data-cnpj="${cnpj}"
                     data-razao="${razaoEscaped}"
                     data-email="${emailEscaped}"
                     data-telefone="${telefoneEscaped}"
                     style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h6 style="margin: 0 0 5px 0; font-size: 14px; color: #1f2937; font-weight: 600;">${razaoSocial}</h6>
                            <p style="margin: 0 0 5px 0; font-size: 12px; color: #374151;"><strong>CNPJ:</strong> ${cnpj}</p>
                            ${telefone ? `<p style="margin: 0 0 5px 0; font-size: 12px; color: #6b7280;"><i class="fas fa-phone"></i> ${telefone}</p>` : ''}
                            ${email ? `<p style="margin: 0 0 5px 0; font-size: 12px; color: #6b7280;"><i class="fas fa-envelope"></i> ${email}</p>` : ''}
                            ${origemBadge}
                        </div>
                        <button type="button" class="btn-selecionar-fornecedor" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; white-space: nowrap;">
                            <i class="fas fa-check"></i> SELECIONAR
                        </button>
                    </div>
                </div>
            `;
        });

        resultsArea.innerHTML = html;

        // Adicionar event listeners nos bot√µes de selecionar
        document.querySelectorAll('.btn-selecionar-fornecedor').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const card = this.closest('.card-fornecedor-selecionavel');
                selecionarFornecedor(card);
            });
        });

        // Adicionar event listener no card todo (clicar no card tamb√©m seleciona)
        document.querySelectorAll('.card-fornecedor-selecionavel').forEach(card => {
            card.addEventListener('click', function() {
                selecionarFornecedor(this);
            });
        });
    }

    // Handler: Buscar Fornecedor PNCP (bot√£o dentro do modal)
    const btnBuscarPNCP = document.getElementById('btn-buscar-fornecedor-pncp');
    if (btnBuscarPNCP) {
        console.log('[OK] Event listener adicionado ao bot√£o BUSCAR do modal PNCP');
        btnBuscarPNCP.addEventListener('click', function() {
            console.log('[BUSCA] Bot√£o BUSCAR (PNCP) clicado!');
            buscarFornecedores('pncp');
        });
    } else {
        console.error(' Bot√£o BUSCAR do modal PNCP n√£o encontrado!');
    }

    // Handler: Buscar Fornecedor LOCAL (bot√£o dentro do modal)
    const btnBuscarLocal = document.getElementById('btn-buscar-fornecedor-local');
    if (btnBuscarLocal) {
        console.log('[OK] Event listener adicionado ao bot√£o BUSCAR do modal LOCAL');
        btnBuscarLocal.addEventListener('click', function() {
            console.log('[BUSCA] Bot√£o BUSCAR (LOCAL) clicado!');
            buscarFornecedores('local');
        });
    } else {
        console.error(' Bot√£o BUSCAR do modal LOCAL n√£o encontrado!');
    }

    // Enter para buscar
    document.getElementById('busca-fornecedor-pncp-input') && document.getElementById('busca-fornecedor-pncp-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            buscarFornecedores('pncp');
        }
    });

    document.getElementById('busca-fornecedor-local-input') && document.getElementById('busca-fornecedor-local-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            buscarFornecedores('local');
        }
    });

    // Fun√ß√£o de busca unificada
    async function buscarFornecedores(tipo) {
        const inputId = tipo === 'pncp' ? 'busca-fornecedor-pncp-input' : 'busca-fornecedor-local-input';
        const btnId = tipo === 'pncp' ? 'btn-buscar-fornecedor-pncp' : 'btn-buscar-fornecedor-local';
        const resultsId = inputId + '-results';

        const termo = document.getElementById(inputId).value.trim();
        const btn = document.getElementById(btnId);
        const resultsArea = document.getElementById(resultsId);

        if (!termo || termo.length < 3) {
            resultsArea.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #fbbf24;">
                    <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <p style="font-size: 14px; color: #92400e;">Digite pelo menos 3 caracteres para buscar.</p>
                </div>
            `;
            return;
        }

        // Loading
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> BUSCANDO...';
        resultsArea.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #3b82f6; margin-bottom: 15px;"></i>
                <p style="color: #1e40af; font-size: 14px; font-weight: 600;">Buscando fornecedores...</p>
                <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">Aguarde alguns segundos...</p>
            </div>
        `;

        try {
            let response, result;

            if (tipo === 'local') {
                // BUSCA LOCAL: Usar API espec√≠fica para fornecedores cadastrados localmente
                console.log('[BUSCA] Buscando fornecedores LOCAIS via /fornecedores/buscar-por-item');
                response = await fetch(window.APP_BASE_PATH + '/fornecedores/buscar-por-item?descricao=' + encodeURIComponent(termo), {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
            } else {
                // BUSCA PNCP: Usar API ampla do Mapa de Fornecedores
                console.log('[BUSCA] Buscando fornecedores PNCP via /api/fornecedores/buscar-por-produto');
                response = await fetch(window.APP_BASE_PATH + '/api/fornecedores/buscar-por-produto?termo=' + encodeURIComponent(termo), {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
            }

            result = await response.json();
            console.log('üìä Resposta da API:', result);

            if (result.success && result.fornecedores && result.fornecedores.length > 0) {
                let fornecedores = result.fornecedores;

                // Se for PNCP, filtrar para mostrar apenas fornecedores PNCP
                if (tipo === 'pncp') {
                    fornecedores = fornecedores.filter(f => f.origem && f.origem.includes('PNCP'));
                    console.log(`[LOG]ÔøΩÔøΩÔøΩ ${fornecedores.length} fornecedores PNCP ap√≥s filtro`);
                } else {
                    // Se for LOCAL, n√£o precisa filtrar pois a API /buscar-por-item j√° retorna apenas locais
                    console.log(`[LOG]ÔøΩÔøΩÔøΩ ${fornecedores.length} fornecedores LOCAIS retornados`);
                }

                if (fornecedores.length === 0) {
                    resultsArea.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-search" style="font-size: 48px; color: #6b7280; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p style="color: #374151; font-size: 14px;">Nenhum fornecedor ${tipo === 'pncp' ? 'do PNCP' : 'LOCAL'} encontrado para: <strong>"${termo}"</strong></p>
                        </div>
                    `;
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-search"></i> BUSCAR';
                    return;
                }

                //  USAR FUN√á√ÉO DE RENDERIZA√á√ÉO UNIFICADA
                renderizarFornecedores(fornecedores, resultsArea, tipo);

                // Restaurar bot√£o
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> BUSCAR';

            } else {
                resultsArea.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-search" style="font-size: 48px; color: #6b7280; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="color: #374151; font-size: 14px;">Nenhum fornecedor encontrado.</p>
                    </div>
                `;
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> BUSCAR';
            }

        } catch (error) {
            console.error(' Erro na busca:', error);
            resultsArea.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc2626; margin-bottom: 15px;"></i>
                    <p style="color: #374151; font-size: 14px; font-weight: 600;">Erro ao buscar fornecedores</p>
                    <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">${error.message}</p>
                </div>
            `;
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> BUSCAR';
        }
    }

    }

    // Fun√ß√£o para selecionar fornecedor e preencher formul√°rio CDF
    function selecionarFornecedor(card) {
        const cnpj = card.getAttribute('data-cnpj');
        const razaoSocial = card.getAttribute('data-razao');
        const email = card.getAttribute('data-email');
        const telefone = card.getAttribute('data-telefone');

        console.log('[OK] Fornecedor selecionado:', { cnpj, razaoSocial, email, telefone });
        console.log('üìß Email vazio?', email === '' || email === 'undefined' || !email);
        console.log('üìû Telefone vazio?', telefone === '' || telefone === 'undefined' || !telefone);

        // Preencher campos do formul√°rio CDF (Etapa 2)
        const cnpjInput = document.getElementById('cdf-cnpj-input');
        const razaoInput = document.getElementById('cdf-razao-social-input');
        const emailInput = document.getElementById('cdf-email-input');
        const telefoneInput = document.getElementById('cdf-telefone-input');

        console.log('[BUSCA] Campos encontrados:', {
            cnpjInput: !!cnpjInput,
            razaoInput: !!razaoInput,
            emailInput: !!emailInput,
            telefoneInput: !!telefoneInput
        });

        if (cnpjInput) cnpjInput.value = cnpj.replace(/\D/g, ''); // Apenas n√∫meros
        if (razaoInput) razaoInput.value = razaoSocial;

        // Fechar modal PRIMEIRO
        const modalPNCP = bootstrap.Modal.getInstance(document.getElementById('modalBuscaFornecedorPNCP'));
        const modalLocal = bootstrap.Modal.getInstance(document.getElementById('modalBuscaFornecedorLocal'));
        if (modalPNCP) modalPNCP.hide();
        if (modalLocal) modalLocal.hide();

        // IMPORTANTE: Aguardar o modal fechar antes de clicar no bot√£o BUSCAR
        console.log(' Aguardando modal fechar para buscar CNPJ automaticamente...');

        setTimeout(() => {
            // Buscar o bot√£o de BUSCAR CNPJ
            const btnBuscarCNPJ = document.getElementById('cdf-btn-buscar-cnpj');

            if (btnBuscarCNPJ) {
                console.log('[BUSCA] Clicando automaticamente no bot√£o BUSCAR CNPJ...');
                btnBuscarCNPJ.click(); // Dispara a busca autom√°tica na Receita Federal
            } else {
                console.error(' Bot√£o BUSCAR CNPJ n√£o encontrado!');

                // Fallback: preencher dados manualmente se dispon√≠veis
                if (email && email !== '' && email !== 'undefined' && email !== 'null') {
                    console.log('[OK] Preenchendo email (fallback):', email);
                    if (emailInput) emailInput.value = email;
                }

                if (telefone && telefone !== '' && telefone !== 'undefined' && telefone !== 'null') {
                    console.log('[OK] Preenchendo telefone (fallback):', telefone);
                    if (telefoneInput) telefoneInput.value = telefone;
                }
            }
        }, 300); // Aguarda 300ms para o modal fechar completamente
    }

    console.log('[OK] M√≥dulo de importa√ß√£o de fornecedores inicializado com sucesso!');
});
</script>

<!-- Modal: Sucesso Salvamento Or√ßamentista -->
<div class="modal fade" id="modalSucessoSalvamento" tabindex="-1" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
            <div class="modal-body" style="padding: 40px 30px; text-align: center;">
                <i class="fas fa-check-circle" style="font-size: 56px; color: #10b981; margin-bottom: 20px;"></i>
                <h5 style="color: #065f46; font-weight: 700; margin-bottom: 12px; font-size: 18px;">Dados Salvos com Sucesso!</h5>
                <p style="color: #6b7280; font-size: 14px; margin: 0; line-height: 1.5;">
                    Os dados do or√ßamentista foram salvos e est√£o dispon√≠veis para uso no sistema.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: BUSCAR FORNECEDOR - PNCP (BUSQUE O MELHOR FORNECEDOR) -->
<div class="modal fade" id="modalBuscaFornecedorPNCP" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                <h5 class="modal-title" style="font-size: 16px; font-weight: 600; margin: 0;">
                    <i class="fas fa-search-dollar"></i> BUSQUE O MELHOR FORNECEDOR - PNCP
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <!-- Campo de Busca -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; color: #374151; font-weight: 600; margin-bottom: 8px;">
                        Busca por Nome, CNPJ, Produto ou Palavra-chave:
                    </label>
                    <div style="display: flex; gap: 10px;">
                        <input
                            type="text"
                            id="busca-fornecedor-pncp-input"
                            placeholder="Digite qualquer termo (ex: medicamento, caneta, CNPJ, nome da empresa)"
                            style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
                        >
                        <button
                            type="button"
                            id="btn-buscar-fornecedor-pncp"
                            class="btn btn-primary"
                            style="padding: 10px 20px; font-size: 13px; font-weight: 600; white-space: nowrap;"
                        >
                            <i class="fas fa-search"></i> BUSCAR
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #6b7280; margin: 8px 0 0 0;">
                        <i class="fas fa-info-circle"></i> Busca em tempo real no PNCP - todos os fornecedores do Brasil
                    </p>
                </div>

                <!-- √Årea de Resultados -->
                <div id="busca-fornecedor-pncp-input-results" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; background: #f9fafb;">
                    <div style="text-align: center; padding: 40px; color: #9ca3af;">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="font-size: 14px;">Digite um termo e clique em BUSCAR para encontrar fornecedores.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background: #f9fafb; padding: 15px 20px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 13px;">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: BUSCAR FORNECEDOR - CADASTRO LOCAL -->
<div class="modal fade" id="modalBuscaFornecedorLocal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white;">
                <h5 class="modal-title" style="font-size: 16px; font-weight: 600; margin: 0;">
                    <i class="fas fa-database"></i> IMPORTAR - CADASTRO LOCAL
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <!-- Campo de Busca -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; color: #374151; font-weight: 600; margin-bottom: 8px;">
                        Busca por Nome, CNPJ, Produto ou Palavra-chave:
                    </label>
                    <div style="display: flex; gap: 10px;">
                        <input
                            type="text"
                            id="busca-fornecedor-local-input"
                            placeholder="Digite qualquer termo (ex: medicamento, caneta, CNPJ, nome da empresa)"
                            style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
                        >
                        <button
                            type="button"
                            id="btn-buscar-fornecedor-local"
                            class="btn btn-primary"
                            style="padding: 10px 20px; font-size: 13px; font-weight: 600; white-space: nowrap;"
                        >
                            <i class="fas fa-search"></i> BUSCAR
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #6b7280; margin: 8px 0 0 0;">
                        <i class="fas fa-info-circle"></i> Busca apenas fornecedores j√° cadastrados localmente
                    </p>
                </div>

                <!-- √Årea de Resultados -->
                <div id="busca-fornecedor-local-input-results" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; background: #f9fafb;">
                    <div style="text-align: center; padding: 40px; color: #9ca3af;">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="font-size: 14px;">Digite um termo e clique em BUSCAR para encontrar fornecedores.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background: #f9fafb; padding: 15px 20px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 13px;">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@endsection
