{{-- VERS√ÉO CR√çTICA: 20251018_200000_PROXY_CACHE_KILLER --}}
@php
    //  HEADERS HTTP AGRESSIVOS: IMPEDIR TODO E QUALQUER CACHE (PROXY + BROWSER)
    header('Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0, max-age=0, s-maxage=0');
    header('Pragma: no-cache');
    header('Expires: Thu, 01 Jan 1970 00:00:00 GMT');
    header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT');
    header('Vary: *');
    header('X-Accel-Expires: 0');

    // Token √∫nico para esta requisi√ß√£o (for√ßa proxy a ver como conte√∫do diferente)
    $cacheToken = microtime(true) . '_' . mt_rand(10000, 99999);
    $deployVersion = '20251020_FIX001'; // VERS√ÉO CR√çTICA - corrige addEventListenerUnico
@endphp
<!-- CACHE-KILLER: {{ $cacheToken }} -->
<!-- DEPLOY-VERSION: {{ $deployVersion }} -->
<!-- GENERATED-AT: {{ now()->format('Y-m-d H:i:s.u') }} -->
<!-- FRAGMENT-BUSTER: {{ md5($cacheToken) }} -->
@extends('layouts.app')

@section('title', 'Elaboracao do Orcamento - Cesta de Precos')

@section('content')

{{-- SCRIPTS CR√çTICOS: DEVEM SER CARREGADOS PRIMEIRO --}}
<script data-cache-token="{{ $cacheToken }}" data-version-check="20251020_FIX001" data-deploy="{{ $deployVersion }}">
(function() {
    var urlAtual = new URL(window.location.href);
    var versaoParam = urlAtual.searchParams.get('_v');
    var agora = Date.now();
    var reloadKey = 'reload_tentativas_' + window.location.pathname;
    var tentativas = parseInt(sessionStorage.getItem(reloadKey) || '0');

    // Verificar se script est√° na vers√£o correta
    var scriptTag = document.currentScript;
    var versaoScript = scriptTag ? scriptTag.getAttribute('data-version-check') : null;

    if (versaoScript !== '20251020_FIX001') {
        // VERS√ÉO ERRADA - CACHE ANTIGO/PROXY DETECTADO!
        if (tentativas < 5) {
            sessionStorage.setItem(reloadKey, String(tentativas + 1));
            console.warn('[CACHE-KILLER] Versao errada: ' + versaoScript + ', esperado: 20251020_FIX001');
            console.warn('[CACHE-KILLER] For√ßando reload... (tentativa ' + (tentativas + 1) + '/5)');
            // Adicionar timestamp DIFERENTE para bypassar proxy
            urlAtual.searchParams.set('_v', agora);
            urlAtual.searchParams.set('_force', tentativas + 1);
            window.location.replace(urlAtual.href);
            return;
        } else {
            // Ap√≥s 5 tentativas, mostrar erro
            alert('ERRO CR√çTICO DE CACHE!\n\nProxy ou navegador est√° bloqueando atualiza√ß√µes.\n\nVers√£o atual: ' + versaoScript + '\nVers√£o esperada: 20251020_FIX001\n\nTente em outro navegador!');
        }
    }

    // SEMPRE recarregar se n√£o tiver _v recente (√∫ltimos 5 segundos)
    if (!versaoParam || (agora - parseInt(versaoParam)) > 5000) {
        urlAtual.searchParams.set('_v', agora);
        console.log('%c FOR√áANDO RELOAD COM TIMESTAMP NOVO...', 'background: #f59e0b; color: white; font-size: 16px; padding: 10px;');
        window.location.replace(urlAtual.href);
    }

    // Se chegou aqui, limpar contador
    sessionStorage.removeItem(reloadKey);
})();
</script>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, post-check=0, pre-check=0, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="version" content="NOCACHE_{{ $cacheToken }}">
<!-- VERS√ÉO DA P√ÅGINA: {{ now()->format('Y-m-d H:i:s') }} | TOKEN: {{ $cacheToken }} -->
<script data-version="20251020_FIX001_ADDLISTENER" data-total-lines="12015" data-cache-token="{{ $cacheToken }}">
//  DETEC√á√ÉO AGRESSIVA DE CACHE ANTIGO
(function() {
    'use strict';

    const VERSAO_ESPERADA = '20251020_FIX001_ADDLISTENER';
    const TOTAL_LINHAS_ESPERADO = 12015;

    // Verificar se h√° erro de sintaxe (sinal de cache antigo)
    const scriptAtual = document.currentScript;
    if (!scriptAtual || !scriptAtual.dataset.version) {
        bloquearPaginaCacheAntigo('Script tag sem vers√£o');
        return;
    }

    if (scriptAtual.dataset.version !== VERSAO_ESPERADA) {
        bloquearPaginaCacheAntigo('Vers√£o incorreta: ' + scriptAtual.dataset.version);
        return;
    }

    console.log('%c VERS√ÉO CORRETA: ' + VERSAO_ESPERADA, 'background: green; color: white; font-size: 18px; padding: 10px; font-weight: bold;');
    console.log('%c Total de linhas esperado: ' + TOTAL_LINHAS_ESPERADO, 'background: blue; color: white; font-size: 14px; padding: 8px;');

    function bloquearPaginaCacheAntigo(motivo) {
        console.error('%c CACHE ANTIGO DETECTADO!', 'background: red; color: white; font-size: 24px; padding: 15px; font-weight: bold;');
        console.error('Motivo:', motivo);

        // Criar tela vermelha bloqueando tudo
        const bloqueio = document.createElement('div');
        bloqueio.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: #dc2626; z-index: 9999999; display: flex;
                        align-items: center; justify-content: center; flex-direction: column;
                        color: white; font-family: Arial, sans-serif; text-align: center; padding: 40px;">
                <h1 style="font-size: 48px; margin-bottom: 20px;"> CACHE DESATUALIZADO!</h1>
                <p style="font-size: 24px; margin-bottom: 40px;">Voc√™ est√° vendo uma vers√£o antiga desta p√°gina</p>

                <div style="background: white; color: #dc2626; padding: 30px; border-radius: 12px; max-width: 600px; text-align: left;">
                    <h2 style="margin-top: 0;">Para corrigir:</h2>
                    <ol style="font-size: 18px; line-height: 1.8;">
                        <li><strong>Pressione Ctrl+Shift+Delete</strong></li>
                        <li>Selecione <strong>"Todo o per√≠odo"</strong></li>
                        <li>Marque <strong>"Cookies"</strong> e <strong>"Cache"</strong></li>
                        <li>Clique em <strong>"Limpar dados"</strong></li>
                        <li><strong>Feche TODAS as abas</strong> do navegador</li>
                        <li>Abra novamente e recarregue esta p√°gina</li>
                    </ol>

                    <hr style="margin: 20px 0; border-color: #fca5a5;">

                    <p style="font-size: 16px;"><strong>OU teste em modo an√¥nimo:</strong></p>
                    <p style="font-size: 18px; background: #fef2f2; padding: 10px; border-radius: 6px; margin: 0;">
                        <strong>Ctrl+Shift+N</strong> (Chrome) ou <strong>Ctrl+Shift+P</strong> (Firefox)
                    </p>
                </div>

                <p style="font-size: 14px; margin-top: 30px; opacity: 0.8;">Motivo: ${motivo}</p>
            </div>
        `;
        document.body.appendChild(bloqueio);

        // Bloquear JavaScript
        throw new Error('CACHE ANTIGO - P√°gina bloqueada');
    }
})();

// ========================================================================
// üöÄ SISTEMA DE CONTROLE DE INICIALIZA√á√ïES (ANTI-DUPLICA√á√ÉO)
// ========================================================================
(function() {
    'use strict';

    // Objeto global para rastrear inicializa√ß√µes
    if (!window.ELABORAR_INITIALIZED) {
        window.ELABORAR_INITIALIZED = {
            modais: {},
            eventListeners: {},
            domContentLoaded: false,
            timestamp: Date.now()
        };
        console.log('[PERFORMANCE] üöÄ Sistema de controle inicializado');
    }

    // Helper para verificar se algo j√° foi inicializado
    window.jaInicializado = function(nome) {
        if (window.ELABORAR_INITIALIZED.modais[nome]) {
            console.warn('[PERFORMANCE]  Tentativa de reinicializar:', nome, '(BLOQUEADO)');
            return true;
        }
        window.ELABORAR_INITIALIZED.modais[nome] = true;
        console.log('[PERFORMANCE]  Inicializando:', nome);
        return false;
    };

    // Helper para event listeners √∫nicos
    window.addEventListenerUnico = function(elemento, evento, handler, nome) {
        const chave = nome || (elemento.id + '_' + evento);

        if (window.ELABORAR_INITIALIZED.eventListeners[chave]) {
            console.warn('[PERFORMANCE]  Event listener j√° existe:', chave, '(BLOQUEADO)');
            return false;
        }

        elemento.addEventListener(evento, handler);
        window.ELABORAR_INITIALIZED.eventListeners[chave] = true;
        console.log('[PERFORMANCE]  Event listener adicionado:', chave);
        return true;
    };

    console.log('%c‚úÖ FUN√á√ÉO addEventListenerUnico CARREGADA! Tipo:', 'background: green; color: white; font-weight: bold; padding: 5px;', typeof window.addEventListenerUnico);
    console.log('[PERFORMANCE]  Helpers de controle criados');
})();
</script>
<style>

    /* ========================================
       FASE 3.3: ESTILOS PARA CURVA ABC
       ======================================== */
    .badge-abc {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 700;
        font-size: 11px;
        text-transform: uppercase;
    }

    .badge-abc-A {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }

    .badge-abc-B {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
    }

    .badge-abc-C {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(107, 114, 128, 0.3);
    }

    #btn-calcular-curva-abc:hover {
        background: #7c3aed !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3);
        transition: all 0.2s ease;
    }

    #btn-calcular-curva-abc:active {
        transform: translateY(0);
        box-shadow: 0 2px 3px rgba(139, 92, 246, 0.3);
    }
</style>

<!-- Modal de Sucesso (aparece apenas uma vez ao criar or√ßamento) -->
<div id="modalSucesso" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 8px; max-width: 400px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
        <div style="width: 60px; height: 60px; background: #10b981; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
            <svg style="width: 35px; height: 35px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        <h3 style="margin: 0 0 10px 0; font-size: 20px; color: #1f2937;">Sucesso!</h3>
        <p style="margin: 0 0 25px 0; color: #6b7280; font-size: 15px;" id="modalSucessoMensagem">
            Orcamento criado com sucesso!
        </p>
        <button onclick="fecharModalSucesso()" style="background: #3b82f6; color: white; border: none; padding: 12px 40px; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer;">
            OK
        </button>
    </div>
</div>

<!-- Modal de Concluso (aparece ao concluir or√ßamento) -->
<div id="modalConcluido" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 480px; text-align: center; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);">
        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; margin: 0 auto 25px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);">
            <svg style="width: 45px; height: 45px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        <h3 style="margin: 0 0 12px 0; font-size: 24px; color: #1f2937; font-weight: 700;">Orcamento Conclu√≠do!</h3>
        <p style="margin: 0 0 8px 0; color: #10b981; font-size: 16px; font-weight: 600;">
            Seu or√ßamento foi criado com sucesso
        </p>
        <p style="margin: 0 0 30px 0; color: #6b7280; font-size: 14px;">
            O or√ßamento foi salvo e esta disponivel em "Orcamentos Realizados"
        </p>
        <button onclick="irParaRealizados()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 14px 50px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.3s;">
            <i class="fas fa-check-circle" style="margin-right: 8px;"></i>OK
        </button>
    </div>
</div>

<script>
    // Variavel global com ID do orcamento (evita erros de sintaxe com Blade tags)
    window.ORCAMENTO_ID = {{ $orcamento->id ?? 'null' }};

    //  CRITICAL: Definir APP_BASE_PATH apenas se n√£o existir (n√£o sobrescrever app.blade.php)
    if (typeof window.APP_BASE_PATH === 'undefined') {
        window.APP_BASE_PATH = '';
    }

    //  VERIFICA√á√ÉO DE CACHE - FOR√áA RELOAD SE VERS√ÉO ERRADA
    (function() {
        const VERSAO_ESPERADA = '20251018_143000_AGGRESSIVE_CACHE_BUSTING';
        const TOTAL_LINHAS_ESPERADO = 11100;

        // Verificar se j√° tentamos recarregar (evitar loop infinito)
        const jaTentouRecarregar = sessionStorage.getItem('cache_reload_tentado');

        // Marcar localStorage para detectar vers√£o carregada
        const versaoAtual = localStorage.getItem('elaborar_versao');

        if (versaoAtual && versaoAtual !== VERSAO_ESPERADA && !jaTentouRecarregar) {
            console.log('%c VERS√ÉO DESATUALIZADA DETECTADA!', 'background: #dc2626; color: white; font-size: 18px; padding: 12px; font-weight: bold;');
            console.log('%c Esperado: ' + VERSAO_ESPERADA, 'color: #ef4444; font-size: 14px; font-weight: bold;');
            console.log('%c Encontrado: ' + versaoAtual, 'color: #ef4444; font-size: 14px; font-weight: bold;');
            console.log('%c FOR√áANDO RELOAD EM 2 SEGUNDOS...', 'background: #f59e0b; color: white; font-size: 16px; padding: 10px; font-weight: bold;');

            // Marcar que tentamos recarregar
            sessionStorage.setItem('cache_reload_tentado', 'true');

            // Force reload com bypass de cache ap√≥s 2 segundos
            setTimeout(function() {
                window.location.reload(true);
            }, 2000);
            return; // N√£o continuar execu√ß√£o
        }

        // Salvar vers√£o atual
        localStorage.setItem('elaborar_versao', VERSAO_ESPERADA);

        // Limpar flag de reload ap√≥s sucesso
        sessionStorage.removeItem('cache_reload_tentado');

        console.log('%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó', 'color: #10b981; font-weight: bold;');
        console.log('%c‚ïë   VERS√ÉO CORRETA CARREGADA                  ‚ïë', 'color: #10b981; font-weight: bold;');
        console.log('%c‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù', 'color: #10b981; font-weight: bold;');
        console.log('%c Vers√£o: ' + VERSAO_ESPERADA, 'color: #10b981; font-size: 14px; font-weight: bold;');
        console.log('%c Total de linhas: ' + TOTAL_LINHAS_ESPERADO, 'color: #10b981; font-size: 14px; font-weight: bold;');
        console.log('%c Carregado em: ' + new Date().toLocaleString('pt-BR'), 'color: #3b82f6; font-size: 12px;');
        console.log('%c' + '‚ïê'.repeat(50), 'color: #10b981;');
    })();

    //  FUN√á√ÉO GLOBAL: Reload com Cache-Busting Autom√°tico
    window.reloadComCacheBusting = function() {
        console.log('%c RECARREGANDO COM CACHE-BUSTING...', 'background: #0891b2; color: white; font-size: 14px; padding: 8px; font-weight: bold;');
        
        // Pegar URL atual
        const url = new URL(window.location.href);
        
        // Adicionar/atualizar par√¢metro _v com timestamp atual
        url.searchParams.set('_v', Date.now());
        
        console.log('%c Nova URL:', 'color: #10b981; font-weight: bold;', url.href);
        
        // Redirecionar para URL com novo timestamp
        window.location.href = url.href;
    };
    
    //  SOBRESCREVER location.reload() GLOBAL para usar cache-busting
    const originalReload = Location.prototype.reload;
    Location.prototype.reload = function(forceReload) {
        console.log('%c location.reload() interceptado! Usando cache-busting...', 'color: #f59e0b; font-weight: bold;');
        window.reloadComCacheBusting();
    };

    //  FUN√á√ïES GLOBAIS PARA CDF (definidas NO IN√çCIO para garantir que existam)
    window.abrirModalPNCP = function() {
        console.log('[GLOBAL] abrirModalPNCP() chamada!');
        try {
            const modal = new bootstrap.Modal(document.getElementById('modalBuscaFornecedorPNCP'));
            modal.show();
            console.log('[GLOBAL] Modal PNCP aberto!');
        } catch(err) {
            console.error('[GLOBAL] Erro ao abrir modal PNCP:', err);
            alert('Erro ao abrir modal: ' + err.message);
        }
    };

    window.abrirModalLocal = function() {
        console.log('[GLOBAL] abrirModalLocal() chamada!');
        try {
            const modal = new bootstrap.Modal(document.getElementById('modalBuscaFornecedorLocal'));
            modal.show();
            console.log('[GLOBAL] Modal LOCAL aberto!');
        } catch(err) {
            console.error('[GLOBAL] Erro ao abrir modal LOCAL:', err);
            alert('Erro ao abrir modal: ' + err.message);
        }
    };

    console.log('[GLOBAL]  Fun√ß√µes CDF definidas!');

    //  PROTE√á√ÉO: Listener √∫nico para modal de sucesso
    window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
        // Verificar se tem parmetro msg=success (vindo do redirect ap√≥s criar or√ßamento)
        const urlParams = new URLSearchParams(window.location.search);
        const msgParam = urlParams.get('msg');

        @if(session('success'))
        const sessionSuccess = true;
        const sessionMessage = {!! json_encode(session('success')) !!};
        @else
        const sessionSuccess = false;
        const sessionMessage = '';
        @endif

        // Mostrar modal APENAS se tem msg=success na URL OU session success
        // E APENAS se no foi mostrado ainda nesta sesso
        const modalJaMostrado = sessionStorage.getItem('modalSucessoMostrado_' + window.ORCAMENTO_ID);

        if ((msgParam === 'success' || sessionSuccess) && !modalJaMostrado) {
            const modal = document.getElementById('modalSucesso');
            if (sessionMessage) {
                document.getElementById('modalSucessoMensagem').textContent = sessionMessage;
            }
            modal.style.display = 'flex';

            // Marcar que o modal ja foi mostrado
            sessionStorage.setItem('modalSucessoMostrado_' + window.ORCAMENTO_ID, 'true');

            // Remover parmetro msg da URL
            if (msgParam === 'success') {
                const url = new URL(window.location);
                url.searchParams.delete('msg');
                window.history.replaceState({}, '', url);
            }
        }
    }, 'modalSucessoInit');

    function fecharModalSucesso() {
        document.getElementById('modalSucesso').style.display = 'none';
    }

    /**
     * Redirecionar para pgina de Orcamentos Realizados
     * Usa URL relativa sem barra inicial (compat√≠vel com proxy e tag <base>)
     */
    function irParaRealizados() {
        const urlRealizados = window.APP_BASE_PATH + '/orcamentos/realizados';
        console.log('[INFO] Redirecionando para:', urlRealizados);
        window.location.href = urlRealizados;
    }
</script>

<style>
    /* Estilos para as se√ß√µes numeradas */
    .secao {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .secao-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
    }

    .secao-numero {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        margin-right: 15px;
        flex-shrink: 0;
    }

    .secao-titulo {
        font-size: 16px;
        font-weight: 700;
        color: #2563eb;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .dados-item {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .dados-label {
        font-weight: 600;
        color: #6b7280;
        font-size: 13px;
    }

    .dados-valor {
        color: #374151;
        font-size: 13px;
    }

    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        background: #3b82f6;
        color: white;
        margin-left: 8px;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        text-decoration: none;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background: #2563eb;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-outline {
        background: white;
        border: 1px solid #d1d5db;
        color: #374151;
    }

    .alert-empty {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #991b1b;
        padding: 15px 20px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        text-align: center;
    }

    .radio-group label {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 8px;
        cursor: pointer;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .radio-group label:hover {
        background: #f9fafb;
    }

    .radio-group input[type="radio"] {
        margin-right: 10px;
    }

    .linha-vertical {
        border-left: 4px solid #3b82f6;
        padding-left: 20px;
        margin: 15px 0;
        position: relative;
    }

    /* Bolinha azul a esquerda de cada se√ßo de metodologia */
    .linha-vertical::before {
        content: '';
        position: absolute;
        left: -10px; /* Ajusta para ficar centralizado na linha (4px de largura / 2 = 2px, ento -10px para bolinha de 16px) */
        top: 0;
        width: 16px;
        height: 16px;
        background: #3b82f6;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 0 1px #3b82f6;
    }

    /* Modais Bootstrap - Garantir centraliza√ßo correta */
    .modal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
    }

    .modal.show .modal-dialog {
        transform: none;
    }

    .modal-dialog-centered {
        display: flex;
        align-items: center;
        min-height: calc(100% - 1rem);
    }

    .modal.fade .modal-dialog-centered {
        transform: translate(0, -50px);
    }

    .modal.show .modal-dialog-centered {
        transform: none;
    }

    /* Modal de Confirma√ßo Customizado */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-overlay .modal-content {
        background: white;
        border-radius: 12px;
        padding: 0;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-overlay .modal-header-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        padding: 24px;
        border-radius: 12px 12px 0 0;
        text-align: center;
    }

    .modal-overlay .modal-icon-warning {
        width: 64px;
        height: 64px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
    }

    .modal-overlay .modal-title {
        color: white;
        font-size: 24px;
        font-weight: 700;
        margin: 0;
    }

    .modal-overlay .modal-body {
        padding: 32px 24px;
        text-align: center;
    }

    .modal-overlay .modal-message {
        color: #374151;
        font-size: 16px;
        line-height: 1.6;
        margin: 0;
    }

    .modal-overlay .modal-footer {
        padding: 0 24px 24px;
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .modal-overlay .modal-btn-confirm {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        padding: 14px 32px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
    }

    .modal-overlay .modal-btn-confirm:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 8px -1px rgba(16, 185, 129, 0.4);
    }

    .modal-overlay .modal-btn-cancel {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
        padding: 14px 32px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .modal-overlay .modal-btn-cancel:hover {
        background: #e5e7eb;
    }

    /* Modal de Edi√ßo Customizado */
    .modal-overlay .modal-header-edit {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        padding: 24px;
        border-radius: 12px 12px 0 0;
        text-align: center;
    }

    .modal-overlay .modal-icon-edit {
        width: 64px;
        height: 64px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
    }

    .modal-overlay .modal-form-group {
        margin-bottom: 20px;
        text-align: left;
    }

    .modal-overlay .modal-form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
        font-size: 13px;
    }

    .modal-overlay .modal-form-label .required {
        color: #dc2626;
        margin-left: 2px;
    }

    .modal-overlay .modal-form-input,
    .modal-overlay .modal-form-textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        color: #374151;
        transition: border-color 0.2s;
    }

    .modal-overlay .modal-form-input:focus,
    .modal-overlay .modal-form-textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .modal-overlay .modal-form-textarea {
        min-height: 120px;
        resize: vertical;
        font-family: inherit;
    }

    .modal-overlay .modal-body-form {
        padding: 24px;
        max-height: 60vh;
        overflow-y: auto;
    }

    /* Media query para telas com pouca altura (como 1440x900) */
    @media (max-height: 1000px) {
        .secao {
            padding: 15px;
            margin-bottom: 15px;
        }

        .secao-header {
            margin-bottom: 12px;
            padding-bottom: 10px;
        }

        .secao-numero {
            width: 36px;
            height: 36px;
            font-size: 16px;
            margin-right: 12px;
        }

        .secao-titulo {
            font-size: 14px;
        }

        .content {
            padding: 20px !important;
        }

        .btn {
            padding: 8px 16px;
            font-size: 12px;
        }
    }

    /* Bot√µes de a√ßo da CDF */
    .btn-icon-acao {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        padding: 6px 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-icon-acao:hover {
        background: #e5e7eb;
        border-color: #9ca3af;
        transform: scale(1.05);
    }

    .btn-icon-acao i {
        font-size: 14px;
    }

    /* Dropdown da engrenagem */
    .dropdown-menu-cdf {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        z-index: 1000;
        margin-top: 4px;
    }

    .dropdown-menu-cdf a {
        display: block;
        padding: 10px 15px;
        color: #374151;
        text-decoration: none;
        font-size: 13px;
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.2s;
    }

    .dropdown-menu-cdf a:last-child {
        border-bottom: none;
    }

    .dropdown-menu-cdf a:hover {
        background: #f9fafb;
        color: #2563eb;
    }

    /* Highlight do termo pesquisado - AMARELO FORTE */
    .highlight-termo,
    .termo-highlight {
        background: #fef08a !important;
        color: #854d0e !important;
        font-weight: 700 !important;
        padding: 2px 4px;
        border-radius: 3px;
        box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.3);
    }
</style>

<!-- Modal de Confirma√ßo -->
<div id="modal-confirmacao" style="display: none;">
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header-warning">
                <div class="modal-icon-warning">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white" style="width: 36px; height: 36px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h2 class="modal-title">Atencao!</h2>
            </div>
            <div class="modal-body">
                <p class="modal-message">
                    <strong>Tem certeza que deseja concluir este orcamento?</strong><br><br>
                    Ao concluir este orcamento, ele nao podera ser alterado.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" id="modal-btn-confirmar" class="modal-btn-confirm">
                    SIM, CONCLUIR
                </button>
                <button type="button" id="modal-btn-cancelar" class="modal-btn-cancel">
                    CANCELAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edi√ßo -->
<div id="modal-edicao" style="display: none;">
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header-edit">
                <div class="modal-icon-edit">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white" style="width: 36px; height: 36px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                </div>
                <h2 class="modal-title">Editar Dados do Orcamento</h2>
            </div>
            <form id="form-editar-dados">
                @csrf
                <div class="modal-body-form">
                    <!-- Nome do Orcamento -->
                    <div class="modal-form-group">
                        <label for="edit_nome" class="modal-form-label">
                            Nome do Orcamento<span class="required">*</span>
                        </label>
                        <input
                            type="text"
                            id="edit_nome"
                            name="nome"
                            class="modal-form-input"
                            value="{{ $orcamento->nome }}"
                            required
                        >
                    </div>

                    <!-- Referncia Externa -->
                    <div class="modal-form-group">
                        <label for="edit_referencia_externa" class="modal-form-label">
                            Referncia Externa
                        </label>
                        <input
                            type="text"
                            id="edit_referencia_externa"
                            name="referencia_externa"
                            class="modal-form-input"
                            value="{{ $orcamento->referencia_externa }}"
                        >
                    </div>

                    <!-- Objeto -->
                    <div class="modal-form-group">
                        <label for="edit_objeto" class="modal-form-label">
                            Objeto<span class="required">*</span>
                        </label>
                        <textarea
                            id="edit_objeto"
                            name="objeto"
                            class="modal-form-textarea"
                            required
                        >{{ $orcamento->objeto }}</textarea>
                    </div>

                    <!-- rgo Interessado -->
                    <div class="modal-form-group">
                        <label for="edit_orgao_interessado" class="modal-form-label">
                            rgo Interessado
                        </label>
                        <input
                            type="text"
                            id="edit_orgao_interessado"
                            name="orgao_interessado"
                            class="modal-form-input"
                            value="{{ $orcamento->orgao_interessado }}"
                        >
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="modal-btn-confirm">
                        SALVAR
                    </button>
                    <button type="button" id="modal-edit-cancelar" class="modal-btn-cancel">
                        CANCELAR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: 1¬∫ Passo - Importar Comprovante de Solicita√ßo de CDF -->
<div class="modal fade" id="modalPrimeiroPasso" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document" style="max-width: 900px;">
        <div class="modal-content">
            <div class="modal-header" style="background: #1e40af; color: white;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 15px;">1¬∫ PASSO: IMPORTAR COMPROVANTE DE SOLICITA√á√ÉO DE COTA√á√ÉO DIRETA</h5>
                <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 1;">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <form id="formPrimeiroPasso">
                    <input type="hidden" id="primeiro_passo_cdf_id" name="cdf_id">

                    <!-- Se√ßo 1: Dados da CDF -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">1</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">DADOS DA COTA√á√ÉO DIRETA COM FORNECEDOR</h6>
                        </div>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 6px; border-left: 4px solid #2563eb;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                                <div><strong>CDF n¬∫:</strong> <span id="modal_cdf_numero"></span></div>
                                <div><strong>FORNECEDOR:</strong> <span id="modal_cdf_fornecedor"></span></div>
                                <div><strong>SITUA√á√ÉO:</strong> <span id="modal_cdf_situacao"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Se√ßo 2: Valida√ßo -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">2</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">VALIDA√á√ÉO DO COMPROVANTE DE SOLICITA√á√ÉO DA CDF</h6>
                        </div>
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151;">1) A cota√ßo direta com fornecedor foi coletada:</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="metodo_coleta" value="email" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <i class="fas fa-envelope" style="font-size: 32px; color: #2563eb; display: block; margin-bottom: 8px;"></i>
                                    <span style="font-size: 13px; font-weight: 600;">Por e-mail</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="metodo_coleta" value="presencial" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <i class="fas fa-store" style="font-size: 32px; color: #ea580c; display: block; margin-bottom: 8px;"></i>
                                    <span style="font-size: 13px; font-weight: 600;">Diretamente perante o fornecedor</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Se√ßo 3: Importa√ßo -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">3</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">IMPORTA√á√ÉO DO COMPROVANTE DE SOLICITA√á√ÉO DE COTA√á√ÉO DIRETA</h6>
                        </div>
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151;">1) Importar o comprovante do envio do e-mail ou do recebimento do of√≠cio de solicita√ßo, no caso de cota√ßo diretamente no estabelecimento comercial:</p>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                                Selecione o arquivo para envio:<span style="color: #dc2626;">*</span>
                            </label>
                            <input type="file" name="comprovante_file" accept=".pdf" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                        </div>
                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 4px;">
                            <p style="margin: 0; font-size: 12px; color: #92400e; font-weight: 600;">ORIENTA√á√ïES PARA UPLOAD DO COMPROVANTE</p>
                            <ul style="margin: 8px 0 0 20px; font-size: 12px; color: #92400e;">
                                <li>Tamanho mximo do arquivo: 2MB.</li>
                                <li>Orienta√ßo de todas as pginas do documento: RETRATO.</li>
                                <li>Formato de arquivo aceito: *.pdf</li>
                            </ul>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="background: #f9fafb; padding: 15px 25px;">
                <button type="button" class="btn btn-primary" id="btnEnviarPrimeiroPasso">
                    <i class="fas fa-check"></i> ENVIAR
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> FECHAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Gerenciamento da CDF -->
<div class="modal fade" id="modalGerenciarCDF" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document" style="max-width: 900px;">
        <div class="modal-content">
            <div class="modal-header" style="background: #1e40af; color: white;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 15px;">GERENCIAMENTO DA SOLICITA√á√ÉO DA CDF</h5>
                <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 1;">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <form id="formGerenciarCDF">
                    <input type="hidden" id="gerenciar_cdf_id" name="cdf_id">

                    <!-- Se√ßo 1: Dados da CDF -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">1</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">DADOS DA COTA√á√ÉO DIRETA COM FORNECEDOR</h6>
                        </div>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 6px; border-left: 4px solid #2563eb;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                                <div><strong>CDF n¬∫:</strong> <span id="modal_ger_cdf_numero"></span></div>
                                <div><strong>FORNECEDOR:</strong> <span id="modal_ger_cdf_fornecedor"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Se√ßo 2: Cancelamento -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">2</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">CANCELAMENTO</h6>
                        </div>
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151;">Cancelar a CDF pois:</p>
                        <div style="margin-left: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="cancelamento_motivo[]" value="nao_enviado" style="margin-right: 8px;">
                                o arquivo foi gerado mas no foi enviado ao fornecedor;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="cancelamento_motivo[]" value="outros" style="margin-right: 8px;">
                                outros:
                            </label>
                            <textarea name="cancelamento_obs" rows="2" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;" placeholder="Descreva o motivo..."></textarea>
                        </div>
                    </div>

                    <!-- Se√ßo 3: Descarte -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">3</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">DESCARTE</h6>
                        </div>
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151;">Descartar a CDF pois:</p>
                        <div style="margin-left: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="sem_resposta" style="margin-right: 8px;">
                                no houve resposta a solicita√ßo at√© a concluso do or√ßamento estimativo;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="fora_prazo" style="margin-right: 8px;">
                                no houve resposta a solicita√ßo dentro do prazo concedido;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="fora_prazo_resposta" style="margin-right: 8px;">
                                a resposta a solicita√ßo deu-se fora do prazo concedido;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="desacordo" style="margin-right: 8px;">
                                a especifica√ßo ou condi√ß√µes de fornecimento informadas esto em desacordo com o teor da solicita√ßo;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="responsavel_nao_identificado" style="margin-right: 8px;">
                                o responsvel pela apresenta√ßo da cota√ßo de pre√ßos no esta devidamente identificado (nome leg√≠vel, CPF e/ou cargo/fun√ßo);
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="cnpj_incompativel" style="margin-right: 8px;">
                                o c√≥digo e descri√ßo da atividade econmica principal ou secundria do fornecedor, indicado no comprovante de inscri√ßo e situa√ßo cadastral do CNPJ, √© incompat√≠vel com o objeto da solicita√ßo da CDF;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="vinculo" style="margin-right: 8px;">
                                existem ind√≠cios de v√≠nculo entre o responsvel pela presente CDF e com outro fornecedor consultado;
                            </label>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                <input type="checkbox" name="descarte_motivo[]" value="outros_desc" style="margin-right: 8px;">
                                outros:
                            </label>
                            <textarea name="descarte_obs" rows="2" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;" placeholder="Descreva o motivo..."></textarea>
                        </div>
                    </div>

                    <!-- Se√ßo 4: Juntar Documento -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">4</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">JUNTAR DOCUMENTO</h6>
                        </div>
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151;">Caso entenda necessrio, o or√ßamentista pode juntar documento:</p>
                        <div style="margin-bottom: 15px;">
                            <input type="file" name="documento_file" accept=".pdf" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                        </div>
                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 4px;">
                            <p style="margin: 0; font-size: 12px; color: #92400e; font-weight: 600;">INFORMA√á√ïES SOBRE UPLOAD</p>
                            <ul style="margin: 8px 0 0 20px; font-size: 12px; color: #92400e;">
                                <li>Tamanho mximo do arquivo: 2MB</li>
                                <li>Orienta√ßo de todas as pginas do documento: RETRATO</li>
                                <li>Formato de arquivo aceito: *.pdf</li>
                            </ul>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="background: #f9fafb; padding: 15px 25px;">
                <button type="button" class="btn btn-primary" id="btnConcluirGerenciamento">
                    <i class="fas fa-check"></i> CONCLUIR
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> FECHAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: 2¬∫ Passo - Validar Cota√ßo Direta com Fornecedor -->
<div class="modal fade" id="modalSegundoPasso" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document" style="max-width: 900px;">
        <div class="modal-content">
            <div class="modal-header" style="background: #1e40af; color: white;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 15px;">2¬∫ PASSO: VALIDAR COTA√á√ÉO DIRETA COM FORNECEDOR (CDF)</h5>
                <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 1;">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <form id="formSegundoPasso">
                    <input type="hidden" id="segundo_passo_cdf_id" name="cdf_id">

                    <!-- Se√ßo 1: Dados da CDF -->
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px;">1</div>
                            <h6 style="margin: 0; color: #1e40af; font-weight: 700; font-size: 14px;">DADOS DA COTA√á√ÉO DIRETA COM FORNECEDOR</h6>
                        </div>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 6px; border-left: 4px solid #2563eb;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                                <div><strong>CDF n¬∫:</strong> <span id="modal_2p_cdf_numero"></span></div>
                                <div><strong>FORNECEDOR:</strong> <span id="modal_2p_cdf_fornecedor"></span></div>
                                <div><strong>SITUA√á√ÉO:</strong> <span id="modal_2p_cdf_situacao"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Questo 1 -->
                    <div style="margin-bottom: 25px;">
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151; font-weight: 600;">
                            1) A cota√ßo foi recebida em at√© 5 (cinco) dias √∫teis da solicita√ßo, ou no prazo de resposta acordado com o fornecedor?
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q1" value="sim" style="margin-right: 10px;" required>
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #22c55e; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-check" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 13px; font-weight: 600;">Sim</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q1" value="nao_descartar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ef4444; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-times" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">No (Descartar CDF)</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Questo 2 -->
                    <div style="margin-bottom: 25px;">
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151; font-weight: 600;">
                            2) Na cota√ßo apresentada, a empresa esta devidamente identificada, com razo social ou nome fantasia, CNPJ, endere√ßo, telefone, e-mail, timbre etc?
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q2" value="sim" style="margin-right: 10px;" required>
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ea580c; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-store" style="font-size: 20px; color: white;"></i>
                                        <i class="fas fa-check" style="font-size: 16px; color: white; position: absolute; bottom: 0; right: 0; background: #22c55e; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;"></i>
                                    </div>
                                    <span style="font-size: 13px; font-weight: 600;">Sim</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q2" value="nao_justificar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ea580c; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-store" style="font-size: 20px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">No (justificar o uso)</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q2" value="nao_descartar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ef4444; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-times" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">No (Descartar CDF)</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Questo 3 -->
                    <div style="margin-bottom: 25px;">
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151; font-weight: 600;">
                            3) O responsvel pela apresenta√ßo da cota√ßo de pre√ßos esta devidamente identificado (nome leg√≠vel, CPF e/ou cargo/fun√ßo):
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q3" value="sim" style="margin-right: 10px;" required>
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; position: relative;">
                                        <i class="fas fa-user" style="font-size: 32px; color: #3b82f6;"></i>
                                        <i class="fas fa-check" style="font-size: 16px; color: white; position: absolute; bottom: -4px; right: -4px; background: #22c55e; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center;"></i>
                                    </div>
                                    <span style="font-size: 13px; font-weight: 600;">Sim</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q3" value="nao_justificar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-user" style="font-size: 32px; color: #f97316;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">No (justificar o uso)</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q3" value="nao_descartar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ef4444; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-times" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">No (Descartar CDF)</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Questo 4 -->
                    <div style="margin-bottom: 25px;">
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151; font-weight: 600;">
                            4) Os itens cotados pelo fornecedor esto em conformidade com a solicita√ßo:
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q4" value="sim" style="margin-right: 10px;" required>
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #22c55e; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-check" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 13px; font-weight: 600;">Sim</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q4" value="nao_descartar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ef4444; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-times" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">No (Descartar CDF)</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Questo 5 -->
                    <div style="margin-bottom: 25px;">
                        <p style="margin-bottom: 12px; font-size: 13px; color: #374151; font-weight: 600;">
                            5) Existem ind√≠cios de v√≠nculo entre o responsvel pela presente CDF e outros fornecedores consultados, como s√≥cios conhecidos em comum, mesmo endere√ßo, mesmo padro grfico das cota√ß√µes, mesmos erros de grafia, itens com valores exatamente iguais etc.:
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q5" value="nao" style="margin-right: 10px;" required>
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #ef4444; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-times" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <span style="font-size: 13px; font-weight: 600;">No</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q5" value="sim_justificar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; position: relative;">
                                        <i class="fas fa-search" style="font-size: 28px; color: #f59e0b;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">Sim (justificar o uso)</span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                                <input type="radio" name="q5" value="sim_descartar" style="margin-right: 10px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="width: 50px; height: 50px; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; position: relative;">
                                        <i class="fas fa-search" style="font-size: 28px; color: #f59e0b;"></i>
                                        <i class="fas fa-times" style="font-size: 14px; color: white; position: absolute; bottom: 0; right: 0; background: #ef4444; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;"></i>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 600;">Sim (Descartar CDF)</span>
                                </div>
                            </label>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer" style="background: #f9fafb; padding: 15px 25px;">
                <button type="button" class="btn btn-primary" id="btnEnviarSegundoPasso">
                    <i class="fas fa-check"></i> CONCLUIR
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> FECHAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cabe√ßalho da Pgina -->
<div class="welcome-section">
    <h1 class="welcome-title">ELABORA√á√ÉO DO OR√áAMENTO ESTIMATIVO</h1>
    <p class="welcome-subtitle">Preencha as informa√ß√µes abaixo para concluir o or√ßamento</p>
</div>

<!-- SE√á√ÉO 1: DADOS CADASTRAIS DO OR√áAMENTO -->
<div class="secao">
    <div class="secao-header">
        <div class="secao-numero">1</div>
        <div class="secao-titulo">DADOS CADASTRAIS DO OR√áAMENTO</div>
    </div>

    <div>
        <div class="dados-item">
            <div class="dados-label">N√∫mero do or√ßamento:</div>
            <div class="dados-valor">{{ $orcamento->numero ?? 'No gerado' }}</div>
        </div>
        <div class="dados-item">
            <div class="dados-label">Nome do or√ßamento:</div>
            <div class="dados-valor">{{ $orcamento->nome }}</div>
        </div>
        <div class="dados-item">
            <div class="dados-label">Referncia externa:</div>
            <div class="dados-valor">{{ $orcamento->referencia_externa ?? '-' }}</div>
        </div>
        <div class="dados-item">
            <div class="dados-label">Objeto:</div>
            <div class="dados-valor">{{ $orcamento->objeto }}</div>
        </div>
        <div class="dados-item">
            <div class="dados-label">rgo interessado:</div>
            <div class="dados-valor">{{ $orcamento->orgao_interessado ?? 'Prefeitura municipal de Barbacena' }}</div>
        </div>
        <div class="dados-item">
            <div class="dados-label">Or√ßamentista:</div>
            <div class="dados-valor">{{ $orcamento->user->name }} (CPF: 000.000.000-00 - PORTARIA: 00000/0000)</div>
        </div>
    </div>

    <div style="margin-top: 20px;">
        <button type="button" id="btn-alterar-dados" class="btn btn-secondary">
            <i class="fas fa-edit"></i>
            ALTERAR
        </button>
    </div>
</div>

<!-- SE√á√ÉO 2: METODOLOGIAS E PADR√ïES -->
<div class="secao">
    <div class="secao-header">
        <div class="secao-numero">2</div>
        <div class="secao-titulo">METODOLOGIAS E PADR√ïES</div>
    </div>

    <div class="linha-vertical">
        <h3 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 15px;">
            MTODO DO JUZO CRTICO (EXPURGO DE SOBREPRE√áO E PRE√áO INEXEQUVEL)
        </h3>
        <div class="radio-group">
            <label>
                <input type="radio" name="metodo_juizo_critico" value="saneamento_desvio_padrao" checked>
                <span style="font-size: 13px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 5px;"></i>
                    Saneamento das amostras pelo desvio-padro
                </span>
            </label>
            <label>
                <input type="radio" name="metodo_juizo_critico" value="saneamento_percentual">
                <span style="font-size: 13px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 5px;"></i>
                    Saneamento das amostras com base em percentual
                </span>
            </label>
        </div>
    </div>

    <div class="linha-vertical">
        <h3 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 15px;">
            MTODO DE OBTEN√á√ÉO DO PRE√áO ESTIMADO
        </h3>
        <div class="radio-group">
            <label>
                <input type="radio" name="metodo_obtencao_preco" value="media_mediana" checked>
                <span style="font-size: 13px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 5px;"></i>
                    M√©dia ou mediana a partir do coeficiente de varia√ßo (padro do sistema)
                </span>
            </label>
            <label>
                <input type="radio" name="metodo_obtencao_preco" value="mediana_todas">
                <span style="font-size: 13px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 5px;"></i>
                    Mediana aplicada a todas as amostras
                </span>
            </label>
            <label>
                <input type="radio" name="metodo_obtencao_preco" value="media_todas">
                <span style="font-size: 13px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 5px;"></i>
                    M√©dia aritm√©tica aplicada a todas as amostras
                </span>
            </label>
            <label>
                <input type="radio" name="metodo_obtencao_preco" value="menor_preco">
                <span style="font-size: 13px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 5px;"></i>
                    Menor pre√ßo aplicado a todas as amostras
                </span>
            </label>
        </div>
    </div>

    <div class="linha-vertical">
        <h3 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 15px;">
            PADR√ÉO DE CASAS DECIMAIS
        </h3>
        <div class="radio-group">
            <label>
                <input type="radio" name="casas_decimais" value="duas" checked>
                <span style="font-size: 13px;">Usar duas casas decimais</span>
            </label>
            <label>
                <input type="radio" name="casas_decimais" value="quatro">
                <span style="font-size: 13px;">Usar quatro casas decimais</span>
            </label>
        </div>
    </div>
</div>

<!-- SE√á√ÉO 3: CADASTRAMENTO DE ITENS DO OR√áAMENTO -->
<div class="secao">
    <div class="secao-header">
        <div class="secao-numero">3</div>
        <div class="secao-titulo">
            CADASTRAMENTO DE ITENS DO OR√áAMENTO
            <span class="badge">{{ $orcamento->itens->count() }}</span>
        </div>
        <div style="margin-left: auto; display: flex; gap: 12px; align-items: center;">
            <button type="button" id="btn-calcular-curva-abc" class="btn" style="background: #8b5cf6; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;" title="Calcular Curva ABC (Princ√≠pio de Pareto)">
                <i class="fas fa-chart-line"></i>
                CALCULAR CURVA ABC
            </button>
            <select class="form-select" style="width: 200px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                <option>ORDEM DE ITENS</option>
            </select>
        </div>
    </div>

    @if($orcamento->itens->count() == 0)
    <div class="alert-empty">
        SEU OR√áAMENTO EST√Å VAZIO<br>
        Voca pode come√ßar usando uma das op√ß√µes abaixo.
    </div>

    <div style="margin-top: 20px; display: flex; gap: 12px;">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAdicionarItem">
            <i class="fas fa-plus"></i>
            CRIAR UM ITEM
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCriarLote">
            <i class="fas fa-layer-group"></i>
            CRIAR UM LOTE
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalImportarPlanilha">
            <i class="fas fa-file-upload"></i>
            IMPORTAR ITENS DE UMA PLANILHA
        </button>
    </div>    @else
    <!-- Listagem de itens cadastrados -->
    <div style="margin-top: 20px; margin-bottom: 25px;">
        <table class="data-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f9fafb;">
                    <th style="padding: 8px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; border-bottom: 1px solid #e5e7eb; width: 40px;">
                        <input type="checkbox" id="checkbox-select-all" style="cursor: pointer;">
                    </th>
                    <th style="padding: 12px; text-align: left; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; width: 50px;">Lote/Item</th>
                    <th style="padding: 12px; text-align: left; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb;">Descri√ß√£o</th>
                    <th style="padding: 12px; text-align: left; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; width: 150px;">Fornecedor</th>
                    <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; width: 100px;">Medida</th>
                    <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; width: 70px;">Qnt</th>
                    <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; width: 110px;">Pre√ßo unit (R$)</th>
                    <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; width: 110px;">Pre√ßo total (R$)</th>
                    <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; width: 90px;">ABC</th>
                    <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; border-bottom: 1px solid #e5e7eb; width: 230px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach($orcamento->itens as $index => $item)
                <tr style="border-bottom: 1px solid #f3f4f6;">
                    <td style="padding: 8px; text-align: center;">
                        <input type="checkbox" class="checkbox-item" data-item-id="{{ $item->id }}" style="cursor: pointer;">
                    </td>
                    <td style="padding: 12px; font-size: 13px; color: #374151; text-align: center; font-weight: 600;">{{ str_pad($index + 1, 2, '0', STR_PAD_LEFT) }}/{{ str_pad($index + 1, 3, '0', STR_PAD_LEFT) }}</td>
                    <td style="padding: 12px; font-size: 13px; color: #374151;">{{ strtoupper($item->descricao) }}</td>
                    <td style="padding: 8px; font-size: 11px; color: #374151;" id="fornecedor-cell-{{ $item->id }}">
                        @if($item->fornecedor_nome)
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-building" style="color: #10b981; font-size: 12px;"></i>
                                <span style="font-weight: 600; color: #059669;" title="{{ e($item->fornecedor_nome) }}">
                                    {{ strlen($item->fornecedor_nome) > 20 ? substr($item->fornecedor_nome, 0, 20) . '...' : $item->fornecedor_nome }}
                                </span>
                            </div>
                        @else
                            <span style="color: #9ca3af; font-style: italic; font-size: 11px;">Sem fornecedor</span>
                        @endif
                    </td>
                    <td style="padding: 12px; font-size: 13px; color: #374151; text-align: center;">{{ $item->medida_fornecimento }}</td>
                    <td style="padding: 12px; font-size: 13px; color: #374151; text-align: right;">{{ rtrim(rtrim(number_format($item->quantidade, 2, ',', '.'), '0'), ',') }}</td>
                    <td style="padding: 12px; font-size: 13px; color: {{ $item->preco_unitario ? '#16a34a' : '#6b7280' }}; text-align: right; font-weight: {{ $item->preco_unitario ? '600' : '400' }};">
                        @if($item->preco_unitario)
                            R$ {{ number_format($item->preco_unitario, 2, ',', '.') }}
                        @else
                            <span style="color: #9ca3af; font-style: italic;">Sem pre√ßo</span>
                        @endif
                    </td>
                    <td style="padding: 12px; font-size: 13px; color: {{ $item->preco_unitario ? '#16a34a' : '#6b7280' }}; text-align: right; font-weight: {{ $item->preco_unitario ? '700' : '400' }};">
                        @if($item->preco_unitario)
                            R$ {{ number_format($item->preco_unitario * $item->quantidade, 2, ',', '.') }}
                        @else
                            <span style="color: #9ca3af; font-style: italic;">-</span>
                        @endif
                    </td>
                    <td style="padding: 12px; font-size: 11px; text-align: center;" id="abc-cell-{{ $item->id }}">
                        @if($item->abc_classe)
                            <span class="badge-abc badge-abc-{{ $item->abc_classe }}" style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-weight: 700; font-size: 11px;">
                                CLASSE {{ $item->abc_classe }}
                            </span>
                            <div style="font-size: 9px; color: #6b7280; margin-top: 2px;">
                                {{ number_format($item->abc_participacao ?? 0, 2, ',', '.') }}%
                            </div>
                        @else
                            <span style="font-weight: 600; color: #9ca3af;">SEM CLASSE</span>
                        @endif
                    </td>
                    <td style="padding: 8px; text-align: center;">
                        <!-- Boto 1: LUPA (Cota√ßo de Precos) -->
                        <button type="button" class="btn-cotacao" data-toggle-modal="cotacao" data-item-id="{{ $item->id }}" data-item-descricao="{{ e($item->descricao) }}" title="Cota√ßo de Precos" style="background: #6b7280; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 3px;">
                            <i class="fas fa-search"></i>
                        </button>
                        <!-- Boto 2: AN√ÅLISE (Anlise Cr√≠tica) -->
                        <button type="button" class="btn-analise" data-item-id="{{ $item->id }}" title="Anlise Cr√≠tica dos Dados" style="background: #6b7280; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 3px;">
                            <i class="fas fa-clipboard-check"></i>
                        </button>
                        <!-- Boto 3: ALTERAR (Editar Item) -->
                        <button type="button" class="btn-editar-item" data-item-id="{{ $item->id }}" title="Alterar Item" style="background: #3b82f6; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 3px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <!-- Bot√£o 4: FORNECEDOR (Adicionar/Editar Fornecedor) -->
                        <button type="button" class="btn-fornecedor-item" data-item-id="{{ $item->id }}" data-item-descricao="{{ e($item->descricao) }}" title="Adicionar Fornecedor" style="background: #10b981; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 3px;">
                            <i class="fas fa-building"></i>
                        </button>
                        <!-- Boto 5: ENGRENAGEM (Outras Op√ß√µes) -->
                        <div style="display: inline-block; position: relative;">
                            <button type="button" class="btn-outras-opcoes" data-item-id="{{ $item->id }}" title="Outras op√ß√µes" style="background: #6b7280; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                <i class="fas fa-cog"></i>
                            </button>
                            <!-- Dropdown (sera criado via JavaScript) -->
                        </div>
                    </td>
                </tr>
                @endforeach
            </tbody>
        </table>

        <!-- Bot√µes de Apagar (abaixo da tabela) -->
        <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
            <button type="button" id="btn-apagar-marcados" class="btn" style="background: #dc2626; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">
                <i class="fas fa-times"></i> APAGAR ITENS MARCADOS
            </button>
            <button type="button" id="btn-apagar-todos" class="btn" style="background: #dc2626; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">
                <i class="fas fa-times"></i> APAGAR TODOS OS ITENS
            </button>
        </div>
    </div>

    <!-- Bot√µes para adicionar mais itens -->
    <div style="margin-top: 20px; display: flex; gap: 12px;">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAdicionarItem">
            <i class="fas fa-plus"></i>
            CRIAR UM ITEM
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCriarLote">
            <i class="fas fa-layer-group"></i>
            CRIAR UM LOTE
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalImportarPlanilha">
            <i class="fas fa-file-upload"></i>
            IMPORTAR ITENS DE UMA PLANILHA
        </button>
    </div>
    @endif
</div>

<!-- SE√á√ÉO 4: COLETA DE AMOSTRAS -->
<div class="secao">
    <div class="secao-header">
        <div class="secao-numero">4</div>
        <div class="secao-titulo">COLETA DE AMOSTRAS</div>
    </div>

    <!-- COTA√á√ÉO DIRETA COM FORNECEDORES (CDF) -->
    <div class="linha-vertical" style="margin-bottom: 30px;">
        <h3 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 10px;">
            COTA√á√ÉO DIRETA COM FORNECEDORES (CDF)
        </h3>
        <table class="data-table" style="margin: 15px 0;">
            <thead>
                <tr>
                    <th>N√∫mero</th>
                    <th>Fornecedor</th>
                    <th>Gerada</th>
                    <th>Solicitada</th>
                    <th>Respondida</th>
                    <th>Validade</th>
                    <th>Situa√ßo</th>
                    <th style="width: 450px;">A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                @if($orcamento->solicitacoesCDF->count() > 0)
                    @foreach($orcamento->solicitacoesCDF as $cdf)
                    <tr>
                        <td>{{ str_pad($cdf->id, 2, '0', STR_PAD_LEFT) }}/2025</td>
                        <td>{{ $cdf->razao_social }}</td>
                        <td>{{ $cdf->created_at->format('d/m/Y') }}</td>
                        <td>{{ $cdf->created_at->format('d/m/Y') }}</td>
                        <td>-</td>
                        <td>-</td>
                        <td><span style="background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 4px; font-size: 11px; font-weight: 600;">{{ $cdf->status }}</span></td>
                        <td>
                            <div style="display: flex; gap: 4px; align-items: center;">
                                <!-- 1. Baixar Of√≠cio (Word) -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="baixar-oficio" title="Baixar Of√≠cio de Solicita√ßo (Word)">
                                    <i class="fas fa-file-word" style="color: #2563eb;"></i>
                                </button>

                                <!-- 2. Baixar Formulrio (Excel) -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="baixar-formulario" title="Baixar Formulrio de Cota√ßo (Excel)">
                                    <i class="fas fa-file-excel" style="color: #16a34a;"></i>
                                </button>

                                <!-- 3. Primeiro Passo -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="primeiro-passo" title="1¬∫ Passo: Validar Solicita√ßo e Importar Comprovante">
                                    <i class="fas fa-check-circle" style="color: #059669;"></i>
                                </button>

                                <!-- 4. Engrenagem (Dropdown) -->
                                <div style="position: relative;">
                                    <button class="btn-icon-acao btn-dropdown-cdf" data-cdf-id="{{ $cdf->id }}" title="Mais op√ß√µes">
                                        <i class="fas fa-cog" style="color: #6b7280;"></i>
                                    </button>
                                    <div class="dropdown-menu-cdf" id="dropdown-cdf-{{ $cdf->id }}" style="display: none;">
                                        <a href="#" data-action="alterar-primeiro-passo" data-cdf-id="{{ $cdf->id }}">Alterar 1¬∫ Passo</a>
                                        <a href="#" data-action="segundo-passo" data-cdf-id="{{ $cdf->id }}">2¬∫ Passo: Validar Cota√ßo</a>
                                    </div>
                                </div>

                                <!-- 5. Baixar Espelho CNPJ -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="baixar-cnpj" title="Baixar Espelho CNPJ">
                                    <i class="fas fa-id-card" style="color: #7c3aed;"></i>
                                </button>

                                <!-- 6. Baixar Comprovante -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="baixar-comprovante" title="Baixar Comprovante da Solicita√ßo">
                                    <i class="fas fa-file-pdf" style="color: #dc2626;"></i>
                                </button>

                                <!-- 7. Baixar Cota√ßo -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="baixar-cotacao" title="Baixar Cota√ßo Direta com Fornecedor">
                                    <i class="fas fa-download" style="color: #ea580c;"></i>
                                </button>

                                <!-- 8. Gerenciar -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="gerenciar" title="Gerenciar a CDF">
                                    <i class="fas fa-tasks" style="color: #0891b2;"></i>
                                </button>

                                <!-- 9. Remover -->
                                <button class="btn-icon-acao" data-cdf-id="{{ $cdf->id }}" data-action="remover" title="Remover a CDF">
                                    <i class="fas fa-trash" style="color: #dc2626;"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    @endforeach
                @else
                <tr>
                    <td colspan="8" style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                        Este or√ßamento ainda no possui cota√ß√µes diretas com fornecedor
                    </td>
                </tr>
                @endif
            </tbody>
        </table>
        <button class="btn btn-outline" id="btn-solicitar-cdf" style="
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            font-weight: 700;
            font-size: 13px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'">
            <i class="fas fa-file-invoice" style="margin-right: 8px;"></i>
            SOLICITAR CDF
        </button>
    </div>

    <!-- CONTRATA√á√ïES SIMILARES FEITAS PELA ADMINISTRA√á√ÉO PBLICA -->
    <div class="linha-vertical" style="margin-bottom: 30px;">
        <h3 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 10px;">
            CONTRATA√á√ïES SIMILARES FEITAS PELA ADMINISTRA√á√ÉO PBLICA
        </h3>
        <table class="data-table" style="margin: 15px 0;">
            <thead>
                <tr>
                    <th>N√∫mero do prego</th>
                    <th>Data</th>
                    <th>Publica√ßo</th>
                    <th>Ente p√∫blico</th>
                </tr>
            </thead>
            <tbody>
                @if($orcamento->contratacoesSimilares->count() > 0)
                    @foreach($orcamento->contratacoesSimilares as $contratacao)
                    <tr>
                        <td>{{ $contratacao->numero_processo }}</td>
                        <td>{{ $contratacao->data_publicacao ? \Carbon\Carbon::parse($contratacao->data_publicacao)->format('d/m/Y') : '-' }}</td>
                        <td>{{ $contratacao->local_publicacao ?? '-' }}</td>
                        <td>{{ $contratacao->ente_publico }}</td>
                    </tr>
                    @endforeach
                @else
                <tr>
                    <td colspan="4" style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                        Este or√ßamento ainda no possui contrata√ß√µes similares de outros entes p√∫blicos
                    </td>
                </tr>
                @endif
            </tbody>
        </table>
        <button class="btn btn-outline" id="btn-contratacoes-similares-novo" style="
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            font-weight: 700;
            font-size: 13px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'">
            <i class="fas fa-building" style="margin-right: 8px;"></i>
            INCLUIR CONTRATA√á√ïES SIMILARES
        </button>
    </div>

    <!-- STIOS DE COMRCIO ELETRNICO -->
    <div class="linha-vertical">
        <h3 style="font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 10px;">
            STIOS DE COMRCIO ELETRNICO
        </h3>
        <table class="data-table" style="margin: 15px 0;">
            <thead>
                <tr>
                    <th>N√∫mero</th>
                    <th>Nome</th>
                    <th>Data da consulta</th>
                </tr>
            </thead>
            <tbody>
                @if($orcamento->coletasEcommerce->count() > 0)
                    @foreach($orcamento->coletasEcommerce as $coleta)
                    <tr>
                        <td>{{ str_pad($coleta->id, 2, '0', STR_PAD_LEFT) }}/2025</td>
                        <td>{{ $coleta->nome_site }}</td>
                        <td>{{ $coleta->data_consulta ? \Carbon\Carbon::parse($coleta->data_consulta)->format('d/m/Y') : '-' }}</td>
                    </tr>
                    @endforeach
                @else
                <tr>
                    <td colspan="3" style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                        Este or√ßamento ainda no possui coletas em s√≠tios de com√©rcio eletrnico.
                    </td>
                </tr>
                @endif
            </tbody>
        </table>
        <button class="btn btn-outline" id="btn-incluir-sitio-ecommerce" style="
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            font-weight: 700;
            font-size: 13px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'">
            <i class="fas fa-shopping-cart" style="margin-right: 8px;"></i>
            INCLUIR COLETA EM S√çTIO DE COM√âRCIO ELETR√îNICO
        </button>
    </div>
</div>

<!-- Modal: Sucesso Salvamento Or√ßamentista -->
<div class="modal fade" id="modalSucessoSalvamento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
            <div class="modal-body" style="padding: 40px 30px; text-align: center;">
                <i class="fas fa-check-circle" style="font-size: 56px; color: #10b981; margin-bottom: 20px;"></i>
                <h5 style="color: #065f46; font-weight: 700; margin-bottom: 12px; font-size: 18px;">Dados Salvos com Sucesso!</h5>
                <p style="color: #6b7280; font-size: 14px; margin: 0; line-height: 1.5;">
                    Os dados do or√ßamentista foram salvos e esto dispon√≠veis para uso no sistema.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- SE√á√ÉO 6: DADOS DO OR√áAMENTISTA (para Preview) -->
<div class="secao">
    <div class="secao-header">
        <div class="secao-numero">6</div>
        <div class="secao-titulo">DADOS DO OR√áAMENTISTA</div>
    </div>

    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 16px; margin-bottom: 20px; border-radius: 6px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-info-circle" style="color: #f59e0b; font-size: 16px;"></i>
            <span style="color: #92400e; font-size: 13px; font-weight: 500;">
                Preencha os dados do or√ßamentista para emisso do preview do or√ßamento. Ao informar um CNPJ, os dados sero preenchidos automaticamente.
            </span>
        </div>
    </div>

    <form id="form-orcamentista" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- Nome do Or√ßamentista -->
        <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Nome do Or√ßamentista: <span style="color: #dc2626;">*</span>
            </label>
            <input
                type="text"
                id="orcamentista_nome"
                name="orcamentista_nome"
                value="{{ $orcamento->orcamentista_nome ?? '' }}"
                required
                class="form-input"
                placeholder="Digite o nome completo do or√ßamentista"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
        </div>

        <!-- CPF/CNPJ -->
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                CPF/CNPJ: <span style="color: #dc2626;">*</span>
            </label>
            <input
                type="text"
                id="orcamentista_cpf_cnpj"
                name="orcamentista_cpf_cnpj"
                value="{{ $orcamento->orcamentista_cpf_cnpj ?? '' }}"
                required
                class="form-input"
                placeholder="Digite CPF ou CNPJ"
                maxlength="18"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
            <small id="cpf-cnpj-feedback" style="display: block; margin-top: 4px; font-size: 11px;"></small>
        </div>

        <!-- CEP -->
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                CEP: <span style="color: #9ca3af; font-weight: 400;">(opcional)</span>
            </label>
            <input
                type="text"
                id="orcamentista_cep_manual"
                name="orcamentista_cep_manual"
                value="{{ $orcamento->orcamentista_cep ?? '' }}"
                class="form-input"
                placeholder="Ex: 00.000-000"
                maxlength="10"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
        </div>

        <!-- Estado (UF) -->
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Estado (UF): <span style="color: #9ca3af; font-weight: 400;">(opcional)</span>
            </label>
            <select
                id="orcamentista_uf_manual"
                name="orcamentista_uf_manual"
                class="form-input"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
                <option value="">Selecione o Estado</option>
                <option value="AC" {{ ($orcamento->orcamentista_uf ?? '') == 'AC' ? 'selected' : '' }}>AC - Acre</option>
                <option value="AL" {{ ($orcamento->orcamentista_uf ?? '') == 'AL' ? 'selected' : '' }}>AL - Alagoas</option>
                <option value="AP" {{ ($orcamento->orcamentista_uf ?? '') == 'AP' ? 'selected' : '' }}>AP - Amap</option>
                <option value="AM" {{ ($orcamento->orcamentista_uf ?? '') == 'AM' ? 'selected' : '' }}>AM - Amazonas</option>
                <option value="BA" {{ ($orcamento->orcamentista_uf ?? '') == 'BA' ? 'selected' : '' }}>BA - Bahia</option>
                <option value="CE" {{ ($orcamento->orcamentista_uf ?? '') == 'CE' ? 'selected' : '' }}>CE - Cear</option>
                <option value="DF" {{ ($orcamento->orcamentista_uf ?? '') == 'DF' ? 'selected' : '' }}>DF - Distrito Federal</option>
                <option value="ES" {{ ($orcamento->orcamentista_uf ?? '') == 'ES' ? 'selected' : '' }}>ES - Espirito Santo</option>
                <option value="GO" {{ ($orcamento->orcamentista_uf ?? '') == 'GO' ? 'selected' : '' }}>GO - Gois</option>
                <option value="MA" {{ ($orcamento->orcamentista_uf ?? '') == 'MA' ? 'selected' : '' }}>MA - Maranho</option>
                <option value="MT" {{ ($orcamento->orcamentista_uf ?? '') == 'MT' ? 'selected' : '' }}>MT - Mato Grosso</option>
                <option value="MS" {{ ($orcamento->orcamentista_uf ?? '') == 'MS' ? 'selected' : '' }}>MS - Mato Grosso do Sul</option>
                <option value="MG" {{ ($orcamento->orcamentista_uf ?? '') == 'MG' ? 'selected' : '' }}>MG - Minas Gerais</option>
                <option value="PA" {{ ($orcamento->orcamentista_uf ?? '') == 'PA' ? 'selected' : '' }}>PA - Par</option>
                <option value="PB" {{ ($orcamento->orcamentista_uf ?? '') == 'PB' ? 'selected' : '' }}>PB - Paraiba</option>
                <option value="PR" {{ ($orcamento->orcamentista_uf ?? '') == 'PR' ? 'selected' : '' }}>PR - Paran</option>
                <option value="PE" {{ ($orcamento->orcamentista_uf ?? '') == 'PE' ? 'selected' : '' }}>PE - Pernambuco</option>
                <option value="PI" {{ ($orcamento->orcamentista_uf ?? '') == 'PI' ? 'selected' : '' }}>PI - Piaui</option>
                <option value="RJ" {{ ($orcamento->orcamentista_uf ?? '') == 'RJ' ? 'selected' : '' }}>RJ - Rio de Janeiro</option>
                <option value="RN" {{ ($orcamento->orcamentista_uf ?? '') == 'RN' ? 'selected' : '' }}>RN - Rio Grande do Norte</option>
                <option value="RS" {{ ($orcamento->orcamentista_uf ?? '') == 'RS' ? 'selected' : '' }}>RS - Rio Grande do Sul</option>
                <option value="RO" {{ ($orcamento->orcamentista_uf ?? '') == 'RO' ? 'selected' : '' }}>RO - Rondnia</option>
                <option value="RR" {{ ($orcamento->orcamentista_uf ?? '') == 'RR' ? 'selected' : '' }}>RR - Roraima</option>
                <option value="SC" {{ ($orcamento->orcamentista_uf ?? '') == 'SC' ? 'selected' : '' }}>SC - Santa Catarina</option>
                <option value="SP" {{ ($orcamento->orcamentista_uf ?? '') == 'SP' ? 'selected' : '' }}>SP - So Paulo</option>
                <option value="SE" {{ ($orcamento->orcamentista_uf ?? '') == 'SE' ? 'selected' : '' }}>SE - Sergipe</option>
                <option value="TO" {{ ($orcamento->orcamentista_uf ?? '') == 'TO' ? 'selected' : '' }}>TO - Tocantins</option>
            </select>
        </div>

        <!-- Endere√ßo/Rua -->
        <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Endere√ßo/Rua: <span style="color: #9ca3af; font-weight: 400;">(opcional)</span>
            </label>
            <input
                type="text"
                id="orcamentista_endereco_manual"
                name="orcamentista_endereco_manual"
                value="{{ $orcamento->orcamentista_endereco ?? '' }}"
                class="form-input"
                placeholder="Ex: Rua Principal, n¬∫ 123, Centro"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
        </div>

        <!-- Telefone -->
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Telefone: <span style="color: #9ca3af; font-weight: 400;">(opcional)</span>
            </label>
            <input
                type="text"
                id="orcamentista_telefone"
                name="orcamentista_telefone"
                value="{{ $orcamento->orcamentista_telefone ?? '' }}"
                class="form-input"
                placeholder="Ex: (00) 0000-0000"
                maxlength="15"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
        </div>

        <!-- Email -->
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Email: <span style="color: #9ca3af; font-weight: 400;">(opcional)</span>
            </label>
            <input
                type="email"
                id="orcamentista_email"
                name="orcamentista_email"
                value="{{ $orcamento->orcamentista_email ?? '' }}"
                class="form-input"
                placeholder="Ex: email@exemplo.com"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
        </div>

        <!-- Setor/Departamento -->
        <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Setor/Departamento: <span style="color: #9ca3af; font-weight: 400;">(opcional)</span>
            </label>
            <input
                type="text"
                id="orcamentista_setor"
                name="orcamentista_setor"
                value="{{ $orcamento->orcamentista_setor ?? '' }}"
                class="form-input"
                placeholder="Ex: SETOR DE COMPRAS"
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
        </div>

        <!-- Campos ocultos para dados da ReceitaWS (sero sobrescritos pelos campos manuais se preenchidos) -->
        <input type="hidden" id="orcamentista_razao_social" name="orcamentista_razao_social" value="{{ $orcamento->orcamentista_razao_social ?? '' }}">
        <input type="hidden" id="orcamentista_endereco" name="orcamentista_endereco" value="{{ $orcamento->orcamentista_endereco ?? '' }}">
        <input type="hidden" id="orcamentista_cep" name="orcamentista_cep" value="{{ $orcamento->orcamentista_cep ?? '' }}">
        <input type="hidden" id="orcamentista_cidade" name="orcamentista_cidade" value="{{ $orcamento->orcamentista_cidade ?? '' }}">
        <input type="hidden" id="orcamentista_uf" name="orcamentista_uf" value="{{ $orcamento->orcamentista_uf ?? '' }}">

        <!-- Upload de Braso -->
        <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Braso/Logo do rgo: <span style="color: #9ca3af; font-weight: 400;">(opcional)</span>
            </label>
            <div style="background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; text-align: center;">
                <input
                    type="file"
                    id="brasao_file"
                    name="brasao_file"
                    accept="image/png,image/jpeg,image/jpg,image/svg+xml"
                    style="display: none;"
                    onchange="previewBrasao(this)"
                >
                <button type="button" onclick="document.getElementById('brasao_file').click()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">
                    <i class="fas fa-upload"></i> Selecionar Braso/Logo
                </button>
                <p style="margin-top: 8px; font-size: 12px; color: #64748b;">
                    Formatos aceitos: PNG, JPG, SVG | Tamanho recomendado: 300x300px | Mx: 2MB
                </p>
                <p style="margin-top: 4px; font-size: 11px; color: #94a3b8;">
                    A imagem sera automaticamente redimensionada para caber perfeitamente no documento
                </p>

                @if($orcamento->brasao_path)
                    <div id="brasao-preview" style="margin-top: 16px; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; display: inline-block;">
                        <img src="{{ asset('storage/' . $orcamento->brasao_path) }}" alt="Braso" style="max-width: 120px; max-height: 120px; object-fit: contain;">
                        <p style="margin-top: 8px; font-size: 11px; color: #10b981; font-weight: 600;"> Braso atual</p>
                    </div>
                @else
                    <div id="brasao-preview" style="margin-top: 16px; display: none;">
                        <div style="padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; display: inline-block;">
                            <img id="brasao-preview-img" src="" alt="Preview" style="max-width: 120px; max-height: 120px; object-fit: contain;">
                            <p style="margin-top: 8px; font-size: 11px; color: #10b981; font-weight: 600;"> Novo braso selecionado</p>
                        </div>
                    </div>
                @endif
            </div>
        </div>

        <!-- Boto Salvar Dados -->
        <div style="grid-column: 1 / -1; margin-top: 10px;">
            <button type="button" id="btn-salvar-orcamentista" class="btn btn-primary">
                <i class="fas fa-save"></i>
                SALVAR DADOS DO OR√áAMENTISTA
            </button>
        </div>
    </form>
</div>

<!-- SE√á√ÉO 7: GERAR OR√áAMENTO ESTIMATIVO -->
<div class="secao">
    <div class="secao-header">
        <div class="secao-numero">7</div>
        <div class="secao-titulo">GERAR OR√áAMENTO ESTIMATIVO</div>
    </div>

    <form id="form-concluir" method="POST" action="/orcamentos/{{ $orcamento->id }}/concluir" enctype="multipart/form-data">
        @csrf

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Observa√ßo/Justificativa geral:
            </label>
            <textarea
                name="observacao_justificativa"
                class="form-textarea"
                rows="6"
                placeholder="Digite aqui observacoes ou justificativas gerais sobre o orcamento..."
                style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: inherit; resize: vertical;"
            >{{ $orcamento->observacao_justificativa ?? '' }}</textarea>
        </div>

        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 13px;">
                Anexar PDF <span style="color: #6b7280; font-weight: 400;">(Opcional - Mx. 2MB):</span>
            </label>
            <input
                type="file"
                name="anexo_pdf"
                accept=".pdf"
                class="form-input"
                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
            >
            @if($orcamento->anexo_pdf)
                <div style="margin-top: 8px; font-size: 12px; color: #059669;">
                    <i class="fas fa-file-pdf"></i> Arquivo anexado: {{ basename($orcamento->anexo_pdf) }}
                </div>
            @endif
            <div style="margin-top: 6px; font-size: 11px; color: #6b7280; line-height: 1.5;">
                <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
                O PDF √© opcional. Voca pode concluir a cota√ßo sem anexar arquivo ou anexar depois.
            </div>
        </div>

        <div style="display: flex; gap: 12px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-check-circle"></i>
                CONCLUIR COTA√á√ÉO
            </button>
            <button type="button" class="btn btn-secondary" id="btn-preview">
                <i class="fas fa-eye"></i>
                PREVIEW DA COTA√á√ÉO
            </button>
        </div>
    </form>
</div>

<script>
// Fun√ßo global para preview do braso
function previewBrasao(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];

        // Validar tamanho (mx 2MB)
        if (file.size > 2 * 1024 * 1024) {
            alert('[AVISO] O arquivo e muito grande. O tamanho maximo e 2MB.');
            input.value = '';
            return;
        }

        // Validar tipo
        const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
        if (!validTypes.includes(file.type)) {
            alert('[AVISO] Formato invlido. Use PNG, JPG ou SVG.');
            input.value = '';
            return;
        }

        // Mostrar preview
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewDiv = document.getElementById('brasao-preview');
            const previewImg = document.getElementById('brasao-preview-img');

            if (previewImg) {
                previewImg.src = e.target.result;
                previewDiv.style.display = 'block';
            }
        };
        reader.readAsDataURL(file);
    }
}

//  PROTE√á√ÉO: Listener √∫nico para config do or√ßamento
window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
    // ===================================================================
    // CONFIGURA√á√ïES DO OR√áAMENTO (passadas do Blade para JavaScript)
    // ===================================================================
    const ORCAMENTO_CONFIG = {
        casasDecimais: '{{ $orcamento->casas_decimais ?? "duas" }}',
        metodoJuizoCritico: '{{ $orcamento->metodo_juizo_critico ?? "saneamento_desvio_padrao" }}'
    };

    console.log('[CONFIG] Casas decimais:', ORCAMENTO_CONFIG.casasDecimais);
    console.log('[CONFIG] Metodo juizo critico:', ORCAMENTO_CONFIG.metodoJuizoCritico);

    // Helper: Escapar string para uso seguro em alerts
    window.escapeAlert = function(texto) {
        if (!texto) return '';
        return String(texto).replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/'/g, "\\'");
    };

    // Boto Preview
    const btnPreview = document.getElementById('btn-preview');
    if (btnPreview) {
        btnPreview.addEventListener('click', function() {
            // Verificar se ha braso selecionado mas no salvo
            const brasaoFile = document.getElementById('brasao_file');
            const brasaoAtual = {{ $orcamento->brasao_path ? 'true' : 'false' }};

            if (brasaoFile && brasaoFile.files.length > 0 && !brasaoAtual) {
                const confirmar = confirm(' ATEN√á√ÉO!\n\n' +
                    'Voca selecionou um novo BRAS√ÉO/LOGO mas ainda N√ÉO salvou.\n\n' +
                    ' Para que o braso apare√ßa no Preview:\n' +
                    '1. Clique em "SALVAR DADOS DO OR√áAMENTISTA" (Se√ßo 6)\n' +
                    '2. Depois clique em "PREVIEW DA COTA√á√ÉO"\n\n' +
                    'Deseja abrir o preview mesmo assim?\n' +
                    '(O braso N√ÉO aparecera se voca no salvou)');

                if (!confirmar) {
                    return;
                }
            }

            // Abrir preview em nova janela - usar URL relativa (sem /) para funcionar com tag <base>
            window.open('orcamentos/' + window.ORCAMENTO_ID + '/preview', '_blank');
        });
    }

    // Controle do Modal de Confirma√ßo
    const form = document.getElementById('form-concluir');
    const modal = document.getElementById('modal-confirmacao');
    const btnConfirmar = document.getElementById('modal-btn-confirmar');
    const btnCancelar = document.getElementById('modal-btn-cancelar');

    if (form && modal && btnConfirmar && btnCancelar) {
        let submitAllowed = false;

        // Interceptar submit do formulrio
        form.addEventListener('submit', function(e) {
            if (!submitAllowed) {
                e.preventDefault();
                // Mostrar modal
                modal.style.display = 'block';
            }
        });

        // Boto Confirmar - submete o formulrio via AJAX
        btnConfirmar.addEventListener('click', async function() {
            submitAllowed = true;
            modal.style.display = 'none';

            // Desabilitar botao e mostrar loading
            btnConfirmar.disabled = true;
            btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Concluindo...';

            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.success) {
                    // Mostrar mensagem de sucesso (escapar para prevenir quebra de sintaxe)
                    alert(window.escapeAlert(data.message || 'Orcamento conclu√≠do com sucesso!'));
                    // Redirecionar usando URL absoluta para evitar problema com localhost
                    const redirectUrl = data.redirect || (window.location.origin + '/module-proxy/price_basket/orcamentos/realizados');
                    window.location.href = redirectUrl;
                } else {
                    alert('Erro: ' + window.escapeAlert(data.message || 'Erro ao concluir or√ßamento'));
                    btnConfirmar.disabled = false;
                    btnConfirmar.innerHTML = '<i class="fas fa-check-circle"></i> CONFIRMAR';
                }
            } catch (error) {
                console.error('Erro ao concluir or√ßamento:', error);
                alert('Erro ao concluir or√ßamento. Por favor, tente novamente.');
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = '<i class="fas fa-check-circle"></i> CONFIRMAR';
            }
        });

        // Boto Cancelar - fecha o modal
        btnCancelar.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        // Fechar modal ao clicar fora dele
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }

    // Controle do Modal de Edi√ßo
    const btnAlterarDados = document.getElementById('btn-alterar-dados');
    const modalEdicao = document.getElementById('modal-edicao');
    const btnEditCancelar = document.getElementById('modal-edit-cancelar');
    const formEditarDados = document.getElementById('form-editar-dados');

    if (btnAlterarDados && modalEdicao && btnEditCancelar && formEditarDados) {
        // Abrir modal de edi√ßo
        btnAlterarDados.addEventListener('click', function() {
            modalEdicao.style.display = 'block';
        });

        // Fechar modal de edi√ßo
        btnEditCancelar.addEventListener('click', function() {
            modalEdicao.style.display = 'none';
        });

        // Fechar modal ao clicar fora
        modalEdicao.addEventListener('click', function(e) {
            if (e.target === modalEdicao) {
                modalEdicao.style.display = 'none';
            }
        });

        // Submit do formulrio de edi√ßo via AJAX
        formEditarDados.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            formData.append('_method', 'PUT');

            // Mostrar loading no botao
            const btnSubmit = this.querySelector('button[type="submit"]');
            const textoOriginal = btnSubmit.innerHTML;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
            btnSubmit.disabled = true;

            fetch(`${window.APP_BASE_PATH}/orcamentos/${window.ORCAMENTO_ID}`, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Atualizar os valores na pgina
                    document.querySelector('.dados-item:nth-child(2) .dados-valor').textContent = formData.get('nome');
                    document.querySelector('.dados-item:nth-child(3) .dados-valor').textContent = formData.get('referencia_externa') || '-';
                    document.querySelector('.dados-item:nth-child(4) .dados-valor').textContent = formData.get('objeto');
                    document.querySelector('.dados-item:nth-child(5) .dados-valor').textContent = formData.get('orgao_interessado') || 'Prefeitura municipal de Barbacena';

                    // Fechar modal
                    modalEdicao.style.display = 'none';

                    // Mensagem de sucesso (opcional)
                    alert('Dados atualizados com sucesso!');
                } else {
                    alert('Erro ao atualizar dados: ' + window.escapeAlert(data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao atualizar dados. Tente novamente.');
            })
            .finally(() => {
                // Restaurar botao
                btnSubmit.innerHTML = textoOriginal;
                btnSubmit.disabled = false;
            });
        });
    }

    // =================================================================
    // CONTROLE DOS MODAIS - ADICIONAR ITEM, CRIAR LOTE, IMPORTAR PLANILHA
    // =================================================================

    // Os modais so abertos automaticamente pelo Bootstrap atrav√©s do data-bs-toggle="modal"
    // Apenas precisamos configurar os event listeners dos bot√µes SALVAR/ENVIAR

    // =================================================================
    // MODAL 1: ADICIONAR ITEM
    // =================================================================

    const btnSalvarItem = document.getElementById('btnSalvarItem');
    if (btnSalvarItem) {
        btnSalvarItem.addEventListener('click', function() {
        const form = document.getElementById('formAdicionarItem');
    
        // Validar campos obrigat√≥rios
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
    
        // Preparar dados do formulrio
        const formData = new FormData(form);
    
        // Pegar o valor do radio button selecionado e ajustar para o backend
        const tipoItemSelecionado = document.querySelector('input[name="tipo_item"]:checked');
        const alterarCdfsSelecionado = document.querySelector('input[name="alterar_cdfs"]:checked');
    
        // Backend espera 'tipo' (no 'tipo_item') com valores lowercase: 'produto' ou 'servico'
        if (tipoItemSelecionado) {
            formData.set('tipo', tipoItemSelecionado.value.toLowerCase().replace('√ß', 'c'));
        }
    
        // Backend espera 'alterar_cdf' (no 'alterar_cdfs') como boolean
        if (alterarCdfsSelecionado) {
            formData.set('alterar_cdf', alterarCdfsSelecionado.value === 'SIM' ? '1' : '0');
        }
    
        // Mostrar loading no botao
        const btnSalvar = this;
        const textoOriginal = btnSalvar.innerHTML;
        btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
        btnSalvar.disabled = true;
    
        // Enviar via AJAX
        fetch(`${window.APP_BASE_PATH}/orcamentos/${window.ORCAMENTO_ID}/itens`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fechar modal
                const modalEl = document.getElementById('modalAdicionarItem');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
    
                // Limpar formulrio
                form.reset();
    
                // Mostrar mensagem de sucesso
                alert('Item adicionado com sucesso!');
    
                // Recarregar pgina para mostrar o novo item
                window.location.reload();
            } else {
                alert('Erro ao adicionar item: ' + window.escapeAlert(data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao adicionar item. Tente novamente.');
        })
        .finally(() => {
            // Restaurar botao
            btnSalvar.innerHTML = textoOriginal;
            btnSalvar.disabled = false;
        });
        });
    }
    
    // =================================================================
    // MODAL 2: CRIAR LOTE
    // =================================================================
    
    const btnSalvarLote = document.getElementById('btnSalvarLote');
    if (btnSalvarLote) {
        btnSalvarLote.addEventListener('click', function() {
        const form = document.getElementById('formCriarLote');
    
        // Validar campos obrigat√≥rios
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
    
        // Validar n√∫mero maior que 1
        const numeroLote = document.getElementById('lote_numero').value;
        if (parseInt(numeroLote) < 1) {
            alert('O n√∫mero do lote deve ser maior ou igual a 1');
            return;
        }
    
        // Preparar dados do formulrio
        const formData = new FormData(form);
    
        // Mostrar loading no botao
        const btnSalvar = this;
        const textoOriginal = btnSalvar.innerHTML;
        btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
        btnSalvar.disabled = true;
    
        // Enviar via AJAX
        fetch(`${window.APP_BASE_PATH}/orcamentos/${window.ORCAMENTO_ID}/lotes`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fechar modal
                const modalEl = document.getElementById('modalCriarLote');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
    
                // Limpar formulrio
                form.reset();
    
                // Mostrar mensagem de sucesso
                alert('Lote criado com sucesso!');
    
                // Recarregar pgina
                window.location.reload();
            } else {
                alert('Erro ao criar lote: ' + window.escapeAlert(data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao criar lote. Tente novamente.');
        })
        .finally(() => {
            // Restaurar botao
            btnSalvar.innerHTML = textoOriginal;
            btnSalvar.disabled = false;
        });
        });
    }
    
    // =================================================================
    // MODAL 3: IMPORTAR PLANILHA
    // =================================================================
    
    const btnEnviarPlanilha = document.getElementById('btnEnviarPlanilha');
    if (btnEnviarPlanilha) {
        btnEnviarPlanilha.addEventListener('click', function() {
        const form = document.getElementById('formImportarPlanilha');
        const arquivoInput = document.getElementById('arquivo_planilha');
    
        // Validar se arquivo foi selecionado
        if (!arquivoInput.files || arquivoInput.files.length === 0) {
            alert('Por favor, selecione um arquivo para importar.');
            return;
        }
    
        // Validar extenso do arquivo
        const arquivo = arquivoInput.files[0];
        const extensao = arquivo.name.split('.').pop().toLowerCase();
        if (!['xlsx', 'xls', 'csv'].includes(extensao)) {
            alert('Por favor, selecione um arquivo Excel vlido (.xlsx, .xls ou .csv)');
            return;
        }
    
        // Preparar dados do formulrio
        const formData = new FormData(form);
    
        // Mostrar loading no botao
        const btnEnviar = this;
        const textoOriginal = btnEnviar.innerHTML;
        btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ENVIANDO...';
        btnEnviar.disabled = true;
    
        // Enviar via AJAX
        // IMPORTANTE: No definir Content-Type - deixar browser definir automaticamente com boundary
        fetch(`${window.APP_BASE_PATH}/orcamentos/${window.ORCAMENTO_ID}/importar-planilha`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || form.querySelector('input[name="_token"]')?.value,
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fechar modal
                const modalEl = document.getElementById('modalImportarPlanilha');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
    
                // Limpar formulrio
                form.reset();
    
                // Mostrar mensagem de sucesso
                alert('Planilha importada com sucesso!' + (data.message ? '\n' + window.escapeAlert(data.message) : ''));

                // Recarregar pgina
                window.location.reload();
            } else {
                alert('Erro ao importar planilha: ' + window.escapeAlert(data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao importar planilha. Verifique o formato do arquivo e tente novamente.');
        })
        .finally(() => {
            // Restaurar botao
            btnEnviar.innerHTML = textoOriginal;
            btnEnviar.disabled = false;
        });
        });
    }
    
    // =================================================================
    // C√ÅLCULO AUTOM√ÅTICO DO PRE√áO TOTAL NO MODAL ADICIONAR ITEM
    // =================================================================

    function calcularPrecoTotalModal() {
        const quantidade = parseFloat(document.getElementById('item_quantidade')?.value) || 0;
        let precoUnitario = parseFloat(document.getElementById('item_preco_unitario')?.value) || 0;

        // ===================================================================
        // APLICAR ARREDONDAMENTO CONFORME CONFIGURA√á√ÉO DE CASAS DECIMAIS
        // ===================================================================
        if (ORCAMENTO_CONFIG.casasDecimais === 'duas') {
            // Arredondar PARA CIMA (conforme requisito do usu√°rio)
            // Exemplo: 15.17 ‚Üí 16, 303.40 ‚Üí 304
            precoUnitario = Math.ceil(precoUnitario);
        } else if (ORCAMENTO_CONFIG.casasDecimais === 'quatro') {
            // Permitir 4 casas decimais (arredondar apenas no 5¬∫ d√≠gito)
            // Exemplo: 15.17456 ‚Üí 15.1746
            precoUnitario = Math.round(precoUnitario * 10000) / 10000;
        }

        // Calcular pre√ßo total
        let precoTotal = quantidade * precoUnitario;

        // Aplicar arredondamento no total tamb√©m
        if (ORCAMENTO_CONFIG.casasDecimais === 'duas') {
            precoTotal = Math.ceil(precoTotal);
        }

        const precoTotalEl = document.getElementById('preco_total_calculado');
        if (precoTotalEl) {
            const decimais = (ORCAMENTO_CONFIG.casasDecimais === 'quatro') ? 4 : 0; // 0 decimais para "duas casas" pois arredonda para inteiro
            precoTotalEl.textContent = 'R$ ' + precoTotal.toLocaleString('pt-BR', {
                minimumFractionDigits: decimais,
                maximumFractionDigits: decimais
            });
        }
    }

    // Adicionar listeners para calcular automaticamente
    const itemQuantidade = document.getElementById('item_quantidade');
    const itemPrecoUnitario = document.getElementById('item_preco_unitario');

    if (itemQuantidade) {
        itemQuantidade.addEventListener('input', calcularPrecoTotalModal);
        itemQuantidade.addEventListener('change', calcularPrecoTotalModal);
    }

    if (itemPrecoUnitario) {
        itemPrecoUnitario.addEventListener('input', calcularPrecoTotalModal);
        itemPrecoUnitario.addEventListener('change', calcularPrecoTotalModal);

        // ===================================================================
        // VALIDAR CASAS DECIMAIS AO SAIR DO CAMPO (BLUR)
        // ===================================================================
        itemPrecoUnitario.addEventListener('blur', function() {
            let valor = parseFloat(this.value) || 0;

            if (ORCAMENTO_CONFIG.casasDecimais === 'duas') {
                // Arredondar para cima e exibir SEM decimais
                // Exemplo: 15.17 ‚Üí 16
                valor = Math.ceil(valor);
                this.value = valor.toFixed(0); // "16" (sem v√≠rgula)
                console.log('[VALIDA√á√ÉO] Pre√ßo arredondado para cima (duas casas):', this.value);
            } else if (ORCAMENTO_CONFIG.casasDecimais === 'quatro') {
                // Permitir at√© 4 casas decimais
                // Exemplo: 15.17456 ‚Üí 15.1746
                valor = Math.round(valor * 10000) / 10000;
                this.value = valor.toFixed(4); // "15.1746"
                console.log('[VALIDA√á√ÉO] Pre√ßo formatado (quatro casas):', this.value);
            }

            // Recalcular total ap√≥s valida√ß√£o
            calcularPrecoTotalModal();
        });
    }

    // =================================================================
    // LIMPAR FORMUL√ÅRIOS QUANDO MODAIS S√ÉO FECHADOS
    // =================================================================

    const modalAdicionarItemEl = document.getElementById('modalAdicionarItem');
    if (modalAdicionarItemEl) {
        modalAdicionarItemEl.addEventListener('hidden.bs.modal', function() {
            document.getElementById('formAdicionarItem')?.reset();
            // Reset do pre√ßo total calculado
            const precoTotalEl = document.getElementById('preco_total_calculado');
            if (precoTotalEl) {
                precoTotalEl.textContent = 'R$ 0,00';
            }
        });
    }

    const modalCriarLoteEl = document.getElementById('modalCriarLote');
    if (modalCriarLoteEl) {
        modalCriarLoteEl.addEventListener('hidden.bs.modal', function() {
            document.getElementById('formCriarLote')?.reset();
        });
    }

    const modalImportarPlanilhaEl = document.getElementById('modalImportarPlanilha');
    if (modalImportarPlanilhaEl) {
        modalImportarPlanilhaEl.addEventListener('hidden.bs.modal', function() {
            document.getElementById('formImportarPlanilha')?.reset();
        });
    }

}, 'orcamentoConfigInit'); //  Fim do DOMContentLoaded - Config do Or√ßamento
</script>

<!-- Boto para voltar -->
<div style="margin-top: 30px;">
    <a href="/orcamentos/pendentes" class="btn btn-outline" style="text-decoration: none;">
        <i class="fas fa-arrow-left"></i>
        VOLTAR PARA A LISTA DE OR√áAMENTOS PENDENTES
    </a>
</div>

<!-- Modal 1: Adicionar Item -->
<div class="modal fade" id="modalAdicionarItem" tabindex="-1" aria-labelledby="modalAdicionarItemLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                <h5 class="modal-title" id="modalAdicionarItemLabel" style="font-weight: 700; text-transform: uppercase;">Adicionar Novo Item do Orcamento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form id="formAdicionarItem">
                    @csrf
                    <!-- Descri√ßo -->
                    <div class="mb-3">
                        <label for="item_descricao" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                            Descri√ßo<span style="color: #dc2626;">*</span>
                        </label>
                        <textarea
                            class="form-control"
                            id="item_descricao"
                            name="descricao"
                            rows="4"
                            placeholder="Descri√ßo do item"
                            required
                            style="font-size: 13px; resize: vertical;"
                        ></textarea>
                        <small class="form-text text-muted" style="font-size: 11px;">Apresentar a descri√ßo constante do termo de referncia ou do projeto bsico.</small>
                    </div>

                    <div class="row">
                        <!-- Medida de fornecimento -->
                        <div class="col-md-4 mb-3">
                            <label for="item_medida" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Medida de fornecimento<span style="color: #dc2626;">*</span>
                            </label>
                            <select
                                class="form-select"
                                id="item_medida"
                                name="medida_fornecimento"
                                required
                                style="font-size: 13px;"
                            >
                                <option value="">Selecione...</option>
                                <option value="Unidade">Unidade</option>
                                <option value="Caixa">Caixa</option>
                                <option value="Metro">Metro</option>
                                <option value="Litro">Litro</option>
                                <option value="Kg">Kg</option>
                            </select>
                        </div>

                        <!-- Quantidade -->
                        <div class="col-md-4 mb-3">
                            <label for="item_quantidade" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Quantidade<span style="color: #dc2626;">*</span>
                            </label>
                            <input
                                type="number"
                                class="form-control"
                                id="item_quantidade"
                                name="quantidade"
                                min="0.0001"
                                step="0.0001"
                                value="0"
                                required
                                style="font-size: 13px;"
                            >
                            <div style="margin-top: 6px;">
                                <label style="font-size: 11px; color: #6b7280;">
                                    <input type="radio" name="quantidade_tipo" value="inteiro" checked style="margin-right: 5px;">
                                    N¬∫ INTEIRO
                                </label>
                                <label style="font-size: 11px; color: #6b7280; margin-left: 15px;">
                                    <input type="radio" name="quantidade_tipo" value="fracionado" style="margin-right: 5px;">
                                    FRACIONADO
                                </label>
                            </div>
                        </div>

                        <!-- Pre√ßo Unitrio -->
                        <div class="col-md-4 mb-3">
                            <label for="item_preco_unitario" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Pre√ßo Unitrio (R$)
                            </label>
                            <input
                                type="number"
                                class="form-control"
                                id="item_preco_unitario"
                                name="preco_unitario"
                                min="0"
                                step="0.01"
                                placeholder="0,00"
                                style="font-size: 13px;"
                            >
                            <small class="form-text text-muted" style="font-size: 11px;">Opcional. Sera calculado o pre√ßo total automaticamente.</small>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Indica√ßo de marca -->
                        <div class="col-md-12 mb-3">
                            <label for="item_marca" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Indica√ßo de marca:
                            </label>
                            <input
                                type="text"
                                class="form-control"
                                id="item_marca"
                                name="indicacao_marca"
                                placeholder="Opcional"
                                style="font-size: 13px;"
                            >
                            <div style="margin-top: 6px;">
                                <label style="font-size: 11px; color: #6b7280;">
                                    <input type="radio" name="marca_referencia" value="referencia" checked style="margin-right: 5px;">
                                    DE REFER√äNCIA
                                </label>
                                <label style="font-size: 11px; color: #6b7280; margin-left: 10px;">
                                    <input type="radio" name="marca_referencia" value="vinculativa" style="margin-right: 5px;">
                                    VINCULATIVA
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Pre√ßo Total Calculado -->
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; padding: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px; font-weight: 600; color: #1e40af;">
                                        <i class="fas fa-calculator"></i> PRE√áO TOTAL:
                                    </span>
                                    <span id="preco_total_calculado" style="font-size: 16px; font-weight: 700; color: #1e40af;">
                                        R$ 0,00
                                    </span>
                                </div>
                                <small style="font-size: 11px; color: #6b7280; display: block; margin-top: 6px;">
                                    Calculado automaticamente: Quantidade a Pre√ßo Unitrio
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Este item √© um -->
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                            Este item √© um:<span style="color: #dc2626;">*</span>
                        </label>
                        <div style="display: flex; gap: 20px;">
                            <label style="cursor: pointer; font-size: 13px;">
                                <input type="radio" name="tipo_item" value="PRODUTO" required style="margin-right: 8px;">
                                PRODUTO
                            </label>
                            <label style="cursor: pointer; font-size: 13px;">
                                <input type="radio" name="tipo_item" value="SERVICO" checked style="margin-right: 8px;">
                                SERVI√áO
                            </label>
                        </div>
                    </div>

                    <!-- Alterar dados em CDFs -->
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                            Alterar dados do item em CDFs, Entes P√∫blicos e Sites de com√©rcio eletrnico?<span style="color: #dc2626;">*</span>
                        </label>
                        <div style="display: flex; gap: 20px;">
                            <label style="cursor: pointer; font-size: 13px;">
                                <input type="radio" name="alterar_cdfs" value="SIM" required style="margin-right: 8px;">
                                SIM
                            </label>
                            <label style="cursor: pointer; font-size: 13px;">
                                <input type="radio" name="alterar_cdfs" value="NAO" checked style="margin-right: 8px;">
                                N√ÉO
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 24px; font-size: 13px; font-weight: 600;">
                    <i class="fas fa-times"></i> FECHAR
                </button>
                <button type="button" id="btnSalvarItem" class="btn btn-primary" style="padding: 10px 24px; font-size: 13px; font-weight: 600;">
                    <i class="fas fa-save"></i> SALVAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal 2: Criar Lote -->
<div class="modal fade" id="modalCriarLote" tabindex="-1" aria-labelledby="modalCriarLoteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                <h5 class="modal-title" id="modalCriarLoteLabel" style="font-weight: 700; text-transform: uppercase;">Criar Novo Lote</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form id="formCriarLote">
                    @csrf
                    <div class="row">
                        <!-- N√∫mero -->
                        <div class="col-md-6 mb-3">
                            <label for="lote_numero" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                N√∫mero<span style="color: #dc2626;">*</span>
                            </label>
                            <input
                                type="number"
                                class="form-control"
                                id="lote_numero"
                                name="numero"
                                min="1"
                                step="1"
                                placeholder="Digite apenas n√∫meros maiores que 1"
                                required
                                style="font-size: 13px;"
                            >
                            <small class="form-text text-muted" style="font-size: 11px;">Digite apenas n√∫meros maiores que 1</small>
                        </div>

                        <!-- Nome -->
                        <div class="col-md-6 mb-3">
                            <label for="lote_nome" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                                Nome<span style="color: #dc2626;">*</span>
                            </label>
                            <input
                                type="text"
                                class="form-control"
                                id="lote_nome"
                                name="nome"
                                maxlength="255"
                                placeholder="Titulo ou nome usado para identificar o conte√∫do do lote"
                                required
                                style="font-size: 13px;"
                            >
                            <small class="form-text text-muted" style="font-size: 11px;">Titulo ou nome usado para identificar o conte√∫do do lote</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 24px; font-size: 13px; font-weight: 600;">
                    <i class="fas fa-times"></i> FECHAR
                </button>
                <button type="button" id="btnSalvarLote" class="btn btn-primary" style="padding: 10px 24px; font-size: 13px; font-weight: 600;">
                    <i class="fas fa-save"></i> SALVAR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal 3: Importar Planilha -->
<div class="modal fade" id="modalImportarPlanilha" tabindex="-1" aria-labelledby="modalImportarPlanilhaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                <h5 class="modal-title" id="modalImportarPlanilhaLabel" style="font-weight: 700; text-transform: uppercase;">Importar Planilha de Itens</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <!-- Mensagem informativa -->
                <div class="alert alert-info" style="background: #e0f2fe; border: 1px solid #7dd3fc; color: #0369a1; margin-bottom: 20px; padding: 15px; border-radius: 6px; font-size: 13px;">
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    <strong>ATEN√á√ÉO:</strong> O sistema s√≥ reconhece planilhas que estejam na formata√ßo padro disponivel na pgina de Downloads de nosso site.
                    Para mais informa√ß√µes <a href="#" style="color: #0369a1; text-decoration: underline; font-weight: 600;">clique aqui</a>
                </div>

                <form id="formImportarPlanilha" enctype="multipart/form-data">
                    @csrf
                    <div class="mb-3">
                        <label for="arquivo_planilha" class="form-label" style="font-weight: 600; color: #374151; font-size: 13px;">
                            Selecionar arquivo:
                        </label>
                        <input
                            type="file"
                            class="form-control"
                            id="arquivo_planilha"
                            name="planilha"
                            accept=".xlsx,.xls,.csv"
                            required
                            style="font-size: 13px; padding: 10px;"
                        >
                        <small class="form-text text-muted" style="font-size: 11px;">Selecione apenas arquivos do tipo excel (*.xls ou *.xlsx)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 24px; font-size: 13px; font-weight: 600;">
                    <i class="fas fa-times"></i> FECHAR
                </button>
                <button type="button" id="btnEnviarPlanilha" class="btn btn-primary" style="padding: 10px 24px; font-size: 13px; font-weight: 600;">
                    <i class="fas fa-upload"></i> ENVIAR
                </button>
            </div>
        </div>
    </div>
</div>

@include('orcamentos._modal-cotacao')
@include('orcamentos._modal_cabecalho_orgao')

{{-- JavaScript do Modal de Cota√ßo --}}
<script>
    console.log('[LOG] [ELABORAR.BLADE.PHP] Pgina carregada - Orcamento ID:', window.ORCAMENTO_ID);
    console.log('[INFO] [ELABORAR.BLADE.PHP] Total de itens: {{ $orcamento->itens->count() }}');
    console.log('[INFO] [ELABORAR.BLADE.PHP] Carregando modal-cotacao.js...');
</script>
<script src="{{ asset('js/modal-cotacao.js') }}?v={{ time() }}"></script>
<script>
    console.log('[LOG] [ELABORAR.BLADE.PHP] modal-cotacao.js carregado!');
</script>

<!-- Modal: Detalhes da Fonte Consultada -->
<div class="modal fade" id="modalDetalhesFonte" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 900px;">
        <div class="modal-content">
            <div class="modal-header" style="background: #3b82f6; color: white; padding: 16px 24px;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 16px; text-transform: uppercase;">
                    DETALHES DA FONTE CONSULTADA
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <table class="table table-sm table-bordered" style="font-size: 12px;">
                    <tbody>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600; width: 180px;">FONTE:</td>
                            <td id="detalhe-fonte"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">IDENTIFICA√á√ÉO:</td>
                            <td id="detalhe-identificacao"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">N¬∫ DO PREG√ÉO:</td>
                            <td id="detalhe-pregao"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">N¬∫ DA ATA:</td>
                            <td id="detalhe-ata"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">DATA/HOMOLOGA√á√ÉO:</td>
                            <td id="detalhe-data-homologacao"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">RG√ÉO:</td>
                            <td id="detalhe-orgao"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">OBJETO:</td>
                            <td id="detalhe-objeto" style="font-size: 11px;"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">LOTE/ITEM/SUBITEM:</td>
                            <td id="detalhe-lote"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">VENCEDOR:</td>
                            <td id="detalhe-vencedor"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">DESCRI√á√ÉO:</td>
                            <td id="detalhe-descricao" style="font-size: 11px;"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">MARCA:</td>
                            <td id="detalhe-marca"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">UNIDADE:</td>
                            <td id="detalhe-unidade"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">QUANTIDADE:</td>
                            <td id="detalhe-quantidade"></td>
                        </tr>
                        <tr>
                            <td style="background: #f3f4f6; font-weight: 600;">VALOR UNIT√ÅRIO</td>
                            <td id="detalhe-valor-unitario" style="font-weight: 600; color: #0891b2;"></td>
                        </tr>
                    </tbody>
                </table>

                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <a id="btn-download-arp" href="#" target="_blank" class="btn" style="background: #3b82f6; color: white; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-download"></i> DOWNLOAD DA ARP
                    </a>
                    <button type="button" class="btn" data-bs-dismiss="modal" style="background: #9ca3af; color: white; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-times"></i> FECHAR
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Ajuste de Embalagem -->
<div class="modal fade" id="modalAjusteEmbalagem" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 900px;">
        <div class="modal-content">
            <div class="modal-header" style="background: #3b82f6; color: white; padding: 16px 24px;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 16px; text-transform: uppercase;">
                    AJUSTE DE EMBALAGEM
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <!-- Descri√ßo da Amostra -->
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 4px;">DESCRI√á√ÉO DA AMOSTRA:</label>
                    <div id="ajuste-descricao" style="font-size: 12px; color: #374151; padding: 8px; background: #f9fafb; border-radius: 4px;"></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Coluna Esquerda: Dados Originais -->
                    <div style="background: #e5e7eb; padding: 20px; border-radius: 6px;">
                        <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 16px; text-transform: uppercase;">Medida de Fornecimento Original</h6>

                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">MED. DE FORNECIMENTO:</label>
                            <input type="text" id="ajuste-original-unidade" class="form-control" readonly style="background: #f3f4f6; font-size: 13px;">
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">A EMBALAGEM :</label>
                            <select id="ajuste-original-embalagem" class="form-select" disabled style="background: #f3f4f6; font-size: 13px;">
                                <option value="primaria">PRIM√ÅRIA</option>
                                <option value="secundaria">SECUND√ÅRIA</option>
                            </select>
                        </div>

                        <div>
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">PRE√áO UNIT√ÅRIO ORIGINAL:</label>
                            <input type="text" id="ajuste-original-preco" class="form-control" readonly style="background: #f3f4f6; font-size: 13px; font-weight: 600;">
                        </div>
                    </div>

                    <!-- Coluna Direita: Dados Desejados -->
                    <div style="background: #dbeafe; padding: 20px; border-radius: 6px;">
                        <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 16px; text-transform: uppercase;">Medida de Fornecimento Desejada</h6>

                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">MEDIDA DESEJADA:</label>
                            <input type="text" id="ajuste-desejado-unidade" class="form-control" placeholder="Ex: UNIDADE, CAIXA, PACOTE" style="font-size: 13px;">
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">ESSA EMBALAGEM :</label>
                            <select id="ajuste-desejado-embalagem" class="form-select" style="font-size: 13px;">
                                <option value="primaria">PRIM√ÅRIA</option>
                                <option value="secundaria">SECUND√ÅRIA</option>
                            </select>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">FATOR DE MULTIPLICA√á√ÉO:</label>
                            <input type="number" id="ajuste-fator" class="form-control" placeholder="0,00" step="0.01" style="font-size: 13px;">
                        </div>

                        <div>
                            <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">PRE√áO UNIT√ÅRIO AJUSTADO:</label>
                            <input type="text" id="ajuste-desejado-preco" class="form-control" readonly style="background: #f3f4f6; font-size: 13px; font-weight: 600; color: #0891b2;">
                        </div>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; margin-top: 24px;">
                    <button type="button" id="btn-concluir-ajuste" class="btn" style="background: #0891b2; color: white; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-check"></i> CONCLUIR
                    </button>
                    <button type="button" class="btn" data-bs-dismiss="modal" style="background: #9ca3af; color: white; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-times"></i> FECHAR
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal NOVO: Anlise Cr√≠tica dos Dados Coletados (Boto Anlise) -->
<div class="modal fade" id="modalAnaliseCritica" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 1200px;">
        <div class="modal-content">
            <div class="modal-header" style="background: #0891b2; color: white; padding: 16px 24px;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 16px; text-transform: uppercase;">
                    AN√ÅLISE CRTICA DOS DADOS COLETADOS
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <!-- Item Pesquisado (fixo no topo, fora das tabs) -->
                <div style="background: #f3f4f6; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
                    <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 4px; display: block;">ITEM PESQUISADO</label>
                    <div id="analise-item-descricao" style="font-size: 14px; font-weight: 600; color: #1f2937;">-</div>
                </div>

                <!-- ========================================
                     NAVEGA√á√ÉO DE TABS
                     ======================================== -->
                <ul class="nav nav-tabs" id="analiseTabsNav" role="tablist" style="margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-regras-btn" data-bs-toggle="tab"
                                data-bs-target="#tab-regras" type="button" role="tab"
                                style="font-size: 12px; font-weight: 600; padding: 10px 20px;">
                            <i class="fas fa-sliders-h"></i> REGRAS & EXPURGO
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-estatisticas-btn" data-bs-toggle="tab"
                                data-bs-target="#tab-estatisticas" type="button" role="tab"
                                style="font-size: 12px; font-weight: 600; padding: 10px 20px;">
                            <i class="fas fa-chart-bar"></i> ESTAT√çSTICAS
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-auditoria-btn" data-bs-toggle="tab"
                                data-bs-target="#tab-auditoria" type="button" role="tab"
                                style="font-size: 12px; font-weight: 600; padding: 10px 20px;">
                            <i class="fas fa-history"></i> AUDITORIA
                        </button>
                    </li>
                </ul>

                <!-- ========================================
                     CONTE√öDO DAS TABS
                     ======================================== -->
                <div class="tab-content" id="analiseTabsContent">

                    <!-- ========================================
                         TAB 1: REGRAS & EXPURGO
                         ======================================== -->
                    <div class="tab-pane fade" id="tab-regras" role="tabpanel">
                        <div style="padding: 20px; background: #f9fafb; border-radius: 6px;">
                            <h6 style="font-size: 14px; font-weight: 700; color: #374151; margin-bottom: 20px;">
                                <i class="fas fa-cog"></i> CONFIGURA√á√ÉO DO M√âTODO DE SANEAMENTO
                            </h6>

                            <!-- M√©todo de Saneamento -->
                            <div style="margin-bottom: 24px;">
                                <label style="font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 12px; display: block;">
                                    SELECIONE O M√âTODO ESTAT√çSTICO:
                                </label>

                                <!-- Radio 1: Desvio-Padr√£o -->
                                <div style="background: white; padding: 16px; border-radius: 6px; border: 2px solid #e5e7eb; margin-bottom: 12px;">
                                    <div style="display: flex; align-items: start; gap: 12px;">
                                        <input type="radio" id="metodo-dp" name="metodo-saneamento" value="DP_MEDIA" checked
                                               style="width: 18px; height: 18px; margin-top: 2px;">
                                        <div style="flex: 1;">
                                            <label for="metodo-dp" style="font-size: 13px; font-weight: 600; color: #1f2937; margin-bottom: 4px; display: block; cursor: pointer;">
                                                M√©todo Desvio-Padr√£o (Œº ¬± œÉ)
                                            </label>
                                            <p style="font-size: 11px; color: #6b7280; margin: 0; line-height: 1.4;">
                                                Expurga valores fora do intervalo [m√©dia - desvio-padr√£o, m√©dia + desvio-padr√£o].
                                                Recomendado para dados com distribui√ß√£o normal.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Radio 2: Percentual da Mediana -->
                                <div style="background: white; padding: 16px; border-radius: 6px; border: 2px solid #e5e7eb;">
                                    <div style="display: flex; align-items: start; gap: 12px;">
                                        <input type="radio" id="metodo-percentual" name="metodo-saneamento" value="PERCENTUAL_MEDIANA"
                                               style="width: 18px; height: 18px; margin-top: 2px;">
                                        <div style="flex: 1;">
                                            <label for="metodo-percentual" style="font-size: 13px; font-weight: 600; color: #1f2937; margin-bottom: 4px; display: block; cursor: pointer;">
                                                M√©todo Percentual da Mediana
                                            </label>
                                            <p style="font-size: 11px; color: #6b7280; margin: 0 0 12px 0; line-height: 1.4;">
                                                Expurga valores fora do intervalo definido por percentuais da mediana. Recomendado para dados com outliers.
                                            </p>

                                            <!-- Inputs de percentuais (habilitados apenas quando radio 2 selecionado) -->
                                            <div id="percentual-inputs" style="display: none; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                                    <div>
                                                        <label style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 4px; display: block;">
                                                            LIMITE INFERIOR (% da mediana)
                                                        </label>
                                                        <input type="number" id="percentual-inf" value="30" min="0" max="100" step="5"
                                                               style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px;">
                                                        <small style="font-size: 10px; color: #9ca3af;">Ex: 30% = mediana √ó 0.30</small>
                                                    </div>
                                                    <div>
                                                        <label style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 4px; display: block;">
                                                            LIMITE SUPERIOR (% da mediana)
                                                        </label>
                                                        <input type="number" id="percentual-sup" value="70" min="0" max="100" step="5"
                                                               style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px;">
                                                        <small style="font-size: 10px; color: #9ca3af;">Ex: 70% = mediana √ó 1.70</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Checkbox: For√ßar m√©todo manualmente -->
                            <div style="background: #fef3c7; padding: 12px; border-radius: 6px; border: 1px solid #f59e0b; margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="forcar-metodo-manual" style="width: 16px; height: 16px;">
                                    <label for="forcar-metodo-manual" style="font-size: 11px; font-weight: 600; color: #92400e; margin: 0; cursor: pointer;">
                                        FOR√áAR M√âTODO MANUALMENTE (ignorar decis√£o autom√°tica do CV)
                                    </label>
                                </div>
                                <p style="font-size: 10px; color: #92400e; margin: 4px 0 0 24px; line-height: 1.3;">
                                    Por padr√£o, o sistema escolhe M√âDIA se CV ‚â§ 25% e MEDIANA se CV > 25%. Marque esta op√ß√£o para sobrescrever esta decis√£o.
                                </p>
                            </div>

                            <!-- Bot√£o Aplicar Saneamento -->
                            <div style="text-align: center;">
                                <button id="btn-aplicar-saneamento" type="button" class="btn"
                                        style="background: #0891b2; color: white; font-size: 13px; font-weight: 700; padding: 12px 40px; border-radius: 6px;">
                                    <i class="fas fa-filter"></i> APLICAR SANEAMENTO
                                </button>
                            </div>

                            <!-- Mensagem de status -->
                            <div id="saneamento-status" style="margin-top: 16px; display: none; padding: 12px; border-radius: 6px; font-size: 12px;"></div>
                        </div>
                    </div>

                    <!-- ========================================
                         TAB 2: ESTAT√çSTICAS (conte√∫do existente movido)
                         ======================================== -->
                    <div class="tab-pane fade show active" id="tab-estatisticas" role="tabpanel">

                <!-- Ju√≠zo Cr√≠tico -->
                <div style="margin-bottom: 24px;">
                    <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 12px;">JUZO CRTICO</h6>
                    <table class="table table-sm table-bordered" style="font-size: 12px;">
                        <thead style="background: #f3f4f6;">
                            <tr>
                                <th>N¬∫ DE AMOSTRAS COLETADAS</th>
                                <th>MDIA</th>
                                <th>DESVIO-PADR√ÉO</th>
                                <th>LIMITE INFERIOR</th>
                                <th>LIMITE SUPERIOR</th>
                                <th>CRTICAS</th>
                                <th>AMOSTRAS EXPURGADAS</th>
                            </tr>
                        </thead>
                        <tbody id="analise-juizo-critico-tbody">
                            <tr style="text-align: center;">
                                <td id="analise-juizo-num-amostras">0</td>
                                <td id="analise-juizo-media">R$ 0,00</td>
                                <td id="analise-juizo-desvio">0,00</td>
                                <td id="analise-juizo-limite-inf">R$ 0,00 (DP - m√©dia)</td>
                                <td id="analise-juizo-limite-sup">R$ 0,00 (DP + m√©dia)</td>
                                <td><span class="badge bg-danger" id="analise-juizo-criticas">0</span></td>
                                <td><span class="badge bg-secondary" id="analise-juizo-expurgadas">0</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- M√©todo Estat√≠stico -->
                <div style="margin-bottom: 24px;">
                    <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 12px;">MTODO ESTATSTICO APLICADO S AMOSTRAS SANEADAS</h6>
                    <table class="table table-sm table-bordered" style="font-size: 12px;">
                        <thead style="background: #f3f4f6;">
                            <tr>
                                <th>N¬∫ DE AMOSTRAS V√ÅLIDAS</th>
                                <th>DESVIO-PADR√ÉO</th>
                                <th>COEFICIENTE DE VARIA√á√ÉO</th>
                                <th>MENOR PRE√áO</th>
                                <th>MDIA</th>
                                <th>MEDIANA</th>
                            </tr>
                        </thead>
                        <tbody id="analise-metodo-estatistico-tbody">
                            <tr style="text-align: center;">
                                <td id="analise-metodo-num-validas">0</td>
                                <td id="analise-metodo-desvio">0,00</td>
                                <td id="analise-metodo-coef-var">0,00%</td>
                                <td id="analise-metodo-menor">R$ 0,00</td>
                                <td id="analise-metodo-media">R$ 0,00</td>
                                <td id="analise-metodo-mediana">R$ 0,00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- S√©rie de Precos Coletados -->
                <div style="margin-bottom: 24px;">
                    <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 12px; text-transform: uppercase;">S√©rie de Precos Coletados</h6>

                    <!-- Mensagem quando no tem amostras -->
                    <div id="analise-serie-vazia" style="font-size: 12px; color: #6b7280; padding: 12px; background: #f9fafb; border-radius: 4px;">
                        VOC√ä N√ÉO POSSUI AMOSTRAS DE PRE√áOS PARA ESTE ITEM
                    </div>

                    <!-- Tabela de amostras selecionadas -->
                    <div id="analise-serie-tabela" style="display: none;">
                        <div class="table-responsive-custom" style="max-height: 400px;">
                            <table class="table table-sm table-bordered" style="font-size: 11px; margin: 0;">
                                <thead class="sticky-header">
                                    <tr>
                                        <th style="width: 60px;">AMOSTRA</th>
                                        <th style="width: 100px;">SITUA√á√ÉO</th>
                                        <th style="min-width: 300px;">FONTE</th>
                                        <th style="width: 100px;">MARCA</th>
                                        <th style="width: 100px;">DATA</th>
                                        <th style="width: 80px;">MEDIDA</th>
                                        <th style="width: 100px; text-align: right;">QNT ORIGINAL</th>
                                        <th style="width: 120px; text-align: right;">VALOR UNIT√ÅRIO</th>
                                        <th style="width: 100px; text-align: center;">A√á√ïES</th>
                                    </tr>
                                </thead>
                                <tbody id="analise-serie-tbody">
                                    <!-- Sera preenchido via JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Boto remover todas -->
                        <div style="text-align: right; margin-top: 12px;">
                            <button id="analise-btn-remover-todas-amostras" class="btn btn-sm" style="background: #dc2626; color: white; font-size: 11px; font-weight: 600;">
                                <i class="fas fa-times"></i> REMOVER TODAS AS AMOSTRAS
                            </button>
                        </div>
                    </div>
                </div>

                <!-- M√©todo Estat√≠stico Final -->
                <div style="margin-bottom: 24px;">
                    <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 12px;">MTODO ESTATSTICO APLICADO S AMOSTRAS SANEADAS</h6>
                    <div style="background: #f3f4f6; padding: 16px; border-radius: 4px;">
                        <table style="width: 100%; font-size: 13px;">
                            <tr>
                                <td style="text-align: right; font-weight: 600; padding: 4px;">MEDIANA</td>
                                <td style="width: 150px; text-align: right; padding: 4px;" id="analise-final-mediana">R$ 0,00</td>
                            </tr>
                            <tr>
                                <td style="text-align: right; font-weight: 600; padding: 4px;">MDIA</td>
                                <td style="text-align: right; padding: 4px;" id="analise-final-media">R$ 0,00</td>
                            </tr>
                            <tr>
                                <td style="text-align: right; font-weight: 600; padding: 4px;">MENOR PRE√áO</td>
                                <td style="text-align: right; padding: 4px;" id="analise-final-menor">R$ 0,00</td>
                            </tr>
                            <tr style="border-top: 2px solid #0891b2;">
                                <td style="text-align: right; font-weight: 700; padding: 8px 4px; color: #0891b2;">MEDIDA DE TEND√äNCIA CENTRAL</td>
                                <td style="text-align: right; font-weight: 700; padding: 8px 4px; color: #0891b2; font-size: 16px;" id="analise-final-tendencia">R$ 0,00</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Cr√≠tica dos Dados -->
                <div>
                    <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 12px; text-transform: uppercase;">Cr√≠tica dos Dados</h6>
                    <button id="analise-btn-adicionar-justificativa" type="button" class="btn btn-outline-secondary btn-sm" onclick="abrirModalJustificativa()" style="font-size: 12px; font-weight: 600; margin-bottom: 12px;">
                        <i class="fas fa-pencil-alt"></i> ADICIONAR JUSTIFICATIVA OU OBSERVA√á√ÉO
                    </button>

                    <!-- Checkboxes de Cr√≠ticas -->
                    <div style="margin-top: 12px;">
                        <div style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="analise-critica-medidas-desiguais" style="width: 16px; height: 16px;">
                            <label for="analise-critica-medidas-desiguais" style="font-size: 12px; margin: 0; cursor: pointer;">
                                1. Existem amostras com medidas de fornecimentos desiguais.
                            </label>
                            <button class="btn btn-sm" style="padding: 2px 8px; background: #6b7280; color: white; font-size: 10px;">+</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="analise-critica-valores-discrepantes" style="width: 16px; height: 16px;">
                            <label for="analise-critica-valores-discrepantes" style="font-size: 12px; margin: 0; cursor: pointer;">
                                2. Existem amostras com valores muito discrepantes.
                            </label>
                            <button class="btn btn-sm" style="padding: 2px 8px; background: #6b7280; color: white; font-size: 10px;">+</button>
                        </div>
                    </div>
                </div>

                <!-- ========================================
                     SE√á√ÉO: TODOS OS JUSTIFICATIVOS E OBSERVA√á√ïES DO ITEM
                     Agregado de TODAS as fontes do sistema
                     ======================================== -->
                <div id="secao-justificativos-agregados" style="margin-top: 30px; display: none;">
                    <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 16px; text-transform: uppercase; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-clipboard-list" style="color: #3b82f6;"></i>
                        TODOS OS JUSTIFICATIVOS E OBSERVA√á√ïES DESTE ITEM
                    </h6>

                    @php
                        // Ser√° preenchido dinamicamente via JavaScript ao abrir o modal
                        // O JavaScript buscar√° o item_id atual e carregar√° as justificativas
                    @endphp

                    <div id="justificativos-loading" style="padding: 20px; text-align: center; background: #f3f4f6; border-radius: 6px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #6b7280;"></i>
                        <p style="margin-top: 10px; font-size: 12px; color: #6b7280;">Carregando justificativas e observa√ß√µes...</p>
                    </div>

                    <div id="justificativos-container" style="display: none;">
                        <!-- Ser√° preenchido via JavaScript -->
                    </div>

                    <div id="justificativos-vazio" style="display: none; padding: 30px; text-align: center; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px;">
                        <i class="fas fa-info-circle" style="font-size: 36px; color: #f59e0b; margin-bottom: 12px;"></i>
                        <p style="color: #92400e; font-size: 13px; font-weight: 600; margin: 0;">
                            Nenhuma justificativa ou observa√ß√£o cadastrada ainda para este item
                        </p>
                        <p style="color: #92400e; font-size: 11px; margin-top: 8px;">
                            As justificativas aparecer√£o aqui automaticamente quando forem cadastradas em qualquer parte do sistema.
                        </p>
                    </div>
                </div>

                    </div><!-- Fecha Tab 2: Estat√≠sticas -->

                    <!-- ========================================
                         TAB 3: AUDITORIA
                         ======================================== -->
                    <div class="tab-pane fade" id="tab-auditoria" role="tabpanel">
                        <!-- LOADING STATE -->
                        <div id="auditoria-loading" style="padding: 40px; text-align: center; display: none;">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p style="font-size: 12px; color: #6b7280; margin-top: 16px;">
                                Carregando hist√≥rico de auditoria...
                            </p>
                        </div>

                        <!-- EMPTY STATE -->
                        <div id="auditoria-vazio" style="padding: 40px; text-align: center; display: none;">
                            <i class="fas fa-history" style="font-size: 48px; color: #9ca3af; margin-bottom: 16px;"></i>
                            <h6 style="font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">
                                NENHUMA A√á√ÉO REGISTRADA
                            </h6>
                            <p style="font-size: 12px; color: #9ca3af; margin: 0;">
                                Ainda n√£o h√° registros de auditoria para este item.
                            </p>
                        </div>

                        <!-- TIMELINE DE AUDITORIA -->
                        <div id="auditoria-timeline" style="padding: 20px; display: none;">
                            <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #e5e7eb;">
                                <h6 style="font-size: 13px; font-weight: 700; color: #374151; margin: 0;">
                                    <i class="fas fa-history"></i> HIST√ìRICO DE ALTERA√á√ïES
                                </h6>
                                <p style="font-size: 11px; color: #6b7280; margin: 4px 0 0 0;">
                                    Registro cronol√≥gico de todas as a√ß√µes realizadas neste item
                                </p>
                            </div>

                            <div id="auditoria-lista" style="position: relative; padding-left: 40px;">
                                <!-- Timeline vertical -->
                                <div style="position: absolute; left: 15px; top: 0; bottom: 0; width: 2px; background: #e5e7eb;"></div>
                                <!-- Logs ser√£o inseridos aqui via JavaScript -->
                            </div>
                        </div>
                    </div>

                </div><!-- Fecha tab-content -->

            </div><!-- Fecha modal-body -->
            <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 13px; font-weight: 600;">
                    <i class="fas fa-times"></i> FECHAR
                </button>
            </div>
        </div>
    </div>
</div>

{{-- ========================================
     MODAL DE JUSTIFICATIVAS E OBSERVA√á√ïES
     Usado quando ha menos de 3 amostras vlidas
     ======================================== --}}
<div class="modal fade" id="modalJustificativa" tabindex="-1" aria-labelledby="modalJustificativaLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border-radius: 8px; overflow: hidden;">

            {{-- Cabe√ßalho Azul --}}
            <div class="modal-header" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 18px 24px; border-bottom: none;">
                <h5 class="modal-title" id="modalJustificativaLabel" style="font-weight: 700; font-size: 16px; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="fas fa-file-alt" style="margin-right: 8px;"></i>
                    JUSTIFICATIVAS E OBSERVA√á√ïES
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            {{-- Corpo do Modal --}}
            <div class="modal-body" style="padding: 24px; background: #f9fafb;">

                <p style="font-size: 14px; color: #374151; margin-bottom: 20px; font-weight: 500;">
                    Marque uma ou mais op√ß√µes e preencha os campos correspondentes.
                </p>

                <form id="formJustificativa">

                    {{-- Op√ßo 1: SCP no retornou nenhum resultado --}}
                    <div class="mb-4">
                        <div class="form-check" style="padding-left: 0;">
                            <input class="form-check-input" type="checkbox" id="justif_scp_sem_resultado" name="justificativas[]" value="scp_sem_resultado" style="width: 18px; height: 18px; margin-top: 2px;">
                            <label class="form-check-label" for="justif_scp_sem_resultado" style="margin-left: 28px; font-size: 13px; color: #374151; font-weight: 600; cursor: pointer;">
                                Ap√≥s a pesquisa de pre√ßos, em 09/10/2025, o SCP no retornou nenhum resultado com as palavras-chave
                            </label>
                        </div>
                        <textarea
                            id="textarea_scp_sem_resultado"
                            class="form-control mt-2"
                            rows="2"
                            placeholder="Digite as palavras-chave utilizadas..."
                            style="font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; padding: 10px; display: none;"
                            disabled
                        ></textarea>
                    </div>

                    {{-- Op√ßo 2: SCP retornou menos de 3 amostras --}}
                    <div class="mb-4">
                        <div class="form-check" style="padding-left: 0;">
                            <input class="form-check-input" type="checkbox" id="justif_scp_poucas_amostras" name="justificativas[]" value="scp_poucas_amostras" style="width: 18px; height: 18px; margin-top: 2px;">
                            <label class="form-check-label" for="justif_scp_poucas_amostras" style="margin-left: 28px; font-size: 13px; color: #374151; font-weight: 600; cursor: pointer;">
                                O SCP no retornou trs ou mais amostras. Utilizei as palavras-chave
                            </label>
                        </div>
                        <textarea
                            id="textarea_scp_poucas_amostras"
                            class="form-control mt-2"
                            rows="2"
                            placeholder="Digite as palavras-chave utilizadas..."
                            style="font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; padding: 10px; display: none;"
                            disabled
                        ></textarea>
                    </div>

                    {{-- Op√ßo 3: Expedi pedido de proposta --}}
                    <div class="mb-4">
                        <div class="form-check" style="padding-left: 0;">
                            <input class="form-check-input" type="checkbox" id="justif_expedi_pedido" name="justificativas[]" value="expedi_pedido" style="width: 18px; height: 18px; margin-top: 2px;">
                            <label class="form-check-label" for="justif_expedi_pedido" style="margin-left: 28px; font-size: 13px; color: #374151; font-weight: 600; cursor: pointer;">
                                Expedi o(s) pedido(s) de proposta(s) n¬∫
                            </label>
                        </div>
                        <div class="row mt-2" id="container_expedi_pedido" style="display: none;">
                            <div class="col-md-6">
                                <input
                                    type="text"
                                    id="input_numero_pedido"
                                    class="form-control"
                                    placeholder="N√∫mero(s) do(s) pedido(s)"
                                    style="font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; padding: 10px;"
                                    disabled
                                />
                            </div>
                            <div class="col-md-12 mt-2">
                                <textarea
                                    id="textarea_expedi_pedido"
                                    class="form-control"
                                    rows="2"
                                    placeholder="e, mesmo ap√≥s o prazo de resposta, no foi poss√≠vel conseguir trs ou mais amostras."
                                    style="font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; padding: 10px;"
                                    disabled
                                ></textarea>
                            </div>
                        </div>
                    </div>

                    {{-- Op√ßo 4: Justificativa livre --}}
                    <div class="mb-4">
                        <div class="form-check" style="padding-left: 0;">
                            <input class="form-check-input" type="checkbox" id="justif_livre" name="justificativas[]" value="justificativa_livre" style="width: 18px; height: 18px; margin-top: 2px;">
                            <label class="form-check-label" for="justif_livre" style="margin-left: 28px; font-size: 13px; color: #374151; font-weight: 600; cursor: pointer;">
                                Justificativa livre:
                            </label>
                        </div>
                        <textarea
                            id="textarea_justif_livre"
                            class="form-control mt-2"
                            rows="4"
                            placeholder="Digite sua justificativa..."
                            style="font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; padding: 10px; display: none;"
                            disabled
                        ></textarea>
                    </div>

                </form>

            </div>

            {{-- Rodap√© --}}
            <div class="modal-footer" style="background: #f3f4f6; padding: 14px 24px; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 13px; font-weight: 600; padding: 9px 20px;">
                    <i class="fas fa-times-circle"></i> FECHAR
                </button>
                <button type="button" class="btn btn-primary" id="btnEnviarJustificativa" style="font-size: 13px; font-weight: 600; padding: 9px 20px; background: #3b82f6; border: none;">
                    <i class="fas fa-check-circle"></i> ENVIAR JUSTIFICATIVA
                </button>
            </div>

        </div>
    </div>
</div>

<script>
// ========================================
// MODAL DE JUSTIFICATIVAS E OBSERVA√á√ïES
// ========================================

// Habilitar/desabilitar campos conforme checkboxes
document.getElementById('justif_scp_sem_resultado') && document.getElementById('justif_scp_sem_resultado').addEventListener('change', function() {
    const textarea = document.getElementById('textarea_scp_sem_resultado');
    if (this.checked) {
        textarea.style.display = 'block';
        textarea.disabled = false;
    } else {
        textarea.style.display = 'none';
        textarea.disabled = true;
        textarea.value = '';
    }
});

document.getElementById('justif_scp_poucas_amostras') && document.getElementById('justif_scp_poucas_amostras').addEventListener('change', function() {
    const textarea = document.getElementById('textarea_scp_poucas_amostras');
    if (this.checked) {
        textarea.style.display = 'block';
        textarea.disabled = false;
    } else {
        textarea.style.display = 'none';
        textarea.disabled = true;
        textarea.value = '';
    }
});

document.getElementById('justif_expedi_pedido') && document.getElementById('justif_expedi_pedido').addEventListener('change', function() {
    const container = document.getElementById('container_expedi_pedido');
    const input = document.getElementById('input_numero_pedido');
    const textarea = document.getElementById('textarea_expedi_pedido');

    if (this.checked) {
        container.style.display = 'block';
        input.disabled = false;
        textarea.disabled = false;
    } else {
        container.style.display = 'none';
        input.disabled = true;
        textarea.disabled = true;
        input.value = '';
        textarea.value = '';
    }
});

document.getElementById('justif_livre') && document.getElementById('justif_livre').addEventListener('change', function() {
    const textarea = document.getElementById('textarea_justif_livre');
    if (this.checked) {
        textarea.style.display = 'block';
        textarea.disabled = false;
    } else {
        textarea.style.display = 'none';
        textarea.disabled = true;
        textarea.value = '';
    }
});

// Fun√ßo para abrir o modal de justificativa
function abrirModalJustificativa() {
    const modal = new bootstrap.Modal(document.getElementById('modalJustificativa'));
    modal.show();
}

// Boto "Enviar Justificativa"
document.getElementById('btnEnviarJustificativa') && document.getElementById('btnEnviarJustificativa').addEventListener('click', function() {
    const checkboxes = document.querySelectorAll('#formJustificativa input[type="checkbox"]:checked');

    if (checkboxes.length === 0) {
        alert('[AVISO] Selecione ao menos uma op√ßo antes de enviar.');
        return;
    }

    // Coletar dados do formulrio
    const justificativas = [];

    if (document.getElementById('justif_scp_sem_resultado').checked) {
        const texto = document.getElementById('textarea_scp_sem_resultado').value.trim();
        if (!texto) {
            alert('[AVISO] Preencha as palavras-chave para a op√ßo "SCP no retornou nenhum resultado".');
            return;
        }
        justificativas.push({
            tipo: 'scp_sem_resultado',
            texto: `Ap√≥s a pesquisa de pre√ßos, em ${new Date().toLocaleDateString('pt-BR')}, o SCP no retornou nenhum resultado com as palavras-chave: ${texto}`
        });
    }

    if (document.getElementById('justif_scp_poucas_amostras').checked) {
        const texto = document.getElementById('textarea_scp_poucas_amostras').value.trim();
        if (!texto) {
            alert('[AVISO] Preencha as palavras-chave para a op√ßo "SCP retornou menos de 3 amostras".');
            return;
        }
        justificativas.push({
            tipo: 'scp_poucas_amostras',
            texto: `O SCP no retornou trs ou mais amostras. Utilizei as palavras-chave: ${texto}`
        });
    }

    if (document.getElementById('justif_expedi_pedido').checked) {
        const numero = document.getElementById('input_numero_pedido').value.trim();
        const observacao = document.getElementById('textarea_expedi_pedido').value.trim();

        if (!numero) {
            alert('[AVISO] Preencha o n√∫mero do pedido para a op√ßo "Expedi pedido de proposta".');
            return;
        }

        let textoCompleto = `Expedi o(s) pedido(s) de proposta(s) n¬∫ ${numero}`;
        if (observacao) {
            textoCompleto += `, ${observacao}`;
        } else {
            textoCompleto += `, e mesmo ap√≥s o prazo de resposta, no foi poss√≠vel conseguir trs ou mais amostras.`;
        }

        justificativas.push({
            tipo: 'expedi_pedido',
            numero_pedido: numero,
            texto: textoCompleto
        });
    }

    if (document.getElementById('justif_livre').checked) {
        const texto = document.getElementById('textarea_justif_livre').value.trim();
        if (!texto) {
            alert('[AVISO] Preencha a justificativa livre.');
            return;
        }
        justificativas.push({
            tipo: 'justificativa_livre',
            texto: texto
        });
    }

    console.log('[INFO] Justificativas coletadas:', justificativas);

    // Montar texto final para exibir no modal de anlise cr√≠tica
    const textoFinal = justificativas.map(j => j.texto).join('\n\n');

    // Substituir a mensagem de alerta no modal de anlise cr√≠tica
    const alertCriticaDados = document.querySelector('.alert-info');
    if (alertCriticaDados) {
        alertCriticaDados.innerHTML = `
            <i class="fas fa-check-circle" style="color: #10b981;"></i>
            <strong>JUSTIFICATIVA ADICIONADA:</strong>
            <br><br>
            <div style="white-space: pre-wrap; font-size: 12px; line-height: 1.6; color: #1f2937;">
                ${textoFinal}
            </div>
        `;
        alertCriticaDados.style.background = '#d1fae5';
        alertCriticaDados.style.border = '1px solid #10b981';
        alertCriticaDados.style.color = '#065f46';
    }

    // TODO: Enviar para backend via AJAX
    // fetch('/orcamentos/item/justificativa', {
    //     method: 'POST',
    //     headers: {
    //         'Content-Type': 'application/json',
    //         'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
    //     },
    //     body: JSON.stringify({
    //         orcamento_id: {{ $orcamento->id }},
    //         item_id: window.currentItemId,
    //         justificativas: justificativas
    //     })
    // });

    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalJustificativa'));
    if (modal) modal.hide();

    // Limpar formulrio
    document.getElementById('formJustificativa').reset();
    document.querySelectorAll('#formJustificativa textarea, #formJustificativa input[type="text"]').forEach(el => {
        el.style.display = 'none';
        el.disabled = true;
    });
    document.getElementById('container_expedi_pedido').style.display = 'none';

    alert('[LOG] Justificativa adicionada com sucesso!');
});

</script>

<!-- Modal 4: S√≠tio de Com√©rcio Eletrnico (Wizard 4 etapas) -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- MODAL NOVO: COM√âRCIO ELETR√îNICO (Design Moderno 2025 - Azul DattaTech) -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal fade" id="modalSitioEcommerce" tabindex="-1" aria-labelledby="modalSitioEcommerceLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 1200px;">
        <div class="modal-content" style="border: none; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- HEADER MODERNO -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="modal-header" style="
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1e40af 100%);
                color: white;
                padding: 25px 30px;
                border: none;
                position: relative;
                overflow: hidden;
            ">
                <!-- Efeito de brilho de fundo -->
                <div style="
                    position: absolute;
                    top: -50%;
                    right: -5%;
                    width: 300px;
                    height: 300px;
                    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
                    border-radius: 50%;
                "></div>

                <div style="position: relative; z-index: 1; width: 100%;">
                    <h5 class="modal-title" id="modalSitioEcommerceLabel" style="
                        font-weight: 800;
                        text-transform: uppercase;
                        font-size: 18px;
                        letter-spacing: 0.5px;
                        margin: 0;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        <div style="
                            background: rgba(255,255,255,0.2);
                            padding: 10px;
                            border-radius: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-shopping-cart" style="font-size: 24px;"></i>
                        </div>
                        <span>Com√©rcio Eletr√¥nico</span>
                        <span style="
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            padding: 6px 14px;
                            border-radius: 20px;
                            font-size: 11px;
                            font-weight: 700;
                            letter-spacing: 1px;
                            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
                        ">v2.0 NOVO</span>
                    </h5>
                </div>

                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="position: relative; z-index: 2;"></button>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- STEPPER MODERNO (4 ETAPAS) -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div style="
                background: linear-gradient(to bottom, #f8fafc 0%, #ffffff 100%);
                padding: 35px 40px 30px;
                border-bottom: 1px solid #e5e7eb;
            ">
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    position: relative;
                ">
                    <!-- Linha de fundo (cinza) -->
                    <div style="
                        position: absolute;
                        top: 28px;
                        left: 6%;
                        right: 6%;
                        height: 4px;
                        background: #e5e7eb;
                        border-radius: 10px;
                        z-index: 0;
                    "></div>

                    <!-- Linha de progresso ativa -->
                    <div id="ece-progress-line" style="
                        position: absolute;
                        top: 28px;
                        left: 6%;
                        height: 4px;
                        background: linear-gradient(to right, #3b82f6, #2563eb);
                        border-radius: 10px;
                        z-index: 0;
                        width: 0%;
                        transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
                    "></div>

                    <!-- Step 1: Dados do S√≠tio -->
                    <div class="ece-wizard-step" data-step="1" style="
                        flex: 1;
                        text-align: center;
                        position: relative;
                        z-index: 1;
                    ">
                        <div class="ece-step-circle" style="
                            width: 56px;
                            height: 56px;
                            border-radius: 50%;
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                            color: white;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 12px;
                            font-weight: 800;
                            font-size: 20px;
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
                            transition: all 0.3s ease;
                        ">
                            1
                        </div>
                        <div class="ece-step-label" style="
                            font-size: 12px;
                            font-weight: 700;
                            color: #3b82f6;
                            text-transform: uppercase;
                            line-height: 1.3;
                            letter-spacing: 0.5px;
                        ">
                            Dados do<br>S√≠tio
                        </div>
                    </div>

                    <!-- Step 2: Dados da Consulta -->
                    <div class="ece-wizard-step" data-step="2" style="
                        flex: 1;
                        text-align: center;
                        position: relative;
                        z-index: 1;
                    ">
                        <div class="ece-step-circle" style="
                            width: 56px;
                            height: 56px;
                            border-radius: 50%;
                            background: #e5e7eb;
                            color: #9ca3af;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 12px;
                            font-weight: 800;
                            font-size: 20px;
                            transition: all 0.3s ease;
                        ">
                            2
                        </div>
                        <div class="ece-step-label" style="
                            font-size: 12px;
                            font-weight: 700;
                            color: #9ca3af;
                            text-transform: uppercase;
                            line-height: 1.3;
                            letter-spacing: 0.5px;
                        ">
                            Dados da<br>Consulta
                        </div>
                    </div>

                    <!-- Step 3: Coleta de Amostras -->
                    <div class="ece-wizard-step" data-step="3" style="
                        flex: 1;
                        text-align: center;
                        position: relative;
                        z-index: 1;
                    ">
                        <div class="ece-step-circle" style="
                            width: 56px;
                            height: 56px;
                            border-radius: 50%;
                            background: #e5e7eb;
                            color: #9ca3af;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 12px;
                            font-weight: 800;
                            font-size: 20px;
                            transition: all 0.3s ease;
                        ">
                            3
                        </div>
                        <div class="ece-step-label" style="
                            font-size: 12px;
                            font-weight: 700;
                            color: #9ca3af;
                            text-transform: uppercase;
                            line-height: 1.3;
                            letter-spacing: 0.5px;
                        ">
                            Coleta de<br>Amostras
                        </div>
                    </div>

                    <!-- Step 4: Anexar Print -->
                    <div class="ece-wizard-step" data-step="4" style="
                        flex: 1;
                        text-align: center;
                        position: relative;
                        z-index: 1;
                    ">
                        <div class="ece-step-circle" style="
                            width: 56px;
                            height: 56px;
                            border-radius: 50%;
                            background: #e5e7eb;
                            color: #9ca3af;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 12px;
                            font-weight: 800;
                            font-size: 20px;
                            transition: all 0.3s ease;
                        ">
                            4
                        </div>
                        <div class="ece-step-label" style="
                            font-size: 12px;
                            font-weight: 700;
                            color: #9ca3af;
                            text-transform: uppercase;
                            line-height: 1.3;
                            letter-spacing: 0.5px;
                        ">
                            Anexar<br>Print
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- FORMUL√ÅRIO E CONTE√öDO DAS ETAPAS -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <form id="formSitioEcommerce" enctype="multipart/form-data">
                @csrf
                <input type="hidden" name="orcamento_id" value="{{ $orcamento->id }}">

                <div class="modal-body" style="padding: 40px; min-height: 500px; background: #fafafa;">

                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <!-- ETAPA 1: DADOS DO S√çTIO -->
                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="ece-wizard-content" id="ece-step-1" style="display: block;">
                        <div style="
                            background: white;
                            border-radius: 16px;
                            padding: 30px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                        ">
                            <h6 style="
                                font-size: 16px;
                                font-weight: 800;
                                color: #1e40af;
                                margin-bottom: 8px;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            ">
                                <div style="
                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 14px;
                                    font-weight: 800;
                                ">1</div>
                                DADOS DO S√çTIO CONSULTADO
                            </h6>
                            <p style="
                                font-size: 13px;
                                color: #6b7280;
                                margin-bottom: 30px;
                            ">
                                Informe os dados b√°sicos do site de com√©rcio eletr√¥nico onde realizou a pesquisa de pre√ßos.
                            </p>

                            <!-- Nome do site -->
                            <div style="margin-bottom: 25px;">
                                <label style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    margin-bottom: 10px;
                                    font-weight: 700;
                                    color: #374151;
                                    font-size: 13px;
                                ">
                                    <i class="fas fa-store" style="color: #3b82f6;"></i>
                                    Nome do site<span style="color: #dc2626;">*</span>
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="nome_site"
                                    placeholder="Ex.: Magazine Luiza, Amazon, Mercado Livre"
                                    required
                                    style="
                                        font-size: 14px;
                                        padding: 12px 16px;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 10px;
                                        transition: all 0.2s;
                                    "
                                    onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                                    onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                                >
                            </div>

                            <!-- Endere√ßo eletr√¥nico (URL) -->
                            <div style="margin-bottom: 25px;">
                                <label style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    margin-bottom: 10px;
                                    font-weight: 700;
                                    color: #374151;
                                    font-size: 13px;
                                ">
                                    <i class="fas fa-link" style="color: #3b82f6;"></i>
                                    Endere√ßo eletr√¥nico (URL)<span style="color: #dc2626;">*</span>
                                </label>
                                <input
                                    type="url"
                                    class="form-control"
                                    name="url_site"
                                    placeholder="https://www.exemplo.com.br/produto/..."
                                    required
                                    style="
                                        font-size: 14px;
                                        padding: 12px 16px;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 10px;
                                        transition: all 0.2s;
                                        font-family: monospace;
                                    "
                                    onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                                    onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                                >
                                <small style="
                                    display: block;
                                    margin-top: 6px;
                                    font-size: 11px;
                                    color: #6b7280;
                                ">
                                    <i class="fas fa-info-circle"></i> Cole o link completo da p√°gina onde encontrou o produto
                                </small>
                            </div>

                            <!-- Site de intermedia√ß√£o -->
                            <div style="margin-bottom: 0;">
                                <label style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    margin-bottom: 15px;
                                    font-weight: 700;
                                    color: #374151;
                                    font-size: 13px;
                                ">
                                    <i class="fas fa-question-circle" style="color: #3b82f6;"></i>
                                    O s√≠tio eletr√¥nico se dedica √† intermedia√ß√£o de vendas?<span style="color: #dc2626;">*</span>
                                </label>
                                <p style="
                                    font-size: 12px;
                                    color: #6b7280;
                                    margin-bottom: 15px;
                                    padding-left: 28px;
                                ">
                                    Marketplaces (Amazon, Mercado Livre), classificados (OLX), etc.
                                </p>
                                <div style="display: flex; gap: 15px; padding-left: 28px;">
                                    <label style="
                                        cursor: pointer;
                                        flex: 1;
                                    ">
                                        <input type="radio" name="eh_intermediacao" value="1" required style="display: none;">
                                        <div id="ece-btn-interm-sim" onclick="eceMarcarIntermediacao('sim')" style="
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            gap: 12px;
                                            padding: 16px 20px;
                                            border: 3px solid #e5e7eb;
                                            border-radius: 12px;
                                            background: white;
                                            transition: all 0.3s;
                                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            <i class="fas fa-check-circle" style="font-size: 32px; color: #10b981;"></i>
                                            <div style="font-weight: 700; font-size: 14px; color: #065f46;">SIM</div>
                                        </div>
                                    </label>
                                    <label style="
                                        cursor: pointer;
                                        flex: 1;
                                    ">
                                        <input type="radio" name="eh_intermediacao" value="0" required style="display: none;">
                                        <div id="ece-btn-interm-nao" onclick="eceMarcarIntermediacao('nao')" style="
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            gap: 12px;
                                            padding: 16px 20px;
                                            border: 3px solid #e5e7eb;
                                            border-radius: 12px;
                                            background: white;
                                            transition: all 0.3s;
                                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            <i class="fas fa-times-circle" style="font-size: 32px; color: #ef4444;"></i>
                                            <div style="font-weight: 700; font-size: 14px; color: #991b1b;">N√ÉO</div>
                                        </div>
                                    </label>
                                </div>
                                <input type="hidden" id="ece-eh-intermediacao" name="eh_intermediacao">
                            </div>
                        </div>
                    </div>

                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <!-- ETAPA 2: DADOS DA CONSULTA -->
                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="ece-wizard-content" id="ece-step-2" style="display: none;">
                        <div style="
                            background: white;
                            border-radius: 16px;
                            padding: 30px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                        ">
                            <h6 style="
                                font-size: 16px;
                                font-weight: 800;
                                color: #1e40af;
                                margin-bottom: 8px;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            ">
                                <div style="
                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 14px;
                                    font-weight: 800;
                                ">2</div>
                                DADOS DA CONSULTA
                            </h6>
                            <p style="
                                font-size: 13px;
                                color: #6b7280;
                                margin-bottom: 30px;
                            ">
                                Registre quando foi realizada a consulta e detalhes sobre o frete.
                            </p>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                                <!-- Data da consulta -->
                                <div>
                                    <label style="
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                        margin-bottom: 10px;
                                        font-weight: 700;
                                        color: #374151;
                                        font-size: 13px;
                                    ">
                                        <i class="fas fa-calendar-alt" style="color: #3b82f6;"></i>
                                        Data da consulta<span style="color: #dc2626;">*</span>
                                    </label>
                                    <input
                                        type="date"
                                        class="form-control"
                                        name="data_consulta"
                                        required
                                        style="
                                            font-size: 14px;
                                            padding: 12px 16px;
                                            border: 2px solid #e5e7eb;
                                            border-radius: 10px;
                                            transition: all 0.2s;
                                        "
                                        onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                                        onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                                    >
                                </div>

                                <!-- Hora da consulta -->
                                <div>
                                    <label style="
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                        margin-bottom: 10px;
                                        font-weight: 700;
                                        color: #374151;
                                        font-size: 13px;
                                    ">
                                        <i class="fas fa-clock" style="color: #3b82f6;"></i>
                                        Hora da consulta<span style="color: #dc2626;">*</span>
                                    </label>
                                    <input
                                        type="time"
                                        class="form-control"
                                        name="hora_consulta"
                                        required
                                        style="
                                            font-size: 14px;
                                            padding: 12px 16px;
                                            border: 2px solid #e5e7eb;
                                            border-radius: 10px;
                                            transition: all 0.2s;
                                        "
                                        onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                                        onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                                    >
                                </div>
                            </div>

                            <!-- Pre√ßo inclui frete -->
                            <div style="margin-top: 30px;">
                                <label style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    margin-bottom: 15px;
                                    font-weight: 700;
                                    color: #374151;
                                    font-size: 13px;
                                ">
                                    <i class="fas fa-truck" style="color: #3b82f6;"></i>
                                    O pre√ßo encontrado inclui frete?<span style="color: #dc2626;">*</span>
                                </label>
                                <div style="display: flex; gap: 15px; padding-left: 28px;">
                                    <label style="cursor: pointer; flex: 1;">
                                        <input type="radio" name="inclui_frete" value="1" required style="display: none;">
                                        <div id="ece-btn-frete-sim" onclick="eceMarcarFrete('sim')" style="
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            gap: 12px;
                                            padding: 16px 20px;
                                            border: 3px solid #e5e7eb;
                                            border-radius: 12px;
                                            background: white;
                                            transition: all 0.3s;
                                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            <i class="fas fa-check-circle" style="font-size: 32px; color: #10b981;"></i>
                                            <div style="font-weight: 700; font-size: 14px; color: #065f46;">SIM</div>
                                        </div>
                                    </label>
                                    <label style="cursor: pointer; flex: 1;">
                                        <input type="radio" name="inclui_frete" value="0" required style="display: none;">
                                        <div id="ece-btn-frete-nao" onclick="eceMarcarFrete('nao')" style="
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            gap: 12px;
                                            padding: 16px 20px;
                                            border: 3px solid #e5e7eb;
                                            border-radius: 12px;
                                            background: white;
                                            transition: all 0.3s;
                                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            <i class="fas fa-times-circle" style="font-size: 32px; color: #ef4444;"></i>
                                            <div style="font-weight: 700; font-size: 14px; color: #991b1b;">N√ÉO</div>
                                        </div>
                                    </label>
                                </div>
                                <input type="hidden" id="ece-inclui-frete" name="inclui_frete">
                            </div>
                        </div>
                    </div>

                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <!-- ETAPA 3: COLETA DE AMOSTRAS -->
                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="ece-wizard-content" id="ece-step-3" style="display: none;">
                        <div style="
                            background: white;
                            border-radius: 16px;
                            padding: 30px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                        ">
                            <h6 style="
                                font-size: 16px;
                                font-weight: 800;
                                color: #1e40af;
                                margin-bottom: 8px;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            ">
                                <div style="
                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 14px;
                                    font-weight: 800;
                                ">3</div>
                                COLETA DE AMOSTRAS
                            </h6>
                            <p style="
                                font-size: 13px;
                                color: #6b7280;
                                margin-bottom: 25px;
                            ">
                                Selecione os itens do or√ßamento e informe os pre√ßos encontrados no site consultado.
                            </p>

                            <div style="
                                max-height: 450px;
                                overflow-y: auto;
                                border: 2px solid #e5e7eb;
                                border-radius: 12px;
                                background: #fafafa;
                            ">
                                <table class="table table-hover mb-0" style="font-size: 12px;">
                                    <thead style="
                                        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                                    ">
                                        <tr>
                                            <th style="
                                                width: 50px;
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <input type="checkbox" id="ece-selecionar-todos" class="form-check-input" style="cursor: pointer;">
                                            </th>
                                            <th style="
                                                width: 100px;
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <i class="fas fa-hashtag" style="color: #3b82f6;"></i> Lote/Item
                                            </th>
                                            <th style="
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <i class="fas fa-align-left" style="color: #3b82f6;"></i> Descri√ß√£o
                                            </th>
                                            <th style="
                                                width: 110px;
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <i class="fas fa-box" style="color: #3b82f6;"></i> Unidade
                                            </th>
                                            <th style="
                                                width: 100px;
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <i class="fas fa-sort-numeric-up" style="color: #3b82f6;"></i> Qtd
                                            </th>
                                            <th style="
                                                width: 140px;
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <i class="fas fa-dollar-sign" style="color: #10b981;"></i> Pre√ßo Unit.
                                            </th>
                                            <th style="
                                                width: 140px;
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <i class="fas fa-calculator" style="color: #10b981;"></i> Pre√ßo Total
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="ece-tbody-itens-coleta">
                                        @foreach($orcamento->itens as $item)
                                        <tr style="transition: background 0.2s ease;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                            <td style="padding: 12px 10px; text-align: center;">
                                                <input
                                                    type="checkbox"
                                                    name="itens_selecionados[]"
                                                    value="{{ $item->id }}"
                                                    class="form-check-input ece-item-checkbox"
                                                    style="cursor: pointer;"
                                                    data-item-id="{{ $item->id }}"
                                                    {{ $item->preco_unitario ? 'checked data-cotacao-preenchida="true"' : '' }}
                                                >
                                            </td>
                                            <td style="padding: 12px 10px; color: #6b7280; font-weight: 600;">
                                                {{ $item->lote_id ? 'Lote ' . str_pad($item->lote->numero, 2, '0', STR_PAD_LEFT) : str_pad($item->numero_item ?: $loop->iteration, 2, '0', STR_PAD_LEFT) }}
                                            </td>
                                            <td style="padding: 12px 10px; color: #111827; font-weight: 500; font-size: 11px;">
                                                {{ $item->descricao }}
                                            </td>
                                            <td style="padding: 12px 10px; color: #6b7280; text-align: center; font-weight: 600;">
                                                {{ $item->medida_fornecimento }}
                                            </td>
                                            <td style="padding: 12px 10px; color: #6b7280; text-align: right; font-weight: 600;">
                                                {{ number_format($item->quantidade, 2, ',', '.') }}
                                            </td>
                                            <td style="padding: 10px;">
                                                <input
                                                    type="number"
                                                    name="preco_unitario[{{ $item->id }}]"
                                                    class="form-control form-control-sm ece-preco-input"
                                                    placeholder="R$ 0,00"
                                                    step="0.01"
                                                    min="0"
                                                    value="{{ $item->preco_unitario ?? '' }}"
                                                    data-item-id="{{ $item->id }}"
                                                    data-quantidade="{{ $item->quantidade }}"
                                                    data-preco-debug="{{ $item->preco_unitario ?? 'NULL' }}"
                                                    data-preco-blade-rendered="{{ $item->preco_unitario ?? 'BLADE_NULL' }}"
                                                    style="
                                                        font-size: 12px;
                                                        padding: 8px 12px;
                                                        border: 2px solid #e5e7eb;
                                                        border-radius: 8px;
                                                        font-weight: 600;
                                                        {{ $item->preco_unitario ? 'border-color: #10b981 !important; background: #f0fdf4;' : '' }}
                                                    "
                                                >
                                            </td>
                                            <td style="padding: 10px; color: #059669; font-weight: 700; text-align: right; font-size: 13px;">
                                                <span class="ece-preco-total" data-item-id="{{ $item->id }}">
                                                    @if($item->preco_unitario)
                                                        R$ {{ number_format($item->preco_unitario * $item->quantidade, 2, ',', '.') }}
                                                    @else
                                                        R$ 0,00
                                                    @endif
                                                </span>
                                            </td>
                                        </tr>
                                        @endforeach
                                    </tbody>
                                </table>
                            </div>

                            <div style="
                                margin-top: 20px;
                                padding: 16px;
                                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                                border: 2px solid #fbbf24;
                                border-radius: 12px;
                                font-size: 12px;
                                color: #92400e;
                                display: flex;
                                align-items: center;
                                gap: 12px;
                            ">
                                <i class="fas fa-info-circle" style="font-size: 20px; color: #f59e0b;"></i>
                                <div>
                                    <strong>Importante:</strong> Marque o checkbox do item para poder informar o pre√ßo unit√°rio.
                                    O pre√ßo total ser√° calculado automaticamente.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <!-- ETAPA 4: ANEXAR PRINT -->
                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="ece-wizard-content" id="ece-step-4" style="display: none;">
                        <div style="
                            background: white;
                            border-radius: 16px;
                            padding: 30px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                        ">
                            <h6 style="
                                font-size: 16px;
                                font-weight: 800;
                                color: #1e40af;
                                margin-bottom: 8px;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            ">
                                <div style="
                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 14px;
                                    font-weight: 800;
                                ">4</div>
                                ANEXAR PRINT DA TELA
                            </h6>
                            <p style="
                                font-size: 13px;
                                color: #6b7280;
                                margin-bottom: 30px;
                            ">
                                Fa√ßa upload do print (captura de tela) da p√°gina onde foi realizada a consulta.
                            </p>

                            <!-- √Årea de upload -->
                            <div id="ece-upload-area" style="
                                border: 3px dashed #d1d5db;
                                border-radius: 16px;
                                padding: 50px;
                                text-align: center;
                                background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
                                margin-bottom: 25px;
                                cursor: pointer;
                                transition: all 0.3s;
                            " onclick="document.getElementById('ece-arquivo-print').click()" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)'" onmouseout="this.style.borderColor='#d1d5db'; this.style.background='linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%)'">
                                <div style="
                                    width: 80px;
                                    height: 80px;
                                    border-radius: 50%;
                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                    margin: 0 auto 20px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
                                ">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 40px; color: white;"></i>
                                </div>
                                <input
                                    type="file"
                                    id="ece-arquivo-print"
                                    name="arquivo_print"
                                    accept=".pdf,.png,.jpg,.jpeg"
                                    style="display: none;"
                                >
                                <h6 style="font-size: 16px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">
                                    Clique para selecionar o arquivo
                                </h6>
                                <p style="font-size: 13px; color: #6b7280; margin: 0;">
                                    Arraste e solte ou clique para escolher
                                </p>
                            </div>

                            <!-- Info do arquivo selecionado -->
                            <div id="ece-file-info" style="
                                display: none;
                                padding: 20px;
                                background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
                                border: 2px solid #10b981;
                                border-radius: 12px;
                                margin-bottom: 25px;
                            ">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="
                                        width: 48px;
                                        height: 48px;
                                        border-radius: 10px;
                                        background: #10b981;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                    ">
                                        <i class="fas fa-check" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div id="ece-file-name" style="font-weight: 700; color: #065f46; font-size: 14px; margin-bottom: 4px;"></div>
                                        <div id="ece-file-size" style="font-size: 12px; color: #047857;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Orienta√ß√µes -->
                            <div style="
                                background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
                                border: 2px solid #7dd3fc;
                                border-left-width: 6px;
                                border-radius: 12px;
                                padding: 20px;
                            ">
                                <h6 style="
                                    font-size: 13px;
                                    font-weight: 800;
                                    color: #0369a1;
                                    margin-bottom: 12px;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-info-circle"></i>
                                    ORIENTA√á√ïES PARA UPLOAD
                                </h6>
                                <ul style="
                                    margin: 0;
                                    padding-left: 20px;
                                    font-size: 12px;
                                    color: #0c4a6e;
                                    line-height: 1.8;
                                ">
                                    <li><strong>Tamanho m√°ximo:</strong> 2GB</li>
                                    <li><strong>Orienta√ß√£o da imagem:</strong> Retrato (preferencial)</li>
                                    <li><strong>Formatos aceitos:</strong> PDF, PNG, JPG, JPEG</li>
                                    <li><strong>Conte√∫do:</strong> Print completo da p√°gina com pre√ßo vis√≠vel</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- FOOTER COM BOT√ïES DE NAVEGA√á√ÉO -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="modal-footer" style="
                    padding: 20px 40px;
                    border-top: 2px solid #e5e7eb;
                    background: linear-gradient(to bottom, #fafafa 0%, #ffffff 100%);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <button
                        type="button"
                        id="ece-btn-anterior"
                        class="btn btn-secondary"
                        style="
                            padding: 12px 28px;
                            font-size: 13px;
                            font-weight: 700;
                            border-radius: 10px;
                            display: none;
                            background: #6b7280;
                            border: none;
                            color: white;
                            transition: all 0.2s;
                        "
                        onmouseover="this.style.background='#4b5563'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                        onmouseout="this.style.background='#6b7280'; this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                    >
                        <i class="fas fa-chevron-left"></i> ANTERIOR
                    </button>
                    <div style="flex: 1;"></div>
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                        style="
                            padding: 12px 28px;
                            font-size: 13px;
                            font-weight: 700;
                            border-radius: 10px;
                            background: white;
                            border: 2px solid #e5e7eb;
                            color: #374151;
                            margin-right: 12px;
                            transition: all 0.2s;
                        "
                        onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#d1d5db'"
                        onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'"
                    >
                        CANCELAR
                    </button>
                    <button
                        type="button"
                        id="ece-btn-proximo"
                        class="btn btn-primary"
                        style="
                            padding: 12px 32px;
                            font-size: 13px;
                            font-weight: 700;
                            border-radius: 10px;
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                            border: none;
                            color: white;
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                            transition: all 0.2s;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'"
                    >
                        PR√ìXIMO <i class="fas fa-chevron-right"></i>
                    </button>
                    <button
                        type="submit"
                        id="ece-btn-concluir"
                        class="btn btn-success"
                        style="
                            padding: 12px 32px;
                            font-size: 13px;
                            font-weight: 700;
                            border-radius: 10px;
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            border: none;
                            color: white;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                            display: none;
                            transition: all 0.2s;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'"
                    >
                        <i class="fas fa-check-circle"></i> CONCLUIR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL COM√âRCIO ELETR√îNICO - VERS√ÉO 2.0 (Design Moderno Azul)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function() {
    'use strict';

    console.log('üõí [MODAL E-COMMERCE] Inicializando vers√£o 2.0...');

    let currentStep = 1;
    const totalSteps = 4;
    const modal = document.getElementById('modalSitioEcommerce');
    const form = document.getElementById('formSitioEcommerce');
    const btnAbrir = document.getElementById('btn-incluir-sitio-ecommerce');
    const btnAnterior = document.getElementById('ece-btn-anterior');
    const btnProximo = document.getElementById('ece-btn-proximo');
    const btnConcluir = document.getElementById('ece-btn-concluir');
    const inputArquivo = document.getElementById('ece-arquivo-print');

    // Remover required do arquivo (valida√ß√£o manual)
    if (inputArquivo) {
        inputArquivo.removeAttribute('required');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUN√á√ÉO: Abrir Modal
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (btnAbrir) {
        btnAbrir.addEventListener('click', function() {
            console.log('üìÇ [MODAL E-COMMERCE] Abrindo modal...');
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            resetWizard();

            // Garantir que required foi removido
            if (inputArquivo) {
                inputArquivo.removeAttribute('required');
            }
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUN√á√ÉO: Marcar Intermedia√ß√£o (Etapa 1)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.eceMarcarIntermediacao = function(opcao) {
        const btnSim = document.getElementById('ece-btn-interm-sim');
        const btnNao = document.getElementById('ece-btn-interm-nao');
        const input = document.getElementById('ece-eh-intermediacao');

        // Reset
        btnSim.style.borderColor = '#e5e7eb';
        btnSim.style.background = 'white';
        btnNao.style.borderColor = '#e5e7eb';
        btnNao.style.background = 'white';

        // Marcar selecionado
        if (opcao === 'sim') {
            btnSim.style.borderColor = '#3b82f6';
            btnSim.style.background = 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)';
            btnSim.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.2)';
            input.value = '1';
            // Marcar radio button real
            document.querySelector('input[name="eh_intermediacao"][value="1"]').checked = true;
        } else {
            btnNao.style.borderColor = '#3b82f6';
            btnNao.style.background = 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)';
            btnNao.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.2)';
            input.value = '0';
            // Marcar radio button real
            document.querySelector('input[name="eh_intermediacao"][value="0"]').checked = true;
        }

        console.log('‚úÖ [MODAL E-COMMERCE] Intermedia√ß√£o marcada:', opcao);
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUN√á√ÉO: Marcar Frete (Etapa 2)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.eceMarcarFrete = function(opcao) {
        const btnSim = document.getElementById('ece-btn-frete-sim');
        const btnNao = document.getElementById('ece-btn-frete-nao');
        const input = document.getElementById('ece-inclui-frete');

        // Reset
        btnSim.style.borderColor = '#e5e7eb';
        btnSim.style.background = 'white';
        btnNao.style.borderColor = '#e5e7eb';
        btnNao.style.background = 'white';

        // Marcar selecionado
        if (opcao === 'sim') {
            btnSim.style.borderColor = '#3b82f6';
            btnSim.style.background = 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)';
            btnSim.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.2)';
            input.value = '1';
            // Marcar radio button real
            document.querySelector('input[name="inclui_frete"][value="1"]').checked = true;
        } else {
            btnNao.style.borderColor = '#3b82f6';
            btnNao.style.background = 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)';
            btnNao.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.2)';
            input.value = '0';
            // Marcar radio button real
            document.querySelector('input[name="inclui_frete"][value="0"]').checked = true;
        }

        console.log('‚úÖ [MODAL E-COMMERCE] Frete marcado:', opcao);
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUN√á√ÉO: Mostrar Etapa
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function eceMostrarEtapa(step) {
        console.log(`üìç [MODAL E-COMMERCE] Navegando para etapa ${step}`);

        // Esconder todas as etapas
        document.querySelectorAll('.ece-wizard-content').forEach(content => {
            content.style.display = 'none';
        });

        // Mostrar etapa atual
        const etapaAtual = document.getElementById('ece-step-' + step);
        if (etapaAtual) {
            etapaAtual.style.display = 'block';
        }

        // Atualizar stepper visual
        eceAtualizarStepper(step);

        // Atualizar bot√µes
        btnAnterior.style.display = step === 1 ? 'none' : 'inline-block';
        btnProximo.style.display = step === totalSteps ? 'none' : 'inline-block';
        btnConcluir.style.display = step === totalSteps ? 'inline-block' : 'none';

        currentStep = step;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUN√á√ÉO: Atualizar Stepper Visual
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function eceAtualizarStepper(step) {
        const steps = document.querySelectorAll('.ece-wizard-step');
        const progressLine = document.getElementById('ece-progress-line');

        steps.forEach((stepEl, index) => {
            const circle = stepEl.querySelector('.ece-step-circle');
            const label = stepEl.querySelector('.ece-step-label');
            const stepNumber = index + 1;

            if (stepNumber < step) {
                // Etapa conclu√≠da
                circle.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                circle.style.color = 'white';
                circle.style.border = 'none';
                circle.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
                label.style.color = '#10b981';
            } else if (stepNumber === step) {
                // Etapa atual
                circle.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                circle.style.color = 'white';
                circle.style.border = 'none';
                circle.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
                label.style.color = '#3b82f6';
            } else {
                // Etapa futura
                circle.style.background = '#e5e7eb';
                circle.style.color = '#9ca3af';
                circle.style.border = '3px solid #f3f4f6';
                circle.style.boxShadow = 'none';
                label.style.color = '#9ca3af';
            }
        });

        // Atualizar linha de progresso
        const progress = ((step - 1) / (totalSteps - 1)) * 100;
        progressLine.style.width = progress + '%';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUN√á√ÉO: Validar Etapa Atual
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function eceValidarEtapa() {
        const stepElement = document.getElementById('ece-step-' + currentStep);

        if (currentStep === 1) {
            // Validar Etapa 1
            const nomeSite = document.querySelector('input[name="nome_site"]');
            const urlSite = document.querySelector('input[name="url_site"]');
            const ehIntermediacao = document.getElementById('ece-eh-intermediacao');

            if (!nomeSite.value.trim()) {
                alert('‚ö†Ô∏è Por favor, informe o nome do site.');
                nomeSite.focus();
                return false;
            }

            if (!urlSite.value.trim()) {
                alert('‚ö†Ô∏è Por favor, informe a URL do site.');
                urlSite.focus();
                return false;
            }

            if (!ehIntermediacao.value) {
                alert('‚ö†Ô∏è Por favor, informe se o site √© de intermedia√ß√£o.');
                return false;
            }
        }

        if (currentStep === 2) {
            // Validar Etapa 2
            const dataConsulta = document.querySelector('input[name="data_consulta"]');
            const horaConsulta = document.querySelector('input[name="hora_consulta"]');
            const incluiFrete = document.getElementById('ece-inclui-frete');

            if (!dataConsulta.value) {
                alert('‚ö†Ô∏è Por favor, informe a data da consulta.');
                dataConsulta.focus();
                return false;
            }

            if (!horaConsulta.value) {
                alert('‚ö†Ô∏è Por favor, informe a hora da consulta.');
                horaConsulta.focus();
                return false;
            }

            if (!incluiFrete.value) {
                alert('‚ö†Ô∏è Por favor, informe se o pre√ßo inclui frete.');
                return false;
            }
        }

        if (currentStep === 3) {
            // Validar Etapa 3
            const checkboxes = document.querySelectorAll('.ece-item-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('‚ö†Ô∏è Por favor, selecione pelo menos um item.');
                return false;
            }

            // Validar se todos os itens selecionados t√™m pre√ßo
            for (let checkbox of checkboxes) {
                const itemId = checkbox.getAttribute('data-item-id');
                const precoInput = document.querySelector(`.ece-preco-input[data-item-id="${itemId}"]`);
                if (!precoInput.value || parseFloat(precoInput.value) <= 0) {
                    alert('‚ö†Ô∏è Por favor, informe o pre√ßo de todos os itens selecionados.');
                    precoInput.focus();
                    return false;
                }
            }
        }

        if (currentStep === 4) {
            // Validar Etapa 4
            if (!inputArquivo.files || inputArquivo.files.length === 0) {
                alert('‚ö†Ô∏è Por favor, anexe o print da consulta.');
                return false;
            }
        }

        return true;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NAVEGA√á√ÉO: Bot√£o Pr√≥ximo
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (btnProximo) {
        btnProximo.addEventListener('click', function() {
            if (eceValidarEtapa()) {
                eceMostrarEtapa(currentStep + 1);
            }
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NAVEGA√á√ÉO: Bot√£o Anterior
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (btnAnterior) {
        btnAnterior.addEventListener('click', function() {
            if (currentStep > 1) {
                eceMostrarEtapa(currentStep - 1);
            }
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CHECKBOX: Selecionar todos
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const checkboxSelectAll = document.getElementById('ece-selecionar-todos');
    if (checkboxSelectAll) {
        checkboxSelectAll.addEventListener('change', function() {
            document.querySelectorAll('.ece-item-checkbox').forEach(cb => {
                cb.checked = this.checked;
            });
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CALCULAR: Pre√ßo total ao digitar pre√ßo unit√°rio
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.querySelectorAll('.ece-preco-input').forEach(input => {
        input.addEventListener('input', function() {
            const itemId = this.getAttribute('data-item-id');
            const quantidade = parseFloat(this.getAttribute('data-quantidade'));
            const precoUnitario = parseFloat(this.value) || 0;
            const precoTotal = quantidade * precoUnitario;

            const spanTotal = document.querySelector(`.ece-preco-total[data-item-id="${itemId}"]`);
            if (spanTotal) {
                spanTotal.textContent = 'R$ ' + precoTotal.toFixed(2).replace('.', ',');
            }
        });
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UPLOAD: Sele√ß√£o de arquivo
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (inputArquivo) {
        inputArquivo.addEventListener('change', function() {
            if (this.files.length > 0) {
                const arquivo = this.files[0];
                const tamanhoMB = (arquivo.size / (1024 * 1024)).toFixed(2);

                document.getElementById('ece-file-name').textContent = arquivo.name;
                document.getElementById('ece-file-size').textContent = `Tamanho: ${tamanhoMB} MB`;
                document.getElementById('ece-file-info').style.display = 'block';

                console.log('üìé [MODAL E-COMMERCE] Arquivo selecionado:', arquivo.name);
            } else {
                document.getElementById('ece-file-info').style.display = 'none';
            }
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SUBMIT: Enviar formul√°rio
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            console.log('üì§ [MODAL E-COMMERCE] Iniciando envio...');

            // Validar todos os steps
            if (!eceValidarEtapa()) {
                return;
            }

            const formData = new FormData(this);

            // Mostrar loading
            btnConcluir.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
            btnConcluir.disabled = true;

            const url = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/coleta-ecommerce';
            console.log('üåê [MODAL E-COMMERCE] URL:', url);

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Coleta de com√©rcio eletr√¥nico salva com sucesso!');
                    bootstrap.Modal.getInstance(modal).hide();
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    alert('‚ùå Erro: ' + (data.message || 'N√£o foi poss√≠vel salvar a coleta.'));
                }
            })
            .catch(error => {
                console.error('‚ùå [MODAL E-COMMERCE] Erro:', error);
                alert('‚ùå Erro ao salvar coleta. Tente novamente.');
            })
            .finally(() => {
                btnConcluir.innerHTML = '<i class="fas fa-check-circle"></i> CONCLUIR';
                btnConcluir.disabled = false;
            });
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUN√á√ÉO: Reset Wizard
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function resetWizard() {
        console.log('üîÑ [MODAL E-COMMERCE] Resetando wizard...');
        currentStep = 1;
        form.reset();
        eceMostrarEtapa(1);

        // Limpar sele√ß√µes
        document.querySelectorAll('.ece-item-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        document.querySelectorAll('.ece-preco-input').forEach(input => {
            input.value = '';
        });
        document.querySelectorAll('.ece-preco-total').forEach(span => {
            span.textContent = 'R$ 0,00';
        });
        document.getElementById('ece-file-info').style.display = 'none';

        // Reset bot√µes de sele√ß√£o
        document.getElementById('ece-btn-interm-sim').style.borderColor = '#e5e7eb';
        document.getElementById('ece-btn-interm-sim').style.background = 'white';
        document.getElementById('ece-btn-interm-nao').style.borderColor = '#e5e7eb';
        document.getElementById('ece-btn-interm-nao').style.background = 'white';
        document.getElementById('ece-btn-frete-sim').style.borderColor = '#e5e7eb';
        document.getElementById('ece-btn-frete-sim').style.background = 'white';
        document.getElementById('ece-btn-frete-nao').style.borderColor = '#e5e7eb';
        document.getElementById('ece-btn-frete-nao').style.background = 'white';
    }

    console.log('‚úÖ [MODAL E-COMMERCE] Inicializa√ß√£o completa!');
})();
</script>

<script>
//  ===============================================================================
//  INICIALIZA√á√ÉO GLOBAL: Sincronizar estado disabled dos campos com checkboxes
//  ESTE C√ìDIGO RODA AO CARREGAR A P√ÅGINA (FORA DE QUALQUER MODAL/IIFE)
//  ===============================================================================
//  PROTE√á√ÉO: Listener √∫nico para sincroniza√ß√£o de checkboxes
window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
    console.log('[INFO] [ELABORAR.BLADE.PHP] Inicializando estado dos campos de pre√ßo...');

    document.querySelectorAll('.ece-item-checkbox').forEach(checkbox => {
        const itemId = checkbox.getAttribute('data-item-id');
        const precoInput = document.querySelector(`.ece-preco-input[data-item-id="${itemId}"]`);

        if (precoInput) {
            // CRUCIAL: Ler o valor que o BLADE renderizou (no atributo data-preco-blade-rendered)
            const valorDoBlade = precoInput.getAttribute('data-preco-blade-rendered');
            const valorAtual = precoInput.value;

            console.log(` Item #${itemId}:`, {
                checkbox_checked: checkbox.checked,
                valor_blade: valorDoBlade,
                valor_atual_campo: valorAtual,
                campo_disabled: precoInput.disabled
            });

            // Se checkbox esta marcado, HABILITAR o campo
            if (checkbox.checked) {
                precoInput.disabled = false;
                console.log(`   ‚úÖ Checkbox marcado ‚Üí Campo HABILITADO`);
            }
            // Se N√ÉO est√° marcado, DESABILITAR
            else {
                precoInput.disabled = true;
                console.log(`   ‚ùå Checkbox desmarcado ‚Üí Campo DESABILITADO`);
            }
        }
    });

    console.log('[INFO] [ELABORAR.BLADE.PHP] Sincroniza√ß√£o conclu√≠da.');
}, 'elaborarEcommerceSyncCheckboxes');
//  ===============================================================================
//  INICIALIZA√á√ÉO GLOBAL: Sincronizar estado disabled dos campos com checkboxes
//  ESTE CDIGO RODA AO CARREGAR A P√ÅGINA (FORA DE QUALQUER MODAL/IIFE)
//  ===============================================================================
//  PROTE√á√ÉO: Listener √∫nico para sincroniza√ß√£o de checkboxes
window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
    console.log('[INFO] [ELABORAR.BLADE.PHP] Inicializando estado dos campos de pre√ßo...');

    document.querySelectorAll('.item-checkbox').forEach(checkbox => {
        const itemId = checkbox.getAttribute('data-item-id');
        const precoInput = document.querySelector(`.preco-input[data-item-id="${itemId}"]`);

        if (precoInput) {
            // CRUCIAL: Ler o valor que o BLADE renderizou (no atributo data-preco-blade-rendered)
            const valorDoBlade = precoInput.getAttribute('data-preco-blade-rendered');
            const valorAtual = precoInput.value;

            console.log(` Item #${itemId}:`, {
                checkbox_checked: checkbox.checked,
                valor_blade: valorDoBlade,
                valor_atual_campo: valorAtual,
                campo_disabled: precoInput.disabled
            });

            // Se checkbox esta marcado, HABILITAR o campo
            if (checkbox.checked) {
                precoInput.disabled = false;

                //  IMPORTANTE: Se o campo esta vazio mas o Blade tinha valor, RESTAURAR!
                if (valorDoBlade && valorDoBlade !== 'BLADE_NULL' && valorDoBlade !== '' && !valorAtual) {
                    console.log(`  a RESTAURANDO valor do Blade: ${valorDoBlade}`);
                    precoInput.value = valorDoBlade;
                }

                console.log(`   Item #${itemId}: checkbox MARCADO a campo HABILITADO (valor final: ${precoInput.value || 'vazio'})`);
            }
            // Se checkbox N√ÉO esta marcado, DESABILITAR o campo
            else {
                precoInput.disabled = true;
                console.log(`   Item #${itemId}: checkbox DESMARCADO a campo DESABILITADO`);
            }
        }
    });

    console.log('[LOG] [ELABORAR.BLADE.PHP] Inicializa√ßo de campos conclu√≠da!');
}, 'checkboxSyncInit'); //  Fim do DOMContentLoaded - Sincroniza√ß√£o Checkboxes
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL SOLICITAR CDF - VERS√ÉO 2.0 (2025)
     Design moderno mantendo TODAS as funcionalidades cr√≠ticas
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal fade" id="modalSolicitarCDF" tabindex="-1" aria-labelledby="modalSolicitarCDFLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 1200px;">
        <div class="modal-content" style="border: none; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 HEADER MODERNO COM GRADIENTE AZUL
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="modal-header" style="
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1e40af 100%);
                color: white;
                padding: 25px 30px;
                border: none;
                position: relative;
                overflow: hidden;
            ">
                <!-- Efeito de brilho de fundo -->
                <div style="
                    position: absolute;
                    top: -50%;
                    right: -5%;
                    width: 300px;
                    height: 300px;
                    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
                    border-radius: 50%;
                "></div>
                
                <div style="position: relative; z-index: 1; width: 100%;">
                    <h5 class="modal-title" id="modalSolicitarCDFLabel" style="
                        font-weight: 800;
                        text-transform: uppercase;
                        font-size: 18px;
                        letter-spacing: 0.5px;
                        margin: 0;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        <div style="
                            background: rgba(255,255,255,0.2);
                            padding: 10px;
                            border-radius: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-file-invoice" style="font-size: 24px;"></i>
                        </div>
                        <span>Solicitar Cota√ß√£o Direta com Fornecedor (CDF)</span>
                    </h5>
                </div>
                
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="position: relative; z-index: 2;"></button>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 STEPPER MODERNO (5 ETAPAS)
                 C√≠rculos de 56px com visual moderno
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div style="background: linear-gradient(180deg, #f9fafb 0%, #ffffff 100%); padding: 30px 20px; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; position: relative; max-width: 900px; margin: 0 auto;">
                    
                    <!-- Linha de conex√£o cinza (fundo) -->
                    <div style="
                        position: absolute;
                        top: 28px;
                        left: 40px;
                        right: 40px;
                        height: 3px;
                        background: #e5e7eb;
                        z-index: 0;
                    "></div>
                    
                    <!-- Linha de progresso azul (animada) -->
                    <div id="cdf-progress-line" style="
                        position: absolute;
                        top: 28px;
                        left: 40px;
                        height: 3px;
                        background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
                        z-index: 0;
                        width: 0%;
                        transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
                    "></div>

                    <!-- Step 1 -->
                    <div class="cdf-wizard-step active" data-step="1" style="
                        flex: 1;
                        text-align: center;
                        position: relative;
                        z-index: 1;
                        max-width: 150px;
                    ">
                        <div class="cdf-step-circle" style="
                            width: 56px;
                            height: 56px;
                            border-radius: 50%;
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                            color: white;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 10px;
                            font-weight: 800;
                            font-size: 20px;
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
                            transition: all 0.3s ease;
                        ">
                            1
                        </div>
                        <div class="cdf-step-label" style="
                            font-size: 11px;
                            font-weight: 700;
                            color: #3b82f6;
                            text-transform: uppercase;
                            line-height: 1.3;
                            letter-spacing: 0.3px;
                        ">
                            Sele√ß√£o<br>de Itens
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div class="cdf-wizard-step" data-step="2" style="
                        flex: 1;
                        text-align: center;
                        position: relative;
                        z-index: 1;
                        max-width: 150px;
                    ">
                        <div class="cdf-step-circle" style="
                            width: 56px;
                            height: 56px;
                            border-radius: 50%;
                            background: #e5e7eb;
                            color: #9ca3af;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 10px;
                            font-weight: 800;
                            font-size: 20px;
                            transition: all 0.3s ease;
                        ">
                            2
                        </div>
                        <div class="cdf-step-label" style="
                            font-size: 11px;
                            font-weight: 700;
                            color: #9ca3af;
                            text-transform: uppercase;
                            line-height: 1.3;
                            letter-spacing: 0.3px;
                        ">
                            Dados do<br>Fornecedor
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div class="cdf-wizard-step" data-step="3" style="
                        flex: 1;
                        text-align: center;
                        position: relative;
                        z-index: 1;
                        max-width: 150px;
                    ">
                        <div class="cdf-step-circle" style="
                            width: 56px;
                            height: 56px;
                            border-radius: 50%;
                            background: #e5e7eb;
                            color: #9ca3af;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 10px;
                            font-weight: 800;
                            font-size: 20px;
                            transition: all 0.3s ease;
                        ">
                            3
                        </div>
                        <div class="cdf-step-label" style="
                            font-size: 11px;
                            font-weight: 700;
                            color: #9ca3af;
                            text-transform: uppercase;
                            line-height: 1.3;
                            letter-spacing: 0.3px;
                        ">
                            Condi√ß√µes<br>Comerciais
                        </div>
                    </div>

                    <!-- Step 4 -->
                    <div class="cdf-wizard-step" data-step="4" style="
                        flex: 1;
                        text-align: center;
                        position: relative;
                        z-index: 1;
                        max-width: 150px;
                    ">
                        <div class="cdf-step-circle" style="
                            width: 56px;
                            height: 56px;
                            border-radius: 50%;
                            background: #e5e7eb;
                            color: #9ca3af;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 10px;
                            font-weight: 800;
                            font-size: 20px;
                            transition: all 0.3s ease;
                        ">
                            4
                        </div>
                        <div class="cdf-step-label" style="
                            font-size: 11px;
                            font-weight: 700;
                            color: #9ca3af;
                            text-transform: uppercase;
                            line-height: 1.3;
                            letter-spacing: 0.3px;
                        ">
                            Validar<br>Empresa
                        </div>
                    </div>

                    <!-- Step 5 -->
                    <div class="cdf-wizard-step" data-step="5" style="
                        flex: 1;
                        text-align: center;
                        position: relative;
                        z-index: 1;
                        max-width: 150px;
                    ">
                        <div class="cdf-step-circle" style="
                            width: 56px;
                            height: 56px;
                            border-radius: 50%;
                            background: #e5e7eb;
                            color: #9ca3af;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 10px;
                            font-weight: 800;
                            font-size: 20px;
                            transition: all 0.3s ease;
                        ">
                            5
                        </div>
                        <div class="cdf-step-label" style="
                            font-size: 11px;
                            font-weight: 700;
                            color: #9ca3af;
                            text-transform: uppercase;
                            line-height: 1.3;
                            letter-spacing: 0.3px;
                        ">
                            Gerar<br>Cota√ß√£o
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 BODY DO MODAL COM FORMUL√ÅRIO
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <form id="formSolicitarCDF" enctype="multipart/form-data">
                @csrf
                <input type="hidden" name="orcamento_id" value="{{ $orcamento->id }}">

                <div class="modal-body" style="padding: 30px; min-height: 450px; background: #fafbfc;">

                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                         ETAPA 1: SELE√á√ÉO DE ITENS
                         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="cdf-wizard-content" id="cdf-step-1" style="display: block;">
                        <!-- Header da Etapa -->
                        <div style="
                            background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
                            padding: 16px 20px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            border-left: 4px solid #3b82f6;
                        ">
                            <h6 style="
                                font-size: 15px;
                                font-weight: 800;
                                color: #1e40af;
                                margin: 0;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            ">
                                <div style="
                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: 800;
                                    font-size: 16px;
                                    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
                                ">1</div>
                                SELE√á√ÉO DE ITENS
                            </h6>
                            <p style="
                                font-size: 13px;
                                color: #1e3a8a;
                                margin: 8px 0 0 0;
                                font-weight: 500;
                                padding-left: 42px;
                            ">
                                Selecione os itens cuja cota√ß√£o ser√° solicitada.
                            </p>
                        </div>

                        <!-- Campo de pesquisa -->
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: #374151; font-size: 13px; margin-bottom: 8px;">
                                <i class="fas fa-search" style="color: #3b82f6;"></i> Pesquisar Item
                            </label>
                            <input
                                type="text"
                                id="cdf-pesquisa-item"
                                class="form-control"
                                placeholder="Digite parte da descri√ß√£o para filtrar..."
                                style="
                                    font-size: 13px;
                                    padding: 12px 16px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 10px;
                                    transition: all 0.2s;
                                "
                                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                            >
                        </div>

                        <!-- Tabela de itens -->
                        <div style="
                            max-height: 400px;
                            overflow-y: auto;
                            border: 2px solid #e5e7eb;
                            border-radius: 12px;
                            background: white;
                        ">
                            <table class="table table-sm" style="margin-bottom: 0; font-size: 13px;">
                                <thead style="
                                    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
                                    position: sticky;
                                    top: 0;
                                    z-index: 10;
                                ">
                                    <tr>
                                        <th style="
                                            width: 50px;
                                            padding: 14px 12px;
                                            text-align: center;
                                            border-bottom: 2px solid #e5e7eb;
                                        ">
                                            <input type="checkbox" id="cdf-select-all-items" style="cursor: pointer; width: 18px; height: 18px;">
                                        </th>
                                        <th style="padding: 14px; font-weight: 700; color: #374151; border-bottom: 2px solid #e5e7eb;">LOTE/ITEM</th>
                                        <th style="padding: 14px; font-weight: 700; color: #374151; border-bottom: 2px solid #e5e7eb;">DESCRI√á√ÉO</th>
                                        <th style="padding: 14px; font-weight: 700; color: #374151; width: 120px; text-align: right; border-bottom: 2px solid #e5e7eb;">QUANTIDADE</th>
                                        <th style="padding: 14px; font-weight: 700; color: #374151; width: 140px; border-bottom: 2px solid #e5e7eb;">UNIDADE</th>
                                    </tr>
                                </thead>
                                <tbody id="cdf-tbody-itens">
                                    @foreach($orcamento->itens as $item)
                                    <tr class="cdf-item-row" style="transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #f3f4f6;">
                                            <input
                                                type="checkbox"
                                                name="itens_selecionados[]"
                                                value="{{ $item->id }}"
                                                class="form-check-input cdf-item-checkbox"
                                                style="cursor: pointer; width: 18px; height: 18px;"
                                            >
                                        </td>
                                        <td style="padding: 12px; color: #6b7280; font-weight: 600; border-bottom: 1px solid #f3f4f6;">
                                            {{ $item->lote_id ? 'Lote ' . $item->lote->numero : 'Item' }}
                                        </td>
                                        <td style="padding: 12px; color: #111827; font-weight: 500; border-bottom: 1px solid #f3f4f6;">
                                            {{ $item->descricao }}
                                        </td>
                                        <td style="padding: 12px; color: #6b7280; text-align: right; border-bottom: 1px solid #f3f4f6;">
                                            {{ number_format($item->quantidade, 2, ',', '.') }}
                                        </td>
                                        <td style="padding: 12px; color: #6b7280; border-bottom: 1px solid #f3f4f6;">
                                            {{ $item->medida_fornecimento }}
                                        </td>
                                    </tr>
                                    @endforeach
                                </tbody>
                            </table>
                        </div>

                        <!-- Alert de aten√ß√£o -->
                        <div style="
                            margin-top: 16px;
                            padding: 14px 16px;
                            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                            border-left: 4px solid #fbbf24;
                            border-radius: 10px;
                            font-size: 12px;
                            color: #92400e;
                            font-weight: 600;
                        ">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                            <strong>Aten√ß√£o:</strong> Selecione pelo menos 1 item para solicitar a cota√ß√£o.
                        </div>
                    </div>


                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                         ETAPA 2: DADOS DO FORNECEDOR + JUSTIFICATIVA
                         PARTE CR√çTICA COM INTEGRA√á√ïES
                         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="cdf-wizard-content" id="cdf-step-2" style="display: none;">
                        <!-- Header da Etapa -->
                        <div style="
                            background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
                            padding: 16px 20px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            border-left: 4px solid #3b82f6;
                        ">
                            <h6 style="
                                font-size: 15px;
                                font-weight: 800;
                                color: #1e40af;
                                margin: 0;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            ">
                                <div style="
                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: 800;
                                    font-size: 16px;
                                    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
                                ">2</div>
                                DADOS DO FORNECEDOR
                            </h6>
                        </div>

                        <div class="row">
                            <!-- CNPJ com busca autom√°tica -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 700; color: #374151; font-size: 13px; margin-bottom: 8px;">
                                    CNPJ <span style="color: #dc2626;">*</span>
                                </label>
                                <div style="display: flex; gap: 10px;">
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="cdf-cnpj-input"
                                        name="cnpj"
                                        placeholder="00.000.000/0000-00"
                                        required
                                        maxlength="18"
                                        style="
                                            font-size: 13px;
                                            padding: 12px 16px;
                                            flex: 1;
                                            border: 2px solid #e5e7eb;
                                            border-radius: 10px;
                                        "
                                    >
                                    <button
                                        type="button"
                                        id="cdf-btn-buscar-cnpj"
                                        class="btn"
                                        style="
                                            padding: 12px 24px;
                                            font-size: 13px;
                                            font-weight: 700;
                                            white-space: nowrap;
                                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                            color: white;
                                            border: none;
                                            border-radius: 10px;
                                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                                            transition: all 0.3s ease;
                                        "
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'"
                                    >
                                        <i class="fas fa-search"></i> BUSCAR
                                    </button>
                                </div>
                                <small style="
                                    font-size: 11px;
                                    color: #6b7280;
                                    margin-top: 6px;
                                    display: block;
                                    font-weight: 500;
                                ">
                                    <i class="fas fa-info-circle" style="color: #3b82f6;"></i> Digite o CNPJ e clique em BUSCAR para preencher automaticamente
                                </small>
                                <button
                                    type="button"
                                    id="cdf-btn-baixar-espelho"
                                    class="btn btn-success btn-sm"
                                    style="
                                        margin-top: 10px;
                                        font-size: 12px;
                                        padding: 8px 16px;
                                        display: none;
                                        font-weight: 700;
                                        border-radius: 8px;
                                    "
                                >
                                    <i class="fas fa-download"></i> BAIXAR ESPELHO CNPJ (PDF)
                                </button>
                            </div>

                            <!-- Raz√£o Social -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 700; color: #374151; font-size: 13px; margin-bottom: 8px;">
                                    Raz√£o Social <span style="color: #dc2626;">*</span>
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="cdf-razao-social-input"
                                    name="razao_social"
                                    placeholder="Nome da empresa"
                                    required
                                    style="
                                        font-size: 13px;
                                        padding: 12px 16px;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 10px;
                                    "
                                >
                            </div>
                        </div>

                        <div class="row">
                            <!-- E-mail -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 700; color: #374151; font-size: 13px; margin-bottom: 8px;">
                                    E-mail <span style="color: #dc2626;">*</span> <span style="font-size: 11px; color: #6b7280; font-weight: 500;">(para envio da cota√ß√£o)</span>
                                </label>
                                <input
                                    type="email"
                                    class="form-control"
                                    id="cdf-email-input"
                                    name="email"
                                    placeholder="contato@empresa.com"
                                    required
                                    style="
                                        font-size: 13px;
                                        padding: 12px 16px;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 10px;
                                    "
                                >
                            </div>

                            <!-- Telefone -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 700; color: #374151; font-size: 13px; margin-bottom: 8px;">
                                    Telefone <span style="font-size: 11px; color: #6b7280; font-weight: 500;">(opcional)</span>
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="cdf-telefone-input"
                                    name="telefone"
                                    placeholder="(00) 0000-0000"
                                    style="
                                        font-size: 13px;
                                        padding: 12px 16px;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 10px;
                                    "
                                >
                            </div>
                        </div>

                        <!-- BOT√ïES DE IMPORTAR FORNECEDOR (INTEGRA√á√ÉO CR√çTICA) -->
                        <div style="margin: 24px 0; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border: 2px solid #bae6fd;">
                            <p style="
                                font-size: 13px;
                                color: #0c4a6e;
                                font-weight: 700;
                                margin-bottom: 14px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-lightbulb" style="color: #3b82f6; font-size: 18px;"></i>
                                N√£o sabe qual fornecedor escolher? Busque em nosso banco de dados:
                            </p>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button
                                    type="button"
                                    id="btn-importar-fornecedor-pncp"
                                    class="btn"
                                    onclick="console.log('[HTML-ONCLICK] PNCP clicado!'); if(typeof window.abrirModalPNCP === 'function') { window.abrirModalPNCP(); } else { console.error('[HTML-ONCLICK] window.abrirModalPNCP n√£o existe!'); } return false;"
                                    style="
                                        flex: 1;
                                        min-width: 200px;
                                        padding: 14px 20px;
                                        font-size: 13px;
                                        font-weight: 700;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 10px;
                                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                        color: white;
                                        border: none;
                                        border-radius: 10px;
                                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                                        transition: all 0.3s ease;
                                    "
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'"
                                >
                                    <i class="fas fa-search-dollar" style="font-size: 16px;"></i>
                                    BUSQUE O MELHOR FORNECEDOR
                                </button>
                                <button
                                    type="button"
                                    id="btn-importar-fornecedor-local"
                                    class="btn"
                                    onclick="console.log('[HTML-ONCLICK] LOCAL clicado!'); if(typeof window.abrirModalLocal === 'function') { window.abrirModalLocal(); } else { console.error('[HTML-ONCLICK] window.abrirModalLocal n√£o existe!'); } return false;"
                                    style="
                                        flex: 1;
                                        min-width: 200px;
                                        padding: 14px 20px;
                                        font-size: 13px;
                                        font-weight: 700;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 10px;
                                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                        color: white;
                                        border: none;
                                        border-radius: 10px;
                                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                                        transition: all 0.3s ease;
                                    "
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'"
                                >
                                    <i class="fas fa-database" style="font-size: 16px;"></i>
                                    IMPORTAR - CADASTRO LOCAL
                                </button>
                            </div>
                            <small style="
                                font-size: 11px;
                                color: #0c4a6e;
                                margin-top: 10px;
                                display: block;
                                font-weight: 600;
                            ">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                Busque por nome, CNPJ, produto ou palavra-chave (ex: "caneta", "papel")
                            </small>
                        </div>

                        <!-- JUSTIFICATIVAS (CAMPO OBRIGAT√ìRIO) -->
                        <hr style="margin: 24px 0; border-color: #e5e7eb;">
                        <div style="
                            background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
                            padding: 16px 20px;
                            border-radius: 12px;
                            margin-bottom: 16px;
                            border-left: 4px solid #3b82f6;
                        ">
                            <h6 style="
                                font-size: 14px;
                                font-weight: 800;
                                color: #1e40af;
                                margin: 0;
                            ">
                                JUSTIFICAR ESCOLHA DO FORNECEDOR <span style="color: #dc2626;">*</span>
                            </h6>
                        </div>

                        <div style="
                            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                            border-left: 4px solid #f59e0b;
                            padding: 14px 16px;
                            border-radius: 10px;
                            margin-bottom: 16px;
                        ">
                            <p style="
                                font-size: 12px;
                                color: #92400e;
                                margin: 0;
                                font-weight: 700;
                            ">
                                <i class="fas fa-exclamation-triangle" style="color: #f59e0b; margin-right: 8px;"></i>
                                Campo obrigat√≥rio: Selecione pelo menos uma justificativa predefinida OU preencha a justificativa livre.
                            </p>
                        </div>

                        <p style="
                            font-size: 13px;
                            color: #374151;
                            margin-bottom: 14px;
                            font-weight: 600;
                        ">
                            Selecione uma ou mais justificativas predefinidas. Voc√™ tamb√©m pode incluir uma justificativa personalizada.
                        </p>

                        <!-- Justificativas predefinidas -->
                        <div class="mb-2">
                            <label style="
                                display: flex;
                                align-items: start;
                                gap: 10px;
                                cursor: pointer;
                                padding: 12px;
                                border-radius: 10px;
                                transition: all 0.2s;
                                background: white;
                                border: 2px solid #e5e7eb;
                            " onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#3b82f6'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                                <input type="checkbox" name="justificativas[]" value="reconhecida_regiao" class="form-check-input" style="margin-top: 3px; width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 12px; color: #374151; line-height: 1.5; font-weight: 500;">
                                    A empresa √© reconhecida da regi√£o como fornecedor dessa linha de materiais/servi√ßos.
                                </span>
                            </label>
                        </div>

                        <div class="mb-2">
                            <label style="
                                display: flex;
                                align-items: start;
                                gap: 10px;
                                cursor: pointer;
                                padding: 12px;
                                border-radius: 10px;
                                transition: all 0.2s;
                                background: white;
                                border: 2px solid #e5e7eb;
                            " onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#3b82f6'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                                <input type="checkbox" name="justificativas[]" value="forneceu_anteriormente" class="form-check-input" style="margin-top: 3px; width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 12px; color: #374151; line-height: 1.5; font-weight: 500;">
                                    A empresa j√° forneceu anteriormente, sem problemas na execu√ß√£o.
                                </span>
                            </label>
                        </div>

                        <div class="mb-2">
                            <label style="
                                display: flex;
                                align-items: start;
                                gap: 10px;
                                cursor: pointer;
                                padding: 12px;
                                border-radius: 10px;
                                transition: all 0.2s;
                                background: white;
                                border: 2px solid #e5e7eb;
                            " onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#3b82f6'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                                <input type="checkbox" name="justificativas[]" value="outro_municipio" class="form-check-input" style="margin-top: 3px; width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 12px; color: #374151; line-height: 1.5; font-weight: 500;">
                                    A empresa √© de outro munic√≠pio, pois h√° restri√ß√£o de fornecedores na pra√ßa local.
                                </span>
                            </label>
                        </div>

                        <div class="mb-2">
                            <label style="
                                display: flex;
                                align-items: start;
                                gap: 10px;
                                cursor: pointer;
                                padding: 12px;
                                border-radius: 10px;
                                transition: all 0.2s;
                                background: white;
                                border: 2px solid #e5e7eb;
                            " onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#3b82f6'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                                <input type="checkbox" name="justificativas[]" value="mais_competitivo" class="form-check-input" style="margin-top: 3px; width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 12px; color: #374151; line-height: 1.5; font-weight: 500;">
                                    O mercado fornecedor √© mais competitivo na pra√ßa pesquisada.
                                </span>
                            </label>
                        </div>

                        <!-- Justificativa livre -->
                        <div class="mb-3" style="margin-top: 16px;">
                            <label class="form-label" style="font-weight: 700; color: #374151; font-size: 13px; margin-bottom: 8px;">
                                Justificativa Livre <span style="font-size: 11px; color: #6b7280; font-weight: 500;">(opcional)</span>
                            </label>
                            <textarea
                                class="form-control"
                                name="justificativa_outro"
                                rows="3"
                                placeholder="Adicione informa√ß√µes adicionais se necess√°rio..."
                                style="
                                    font-size: 13px;
                                    padding: 12px 16px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 10px;
                                "
                            ></textarea>
                        </div>
                    </div>


                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                         ETAPA 3: CONDI√á√ïES COMERCIAIS
                         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="cdf-wizard-content" id="cdf-step-3" style="display: none;">
                        <!-- Header da Etapa -->
                        <div style="
                            background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
                            padding: 16px 20px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            border-left: 4px solid #3b82f6;
                        ">
                            <h6 style="
                                font-size: 15px;
                                font-weight: 800;
                                color: #1e40af;
                                margin: 0;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            ">
                                <div style="
                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: 800;
                                    font-size: 16px;
                                    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
                                ">3</div>
                                CONDI√á√ïES COMERCIAIS
                            </h6>
                        </div>

                        <div class="row">
                            <!-- Prazo de resposta -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 700; color: #374151; font-size: 13px; margin-bottom: 8px;">
                                    Prazo de resposta (dias) <span style="color: #dc2626;">*</span>
                                </label>
                                <input
                                    type="number"
                                    class="form-control"
                                    name="prazo_resposta_dias"
                                    placeholder="Ex: 5"
                                    min="1"
                                    required
                                    style="
                                        font-size: 13px;
                                        padding: 12px 16px;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 10px;
                                    "
                                >
                                <small style="font-size: 11px; color: #6b7280; font-weight: 500; margin-top: 4px; display: block;">
                                    Prazo para o fornecedor responder
                                </small>
                            </div>

                            <!-- Prazo de entrega -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 700; color: #374151; font-size: 13px; margin-bottom: 8px;">
                                    Prazo de entrega (dias) <span style="color: #dc2626;">*</span>
                                </label>
                                <input
                                    type="number"
                                    class="form-control"
                                    name="prazo_entrega_dias"
                                    placeholder="Ex: 10"
                                    min="1"
                                    required
                                    style="
                                        font-size: 13px;
                                        padding: 12px 16px;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 10px;
                                    "
                                >
                                <small style="font-size: 11px; color: #6b7280; font-weight: 500; margin-top: 4px; display: block;">
                                    Prazo ap√≥s autoriza√ß√£o de fornecimento
                                </small>
                            </div>
                        </div>

                        <!-- Frete -->
                        <div class="mb-3">
                            <label class="form-label d-block" style="font-weight: 700; color: #374151; font-size: 13px; margin-bottom: 12px;">
                                Frete <span style="color: #dc2626;">*</span>
                            </label>
                            <div style="display: flex; gap: 14px;">
                                <label style="
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 0;
                                    flex: 1;
                                    position: relative;
                                ">
                                    <input type="radio" name="frete" value="CIF" required style="position: absolute; opacity: 0; cursor: pointer;" onchange="this.closest('label').querySelector('.radio-card').style.borderColor='#3b82f6'; this.closest('label').querySelector('.radio-card').style.background='linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%)'; this.closest('label').parentElement.querySelectorAll('.radio-card').forEach(c => {if(c !== this.closest('label').querySelector('.radio-card')) {c.style.borderColor='#d1d5db'; c.style.background='white'}})">
                                    <div class="radio-card" style="
                                        padding: 16px 20px;
                                        border: 3px solid #d1d5db;
                                        border-radius: 12px;
                                        background: white;
                                        font-size: 13px;
                                        text-align: center;
                                        width: 100%;
                                        transition: all 0.2s;
                                        cursor: pointer;
                                    ">
                                        <div style="font-weight: 800; color: #111827; font-size: 16px; margin-bottom: 4px;">CIF</div>
                                        <div style="color: #6b7280; font-size: 11px; font-weight: 600;">Entregue na sede do comprador</div>
                                    </div>
                                </label>
                                <label style="
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 0;
                                    flex: 1;
                                    position: relative;
                                ">
                                    <input type="radio" name="frete" value="FOB" required style="position: absolute; opacity: 0; cursor: pointer;" onchange="this.closest('label').querySelector('.radio-card').style.borderColor='#3b82f6'; this.closest('label').querySelector('.radio-card').style.background='linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%)'; this.closest('label').parentElement.querySelectorAll('.radio-card').forEach(c => {if(c !== this.closest('label').querySelector('.radio-card')) {c.style.borderColor='#d1d5db'; c.style.background='white'}})">
                                    <div class="radio-card" style="
                                        padding: 16px 20px;
                                        border: 3px solid #d1d5db;
                                        border-radius: 12px;
                                        background: white;
                                        font-size: 13px;
                                        text-align: center;
                                        width: 100%;
                                        transition: all 0.2s;
                                        cursor: pointer;
                                    ">
                                        <div style="font-weight: 800; color: #111827; font-size: 16px; margin-bottom: 4px;">FOB</div>
                                        <div style="color: #6b7280; font-size: 11px; font-weight: 600;">Entregue no fornecedor</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Observa√ß√µes -->
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 700; color: #374151; font-size: 13px; margin-bottom: 8px;">
                                Observa√ß√µes <span style="font-size: 11px; color: #6b7280; font-weight: 500;">(opcional)</span>
                            </label>
                            <textarea
                                class="form-control"
                                name="observacao"
                                rows="4"
                                placeholder="Ex: marca/modelo desejado, SLA, garantias, montagem, etc."
                                style="
                                    font-size: 13px;
                                    padding: 12px 16px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 10px;
                                "
                            ></textarea>
                        </div>
                    </div>

                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                         ETAPA 4: VALIDAR EMPRESA
                         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="cdf-wizard-content" id="cdf-step-4" style="display: none;">
                        <!-- Header da Etapa -->
                        <div style="
                            background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
                            padding: 16px 20px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            border-left: 4px solid #3b82f6;
                        ">
                            <h6 style="
                                font-size: 15px;
                                font-weight: 800;
                                color: #1e40af;
                                margin: 0;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            ">
                                <div style="
                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: 800;
                                    font-size: 16px;
                                    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
                                ">4</div>
                                VALIDAR EMPRESA
                            </h6>
                        </div>

                        <!-- Checkbox de valida√ß√£o -->
                        <div class="mb-4">
                            <div style="
                                background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
                                border: 2px solid #3b82f6;
                                border-radius: 12px;
                                padding: 18px 20px;
                            ">
                                <label style="
                                    display: flex;
                                    align-items: center;
                                    gap: 14px;
                                    cursor: pointer;
                                    margin: 0;
                                ">
                                    <input
                                        type="checkbox"
                                        name="fornecedor_valido"
                                        required
                                        class="form-check-input"
                                        style="
                                            width: 24px;
                                            height: 24px;
                                            cursor: pointer;
                                            border: 2px solid #3b82f6;
                                        "
                                    >
                                    <span style="
                                        font-size: 14px;
                                        font-weight: 700;
                                        color: #0369a1;
                                    ">
                                        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                                        Confirmo que o fornecedor √© v√°lido para este processo
                                    </span>
                                </label>
                            </div>
                        </div>

                        <!-- Upload espelho CNPJ (opcional) -->
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 700; color: #374151; font-size: 13px; margin-bottom: 10px;">
                                Upload do Espelho do CNPJ <span style="font-size: 11px; color: #6b7280; font-weight: 500;">(opcional)</span>
                            </label>
                            <div style="
                                border: 3px dashed #d1d5db;
                                border-radius: 12px;
                                padding: 30px 25px;
                                text-align: center;
                                background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
                                transition: all 0.2s;
                            " onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#f0f9ff'" onmouseout="this.style.borderColor='#d1d5db'; this.style.background='linear-gradient(135deg, #f9fafb 0%, #ffffff 100%)'">
                                <i class="fas fa-file-pdf" style="font-size: 40px; color: #9ca3af; margin-bottom: 12px;"></i>
                                <input
                                    type="file"
                                    id="cdf-arquivo-cnpj"
                                    name="arquivo_cnpj"
                                    accept=".pdf"
                                    style="display: none;"
                                >
                                <button
                                    type="button"
                                    id="cdf-btn-selecionar-cnpj"
                                    class="btn"
                                    style="
                                        font-size: 13px;
                                        padding: 10px 24px;
                                        font-weight: 700;
                                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                        color: white;
                                        border: none;
                                        border-radius: 10px;
                                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                                    "
                                >
                                    <i class="fas fa-folder-open"></i> SELECIONAR ARQUIVO
                                </button>
                                <div id="cdf-nome-arquivo-cnpj" style="
                                    margin-top: 12px;
                                    font-size: 12px;
                                    color: #059669;
                                    font-weight: 700;
                                "></div>
                            </div>
                            <small style="
                                font-size: 11px;
                                color: #6b7280;
                                display: block;
                                margin-top: 8px;
                                font-weight: 600;
                            ">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i> M√°x. 2MB ‚Ä¢ Formato: PDF ‚Ä¢ Orienta√ß√£o: Retrato
                            </small>
                        </div>
                    </div>

                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                         ETAPA 5: GERAR COTA√á√ÉO
                         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="cdf-wizard-content" id="cdf-step-5" style="display: none;">
                        <!-- Header da Etapa -->
                        <div style="
                            background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
                            padding: 16px 20px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            border-left: 4px solid #3b82f6;
                        ">
                            <h6 style="
                                font-size: 15px;
                                font-weight: 800;
                                color: #1e40af;
                                margin: 0;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            ">
                                <div style="
                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: 800;
                                    font-size: 16px;
                                    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
                                ">5</div>
                                GERAR COTA√á√ÉO
                            </h6>
                        </div>

                        <!-- Alerta de recomenda√ß√µes -->
                        <div style="
                            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                            border: 2px solid #fbbf24;
                            border-radius: 12px;
                            padding: 20px 24px;
                            margin-bottom: 20px;
                        ">
                            <h6 style="
                                font-size: 14px;
                                font-weight: 800;
                                color: #92400e;
                                margin-bottom: 12px;
                            ">
                                <i class="fas fa-exclamation-triangle" style="font-size: 18px; margin-right: 8px;"></i> RECOMENDA√á√ïES IMPORTANTES
                            </h6>
                            <p style="
                                font-size: 12px;
                                color: #78350f;
                                line-height: 1.7;
                                margin-bottom: 0;
                                font-weight: 600;
                            ">
                                A solicita√ß√£o de CDF est√° pronta para ser gerada. Ao concluir, o sistema ir√° registrar a cota√ß√£o e voc√™ poder√°:
                            </p>
                        </div>

                        <!-- Card 1: Documentos gerados -->
                        <div style="
                            background: white;
                            border: 2px solid #bae6fd;
                            border-radius: 12px;
                            padding: 18px 22px;
                            margin-bottom: 14px;
                        ">
                            <h6 style="
                                font-size: 13px;
                                font-weight: 800;
                                color: #0369a1;
                                margin-bottom: 10px;
                            ">
                                <i class="fas fa-file-alt" style="margin-right: 8px;"></i> 1. DOCUMENTOS GERADOS
                            </h6>
                            <p style="
                                font-size: 12px;
                                color: #0c4a6e;
                                line-height: 1.7;
                                margin-bottom: 0;
                                font-weight: 600;
                            ">
                                ‚Ä¢ <strong>Of√≠cio de solicita√ß√£o</strong> em formato DOC/PDF<br>
                                ‚Ä¢ <strong>Formul√°rio de cota√ß√£o</strong> em formato Excel (XLS)
                            </p>
                        </div>

                        <!-- Card 2: Envio da solicita√ß√£o -->
                        <div style="
                            background: white;
                            border: 2px solid #bae6fd;
                            border-radius: 12px;
                            padding: 18px 22px;
                            margin-bottom: 14px;
                        ">
                            <h6 style="
                                font-size: 13px;
                                font-weight: 800;
                                color: #0369a1;
                                margin-bottom: 10px;
                            ">
                                <i class="fas fa-envelope" style="margin-right: 8px;"></i> 2. ENVIO DA SOLICITA√á√ÉO
                            </h6>
                            <p style="
                                font-size: 12px;
                                color: #0c4a6e;
                                line-height: 1.7;
                                margin-bottom: 0;
                                font-weight: 600;
                            ">
                                A solicita√ß√£o deve ser enviada <strong>por e-mail</strong> para o fornecedor informado. Em anexo, envie o formul√°rio de cota√ß√£o e, se aplic√°vel, o termo de refer√™ncia.
                            </p>
                        </div>

                        <!-- Card 3: V√≠nculos entre fornecedores -->
                        <div style="
                            background: white;
                            border: 2px solid #bae6fd;
                            border-radius: 12px;
                            padding: 18px 22px;
                        ">
                            <h6 style="
                                font-size: 13px;
                                font-weight: 800;
                                color: #0369a1;
                                margin-bottom: 10px;
                            ">
                                <i class="fas fa-users" style="margin-right: 8px;"></i> 3. V√çNCULOS ENTRE FORNECEDORES
                            </h6>
                            <p style="
                                font-size: 12px;
                                color: #0c4a6e;
                                line-height: 1.7;
                                margin-bottom: 0;
                                font-weight: 600;
                            ">
                                Verifique se h√° ind√≠cios de v√≠nculo entre fornecedores consultados (parentesco, mesmo endere√ßo, grupo empresarial). Caso haja, as CDFs devem ser descartadas.
                            </p>
                        </div>
                    </div>

                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     FOOTER COM BOT√ïES DE NAVEGA√á√ÉO
                     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="modal-footer" style="
                    padding: 18px 30px;
                    border-top: 2px solid #e5e7eb;
                    display: flex;
                    justify-content: space-between;
                    background: linear-gradient(180deg, #fafbfc 0%, #ffffff 100%);
                ">
                    <button
                        type="button"
                        id="cdf-btn-anterior"
                        class="btn"
                        style="
                            padding: 12px 28px;
                            font-size: 13px;
                            font-weight: 700;
                            display: none;
                            background: #f3f4f6;
                            color: #374151;
                            border: 2px solid #d1d5db;
                            border-radius: 10px;
                            transition: all 0.2s;
                        "
                        onmouseover="this.style.background='#e5e7eb'"
                        onmouseout="this.style.background='#f3f4f6'"
                    >
                        <i class="fas fa-chevron-left"></i> ANTERIOR
                    </button>
                    <div style="flex: 1;"></div>
                    <button
                        type="button"
                        class="btn"
                        data-bs-dismiss="modal"
                        style="
                            padding: 12px 28px;
                            font-size: 13px;
                            font-weight: 700;
                            margin-right: 10px;
                            background: #f3f4f6;
                            color: #374151;
                            border: 2px solid #d1d5db;
                            border-radius: 10px;
                            transition: all 0.2s;
                        "
                        onmouseover="this.style.background='#e5e7eb'"
                        onmouseout="this.style.background='#f3f4f6'"
                    >
                        CANCELAR
                    </button>
                    <button
                        type="button"
                        id="cdf-btn-proximo"
                        class="btn"
                        style="
                            padding: 12px 28px;
                            font-size: 13px;
                            font-weight: 700;
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                            color: white;
                            border: none;
                            border-radius: 10px;
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                            transition: all 0.3s ease;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'"
                    >
                        PR√ìXIMO <i class="fas fa-chevron-right"></i>
                    </button>
                    <button
                        type="submit"
                        id="cdf-btn-gerar"
                        class="btn"
                        style="
                            padding: 12px 28px;
                            font-size: 13px;
                            font-weight: 700;
                            display: none;
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white;
                            border: none;
                            border-radius: 10px;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                            transition: all 0.3s ease;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'"
                    >
                        <i class="fas fa-check-circle"></i> GERAR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ===== MODAL SOLICITAR CDF =====
(function() {
    let cdfCurrentStep = 1;
    const cdfTotalSteps = 5;
    const cdfModal = document.getElementById('modalSolicitarCDF');
    const cdfForm = document.getElementById('formSolicitarCDF');
    const cdfBtnAbrir = document.getElementById('btn-solicitar-cdf');
    const cdfBtnAnterior = document.getElementById('cdf-btn-anterior');
    const cdfBtnProximo = document.getElementById('cdf-btn-proximo');
    const cdfBtnGerar = document.getElementById('cdf-btn-gerar');
    const cdfBtnSelecionarCNPJ = document.getElementById('cdf-btn-selecionar-cnpj');
    const cdfInputCNPJ = document.getElementById('cdf-arquivo-cnpj');
    const cdfPesquisaItem = document.getElementById('cdf-pesquisa-item');

    // IMPORTANTE: Remover atributo required dos inputs de arquivo
    if (cdfInputCNPJ) {
        cdfInputCNPJ.removeAttribute('required');
    }

    // Abrir modal
    if (cdfBtnAbrir) {
        cdfBtnAbrir.addEventListener('click', function() {
            const bsModal = new bootstrap.Modal(cdfModal);
            bsModal.show();
            cdfResetWizard();

            // Garantir que required foi removido
            if (cdfInputCNPJ) {
                cdfInputCNPJ.removeAttribute('required');
            }
        });
    }

    // Navega√ßo entre etapas
    if (cdfBtnProximo) {
        cdfBtnProximo.addEventListener('click', function() {
            if (cdfValidateCurrentStep()) {
                cdfGoToStep(cdfCurrentStep + 1);
            }
        });
    }

    if (cdfBtnAnterior) {
        cdfBtnAnterior.addEventListener('click', function() {
            cdfGoToStep(cdfCurrentStep - 1);
        });
    }

    // Upload arquivo CNPJ
    if (cdfBtnSelecionarCNPJ) {
        cdfBtnSelecionarCNPJ.addEventListener('click', function() {
            cdfInputCNPJ.click();
        });
    }

    if (cdfInputCNPJ) {
        cdfInputCNPJ.addEventListener('change', function() {
            const nomeArquivo = document.getElementById('cdf-nome-arquivo-cnpj');
            if (this.files.length > 0) {
                nomeArquivo.textContent = ` ${this.files[0].name}`;
            } else {
                nomeArquivo.textContent = '';
            }
        });
    }

    // Pesquisa de itens
    if (cdfPesquisaItem) {
        cdfPesquisaItem.addEventListener('input', function() {
            const termo = this.value.toLowerCase();
            const rows = document.querySelectorAll('.cdf-item-row');

            rows.forEach(row => {
                const descricao = row.cells[2].textContent.toLowerCase();
                if (termo === '' || descricao.includes(termo)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }

    // Buscar CNPJ automaticamente
    const cdfBtnBuscarCNPJ = document.getElementById('cdf-btn-buscar-cnpj');
    const cdfCnpjInput = document.getElementById('cdf-cnpj-input');
    const cdfRazaoSocialInput = document.getElementById('cdf-razao-social-input');
    const cdfEmailInput = document.getElementById('cdf-email-input');
    const cdfTelefoneInput = document.getElementById('cdf-telefone-input');

    if (cdfBtnBuscarCNPJ && cdfCnpjInput) {
        cdfBtnBuscarCNPJ.addEventListener('click', async function() {
            const cnpj = cdfCnpjInput.value.replace(/\D/g, ''); // Remover formata√ßo

            if (cnpj.length !== 14) {
                alert('[LOG] CNPJ Invlido\n\nDigite um CNPJ vlido com 14 d√≠gitos.');
                return;
            }

            // Desabilitar botao durante busca
            cdfBtnBuscarCNPJ.disabled = true;
            cdfBtnBuscarCNPJ.innerHTML = '<i class="fas fa-spinner fa-spin"></i> BUSCANDO...';

            try {
                // Buscar na API da Receita Federal via backend
                const response = await fetch(`${window.APP_BASE_PATH}/api/cnpj/consultar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ cnpj: cnpj })
                });

                const result = await response.json();

                if (result.success) {
                    // Preencher campos automaticamente com dados da Receita Federal
                    if (cdfRazaoSocialInput) cdfRazaoSocialInput.value = result.razao_social || '';
                    if (cdfEmailInput) cdfEmailInput.value = result.email || '';
                    if (cdfTelefoneInput) cdfTelefoneInput.value = result.telefone || '';

                    // MOSTRAR BOT√ÉO DE BAIXAR ESPELHO CNPJ
                    const btnBaixarEspelho = document.getElementById('cdf-btn-baixar-espelho');
                    if (btnBaixarEspelho) {
                        btnBaixarEspelho.style.display = 'inline-block';
                        console.log('[LOG] Boto de baixar espelho CNPJ exibido');
                    }

                    // Mensagem de sucesso
                    let mensagem = ` CNPJ Encontrado!\n\n` +
                                   `Razo Social: ${result.razao_social}\n` +
                                   `Situa√ßo: ${result.situacao}\n\n` +
                                   `Dados preenchidos automaticamente!`;

                    // Avisar se no tem email
                    if (!result.email) {
                        mensagem += `\n\n Email no encontrado no cadastro da Receita Federal.\nPor favor, preencha manualmente.`;
                        // Focar no campo email
                        if (cdfEmailInput) {
                            setTimeout(() => cdfEmailInput.focus(), 100);
                        }
                    }

                    // Avisar se empresa no esta ativa
                    if (result.warning) {
                        mensagem += `\n\n ${result.warning}`;
                    }

                    alert(mensagem);

                } else {
                    // Erro: CNPJ no encontrado ou invlido
                    alert(` ${result.message || 'Erro ao buscar CNPJ'}\n\nVerifique o CNPJ digitado ou preencha os dados manualmente.`);

                    // ESCONDER BOT√ÉO DE BAIXAR ESPELHO CNPJ
                    const btnBaixarEspelho = document.getElementById('cdf-btn-baixar-espelho');
                    if (btnBaixarEspelho) {
                        btnBaixarEspelho.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Erro ao buscar CNPJ:', error);
                alert('[LOG] Erro ao Buscar CNPJ\n\nNo foi poss√≠vel consultar a Receita Federal.\nVerifique sua conexo e tente novamente.\n\nVoca pode preencher os dados manualmente.');
            } finally {
                // Reabilitar botao
                cdfBtnBuscarCNPJ.disabled = false;
                cdfBtnBuscarCNPJ.innerHTML = '<i class="fas fa-search"></i> BUSCAR';
            }
        });

        // Adicionar mscara ao campo CNPJ do CDF
        cdfCnpjInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 14) {
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
            }
            e.target.value = value;
        });

        // Permitir buscar ao pressionar Enter no campo CNPJ
        cdfCnpjInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                cdfBtnBuscarCNPJ.click();
            }
        });
    }

    // ========== BOT√ÉO BAIXAR ESPELHO CNPJ ==========
    const btnBaixarEspelhoCNPJ = document.getElementById('cdf-btn-baixar-espelho');
    if (btnBaixarEspelhoCNPJ && cdfCnpjInput) {
        btnBaixarEspelhoCNPJ.addEventListener('click', function() {
            const cnpj = cdfCnpjInput.value.replace(/\D/g, ''); // Remover formata√ßo

            if (cnpj.length !== 14) {
                alert('[LOG] CNPJ Invlido\n\nDigite um CNPJ vlido com 14 d√≠gitos antes de baixar o espelho.');
                return;
            }

            console.log('[INFO] Iniciando download do espelho CNPJ:', cnpj);

            // SOLU√á√ÉO: Usar um FORM invis√≠vel para fazer download via POST
            // Isso evita problemas com blob URLs em contextos de proxy/iframe

            // Criar form temporrio
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `${window.APP_BASE_PATH}/baixar-espelho-cnpj`;
            form.target = '_blank'; // Abrir em nova aba (o servidor for√ßara download)
            form.style.display = 'none';

            // Adicionar CSRF token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_token';
            csrfInput.value = document.querySelector('meta[name="csrf-token"]').content;
            form.appendChild(csrfInput);

            // Adicionar CNPJ
            const cnpjInput = document.createElement('input');
            cnpjInput.type = 'hidden';
            cnpjInput.name = 'cnpj';
            cnpjInput.value = cnpj;
            form.appendChild(cnpjInput);

            // Adicionar ao DOM
            document.body.appendChild(form);

            console.log('[INFO] Enviando formulrio para download...');

            // Submeter form
            form.submit();

            // Remover form ap√≥s um delay
            setTimeout(() => {
                document.body.removeChild(form);
                console.log('[LOG] Download iniciado! Formulrio removido.');
            }, 1000);
        });
    }

    // Mscara CNPJ (outro campo)
    const cnpjInput = document.querySelector('input[name="fornecedor_cnpj"]');
    if (cnpjInput) {
        cnpjInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 14) {
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
            }
            e.target.value = value;
        });
    }

    // Mscara telefone
    const telInput = document.querySelector('input[name="fornecedor_telefone"]');
    if (telInput) {
        telInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/^(\d{2})(\d)/, '($1) $2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
                if (value.length === 14) {
                    value = value.replace(/(\d{5})-(\d{4})/, '$1-$2');
                }
            }
            e.target.value = value;
        });
    }

    function cdfGoToStep(step) {
        if (step < 1 || step > cdfTotalSteps) return;

        // Esconder todas as etapas
        document.querySelectorAll('.cdf-wizard-content').forEach(content => {
            content.style.display = 'none';
        });

        // Mostrar etapa atual
        document.getElementById(`cdf-step-${step}`).style.display = 'block';

        // Atualizar indicadores visuais
        cdfUpdateStepIndicators(step);

        // Atualizar bot√µes
        cdfBtnAnterior.style.display = step === 1 ? 'none' : 'inline-block';
        cdfBtnProximo.style.display = step === cdfTotalSteps ? 'none' : 'inline-block';
        cdfBtnGerar.style.display = step === cdfTotalSteps ? 'inline-block' : 'none';

        cdfCurrentStep = step;
    }

    function cdfUpdateStepIndicators(step) {
        document.querySelectorAll('.cdf-wizard-step').forEach((stepEl, index) => {
            const stepNumber = index + 1;
            const circle = stepEl.querySelector('.cdf-step-circle');
            const label = stepEl.querySelector('.cdf-step-label');

            if (stepNumber < step) {
                circle.style.background = '#10b981';
                circle.style.color = 'white';
                label.style.color = '#10b981';
                stepEl.classList.remove('active');
            } else if (stepNumber === step) {
                circle.style.background = '#3b82f6';
                circle.style.color = 'white';
                circle.style.boxShadow = '0 2px 8px rgba(59, 130, 246, 0.3)';
                label.style.color = '#3b82f6';
                stepEl.classList.add('active');
            } else {
                circle.style.background = '#e5e7eb';
                circle.style.color = '#9ca3af';
                circle.style.boxShadow = 'none';
                label.style.color = '#9ca3af';
                stepEl.classList.remove('active');
            }
        });

        const progress = ((step - 1) / (cdfTotalSteps - 1)) * 100;
        document.getElementById('cdf-progress-line').style.width = `${progress}%`;
    }

    function cdfValidateCurrentStep() {
        const stepElement = document.getElementById(`cdf-step-${cdfCurrentStep}`);
        const inputs = stepElement.querySelectorAll('input[required], select[required], textarea[required]');

        for (let input of inputs) {
            if (input.type === 'checkbox' && input.hasAttribute('required')) {
                if (!input.checked) {
                    alert('[LOG] Campo Obrigat√≥rio\n\nPor favor, marque o checkbox obrigat√≥rio para continuar.');
                    input.focus();
                    return false;
                }
            } else if (input.type === 'radio') {
                const radioName = input.name;
                if (!stepElement.querySelector(`input[name="${radioName}"]:checked`)) {
                    // Descobrir qual o label do radio
                    const radioGroup = stepElement.querySelector(`input[name="${radioName}"]`);
                    const label = radioGroup ? radioGroup.closest('.mb-3, .row, div')?.querySelector('label')?.textContent?.trim() : '';

                    alert(` Sele√ßo Obrigat√≥ria\n\nPor favor, selecione uma op√ßo${label ? ' para: ' + label : '.'}`);
                    return false;
                }
            } else if (!input.value) {
                // Pegar o label do campo
                const label = input.closest('.mb-3, .col-md-6')?.querySelector('label')?.textContent?.trim().replace('*', '') || 'Este campo';

                alert(` Campo Obrigat√≥rio\n\nPor favor, preencha o campo: ${label}`);
                input.focus();
                return false;
            }
        }

        // Valida√ßo espec√≠fica etapa 1: pelo menos 1 item selecionado
        if (cdfCurrentStep === 1) {
            const checkboxes = stepElement.querySelectorAll('.cdf-item-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('[LOG] Nenhum Item Selecionado\n\nPor favor, selecione pelo menos um item para solicitar cota√ßo.');
                return false;
            }
        }

        // Valida√ßo espec√≠fica etapa 2: pelo menos 1 justificativa selecionada
        if (cdfCurrentStep === 2) {
            const justificativasCheckboxes = stepElement.querySelectorAll('input[name="justificativas[]"]:checked');
            const justificativaOutro = stepElement.querySelector('textarea[name="justificativa_outro"]');
            const hasJustificativaOutro = justificativaOutro && justificativaOutro.value.trim() !== '';

            if (justificativasCheckboxes.length === 0 && !hasJustificativaOutro) {
                alert('[LOG] Justificativa Obrigat√≥ria\n\nPor favor, selecione pelo menos uma justificativa predefinida OU preencha a justificativa livre para continuar.');
                return false;
            }
        }

        return true;
    }

    function cdfResetWizard() {
        cdfCurrentStep = 1;
        cdfForm.reset();
        cdfGoToStep(1);
        document.getElementById('cdf-nome-arquivo-cnpj').textContent = '';
        if (cdfPesquisaItem) cdfPesquisaItem.value = '';
        document.querySelectorAll('.cdf-item-row').forEach(row => row.style.display = '');
    }

    // Submit do formulrio
    if (cdfForm) {
        cdfForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('[INFO] CDF FORM SUBMIT - Iniciando envio da CDF...');

            if (!cdfValidateCurrentStep()) {
                console.error('[ERRO] CDF FORM SUBMIT - Valida√ßo falhou');
                return;
            }

            console.log('[LOG] CDF FORM SUBMIT - Valida√ßo passou, preparando requisi√ßo...');

            const formData = new FormData(this);

            console.log('[INFO] CDF FORM SUBMIT - FormData criado:', Array.from(formData.entries()));

            cdfBtnGerar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GERANDO...';
            cdfBtnGerar.disabled = true;

            const url = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/solicitar-cdf';
            console.log('[INFO] CDF FORM SUBMIT - URL:', url);
            console.log('[INFO] CDF FORM SUBMIT - Iniciando requisi√ßo fetch...');

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                }
            })
            .then(response => {
                console.log('[INFO] CDF FORM SUBMIT - Resposta recebida:', response.status);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('[LOG] Solicita√ßo Gerada\n\nSolicita√ßo de CDF gerada com sucesso!');

                    setTimeout(() => {
                        bootstrap.Modal.getInstance(cdfModal).hide();
                        location.reload();
                    }, 1000);
                } else {
                    let detalhes = '';
                    if (data.errors) {
                        detalhes = 'Erros de valida√ßo:\n';
                        Object.keys(data.errors).forEach(key => {
                            detalhes += `- ${key}: ${data.errors[key].join(', ')}\n`;
                        });
                    }
                    if (data.error_details) {
                        detalhes += `\nDetalhes t√©cnicos:\n`;
                        detalhes += `Arquivo: ${data.error_details.file}\n`;
                        detalhes += `Linha: ${data.error_details.line}\n`;
                    }

                    alert(` Erro ao Gerar Solicita√ßo\n\n${window.escapeAlert(data.message || 'No foi poss√≠vel gerar a solicita√ßo.')}${detalhes ? '\n\n' + detalhes : ''}`);
                }
            })
            .catch(error => {
                console.error('[ERRO] CDF FORM SUBMIT - ERRO NO FETCH:', error);

                let detalhes = `URL: orcamentos/${window.ORCAMENTO_ID}/solicitar-cdf\n`;
                detalhes += `Erro: ${error.message}\n\n`;
                if (error.stack) {
                    detalhes += `Stack Trace:\n${error.stack}`;
                }

                alert(` Erro ao Gerar Solicita√ßo\n\nOcorreu um erro ao enviar o formulrio.\n\n${detalhes}`);
            })
            .finally(() => {
                console.log('[INFO] CDF FORM SUBMIT - Finalizando...');
                cdfBtnGerar.innerHTML = '<i class="fas fa-check-circle"></i> GERAR';
                cdfBtnGerar.disabled = false;
            });
        });
    }

// ===== SELECT ALL CHECKBOX PARA ITENS CDF =====
const cdfSelectAllCheckbox = document.getElementById('cdf-select-all-items');
if (cdfSelectAllCheckbox) {
    cdfSelectAllCheckbox.addEventListener('change', function() {
        const itemCheckboxes = document.querySelectorAll('.cdf-item-checkbox');
        const visibleCheckboxes = Array.from(itemCheckboxes).filter(cb => cb.closest('tr').style.display !== 'none');
        
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        
        const action = this.checked ? 'Selecionados' : 'Desmarcados';
        console.log('[CDF] ' + action + ' ' + visibleCheckboxes.length + ' itens vis√≠veis');
    });
}
})();
</script>


<!--  
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                               ‚ïë
‚ïë  MODAL NOVO E MODERNO - CONTRATA√á√ïES SIMILARES                               ‚ïë
‚ïë  Vers√£o: 2.0 (2025)                                                           ‚ïë
‚ïë  Design: Moderno, intuitivo e funcional                                       ‚ïë
‚ïë                                                                               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->

<!-- Modal Novo: Contrata√ß√µes Similares v2.0 -->
<div class="modal fade" id="modalContratacoesSimilaresNovo" tabindex="-1" aria-labelledby="modalContratacoesSimilaresNovoLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 1200px;">
        <div class="modal-content" style="border: none; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- HEADER MODERNO -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="modal-header" style="
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1e40af 100%);
                color: white;
                padding: 25px 30px;
                border: none;
                position: relative;
                overflow: hidden;
            ">
                <!-- Efeito de brilho de fundo -->
                <div style="
                    position: absolute;
                    top: -50%;
                    right: -5%;
                    width: 300px;
                    height: 300px;
                    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
                    border-radius: 50%;
                "></div>
                
                <div style="position: relative; z-index: 1; width: 100%;">
                    <h5 class="modal-title" id="modalContratacoesSimilaresNovoLabel" style="
                        font-weight: 800;
                        text-transform: uppercase;
                        font-size: 18px;
                        letter-spacing: 0.5px;
                        margin: 0;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        <div style="
                            background: rgba(255,255,255,0.2);
                            padding: 10px;
                            border-radius: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-building" style="font-size: 24px;"></i>
                        </div>
                        <span>Contrata√ß√µes Similares</span>
                        <span style="
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            padding: 6px 14px;
                            border-radius: 20px;
                            font-size: 11px;
                            font-weight: 700;
                            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
                            letter-spacing: 1px;
                        ">v2.0 NOVO</span>
                    </h5>
                    <p style="
                        margin: 8px 0 0 58px;
                        font-size: 13px;
                        opacity: 0.9;
                        font-weight: 500;
                    ">
                        Incluir contrata√ß√µes similares de outros entes p√∫blicos
                    </p>
                </div>
                
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="
                    position: relative;
                    z-index: 2;
                    opacity: 0.9;
                "></button>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- STEPPER / WIZARD MELHORADO -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div style="
                background: linear-gradient(to bottom, #f8fafc 0%, #ffffff 100%);
                padding: 25px 30px;
                border-bottom: 2px solid #e5e7eb;
            ">
                <div style="display: flex; justify-content: space-between; position: relative;">
                    <!-- Linha de progresso de fundo -->
                    <div style="
                        position: absolute;
                        top: 28px;
                        left: 8%;
                        right: 8%;
                        height: 4px;
                        background: #e5e7eb;
                        border-radius: 10px;
                        z-index: 0;
                    "></div>
                    
                    <!-- Linha de progresso ativa -->
                    <div id="csn-progress-line" style="
                        position: absolute;
                        top: 28px;
                        left: 8%;
                        height: 4px;
                        background: linear-gradient(to right, #3b82f6, #2563eb);
                        border-radius: 10px;
                        z-index: 0;
                        width: 0%;
                        transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
                    "></div>

                    <!-- Step 1: Dados da Contrata√ß√£o -->
                    <div class="csn-wizard-step" data-step="1" style="
                        flex: 1;
                        text-align: center;
                        position: relative;
                        z-index: 1;
                    ">
                        <div class="csn-step-circle" style="
                            width: 56px;
                            height: 56px;
                            border-radius: 50%;
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                            color: white;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 12px;
                            font-weight: 800;
                            font-size: 20px;
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
                            transition: all 0.3s ease;
                        ">
                            1
                        </div>
                        <div class="csn-step-label" style="
                            font-size: 12px;
                            font-weight: 700;
                            color: #3b82f6;
                            text-transform: uppercase;
                            line-height: 1.3;
                            letter-spacing: 0.5px;
                        ">
                            Dados da<br>Contrata√ß√£o
                        </div>
                    </div>

                    <!-- Step 2: Coleta de Amostras -->
                    <div class="csn-wizard-step" data-step="2" style="
                        flex: 1;
                        text-align: center;
                        position: relative;
                        z-index: 1;
                    ">
                        <div class="csn-step-circle" style="
                            width: 56px;
                            height: 56px;
                            border-radius: 50%;
                            background: #e5e7eb;
                            color: #9ca3af;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 12px;
                            font-weight: 800;
                            font-size: 20px;
                            transition: all 0.3s ease;
                            border: 3px solid #f3f4f6;
                        ">
                            2
                        </div>
                        <div class="csn-step-label" style="
                            font-size: 12px;
                            font-weight: 700;
                            color: #9ca3af;
                            text-transform: uppercase;
                            line-height: 1.3;
                            letter-spacing: 0.5px;
                        ">
                            Coleta de<br>Amostras
                        </div>
                    </div>

                    <!-- Step 3: Anexar PDF -->
                    <div class="csn-wizard-step" data-step="3" style="
                        flex: 1;
                        text-align: center;
                        position: relative;
                        z-index: 1;
                    ">
                        <div class="csn-step-circle" style="
                            width: 56px;
                            height: 56px;
                            border-radius: 50%;
                            background: #e5e7eb;
                            color: #9ca3af;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 12px;
                            font-weight: 800;
                            font-size: 20px;
                            transition: all 0.3s ease;
                            border: 3px solid #f3f4f6;
                        ">
                            3
                        </div>
                        <div class="csn-step-label" style="
                            font-size: 12px;
                            font-weight: 700;
                            color: #9ca3af;
                            text-transform: uppercase;
                            line-height: 1.3;
                            letter-spacing: 0.5px;
                        ">
                            Anexar<br>PDF
                        </div>
                    </div>
                </div>
            </div>


            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- FORMUL√ÅRIO -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <form id="formContratacoesSimilaresNovo" method="POST" action="javascript:void(0);" enctype="multipart/form-data">
                @csrf
                <input type="hidden" name="orcamento_id" value="{{ $orcamento->id }}">

                <div class="modal-body" style="padding: 30px 35px; min-height: 500px; background: #fafbfc;">

                    <!-- ============================================================ -->
                    <!-- ETAPA 1: DADOS DA CONTRATA√á√ÉO -->
                    <!-- ============================================================ -->
                    <div class="csn-wizard-content" id="csn-step-1" style="display: block;">
                        
                        <!-- T√≠tulo da Etapa -->
                        <div style="
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                            padding: 16px 20px;
                            border-radius: 12px;
                            margin-bottom: 25px;
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
                        ">
                            <h6 style="
                                font-size: 15px;
                                font-weight: 800;
                                color: white;
                                margin: 0;
                                display: flex;
                                align-items: center;
                                gap: 12px;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            ">
                                <span style="
                                    background: rgba(255,255,255,0.3);
                                    padding: 6px 12px;
                                    border-radius: 8px;
                                    font-size: 14px;
                                ">1</span>
                                <i class="fas fa-file-contract"></i>
                                Dados da Contrata√ß√£o
                            </h6>
                        </div>

                        <!-- Informa√ß√£o sobre o ente p√∫blico -->
                        <div class="mb-4">
                            <label class="form-label" style="
                                font-weight: 700;
                                color: #1f2937;
                                font-size: 13px;
                                margin-bottom: 8px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-landmark" style="color: #3b82f6;"></i>
                                Ente p√∫blico <span style="color: #ef4444;">*</span>
                            </label>
                            <input
                                type="text"
                                class="form-control"
                                name="ente_publico"
                                placeholder="Ex: Prefeitura Municipal de Barbacena, UASG 123456, CNPJ 00.000.000/0001-00"
                                required
                                style="
                                    font-size: 13px;
                                    padding: 12px 16px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 10px;
                                    transition: all 0.3s ease;
                                "
                                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                            >
                            <small style="
                                font-size: 11px;
                                color: #6b7280;
                                font-weight: 500;
                                margin-top: 6px;
                                display: block;
                            ">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                Informe o √≥rg√£o, UASG ou CNPJ do ente p√∫blico que realizou a contrata√ß√£o
                            </small>
                        </div>

                        <!-- Tipo e N√∫mero do Processo -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label" style="
                                    font-weight: 700;
                                    color: #1f2937;
                                    font-size: 13px;
                                    margin-bottom: 8px;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-folder-open" style="color: #3b82f6;"></i>
                                    Tipo <span style="color: #ef4444;">*</span>
                                </label>
                                <select
                                    class="form-control"
                                    name="tipo"
                                    required
                                    style="
                                        font-size: 13px;
                                        padding: 12px 16px;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 10px;
                                        transition: all 0.3s ease;
                                        background: white;
                                    "
                                    onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                                    onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                                >
                                    <option value="">Selecione o tipo...</option>
                                    <option value="Preg√£o">Preg√£o</option>
                                    <option value="Contrato">Contrato</option>
                                    <option value="Ata de Registro de Pre√ßos">Ata de Registro de Pre√ßos</option>
                                    <option value="Dispensa">Dispensa</option>
                                    <option value="Inexigibilidade">Inexigibilidade</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-4">
                                <label class="form-label" style="
                                    font-weight: 700;
                                    color: #1f2937;
                                    font-size: 13px;
                                    margin-bottom: 8px;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-hashtag" style="color: #3b82f6;"></i>
                                    N√∫mero do processo <span style="color: #ef4444;">*</span>
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="numero_processo"
                                    placeholder="Ex: 0001/2025 ou 123456"
                                    required
                                    style="
                                        font-size: 13px;
                                        padding: 12px 16px;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 10px;
                                        transition: all 0.3s ease;
                                    "
                                    onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                                    onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                                >
                                <small style="
                                    font-size: 11px;
                                    color: #6b7280;
                                    font-weight: 500;
                                    margin-top: 6px;
                                    display: block;
                                ">
                                    Formato: n√∫mero/ano (Ex: 0001/2025)
                                </small>
                            </div>
                        </div>

                        <!-- H√° Registro de Pre√ßos? (Novo Design) -->
                        <div class="mb-4">
                            <label class="form-label d-block" style="
                                font-weight: 700;
                                color: #1f2937;
                                font-size: 13px;
                                margin-bottom: 12px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-question-circle" style="color: #3b82f6;"></i>
                                H√° Registro de Pre√ßos? <span style="color: #ef4444;">*</span>
                            </label>
                            <div style="display: flex; gap: 16px;">
                                <!-- Bot√£o SIM -->
                                <div id="csn-btn-registro-sim" onclick="csnSelecionarRegistroPreco('sim')" style="
                                    flex: 1;
                                    padding: 20px;
                                    border: 3px solid #e5e7eb;
                                    border-radius: 16px;
                                    background: white;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    position: relative;
                                    overflow: hidden;
                                " onmouseover="if(!this.classList.contains('selected')){this.style.borderColor='#d1d5db'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.1)'}" onmouseout="if(!this.classList.contains('selected')){this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none'}">
                                    <i class="fas fa-check-circle" style="
                                        font-size: 48px;
                                        color: #10b981;
                                        margin-bottom: 12px;
                                        display: block;
                                        transition: all 0.3s ease;
                                    "></i>
                                    <div style="
                                        font-weight: 800;
                                        color: #1f2937;
                                        font-size: 18px;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                    ">Sim</div>
                                    <div style="
                                        font-size: 12px;
                                        color: #6b7280;
                                        margin-top: 6px;
                                        font-weight: 500;
                                    ">Possui Registro de Pre√ßos</div>
                                </div>

                                <!-- Bot√£o N√ÉO -->
                                <div id="csn-btn-registro-nao" onclick="csnSelecionarRegistroPreco('nao')" style="
                                    flex: 1;
                                    padding: 20px;
                                    border: 3px solid #e5e7eb;
                                    border-radius: 16px;
                                    background: white;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    position: relative;
                                    overflow: hidden;
                                " onmouseover="if(!this.classList.contains('selected')){this.style.borderColor='#d1d5db'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.1)'}" onmouseout="if(!this.classList.contains('selected')){this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none'}">
                                    <i class="fas fa-times-circle" style="
                                        font-size: 48px;
                                        color: #ef4444;
                                        margin-bottom: 12px;
                                        display: block;
                                        transition: all 0.3s ease;
                                    "></i>
                                    <div style="
                                        font-weight: 800;
                                        color: #1f2937;
                                        font-size: 18px;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                    ">N√£o</div>
                                    <div style="
                                        font-size: 12px;
                                        color: #6b7280;
                                        margin-top: 6px;
                                        font-weight: 500;
                                    ">N√£o possui Registro de Pre√ßos</div>
                                </div>

                                <!-- Input hidden -->
                                <input type="hidden" id="csn-eh-registro-precos" name="eh_registro_precos" value="">
                            </div>
                        </div>

                        <hr style="
                            margin: 30px 0;
                            border: none;
                            border-top: 2px dashed #e5e7eb;
                        ">

                        <!-- Dados da Publica√ß√£o -->
                        <div style="
                            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
                            padding: 16px 20px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            border-left: 4px solid #3b82f6;
                        ">
                            <h6 style="
                                font-size: 14px;
                                font-weight: 800;
                                color: #1f2937;
                                margin: 0;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            ">
                                <i class="fas fa-newspaper" style="color: #3b82f6;"></i>
                                Dados da Publica√ß√£o
                            </h6>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label" style="
                                    font-weight: 700;
                                    color: #1f2937;
                                    font-size: 13px;
                                    margin-bottom: 8px;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-calendar-alt" style="color: #3b82f6;"></i>
                                    Data da publica√ß√£o <span style="color: #ef4444;">*</span>
                                </label>
                                <input
                                    type="date"
                                    class="form-control"
                                    name="data_publicacao"
                                    required
                                    style="
                                        font-size: 13px;
                                        padding: 12px 16px;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 10px;
                                        transition: all 0.3s ease;
                                    "
                                    onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                                    onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                                >
                            </div>

                            <div class="col-md-6 mb-4">
                                <label class="form-label" style="
                                    font-weight: 700;
                                    color: #1f2937;
                                    font-size: 13px;
                                    margin-bottom: 8px;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-map-marker-alt" style="color: #3b82f6;"></i>
                                    Local de publica√ß√£o
                                </label>
                                <select
                                    class="form-control"
                                    name="local_publicacao"
                                    style="
                                        font-size: 13px;
                                        padding: 12px 16px;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 10px;
                                        transition: all 0.3s ease;
                                        background: white;
                                    "
                                    onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                                    onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                                >
                                    <option value="">Selecione...</option>
                                    <option value="Di√°rio Oficial">Di√°rio Oficial</option>
                                    <option value="Portal da Transpar√™ncia">Portal da Transpar√™ncia</option>
                                    <option value="PNCP">PNCP</option>
                                    <option value="ComprasGov">ComprasGov</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label" style="
                                font-weight: 700;
                                color: #1f2937;
                                font-size: 13px;
                                margin-bottom: 8px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-link" style="color: #3b82f6;"></i>
                                Link oficial <span style="color: #ef4444;">*</span>
                            </label>
                            <input
                                type="url"
                                class="form-control"
                                name="link_oficial"
                                placeholder="https://..."
                                required
                                style="
                                    font-size: 13px;
                                    padding: 12px 16px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 10px;
                                    transition: all 0.3s ease;
                                "
                                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                            >
                            <small style="
                                font-size: 11px;
                                color: #6b7280;
                                font-weight: 500;
                                margin-top: 6px;
                                display: block;
                            ">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                Link do PNCP, ComprasGov, Di√°rio Oficial ou portal oficial que comprova a origem da contrata√ß√£o
                            </small>
                        </div>

                    </div>


                    <!-- ============================================================ -->
                    <!-- ETAPA 2: COLETA DE AMOSTRAS -->
                    <!-- ============================================================ -->
                    <div class="csn-wizard-content" id="csn-step-2" style="display: none;">
                        
                        <!-- T√≠tulo da Etapa -->
                        <div style="
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                            padding: 16px 20px;
                            border-radius: 12px;
                            margin-bottom: 25px;
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
                        ">
                            <h6 style="
                                font-size: 15px;
                                font-weight: 800;
                                color: white;
                                margin: 0;
                                display: flex;
                                align-items: center;
                                gap: 12px;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            ">
                                <span style="
                                    background: rgba(255,255,255,0.3);
                                    padding: 6px 12px;
                                    border-radius: 8px;
                                    font-size: 14px;
                                ">2</span>
                                <i class="fas fa-list-check"></i>
                                Coleta de Amostras
                            </h6>
                            <p style="
                                margin: 8px 0 0 0;
                                font-size: 12px;
                                opacity: 0.95;
                                font-weight: 500;
                            ">
                                Preencha o pre√ßo coletado para cada item. Itens com R$ 0,00 ou desmarcados ser√£o ignorados.
                            </p>
                        </div>

                        <!-- Tabela de Itens -->
                        <div style="
                            border: 2px solid #e5e7eb;
                            border-radius: 12px;
                            overflow: hidden;
                            background: white;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                        ">
                            <div style="
                                max-height: 450px;
                                overflow-y: auto;
                            ">
                                <table class="table table-hover mb-0" style="font-size: 12px;">
                                    <thead style="
                                        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                                    ">
                                        <tr>
                                            <th style="
                                                width: 50px;
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <input type="checkbox" id="csn-selecionar-todos" class="form-check-input" style="cursor: pointer;">
                                            </th>
                                            <th style="
                                                width: 100px;
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <i class="fas fa-hashtag" style="color: #3b82f6;"></i> Item
                                            </th>
                                            <th style="
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <i class="fas fa-align-left" style="color: #3b82f6;"></i> Descri√ß√£o
                                            </th>
                                            <th style="
                                                width: 110px;
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <i class="fas fa-box" style="color: #3b82f6;"></i> Unidade
                                            </th>
                                            <th style="
                                                width: 100px;
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <i class="fas fa-sort-numeric-up" style="color: #3b82f6;"></i> Qtd
                                            </th>
                                            <th style="
                                                width: 140px;
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <i class="fas fa-dollar-sign" style="color: #10b981;"></i> Pre√ßo Unit.
                                            </th>
                                            <th style="
                                                width: 140px;
                                                padding: 14px 10px;
                                                font-weight: 800;
                                                color: #1f2937;
                                                text-transform: uppercase;
                                                font-size: 11px;
                                                letter-spacing: 0.5px;
                                            ">
                                                <i class="fas fa-signal" style="color: #3b82f6;"></i> N√≠vel Conf.
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach($orcamento->itens as $item)
                                        <tr style="transition: background 0.2s ease;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                            <td style="padding: 12px 10px; text-align: center;">
                                                <input
                                                    type="checkbox"
                                                    name="itens_selecionados[]"
                                                    value="{{ $item->id }}"
                                                    class="form-check-input csn-item-check"
                                                    style="cursor: pointer;"
                                                >
                                            </td>
                                            <td style="padding: 12px 10px;">
                                                <span style="
                                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                                    color: white;
                                                    padding: 6px 12px;
                                                    border-radius: 8px;
                                                    font-weight: 700;
                                                    font-size: 12px;
                                                    display: inline-block;
                                                ">
                                                    {{ str_pad($item->numero_item ?: $loop->iteration, 2, '0', STR_PAD_LEFT) }}
                                                </span>
                                            </td>
                                            <td style="padding: 12px 10px;">
                                                <textarea
                                                    name="descricao[{{ $item->id }}]"
                                                    class="form-control form-control-sm"
                                                    rows="2"
                                                    style="
                                                        font-size: 11px;
                                                        border: 1px solid #e5e7eb;
                                                        border-radius: 6px;
                                                        resize: none;
                                                    "
                                                    placeholder="Descri√ß√£o do item..."
                                                >{{ $item->descricao }}</textarea>
                                            </td>
                                            <td style="padding: 12px 10px;">
                                                <input
                                                    type="text"
                                                    name="unidade[{{ $item->id }}]"
                                                    class="form-control form-control-sm"
                                                    value="{{ $item->unidade }}"
                                                    style="
                                                        font-size: 11px;
                                                        border: 1px solid #e5e7eb;
                                                        border-radius: 6px;
                                                        text-align: center;
                                                        font-weight: 600;
                                                    "
                                                >
                                            </td>
                                            <td style="padding: 12px 10px;">
                                                <input
                                                    type="number"
                                                    name="quantidade_referencia[{{ $item->id }}]"
                                                    class="form-control form-control-sm"
                                                    value="1"
                                                    min="0.01"
                                                    step="0.01"
                                                    style="
                                                        font-size: 11px;
                                                        border: 1px solid #e5e7eb;
                                                        border-radius: 6px;
                                                        text-align: center;
                                                        font-weight: 600;
                                                    "
                                                >
                                            </td>
                                            <td style="padding: 12px 10px;">
                                                <div style="position: relative;">
                                                    <span style="
                                                        position: absolute;
                                                        left: 12px;
                                                        top: 50%;
                                                        transform: translateY(-50%);
                                                        color: #10b981;
                                                        font-weight: 700;
                                                        font-size: 12px;
                                                    ">R$</span>
                                                    <input
                                                        type="number"
                                                        name="preco_unitario[{{ $item->id }}]"
                                                        class="form-control form-control-sm csn-preco-input"
                                                        data-item-id="{{ $item->id }}"
                                                        placeholder="0,00"
                                                        min="0"
                                                        step="0.01"
                                                        style="
                                                            font-size: 12px;
                                                            border: 2px solid #e5e7eb;
                                                            border-radius: 8px;
                                                            text-align: right;
                                                            font-weight: 700;
                                                            padding-left: 35px;
                                                            padding-right: 12px;
                                                            color: #10b981;
                                                        "
                                                        onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'"
                                                        onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                                                    >
                                                </div>
                                            </td>
                                            <td style="padding: 12px 10px;">
                                                <select
                                                    name="nivel_confianca[{{ $item->id }}]"
                                                    class="form-control form-control-sm"
                                                    style="
                                                        font-size: 11px;
                                                        border: 1px solid #e5e7eb;
                                                        border-radius: 6px;
                                                        font-weight: 600;
                                                    "
                                                >
                                                    <option value="Unit√°rio">Unit√°rio</option>
                                                    <option value="Estimado">Estimado</option>
                                                    <option value="Global">Global</option>
                                                </select>
                                            </td>
                                        </tr>
                                        @endforeach
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Estat√≠sticas -->
                        <div style="
                            display: flex;
                            gap: 16px;
                            margin-top: 20px;
                        ">
                            <div style="
                                flex: 1;
                                background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
                                padding: 16px;
                                border-radius: 12px;
                                border-left: 4px solid #3b82f6;
                            ">
                                <div style="font-size: 11px; color: #1e40af; font-weight: 700; text-transform: uppercase; margin-bottom: 4px;">Total de Itens</div>
                                <div style="font-size: 28px; font-weight: 800; color: #1e40af;">{{ $orcamento->itens->count() }}</div>
                            </div>
                            <div style="
                                flex: 1;
                                background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                                padding: 16px;
                                border-radius: 12px;
                                border-left: 4px solid #10b981;
                            ">
                                <div style="font-size: 11px; color: #065f46; font-weight: 700; text-transform: uppercase; margin-bottom: 4px;">Itens Selecionados</div>
                                <div id="csn-count-selecionados" style="font-size: 28px; font-weight: 800; color: #065f46;">0</div>
                            </div>
                        </div>

                    </div>


                    <!-- ============================================================ -->
                    <!-- ETAPA 3: ANEXAR PDF -->
                    <!-- ============================================================ -->
                    <div class="csn-wizard-content" id="csn-step-3" style="display: none;">
                        
                        <!-- T√≠tulo da Etapa -->
                        <div style="
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                            padding: 16px 20px;
                            border-radius: 12px;
                            margin-bottom: 25px;
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
                        ">
                            <h6 style="
                                font-size: 15px;
                                font-weight: 800;
                                color: white;
                                margin: 0;
                                display: flex;
                                align-items: center;
                                gap: 12px;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            ">
                                <span style="
                                    background: rgba(255,255,255,0.3);
                                    padding: 6px 12px;
                                    border-radius: 8px;
                                    font-size: 14px;
                                ">3</span>
                                <i class="fas fa-file-pdf"></i>
                                Anexar PDF da ARP
                            </h6>
                            <p style="
                                margin: 8px 0 0 0;
                                font-size: 12px;
                                opacity: 0.95;
                                font-weight: 500;
                            ">
                                Para concluir, anexe o documento PDF que comprova a contrata√ß√£o similar
                            </p>
                        </div>

                        <!-- √Årea de Upload -->
                        <div class="mb-4">
                            <label class="form-label" style="
                                font-weight: 700;
                                color: #1f2937;
                                font-size: 13px;
                                margin-bottom: 12px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-cloud-upload-alt" style="color: #3b82f6;"></i>
                                Selecione o arquivo PDF <span style="color: #ef4444;">*</span>
                            </label>
                            
                            <div id="csn-upload-area" style="
                                border: 3px dashed #d1d5db;
                                border-radius: 16px;
                                padding: 50px 30px;
                                text-align: center;
                                background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
                                cursor: pointer;
                                transition: all 0.3s ease;
                                position: relative;
                                overflow: hidden;
                            " onclick="document.getElementById('csn-arquivo-pdf').click()" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)'" onmouseout="this.style.borderColor='#d1d5db'; this.style.background='linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%)'">
                                
                                <!-- √çcone animado -->
                                <div style="
                                    width: 80px;
                                    height: 80px;
                                    margin: 0 auto 20px;
                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
                                ">
                                    <i class="fas fa-file-pdf" style="
                                        font-size: 40px;
                                        color: white;
                                    "></i>
                                </div>

                                <input
                                    type="file"
                                    id="csn-arquivo-pdf"
                                    name="arquivo_pdf"
                                    accept=".pdf"
                                    style="display: none;"
                                >
                                
                                <h6 style="
                                    font-size: 16px;
                                    font-weight: 800;
                                    color: #1f2937;
                                    margin-bottom: 8px;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                ">
                                    Clique para selecionar o arquivo
                                </h6>
                                
                                <p style="
                                    font-size: 13px;
                                    color: #6b7280;
                                    margin: 0 0 20px 0;
                                    font-weight: 500;
                                ">
                                    ou arraste e solte o arquivo aqui
                                </p>

                                <div style="
                                    display: inline-block;
                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                    color: white;
                                    padding: 12px 28px;
                                    border-radius: 10px;
                                    font-weight: 700;
                                    font-size: 13px;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'">
                                    <i class="fas fa-folder-open"></i> SELECIONAR ARQUIVO
                                </div>
                                
                                <div id="csn-nome-arquivo" style="
                                    margin-top: 20px;
                                    font-size: 13px;
                                    font-weight: 700;
                                    color: #059669;
                                    display: none;
                                "></div>
                            </div>
                        </div>

                        <!-- Informa√ß√µes do Arquivo -->
                        <div id="csn-file-info" style="display: none; margin-top: 20px;">
                            <div style="
                                background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                                border: 2px solid #10b981;
                                border-radius: 12px;
                                padding: 20px;
                            ">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div style="
                                        width: 60px;
                                        height: 60px;
                                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                                    ">
                                        <i class="fas fa-check-circle" style="font-size: 30px; color: white;"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h6 style="
                                            font-size: 14px;
                                            font-weight: 800;
                                            color: #065f46;
                                            margin: 0 0 6px 0;
                                            text-transform: uppercase;
                                            letter-spacing: 0.5px;
                                        ">Arquivo Selecionado</h6>
                                        <div id="csn-file-name" style="
                                            font-size: 13px;
                                            color: #047857;
                                            font-weight: 600;
                                        "></div>
                                        <div id="csn-file-size" style="
                                            font-size: 11px;
                                            color: #059669;
                                            margin-top: 4px;
                                        "></div>
                                    </div>
                                    <button type="button" onclick="csnRemoverArquivo()" style="
                                        background: #ef4444;
                                        color: white;
                                        border: none;
                                        padding: 10px 16px;
                                        border-radius: 8px;
                                        font-weight: 700;
                                        font-size: 11px;
                                        cursor: pointer;
                                        text-transform: uppercase;
                                        transition: all 0.3s ease;
                                    " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                                        <i class="fas fa-trash"></i> Remover
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Orienta√ß√µes -->
                        <div style="
                            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
                            border: 2px solid #fbbf24;
                            border-radius: 12px;
                            padding: 20px;
                            margin-top: 25px;
                        ">
                            <h6 style="
                                font-size: 13px;
                                font-weight: 800;
                                color: #92400e;
                                margin-bottom: 12px;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            ">
                                <i class="fas fa-info-circle" style="font-size: 18px;"></i>
                                Orienta√ß√µes para Upload
                            </h6>
                            <ul style="
                                margin: 0;
                                padding-left: 24px;
                                font-size: 12px;
                                color: #78350f;
                                line-height: 1.9;
                                font-weight: 600;
                            ">
                                <li><strong>Tamanho m√°ximo:</strong> 2 MB</li>
                                <li><strong>Formato:</strong> Apenas arquivos PDF (*.pdf)</li>
                                <li><strong>Orienta√ß√£o:</strong> Todas as p√°ginas em formato RETRATO</li>
                                <li><strong>Conte√∫do:</strong> Deve conter dados claros da contrata√ß√£o</li>
                            </ul>
                        </div>

                    </div>

                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- FOOTER COM BOT√ïES DE NAVEGA√á√ÉO -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="modal-footer" style="
                    background: linear-gradient(to top, #f8fafc 0%, #ffffff 100%);
                    padding: 20px 30px;
                    border-top: 2px solid #e5e7eb;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <div>
                        <!-- Bot√£o Anterior -->
                        <button type="button" id="csn-btn-anterior" class="btn" style="
                            display: none;
                            background: white;
                            border: 2px solid #e5e7eb;
                            color: #374151;
                            font-size: 13px;
                            font-weight: 700;
                            padding: 12px 24px;
                            border-radius: 10px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.borderColor='#3b82f6'; this.style.color='#3b82f6'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.color='#374151'">
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <!-- Bot√£o Cancelar -->
                        <button type="button" class="btn" data-bs-dismiss="modal" style="
                            background: white;
                            border: 2px solid #e5e7eb;
                            color: #6b7280;
                            font-size: 13px;
                            font-weight: 700;
                            padding: 12px 24px;
                            border-radius: 10px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.borderColor='#ef4444'; this.style.color='#ef4444'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.color='#6b7280'">
                            <i class="fas fa-times"></i> Cancelar
                        </button>

                        <!-- Bot√£o Pr√≥xima -->
                        <button type="button" id="csn-btn-proxima" class="btn" style="
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                            border: none;
                            color: white;
                            font-size: 13px;
                            font-weight: 800;
                            padding: 12px 32px;
                            border-radius: 10px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'">
                            Pr√≥xima <i class="fas fa-arrow-right"></i>
                        </button>

                        <!-- Bot√£o Concluir -->
                        <button type="submit" id="csn-btn-concluir" class="btn" style="
                            display: none;
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            border: none;
                            color: white;
                            font-size: 13px;
                            font-weight: 800;
                            padding: 12px 32px;
                            border-radius: 10px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                            <i class="fas fa-check-circle"></i> Concluir
                        </button>
                    </div>
                </div>

            </form>

        </div>
    </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- JAVASCRIPT COMPLETO E FUNCIONAL - SEM ERROS -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
(function() {
    'use strict';
    
    console.log('üéØ [MODAL CSN v2.0] Inicializando...');

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VARI√ÅVEIS GLOBAIS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentStep = 1;
    const totalSteps = 3;
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUN√á√ÉO: Abrir Modal
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.csnAbrirModal = function() {
        console.log('üöÄ [MODAL CSN] Abrindo modal...');
        
        // Resetar para etapa 1
        currentStep = 1;
        csnMostrarEtapa(1);
        
        // Resetar formul√°rio
        document.getElementById('formContratacoesSimilaresNovo').reset();
        
        // Resetar sele√ß√£o de registro de pre√ßos
        document.getElementById('csn-btn-registro-sim').classList.remove('selected');
        document.getElementById('csn-btn-registro-nao').classList.remove('selected');
        document.getElementById('csn-btn-registro-sim').style.borderColor = '#e5e7eb';
        document.getElementById('csn-btn-registro-sim').style.background = 'white';
        document.getElementById('csn-btn-registro-nao').style.borderColor = '#e5e7eb';
        document.getElementById('csn-btn-registro-nao').style.background = 'white';
        document.getElementById('csn-eh-registro-precos').value = '';
        
        // Resetar arquivo
        csnRemoverArquivo();
        
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById('modalContratacoesSimilaresNovo'));
        modal.show();
        
        console.log('‚úÖ [MODAL CSN] Modal aberto!');
    };
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUN√á√ÉO: Selecionar Registro de Pre√ßos (Sim/N√£o)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.csnSelecionarRegistroPreco = function(opcao) {
        console.log('üìù [MODAL CSN] Registro de pre√ßos selecionado:', opcao);
        
        const btnSim = document.getElementById('csn-btn-registro-sim');
        const btnNao = document.getElementById('csn-btn-registro-nao');
        const input = document.getElementById('csn-eh-registro-precos');
        
        // Resetar todos
        btnSim.classList.remove('selected');
        btnNao.classList.remove('selected');
        btnSim.style.borderColor = '#e5e7eb';
        btnSim.style.background = 'white';
        btnNao.style.borderColor = '#e5e7eb';
        btnNao.style.background = 'white';
        
        // Marcar selecionado
        if (opcao === 'sim') {
            btnSim.classList.add('selected');
            btnSim.style.borderColor = '#3b82f6';
            btnSim.style.background = 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)';
            btnSim.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.2)';
            input.value = '1';
        } else {
            btnNao.classList.add('selected');
            btnNao.style.borderColor = '#3b82f6';
            btnNao.style.background = 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)';
            btnNao.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.2)';
            input.value = '0';
        }
        
        console.log('‚úÖ [MODAL CSN] Valor salvo:', input.value);
    };
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUN√á√ÉO: Mostrar Etapa
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function csnMostrarEtapa(step) {
        console.log(`üìç [MODAL CSN] Navegando para etapa ${step}`);
        
        // Esconder todas as etapas
        document.getElementById('csn-step-1').style.display = 'none';
        document.getElementById('csn-step-2').style.display = 'none';
        document.getElementById('csn-step-3').style.display = 'none';
        
        // Mostrar etapa atual
        document.getElementById('csn-step-' + step).style.display = 'block';
        
        // Atualizar stepper visual
        csnAtualizarStepper(step);
        
        // Atualizar bot√µes
        if (step === 1) {
            document.getElementById('csn-btn-anterior').style.display = 'none';
            document.getElementById('csn-btn-proxima').style.display = 'inline-block';
            document.getElementById('csn-btn-concluir').style.display = 'none';
        } else if (step === 2) {
            document.getElementById('csn-btn-anterior').style.display = 'inline-block';
            document.getElementById('csn-btn-proxima').style.display = 'inline-block';
            document.getElementById('csn-btn-concluir').style.display = 'none';
        } else if (step === 3) {
            document.getElementById('csn-btn-anterior').style.display = 'inline-block';
            document.getElementById('csn-btn-proxima').style.display = 'none';
            document.getElementById('csn-btn-concluir').style.display = 'inline-block';
        }
        
        currentStep = step;
        console.log('‚úÖ [MODAL CSN] Etapa exibida:', step);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUN√á√ÉO: Atualizar Stepper Visual
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function csnAtualizarStepper(step) {
        const steps = document.querySelectorAll('.csn-wizard-step');
        const progressLine = document.getElementById('csn-progress-line');
        
        steps.forEach((stepEl, index) => {
            const circle = stepEl.querySelector('.csn-step-circle');
            const label = stepEl.querySelector('.csn-step-label');
            const stepNumber = index + 1;
            
            if (stepNumber < step) {
                // Etapa completada
                circle.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                circle.style.color = 'white';
                circle.style.border = 'none';
                circle.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
                label.style.color = '#10b981';
            } else if (stepNumber === step) {
                // Etapa atual
                circle.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                circle.style.color = 'white';
                circle.style.border = 'none';
                circle.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
                label.style.color = '#3b82f6';
            } else {
                // Etapa futura
                circle.style.background = '#e5e7eb';
                circle.style.color = '#9ca3af';
                circle.style.border = '3px solid #f3f4f6';
                circle.style.boxShadow = 'none';
                label.style.color = '#9ca3af';
            }
        });
        
        // Atualizar linha de progresso
        const progress = ((step - 1) / (totalSteps - 1)) * 100;
        progressLine.style.width = progress + '%';
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUN√á√ÉO: Validar Etapa 1
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function csnValidarEtapa1() {
        console.log('üîç [MODAL CSN] Validando etapa 1...');
        
        const form = document.getElementById('formContratacoesSimilaresNovo');
        const step1 = document.getElementById('csn-step-1');
        const camposObrigatorios = step1.querySelectorAll('[required]');
        const registroPrecos = document.getElementById('csn-eh-registro-precos').value;
        
        let erros = [];
        
        // Validar campos obrigat√≥rios
        camposObrigatorios.forEach(campo => {
            if (!campo.value || campo.value.trim() === '') {
                erros.push(campo.name || 'campo desconhecido');
                campo.style.borderColor = '#ef4444';
                campo.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
            } else {
                campo.style.borderColor = '#e5e7eb';
                campo.style.boxShadow = 'none';
            }
        });
        
        // Validar registro de pre√ßos
        if (!registroPrecos) {
            erros.push('Registro de Pre√ßos n√£o selecionado');
            alert('‚ö†Ô∏è Por favor, selecione se h√° Registro de Pre√ßos (Sim ou N√£o)');
        }
        
        if (erros.length > 0) {
            console.log('‚ùå [MODAL CSN] Erros na valida√ß√£o:', erros);
            alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios da Etapa 1');
            return false;
        }
        
        console.log('‚úÖ [MODAL CSN] Etapa 1 validada com sucesso!');
        return true;
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EVENTO: Bot√£o Pr√≥xima
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.getElementById('csn-btn-proxima').addEventListener('click', function() {
        console.log('‚û°Ô∏è [MODAL CSN] Bot√£o Pr√≥xima clicado. Etapa atual:', currentStep);
        
        if (currentStep === 1) {
            // Validar etapa 1 antes de avan√ßar
            if (csnValidarEtapa1()) {
                csnMostrarEtapa(2);
            }
        } else if (currentStep === 2) {
            // Avan√ßar para etapa 3 (sem valida√ß√£o r√≠gida na etapa 2)
            csnMostrarEtapa(3);
        }
    });
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EVENTO: Bot√£o Anterior
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.getElementById('csn-btn-anterior').addEventListener('click', function() {
        console.log('‚¨ÖÔ∏è [MODAL CSN] Bot√£o Anterior clicado. Etapa atual:', currentStep);
        
        if (currentStep > 1) {
            csnMostrarEtapa(currentStep - 1);
        }
    });
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONTADOR DE ITENS SELECIONADOS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function csnAtualizarContador() {
        const checkboxes = document.querySelectorAll('.csn-item-check:checked');
        const counter = document.getElementById('csn-count-selecionados');
        if (counter) {
            counter.textContent = checkboxes.length;
        }
    }
    
    // Selecionar todos
    const selectAllCheckbox = document.getElementById('csn-selecionar-todos');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const itemCheckboxes = document.querySelectorAll('.csn-item-check');
            itemCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            csnAtualizarContador();
        });
    }
    
    // Atualizar contador ao marcar/desmarcar itens
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('csn-item-check')) {
            csnAtualizarContador();
        }
    });

    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UPLOAD DE ARQUIVO PDF
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const fileInput = document.getElementById('csn-arquivo-pdf');
    const uploadArea = document.getElementById('csn-upload-area');
    
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const arquivo = this.files[0];
            
            if (!arquivo) {
                console.log('‚ùå [MODAL CSN] Nenhum arquivo selecionado');
                return;
            }
            
            console.log('üìÑ [MODAL CSN] Arquivo selecionado:', arquivo.name);
            
            // Validar tamanho (m√°x 2MB)
            const maxSize = 2 * 1024 * 1024; // 2MB
            if (arquivo.size > maxSize) {
                alert('‚ö†Ô∏è Arquivo muito grande! Tamanho m√°ximo permitido: 2MB');
                this.value = '';
                console.log('‚ùå [MODAL CSN] Arquivo rejeitado: tamanho excedido');
                return;
            }
            
            // Validar tipo
            if (arquivo.type !== 'application/pdf') {
                alert('‚ö†Ô∏è Formato inv√°lido! Apenas arquivos PDF s√£o aceitos.');
                this.value = '';
                console.log('‚ùå [MODAL CSN] Arquivo rejeitado: n√£o √© PDF');
                return;
            }
            
            // Mostrar informa√ß√µes do arquivo
            const tamanhoMB = (arquivo.size / (1024 * 1024)).toFixed(2);
            document.getElementById('csn-file-name').textContent = arquivo.name;
            document.getElementById('csn-file-size').textContent = `Tamanho: ${tamanhoMB} MB`;
            document.getElementById('csn-file-info').style.display = 'block';
            
            console.log('‚úÖ [MODAL CSN] Arquivo validado com sucesso!');
        });
    }
    
    // Remover arquivo
    window.csnRemoverArquivo = function() {
        const fileInput = document.getElementById('csn-arquivo-pdf');
        if (fileInput) {
            fileInput.value = '';
        }
        const fileInfo = document.getElementById('csn-file-info');
        if (fileInfo) {
            fileInfo.style.display = 'none';
        }
        console.log('üóëÔ∏è [MODAL CSN] Arquivo removido');
    };
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EVENTO: Envio do Formul√°rio
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const form = document.getElementById('formContratacoesSimilaresNovo');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('üì§ [MODAL CSN] Enviando formul√°rio...');
            
            // Validar se h√° arquivo
            const arquivo = document.getElementById('csn-arquivo-pdf').files[0];
            if (!arquivo) {
                alert('‚ö†Ô∏è Por favor, anexe o arquivo PDF da ARP antes de concluir');
                console.log('‚ùå [MODAL CSN] Erro: arquivo PDF n√£o anexado');
                return;
            }
            
            // Validar se h√° itens selecionados
            const itensSelecionados = document.querySelectorAll('.csn-item-check:checked');
            if (itensSelecionados.length === 0) {
                alert('‚ö†Ô∏è Selecione ao menos um item na Etapa 2');
                console.log('‚ùå [MODAL CSN] Erro: nenhum item selecionado');
                csnMostrarEtapa(2);
                return;
            }
            
            // Preparar FormData
            const formData = new FormData(this);
            
            // Adicionar itens selecionados
            console.log(`üì¶ [MODAL CSN] ${itensSelecionados.length} itens selecionados`);
            
            // Mostrar loading
            const btnConcluir = document.getElementById('csn-btn-concluir');
            const textoOriginal = btnConcluir.innerHTML;
            btnConcluir.disabled = true;
            btnConcluir.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
            
            // Enviar para o backend
            const orcamentoId = window.ORCAMENTO_ID || document.querySelector('input[name="orcamento_id"]').value;
            const url = window.APP_BASE_PATH + '/orcamentos/' + orcamentoId + '/contratacoes-similares';
            
            console.log('üåê [MODAL CSN] Enviando para:', url);
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                },
                body: formData
            })
            .then(response => {
                console.log('üì® [MODAL CSN] Resposta recebida:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ [MODAL CSN] Resposta do servidor:', data);
                
                if (data.success || data.message) {
                    // Sucesso!
                    alert('‚úÖ Contrata√ß√£o similar salva com sucesso!');
                    
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalContratacoesSimilaresNovo'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Recarregar p√°gina para mostrar dados atualizados
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    throw new Error(data.error || 'Erro ao salvar contrata√ß√£o similar');
                }
            })
            .catch(error => {
                console.error('‚ùå [MODAL CSN] Erro:', error);
                alert('‚ùå Erro ao salvar: ' + error.message);
                
                // Restaurar bot√£o
                btnConcluir.disabled = false;
                btnConcluir.innerHTML = textoOriginal;
            });
        });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONECTAR BOT√ÉO PRINCIPAL AO MODAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'btn-contratacoes-similares-novo') {
            e.preventDefault();
            console.log('üéØ [MODAL CSN] Bot√£o principal clicado!');
            csnAbrirModal();
        }
    });
    
    console.log('‚úÖ [MODAL CSN v2.0] Inicializado com sucesso!');
    
})();
</script>

<script>
// ===============================================================================
// SCRIPT PRINCIPAL: Auto-save e funcionalidades gerais da elabora√ß√£o
// ===============================================================================
window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
    // ========================================
    // GAP #3: AUTO-SAVE METODOLOGIAS (Se√ß√£o 2)
    // ========================================
    const radioMetodologias = document.querySelectorAll(
        'input[name="metodo_juizo_critico"], input[name="metodo_obtencao_preco"], input[name="casas_decimais"]'
    );

    radioMetodologias.forEach(radio => {
        radio.addEventListener('change', function() {
            const metodoJuizoCritico = document.querySelector('input[name="metodo_juizo_critico"]:checked')?.value;
            const metodoObtencaoPreco = document.querySelector('input[name="metodo_obtencao_preco"]:checked')?.value;
            const casasDecimais = document.querySelector('input[name="casas_decimais"]:checked')?.value;

            if (!metodoJuizoCritico || !metodoObtencaoPreco || !casasDecimais) return;

            fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/metodologias', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    metodo_juizo_critico: metodoJuizoCritico,
                    metodo_obtencao_preco: metodoObtencaoPreco,
                    casas_decimais: casasDecimais
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('[LOG] Metodologias salvas automaticamente');
                } else {
                    console.error('Erro ao salvar metodologias:', data.message);
                }
            })
            .catch(error => {
                console.error('Erro na requisi√ßo:', error);
            });
        });
    });

    // ========================================
    // GAP #2: EXCLUIR ITEM
    // ========================================
    document.querySelectorAll('.btn-excluir-item').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');

            if (!confirm('Tem certeza que deseja excluir este item?')) {
                return;
            }

            // Mostrar loading no botao
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            this.disabled = true;

            fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + itemId, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Recarregar para atualizar a lista
                } else {
                    alert('Erro: ' + window.escapeAlert(data.message));
                    this.innerHTML = originalHTML;
                    this.disabled = false;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao excluir item. Tente novamente.');
                this.innerHTML = originalHTML;
                this.disabled = false;
            });
        });
    });
}, 'elaborarPrincipalInit'); // FIM DOMContentLoaded - ELABORAR PRINCIPAL

console.log('[ELABORAR] Script principal carregado!');
</script>

<!-- ================================================================== -->
<!-- C√ìDIGO FUNCIONAL: MODAL EDITAR ITEM -->
<!-- ================================================================== -->
<script>
    let modalEditarItem = null;
    let currentEditItemId = null;

    // Criar modal de edi√ßo dinamicamente
    function criarModalEditarItem() {
        if (document.getElementById('modalEditarItem')) return;

        const modalHTML = `
        <div class="modal fade" id="modalEditarItem" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content" style="border-radius: 8px; border: none;">
                    <div class="modal-header" style="background: #0891b2; color: white; border-radius: 8px 8px 0 0;">
                        <h5 class="modal-title" style="font-weight: 700; font-size: 15px;">ALTERAR ITEM DO OR√áAMENTO</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="padding: 25px;">
                        <form id="formEditarItem">
                            <div class="mb-3">
                                <label class="form-label" style="font-weight: 600; font-size: 13px;">Descri√ßo*</label>
                                <textarea id="edit-descricao" class="form-control" rows="3" required style="font-size: 13px;"></textarea>
                                <small style="color: #6b7280; font-size: 11px;">Reproduza a descri√ßo constante do termo de referncia ou do projeto bsico.</small>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" style="font-weight: 600; font-size: 13px;">Medida de fornecimento*</label>
                                    <select id="edit-medida" class="form-select" required style="font-size: 13px;">
                                        <option value="">Selecione...</option>
                                        <option value="UNIDADE">Unidade</option>
                                        <option value="CAIXA">Caixa</option>
                                        <option value="METRO">Metro</option>
                                        <option value="LITRO">Litro</option>
                                        <option value="KG">Quilograma</option>
                                        <option value="PACOTE">Pacote</option>
                                        <option value="RESMA">Resma</option>
                                        <option value="M√äS">Ms</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" style="font-weight: 600; font-size: 13px;">Quantidade*</label>
                                    <input type="number" id="edit-quantidade" class="form-control" step="0.0001" min="0.0001" required style="font-size: 13px;">
                                    <div style="margin-top: 8px;">
                                        <label style="font-size: 12px; margin-right: 15px;">
                                            <input type="radio" name="edit-tipo-quantidade" value="inteiro" checked> N¬∞ INTEIRO
                                        </label>
                                        <label style="font-size: 12px;">
                                            <input type="radio" name="edit-tipo-quantidade" value="fracionado"> FRACIONADO
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" style="font-weight: 600; font-size: 13px;">Indica√ßo de marca:</label>
                                <div>
                                    <label style="font-size: 12px; margin-right: 15px;">
                                        <input type="radio" name="edit-tipo-marca" value="referencia" checked> DE REFER√äNCIA
                                    </label>
                                    <label style="font-size: 12px;">
                                        <input type="radio" name="edit-tipo-marca" value="vinculativa"> VINCULATIVA
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" style="font-weight: 600; font-size: 13px;">Este item √© um:*</label>
                                <div>
                                    <label style="font-size: 12px; margin-right: 15px;">
                                        <input type="radio" name="edit-tipo" value="produto" required> PRODUTO
                                    </label>
                                    <label style="font-size: 12px;">
                                        <input type="radio" name="edit-tipo" value="servico" required> SERVI√áO
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" style="font-weight: 600; font-size: 13px;">Alterar os dados do item em CDFs, Entes P√∫blicos e Sites de com√©rcio eletrnico?</label>
                                <div>
                                    <label style="font-size: 12px; margin-right: 15px;">
                                        <input type="radio" name="edit-alterar-cdf" value="1" required> SIM
                                    </label>
                                    <label style="font-size: 12px;">
                                        <input type="radio" name="edit-alterar-cdf" value="0" required checked> N√ÉO
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 15px 25px;">
                        <button type="button" id="btnSalvarEdicao" class="btn btn-primary" style="font-size: 13px; background: #0891b2; border: none; padding: 8px 24px;">
                            <i class="fas fa-save"></i> SALVAR
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 13px; padding: 8px 24px;">
                            <i class="fas fa-times"></i> FECHAR
                        </button>
                    </div>
                </div>
            </div>
        </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modalEditarItem = new bootstrap.Modal(document.getElementById('modalEditarItem'));
    }

    // Abrir modal ao clicar em editar
    document.querySelectorAll('.btn-editar-item').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            currentEditItemId = itemId;

            // Criar modal se no existir
            criarModalEditarItem();

            // Buscar dados do item
            fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID, {
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                const item = data.itens.find(i => i.id == itemId);
                if (!item) {
                    alert('Item no encontrado');
                    return;
                }

                // Preencher formul√°rio (com prote√ß√£o contra null)
                const editDesc = document.getElementById('edit-descricao');
                if (editDesc) editDesc.value = item.descricao || '';

                const editMed = document.getElementById('edit-medida');
                if (editMed) editMed.value = item.medida_fornecimento || '';

                const editQtd = document.getElementById('edit-quantidade');
                if (editQtd) editQtd.value = item.quantidade || '';

                // Tipo de quantidade (inteiro/fracionado) - com prote√ß√£o
                const tipoQuantidade = item.tipo_quantidade || 'inteiro';
                const radioTipoQtd = document.querySelector(`input[name="edit-tipo-quantidade"][value="${tipoQuantidade}"]`);
                if (radioTipoQtd) radioTipoQtd.checked = true;

                // Tipo de marca (referencia/vinculativa) - com prote√ß√£o
                const tipoMarca = item.tipo_marca || 'referencia';
                const radioTipoMarca = document.querySelector(`input[name="edit-tipo-marca"][value="${tipoMarca}"]`);
                if (radioTipoMarca) radioTipoMarca.checked = true;

                // Tipo (produto/servi√ßo) - com prote√ß√£o
                const radioTipo = document.querySelector(`input[name="edit-tipo"][value="${item.tipo}"]`);
                if (radioTipo) radioTipo.checked = true;

                // Alterar CDF - com prote√ß√£o
                const radioAlterarCDF = document.querySelector(`input[name="edit-alterar-cdf"][value="${item.alterar_cdf ? '1' : '0'}"]`);
                if (radioAlterarCDF) radioAlterarCDF.checked = true;

                // Mostrar modal
                modalEditarItem.show();
            })
            .catch(error => {
                console.error('Erro ao buscar item:', error);
                alert('Erro ao carregar dados do item');
            });
        });
    });

    // Salvar edi√ßo
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'btnSalvarEdicao') {
            const form = document.getElementById('formEditarItem');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const btnSalvar = e.target;
            const originalHTML = btnSalvar.innerHTML;
            btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
            btnSalvar.disabled = true;

            // Coletar dados do formul√°rio (compat√≠vel com ambos os modais)
            const descricao = document.getElementById('edit-descricao')?.value;
            const medidaFornecimento = document.getElementById('edit-medida-fornecimento')?.value || document.getElementById('edit-medida')?.value;
            const quantidade = parseFloat(document.getElementById('edit-quantidade')?.value);
            const indicacaoMarca = document.getElementById('edit-indicacao-marca')?.value || '';

            // Validar campos obrigat√≥rios
            if (!descricao || !medidaFornecimento || !quantidade) {
                alert('Por favor, preencha todos os campos obrigat√≥rios (Descri√ß√£o, Unidade, Quantidade).');
                btnSalvar.innerHTML = originalHTML;
                btnSalvar.disabled = false;
                return;
            }

            const data = {
                descricao: descricao,
                medida_fornecimento: medidaFornecimento,
                quantidade: quantidade,
                indicacao_marca: indicacaoMarca,
                tipo_quantidade: 'inteiro', // Padr√£o
                tipo_marca: 'referencia', // Padr√£o
                tipo: 'produto', // Padr√£o
                alterar_cdf: false // Padr√£o
            };

            console.log('[ALTERAR-ITEM] Dados a enviar:', data);

            fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + currentEditItemId, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('[ALTERAR-ITEM] Status da resposta:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('[ALTERAR-ITEM] Resposta recebida:', data);

                if (data.success) {
                    console.log('[ALTERAR-ITEM] Item salvo com sucesso!');
                    alert('Item alterado com sucesso!');
                    modalEditarItem.hide();
                    location.reload(); // Recarregar para atualizar a lista
                } else {
                    console.error('[ALTERAR-ITEM] Erro ao salvar:', data);
                    alert('Erro: ' + (data.message || 'Erro desconhecido'));
                    btnSalvar.innerHTML = originalHTML;
                    btnSalvar.disabled = false;
                }
            })
            .catch(error => {
                console.error('[ALTERAR-ITEM] Erro na requisi√ß√£o:', error);
                alert('Erro ao salvar. Verifique o console para mais detalhes.');
                btnSalvar.innerHTML = originalHTML;
                btnSalvar.disabled = false;
            });
        }
    });
</script>

<!-- ================================================================== -->
<!-- C√ìDIGO FUNCIONAL DESCOMENTADO - EVENT LISTENERS -->
<!-- ================================================================== -->

<script>
// ========================================
// FUNCIONALIDADE: BOT√ÉO ADICIONAR FORNECEDOR
// ========================================
//  CORRIGIDO: Convertido de jQuery para Vanilla JS
//  PROTE√á√ÉO: Listener √∫nico (DESABILITADO - c√≥digo movido)
window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
    console.log('[FORNECEDOR] Inicializando event listener...');
    console.log('[FORNECEDOR]  DESABILITADO - Event listener movido para linha 10030+ (modal Receita Federal)');

    //  C√ìDIGO DESABILITADO - Estava abrindo modal PNCP incorreto
    //  C√ìDIGO CORRETO est√° na linha 10030+ (abre modal Receita Federal)

    /*
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.btn-fornecedor-item');

        if (btn) {
            e.preventDefault();
            e.stopPropagation();

            const itemId = btn.getAttribute('data-item-id');
            const itemDescricao = btn.getAttribute('data-item-descricao');

            console.log('[FORNECEDOR] ===== BOT√ÉO CLICADO =====');
            console.log('[FORNECEDOR] Item ID:', itemId);
            console.log('[FORNECEDOR] Item Descri√ß√£o:', itemDescricao);

            // Tentar abrir o modal
            const modalEl = document.getElementById('modalBuscaFornecedorPNCP');

            if (modalEl) {
                console.log('[FORNECEDOR]  Modal encontrado! Abrindo...');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            } else {
                console.error('[FORNECEDOR]  Modal "modalBuscaFornecedorPNCP" n√£o encontrado no DOM!');
                alert('Erro: Modal de busca de fornecedor n√£o foi encontrado. Verifique o console para mais detalhes.');
            }
        }
    });
    */

    console.log('[FORNECEDOR] Event listener configurado (agora na linha 10030+)');
}, 'fornecedorDisabledInit');

// ========================================
// FUNCIONALIDADE: SELECT ALL CHECKBOXES
// ========================================
//  PROTE√á√ÉO: Listener √∫nico para select all
window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
(function() {
    const checkboxSelectAll = document.getElementById('checkbox-select-all');
    const checkboxesItems = document.querySelectorAll('.checkbox-item');

    if (!checkboxSelectAll || checkboxesItems.length === 0) return;

    // Evento no checkbox "selecionar todos"
    checkboxSelectAll.addEventListener('change', function() {
        const isChecked = this.checked;
        checkboxesItems.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    });

    // Evento nos checkboxes individuais (para desmarcar o "selecionar todos" se algum for desmarcado)
    checkboxesItems.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Se algum checkbox no estiver marcado, desmarcar o "selecionar todos"
            const allChecked = Array.from(checkboxesItems).every(cb => cb.checked);
            checkboxSelectAll.checked = allChecked;
        });
    });
})();
}, 'selectAllCheckboxInit'); //  FIM DOMContentLoaded - SELECT ALL CHECKBOXES

// ========================================
// FUNCIONALIDADE: DROPDOWN ENGRENAGEM (Duplicar, Renumerar, Apagar)
// ========================================
//  PROTE√á√ÉO: Listener √∫nico para dropdown engrenagem
window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
(function() {
    console.log('[DEBUG] Inicializando Dropdown Engrenagem...');
    const botaoesEngrenagem = document.querySelectorAll('.btn-outras-opcoes');
    console.log('[DEBUG] Bot√µes .btn-outras-opcoes encontrados:', botaoesEngrenagem.length);
    let dropdownAtual = null;

    // Criar dropdown para cada botao engrenagem
    botaoesEngrenagem.forEach(btn => {
        const itemId = btn.getAttribute('data-item-id');
        const container = btn.parentElement;

        // Criar menu dropdown
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-engrenagem';
        dropdown.style.cssText = `
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            z-index: 1000;
            display: none;
        `;

        dropdown.innerHTML = `
            <div style="padding: 4px 0;">
                <button type="button" class="dropdown-item-duplicar" data-item-id="${itemId}" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: white; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-copy" style="color: #3b82f6; width: 16px;"></i>
                    <span>Duplicar Item</span>
                </button>
                <button type="button" class="dropdown-item-renumerar" data-item-id="${itemId}" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: white; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-sort-numeric-down" style="color: #10b981; width: 16px;"></i>
                    <span>Renumerar</span>
                </button>
                <button type="button" class="dropdown-item-apagar" data-item-id="${itemId}" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: white; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #f3f4f6;">
                    <i class="fas fa-trash" style="color: #dc2626; width: 16px;"></i>
                    <span style="color: #dc2626;">Apagar</span>
                </button>
            </div>
        `;

        // Adicionar hover effect
        const items = dropdown.querySelectorAll('button[class^="dropdown-item"]');
        items.forEach(item => {
            item.addEventListener('mouseenter', function() {
                this.style.background = '#f3f4f6';
            });
            item.addEventListener('mouseleave', function() {
                this.style.background = 'white';
            });
        });

        container.appendChild(dropdown);

        // Toggle dropdown ao clicar no botao
        btn.addEventListener('click', function(e) {
            e.stopPropagation();

            // Fechar dropdown atual se houver
            if (dropdownAtual && dropdownAtual !== dropdown) {
                dropdownAtual.style.display = 'none';
            }

            // Toggle do dropdown
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                dropdownAtual = dropdown;
            } else {
                dropdown.style.display = 'none';
                dropdownAtual = null;
            }
        });
    });

    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function() {
        if (dropdownAtual) {
            dropdownAtual.style.display = 'none';
            dropdownAtual = null;
        }
    });

    // ========================================
    // A√á√ïES DO DROPDOWN
    // ========================================

    // DUPLICAR ITEM
    document.addEventListener('click', function(e) {
        if (e.target.closest('.dropdown-item-duplicar')) {
            const itemId = e.target.closest('.dropdown-item-duplicar').getAttribute('data-item-id');
            console.log('[INFO] Duplicar item ID:', itemId);

            if (!confirm('Deseja duplicar este item?')) return;

            // Buscar dados do item atual
            fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID, {
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                const item = data.itens.find(i => i.id == itemId);
                if (!item) {
                    alert('Item no encontrado');
                    return;
                }

                // Criar novo item duplicado
                const novoItem = {
                    descricao: item.descricao + ' (CPIA)',
                    medida_fornecimento: item.medida_fornecimento,
                    quantidade: item.quantidade,
                    tipo_quantidade: item.tipo_quantidade || 'inteiro',
                    tipo_marca: item.tipo_marca || 'referencia',
                    tipo: item.tipo,
                    alterar_cdf: item.alterar_cdf || false,
                    lote_id: item.lote_id || null
                };

                // Enviar requisi√ßo para criar item duplicado
                fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(novoItem)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success || result.item) {
                        alert('[LOG] Item duplicado com sucesso!');
                        location.reload();
                    } else {
                        alert('Erro ao duplicar item: ' + (result.message || 'Erro desconhecido'));
                    }
                })
                .catch(error => {
                    console.error('Erro ao duplicar item:', error);
                    alert('Erro ao duplicar item. Tente novamente.');
                });
            })
            .catch(error => {
                console.error('Erro ao buscar item:', error);
                alert('Erro ao buscar dados do item.');
            });

            // Fechar dropdown
            if (dropdownAtual) {
                dropdownAtual.style.display = 'none';
                dropdownAtual = null;
            }
        }
    });

    // RENUMERAR
    document.addEventListener('click', async function(e) {
        if (e.target.closest('.dropdown-item-renumerar')) {
            const itemId = e.target.closest('.dropdown-item-renumerar').getAttribute('data-item-id');
            console.log('[INFO] Renumerar item ID:', itemId);

            const novoNumero = prompt('Digite o novo n√∫mero do item:');
            if (!novoNumero) return;

            // Validar se √© um n√∫mero
            const numeroInt = parseInt(novoNumero);
            if (isNaN(numeroInt) || numeroInt < 1) {
                alert('Digite um n√∫mero vlido maior que zero.');
                return;
            }

            // Fechar dropdown imediatamente
            if (dropdownAtual) {
                dropdownAtual.style.display = 'none';
                dropdownAtual = null;
            }

            try {
                const response = await fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + itemId + '/renumerar', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content || ''
                    },
                    body: JSON.stringify({ novo_numero: numeroInt })
                });

                const result = await response.json();

                if (result.success) {
                    // Mostrar mensagem de sucesso
                    if (window.mostrarNotificacao) {
                        window.mostrarNotificacao(result.message, 'success');
                    } else {
                        alert(result.message);
                    }

                    // Recarregar pgina ap√≥s 1 segundo
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    // Mostrar mensagem de erro
                    if (window.mostrarNotificacao) {
                        window.mostrarNotificacao(result.message, 'error');
                    } else {
                        alert(result.message);
                    }
                }
            } catch (error) {
                console.error('Erro ao renumerar item:', error);
                if (window.mostrarNotificacao) {
                    window.mostrarNotificacao('Erro ao renumerar item. Tente novamente.', 'error');
                } else {
                    alert('Erro ao renumerar item. Tente novamente.');
                }
            }
        }
    });

    // APAGAR ITEM
    document.addEventListener('click', function(e) {
        if (e.target.closest('.dropdown-item-apagar')) {
            const itemId = e.target.closest('.dropdown-item-apagar').getAttribute('data-item-id');
            console.log('[!!!] Apagar item ID:', itemId);

            if (!confirm(' Tem certeza que deseja APAGAR este item?\n\nEsta a√ßo no pode ser desfeita.')) return;

            // Excluir item
            fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + itemId, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('[LOG] Item exclu√≠do com sucesso!');
                    location.reload();
                } else {
                    alert('Erro ao excluir item: ' + window.escapeAlert(data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro ao excluir item:', error);
                alert('Erro ao excluir item. Tente novamente.');
            });

            // Fechar dropdown
            if (dropdownAtual) {
                dropdownAtual.style.display = 'none';
                dropdownAtual = null;
            }
        }
    });
})();
}, 'dropdownEngrenagemInit'); //  FIM DOMContentLoaded - DROPDOWN ENGRENAGEM

// ========================================
// FUNCIONALIDADE: APAGAR ITENS MARCADOS
// ========================================
//  PROTE√á√ÉO: Listener √∫nico para apagar itens
window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
(function() {
    const btnApagarMarcados = document.getElementById('btn-apagar-marcados');
    if (!btnApagarMarcados) return;

    btnApagarMarcados.addEventListener('click', function() {
        const checkboxesMarcados = document.querySelectorAll('.checkbox-item:checked');

        if (checkboxesMarcados.length === 0) {
            alert('[AVISO] Nenhum item selecionado!\n\nMarque pelo menos um item para apagar.');
            return;
        }

        const quantidade = checkboxesMarcados.length;
        const confirmacao = confirm(` ATEN√á√ÉO!\n\nVoca esta prestes a APAGAR ${quantidade} item(ns) selecionado(s).\n\nEsta a√ßo no pode ser desfeita.\n\nDeseja continuar?`);

        if (!confirmacao) return;

        // Mostrar loading
        const originalHTML = btnApagarMarcados.innerHTML;
        btnApagarMarcados.innerHTML = '<i class="fas fa-spinner fa-spin"></i> APAGANDO...';
        btnApagarMarcados.disabled = true;

        // Coletar IDs dos itens marcados
        const idsParaApagar = Array.from(checkboxesMarcados).map(cb => cb.getAttribute('data-item-id'));
        let itensApagados = 0;
        let erros = 0;

        // Apagar cada item
        const promises = idsParaApagar.map(itemId => {
            return fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + itemId, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    itensApagados++;
                } else {
                    erros++;
                }
            })
            .catch(error => {
                console.error('Erro ao apagar item:', error);
                erros++;
            });
        });

        // Aguardar todas as requisi√ß√µes
        Promise.all(promises).then(() => {
            if (erros === 0) {
                alert(` Sucesso!\n\n${itensApagados} item(ns) apagado(s) com sucesso!`);
            } else {
                alert(` Aten√ßo!\n\nItens apagados: ${itensApagados}\nErros: ${erros}\n\nA pgina sera recarregada.`);
            }
            location.reload();
        });
    });
})();
}, 'apagarItensMarcadosInit'); //  FIM DOMContentLoaded - APAGAR ITENS MARCADOS

// ========================================
// FUNCIONALIDADE: APAGAR TODOS OS ITENS
// ========================================
//  PROTE√á√ÉO: Listener √∫nico para apagar todos
window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
(function() {
    const btnApagarTodos = document.getElementById('btn-apagar-todos');
    if (!btnApagarTodos) return;

    btnApagarTodos.addEventListener('click', function() {
        const todosCheckboxes = document.querySelectorAll('.checkbox-item');

        if (todosCheckboxes.length === 0) {
            alert('[AVISO] No ha itens para apagar!');
            return;
        }

        const quantidade = todosCheckboxes.length;
        const confirmacao1 = confirm(` ATEN√á√ÉO M√ÅXIMA! \n\nVoca esta prestes a APAGAR TODOS OS ${quantidade} ITENS deste or√ßamento!\n\nEsta √© uma a√ßo IRREVERSVEL e PERIGOSA!\n\nTem CERTEZA ABSOLUTA?`);

        if (!confirmacao1) return;

        // Segunda confirma√ßo
        const confirmacao2 = confirm(`a LTIMA CONFIRMA√á√ÉO!\n\nDigite OK na pr√≥xima tela para confirmar a excluso de TODOS OS ${quantidade} ITENS.\n\nContinuar?`);

        if (!confirmacao2) return;

        const digitacao = prompt('Digite "APAGAR TUDO" (sem aspas) para confirmar:');

        if (digitacao !== 'APAGAR TUDO') {
            alert('[LOG] Opera√ßo cancelada!\n\nTexto de confirma√ßo incorreto.');
            return;
        }

        // Mostrar loading
        const originalHTML = btnApagarTodos.innerHTML;
        btnApagarTodos.innerHTML = '<i class="fas fa-spinner fa-spin"></i> APAGANDO TUDO...';
        btnApagarTodos.disabled = true;

        // Coletar IDs de todos os itens
        const idsParaApagar = Array.from(todosCheckboxes).map(cb => cb.getAttribute('data-item-id'));
        let itensApagados = 0;
        let erros = 0;

        // Apagar cada item
        const promises = idsParaApagar.map(itemId => {
            return fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + itemId, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    itensApagados++;
                } else {
                    erros++;
                }
            })
            .catch(error => {
                console.error('Erro ao apagar item:', error);
                erros++;
            });
        });

        // Aguardar todas as requisi√ß√µes
        Promise.all(promises).then(() => {
            if (erros === 0) {
                alert(` Opera√ßo conclu√≠da!\n\nTODOS os ${itensApagados} itens foram apagados com sucesso!`);
            } else {
                alert(` Opera√ßo conclu√≠da com erros!\n\nItens apagados: ${itensApagados}\nErros: ${erros}\n\nA pgina sera recarregada.`);
            }
            location.reload();
        });
    });
})();
}, 'apagarTodosItensInit'); //  FIM DOMContentLoaded - APAGAR TODOS OS ITENS

</script>

<!-- ================================================================== -->
<!-- FIM DO C√ìDIGO FUNCIONAL DESCOMENTADO -->
<!-- ================================================================== -->

<script>
// ========================================
// FUNCIONALIDADE: MODAL AN√ÅLISE CRTICA
// ========================================
//  PROTE√á√ÉO: Listener √∫nico para modal an√°lise cr√≠tica
window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
(function() {
    console.log('[DEBUG] Inicializando Modal An√°lise Cr√≠tica...');
    const modalAnalise = document.getElementById('modalAnaliseCritica');
    const btnsAnalise = document.querySelectorAll('.btn-analise');

    console.log('[DEBUG] Modal An√°lise encontrado:', modalAnalise);
    console.log('[DEBUG] Bot√µes .btn-analise encontrados:', btnsAnalise.length);

    if (!modalAnalise) {
        console.warn('[DEBUG] Modal An√°lise N√ÉO encontrado! Abortando...');
        return;
    }

    let itemAtualAnalise = null;

    // Abrir modal ao clicar no botao anlise
    btnsAnalise.forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            itemAtualAnalise = itemId;

            // Buscar descri√ßo do item E amostras salvas
            Promise.all([
                fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID, {
                    headers: { 'Accept': 'application/json' }
                }).then(r => r.json()),
                fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + itemId + '/amostras', {
                    headers: { 'Accept': 'application/json' }
                }).then(r => r.json())
            ])
            .then(([orcamentoData, amostrasData]) => {
                const item = orcamentoData.itens.find(i => i.id == itemId);
                if (item) {
                    document.getElementById('analise-item-descricao').textContent = item.descricao;
                }

                // Processar e exibir amostras salvas
                if (amostrasData.success && amostrasData.amostras && amostrasData.amostras.length > 0) {
                    const amostras = amostrasData.amostras;
                    console.log('[LOG] Amostras carregadas do banco:', amostras.length);

                    // Calcular estat√≠sticas
                    const valores = amostras.map(a => parseFloat(a.valor_unitario || a.preco_unitario || 0));
                    const valoresOrdenados = valores.slice().sort((a,b) => a - b);
                    const total = valores.reduce((sum, v) => sum + v, 0);
                    const media = total / valores.length;
                    const mediana = calcularMediana(valoresOrdenados);
                    const minimo = Math.min(...valores);

                    // Calcular desvio padro
                    const variancia = valores.reduce((sum, v) => sum + Math.pow(v - media, 2), 0) / valores.length;
                    const desvioPadrao = Math.sqrt(variancia);
                    const coefVariacao = (desvioPadrao / media) * 100;

                    // Fun√ßo auxiliar segura para atualizar elemento
                    const atualizarElemento = (id, valor) => {
                        const elem = document.getElementById(id);
                        if (elem) elem.textContent = valor;
                    };

                    // Atualizar "Ju√≠zo Cr√≠tico"
                    atualizarElemento('analise-juizo-num-amostras', amostras.length);
                    atualizarElemento('analise-juizo-media', 'R$ ' + media.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-juizo-desvio', desvioPadrao.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-juizo-limite-inf', 'R$ ' + (media - desvioPadrao).toFixed(2).replace('.', ',') + ' (DP - m√©dia)');
                    atualizarElemento('analise-juizo-limite-sup', 'R$ ' + (media + desvioPadrao).toFixed(2).replace('.', ',') + ' (DP + m√©dia)');

                    // Atualizar "M√©todo Estat√≠stico"
                    atualizarElemento('analise-metodo-num-validas', amostras.length);
                    atualizarElemento('analise-metodo-desvio', desvioPadrao.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-metodo-coef-var', coefVariacao.toFixed(2).replace('.', ',') + '%');
                    atualizarElemento('analise-metodo-menor', 'R$ ' + minimo.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-metodo-media', 'R$ ' + media.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-metodo-mediana', 'R$ ' + mediana.toFixed(2).replace('.', ','));

                    // Atualizar "M√©todo Estat√≠stico Final"
                    atualizarElemento('analise-final-mediana', 'R$ ' + mediana.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-final-media', 'R$ ' + media.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-final-menor', 'R$ ' + minimo.toFixed(2).replace('.', ','));
                    atualizarElemento('analise-final-tendencia', 'R$ ' + mediana.toFixed(2).replace('.', ','));

                    // Mostrar tabela e ocultar mensagem vazia
                    const serieVazia = document.getElementById('analise-serie-vazia');
                    const serieTabela = document.getElementById('analise-serie-tabela');
                    if (serieVazia) serieVazia.style.display = 'none';
                    if (serieTabela) serieTabela.style.display = 'block';

                    // Exibir tabela de amostras
                    const tbody = document.getElementById('analise-serie-tbody');
                    if (tbody) {
                        tbody.innerHTML = '';
                        amostras.forEach((a, idx) => {
                            const tr = document.createElement('tr');
                            tr.style.textAlign = 'center';
                            tr.innerHTML = `
                                <td>${idx + 1}</td>
                                <td><span class="badge bg-success">V√ÅLIDA</span></td>
                                <td style="text-align: left;">${a.fonte || 'No especificada'} - ${a.orgao || 'N/A'}</td>
                                <td>${a.marca || '-'}</td>
                                <td>${a.data_cotacao || a.data || '-'}</td>
                                <td>${a.medida_fornecimento || 'UN'}</td>
                                <td style="text-align: right;">${a.quantidade || 1}</td>
                                <td style="text-align: right;">R$ ${parseFloat(a.valor_unitario || a.preco_unitario || 0).toFixed(2).replace('.', ',')}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" style="font-size: 10px; padding: 2px 6px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                } else {
                    console.log('[AVISO] Nenhuma amostra salva para este item');

                    // VERIFICAR SE O ITEM TEM PRE√áO UNIT√ÅRIO
                    const precoUnitario = parseFloat(amostrasData.item?.preco_unitario || 0);

                    // Fun√ßo auxiliar segura para atualizar elemento
                    const zerarElemento = (id, valor) => {
                        const elem = document.getElementById(id);
                        if (elem) elem.textContent = valor;
                    };

                    if (precoUnitario > 0) {
                        // TEM PRE√áO UNIT√ÅRIO a Mostrar 1 amostra com o valor do pr√≥prio item
                        console.log('[LOG] Item tem pre√ßo unitrio: R$', precoUnitario.toFixed(2));

                        const precoFormatado = 'R$ ' + precoUnitario.toFixed(2).replace('.', ',');

                        // Atualizar estat√≠sticas com 1 amostra (o pr√≥prio item)
                        zerarElemento('analise-juizo-num-amostras', '1');
                        zerarElemento('analise-juizo-media', precoFormatado);
                        zerarElemento('analise-juizo-desvio', '0,00');
                        zerarElemento('analise-juizo-limite-inf', precoFormatado + ' (DP - m√©dia)');
                        zerarElemento('analise-juizo-limite-sup', precoFormatado + ' (DP + m√©dia)');

                        zerarElemento('analise-metodo-num-validas', '1');
                        zerarElemento('analise-metodo-desvio', '0,00');
                        zerarElemento('analise-metodo-coef-var', '0,00%');
                        zerarElemento('analise-metodo-menor', precoFormatado);
                        zerarElemento('analise-metodo-media', precoFormatado);
                        zerarElemento('analise-metodo-mediana', precoFormatado);

                        zerarElemento('analise-final-mediana', precoFormatado);
                        zerarElemento('analise-final-media', precoFormatado);
                        zerarElemento('analise-final-menor', precoFormatado);
                        zerarElemento('analise-final-tendencia', precoFormatado);

                        // Mostrar tabela com 1 amostra (o pr√≥prio item)
                        const serieVazia = document.getElementById('analise-serie-vazia');
                        const serieTabela = document.getElementById('analise-serie-tabela');
                        if (serieVazia) serieVazia.style.display = 'none';
                        if (serieTabela) serieTabela.style.display = 'block';

                        const tbody = document.getElementById('analise-serie-tbody');
                        if (tbody) {
                            tbody.innerHTML = '';
                            const tr = document.createElement('tr');
                            tr.style.textAlign = 'center';
                            tr.innerHTML = `
                                <td>1</td>
                                <td><span class="badge bg-success">V√ÅLIDA</span></td>
                                <td style="text-align: left;">Valor do pr√≥prio item (ja cadastrado)</td>
                                <td>-</td>
                                <td>${new Date().toLocaleDateString('pt-BR')}</td>
                                <td>${amostrasData.item?.medida_fornecimento || 'UN'}</td>
                                <td style="text-align: right;">${amostrasData.item?.quantidade || 1}</td>
                                <td style="text-align: right;">${precoFormatado}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" disabled style="font-size: 10px; padding: 2px 6px;">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        }
                    } else {
                        // N√ÉO TEM PRE√áO UNIT√ÅRIO a Zerar tudo
                        console.log('[AVISO] Item no tem pre√ßo unitrio');

                        zerarElemento('analise-juizo-num-amostras', '0');
                        zerarElemento('analise-juizo-media', 'R$ 0,00');
                        zerarElemento('analise-juizo-desvio', '0,00');
                        zerarElemento('analise-juizo-limite-inf', 'R$ 0,00 (DP - m√©dia)');
                        zerarElemento('analise-juizo-limite-sup', 'R$ 0,00 (DP + m√©dia)');
                        zerarElemento('analise-metodo-num-validas', '0');
                        zerarElemento('analise-metodo-desvio', '0,00');
                        zerarElemento('analise-metodo-coef-var', '0,00%');
                        zerarElemento('analise-metodo-menor', 'R$ 0,00');
                        zerarElemento('analise-metodo-media', 'R$ 0,00');
                        zerarElemento('analise-metodo-mediana', 'R$ 0,00');
                        zerarElemento('analise-final-mediana', 'R$ 0,00');
                        zerarElemento('analise-final-media', 'R$ 0,00');
                        zerarElemento('analise-final-menor', 'R$ 0,00');
                        zerarElemento('analise-final-tendencia', 'R$ 0,00');

                        // Mostrar mensagem vazia e ocultar tabela
                        const serieVazia = document.getElementById('analise-serie-vazia');
                        const serieTabela = document.getElementById('analise-serie-tabela');
                        if (serieVazia) serieVazia.style.display = 'block';
                        if (serieTabela) serieTabela.style.display = 'none';
                    }
                }
            })
            .catch(err => {
                console.error('[ERRO] Erro ao carregar dados:', err);
                alert('Erro ao carregar dados da anlise cr√≠tica.');
            });

            // Abrir modal
            const modalInstance = new bootstrap.Modal(modalAnalise);
            modalInstance.show();
        });
    });

    // Fun√ßo auxiliar para calcular mediana
    function calcularMediana(valores) {
        const meio = Math.floor(valores.length / 2);
        if (valores.length % 2 === 0) {
            return (valores[meio - 1] + valores[meio]) / 2;
        }
        return valores[meio];
    }

    // Boto Justificativa/Observa√ßo
    const btnJustificativa = document.getElementById('analise-btn-justificativa');
    if (btnJustificativa) {
        btnJustificativa.addEventListener('click', function() {
            const justificativa = prompt('Digite a justificativa ou observa√ßo para este item:');

            if (justificativa && justificativa.trim()) {
                console.log('[INFO] Justificativa salva:', justificativa);
                alert('[LOG] Justificativa salva com sucesso!');

                // Em produ√ßo, salvar no backend
                // fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + itemAtualAnalise + '/justificativa', ...)
            }
        });
    }

    // ============================================================
    // TAB AUDITORIA - Carregar logs quando tab for clicada
    // ============================================================
    const tabAuditoriaBtn = document.getElementById('tab-auditoria-btn');
    if (tabAuditoriaBtn) {
        tabAuditoriaBtn.addEventListener('click', function() {
            if (!itemAtualAnalise) {
                console.warn('[AUDITORIA] Nenhum item selecionado');
                return;
            }

            console.log('[AUDITORIA] Carregando logs para item:', itemAtualAnalise);

            // Mostrar loading
            document.getElementById('auditoria-loading').style.display = 'block';
            document.getElementById('auditoria-vazio').style.display = 'none';
            document.getElementById('auditoria-timeline').style.display = 'none';

            // Buscar logs de auditoria
            fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + itemAtualAnalise + '/audit-logs', {
                headers: { 'Accept': 'application/json' }
            })
            .then(r => r.json())
            .then(data => {
                console.log('[AUDITORIA] Logs recebidos:', data);

                // Esconder loading
                document.getElementById('auditoria-loading').style.display = 'none';

                if (data.success && data.logs && data.logs.length > 0) {
                    // Mostrar timeline
                    document.getElementById('auditoria-timeline').style.display = 'block';

                    // Renderizar logs
                    const listaAuditoria = document.getElementById('auditoria-lista');
                    listaAuditoria.innerHTML = '<div style="position: absolute; left: 15px; top: 0; bottom: 0; width: 2px; background: #e5e7eb;"></div>';

                    data.logs.forEach((log, index) => {
                        const logItem = document.createElement('div');
                        logItem.style.cssText = 'position: relative; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid #f3f4f6;';

                        // Badge de cor baseada na a√ß√£o
                        const corBadge = log.cor === 'success' ? '#10b981' :
                                        log.cor === 'danger' ? '#ef4444' :
                                        log.cor === 'warning' ? '#f59e0b' :
                                        log.cor === 'info' ? '#3b82f6' :
                                        log.cor === 'primary' ? '#3b82f6' : '#6b7280';

                        logItem.innerHTML = `
                            <!-- √çcone circular na linha do tempo -->
                            <div style="position: absolute; left: -32px; top: 0; width: 32px; height: 32px; background: ${corBadge}; border: 3px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <i class="fas ${log.icone}" style="color: white; font-size: 12px;"></i>
                            </div>

                            <!-- Conte√∫do do log -->
                            <div style="padding-left: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <span class="badge bg-${log.cor}" style="font-size: 10px; font-weight: 600; margin-right: 8px;">
                                            ${log.label}
                                        </span>
                                        <span style="font-size: 11px; color: #6b7280;">
                                            <i class="fas fa-user" style="font-size: 9px;"></i> ${log.usuario}
                                        </span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 10px; color: #9ca3af;">${log.data_relativa}</div>
                                        <div style="font-size: 9px; color: #d1d5db;">${log.data_hora}</div>
                                    </div>
                                </div>

                                ${log.observacao ? `
                                    <p style="font-size: 11px; color: #374151; margin: 8px 0; line-height: 1.5;">
                                        ${log.observacao}
                                    </p>
                                ` : ''}

                                ${(log.dados_antes || log.dados_depois) ? `
                                    <div style="margin-top: 10px;">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'" style="font-size: 9px; padding: 3px 8px;">
                                            <i class="fas fa-code"></i> Ver Detalhes (JSON)
                                        </button>
                                        <div style="display: none; margin-top: 8px; background: #f9fafb; border-radius: 4px; padding: 10px;">
                                            ${log.dados_antes ? `
                                                <div style="margin-bottom: 8px;">
                                                    <strong style="font-size: 10px; color: #6b7280;">ANTES:</strong>
                                                    <pre style="font-size: 9px; background: white; padding: 8px; border-radius: 4px; margin: 4px 0; overflow-x: auto;">${JSON.stringify(log.dados_antes, null, 2)}</pre>
                                                </div>
                                            ` : ''}
                                            ${log.dados_depois ? `
                                                <div>
                                                    <strong style="font-size: 10px; color: #6b7280;">DEPOIS:</strong>
                                                    <pre style="font-size: 9px; background: white; padding: 8px; border-radius: 4px; margin: 4px 0; overflow-x: auto;">${JSON.stringify(log.dados_depois, null, 2)}</pre>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;

                        listaAuditoria.appendChild(logItem);
                    });
                } else {
                    // Mostrar estado vazio
                    document.getElementById('auditoria-vazio').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('[AUDITORIA] Erro ao carregar logs:', error);
                document.getElementById('auditoria-loading').style.display = 'none';
                document.getElementById('auditoria-vazio').style.display = 'block';
            });
        });
    }
})();
}, 'modalAnaliseCriticaInit');
</script>

<script>
(function() {
    // ============================================================
    // SE√á√ÉO 6: DADOS DO OR√áAMENTISTA - CPF/CNPJ e ReceitaWS
    // ============================================================

    const inputCpfCnpj = document.getElementById('orcamentista_cpf_cnpj');
    const feedbackCpfCnpj = document.getElementById('cpf-cnpj-feedback');
    const brasaoContainer = document.getElementById('brasao-upload-container');
    const btnSalvarOrcamentista = document.getElementById('btn-salvar-orcamentista');

    // Fun√ßo para aplicar mscara de CPF/CNPJ
    function aplicarMascaraCpfCnpj(valor) {
        // Remove tudo que no √© n√∫mero
        valor = valor.replace(/\D/g, '');

        if (valor.length <= 11) {
            // Mscara de CPF: 000.000.000-00
            valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
            valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
            valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        } else {
            // Mscara de CNPJ: 00.000.000/0000-00
            valor = valor.replace(/^(\d{2})(\d)/, '$1.$2');
            valor = valor.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            valor = valor.replace(/\.(\d{3})(\d)/, '.$1/$2');
            valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
        }

        return valor;
    }

    // Fun√ßo para validar CPF
    function validarCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');

        if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) {
            return false;
        }

        let soma = 0;
        let resto;

        for (let i = 1; i <= 9; i++) {
            soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
        }

        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.substring(9, 10))) return false;

        soma = 0;
        for (let i = 1; i <= 10; i++) {
            soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
        }

        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.substring(10, 11))) return false;

        return true;
    }

    // Fun√ßo para validar CNPJ
    function validarCNPJ(cnpj) {
        cnpj = cnpj.replace(/\D/g, '');

        if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) {
            return false;
        }

        let tamanho = cnpj.length - 2;
        let numeros = cnpj.substring(0, tamanho);
        let digitos = cnpj.substring(tamanho);
        let soma = 0;
        let pos = tamanho - 7;

        for (let i = tamanho; i >= 1; i--) {
            soma += numeros.charAt(tamanho - i) * pos--;
            if (pos < 2) pos = 9;
        }

        let resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
        if (resultado != digitos.charAt(0)) return false;

        tamanho = tamanho + 1;
        numeros = cnpj.substring(0, tamanho);
        soma = 0;
        pos = tamanho - 7;

        for (let i = tamanho; i >= 1; i--) {
            soma += numeros.charAt(tamanho - i) * pos--;
            if (pos < 2) pos = 9;
        }

        resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
        if (resultado != digitos.charAt(1)) return false;

        return true;
    }

    // =================================================================
    // BUSCA AUTOM√ÅTICA POR CEP (ViaCEP API)
    // =================================================================
    async function buscarCEP(cep) {
        const cepLimpo = cep.replace(/\D/g, '');

        // Validar CEP (8 d√≠gitos)
        if (cepLimpo.length !== 8) {
            return;
        }

        console.log('[INFO] Buscando CEP:', cepLimpo);

        try {
            const response = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
            const data = await response.json();

            if (data.erro) {
                console.warn(' CEP no encontrado');
                return;
            }

            console.log('[LOG] CEP encontrado:', data);

            // Preencher campos VISVEIS automaticamente
            if (data.uf) {
                document.getElementById('orcamentista_uf_manual').value = data.uf;
                document.getElementById('orcamentista_uf').value = data.uf; // hidden
            }

            if (data.logradouro) {
                const enderecoCompleto = `${data.logradouro}, ${data.bairro}, ${data.localidade}`;
                document.getElementById('orcamentista_endereco_manual').value = enderecoCompleto;
                document.getElementById('orcamentista_endereco').value = enderecoCompleto; // hidden
            }

            if (data.localidade) {
                document.getElementById('orcamentista_cidade').value = data.localidade; // hidden
            }

            console.log('[LOG] Campos preenchidos automaticamente via CEP!');

        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
        }
    }

    // =================================================================
    // BUSCA AUTOM√ÅTICA POR CNPJ (ReceitaWS via Backend)
    // =================================================================
    async function buscarDadosCNPJ(cnpj) {
        const cnpjLimpo = cnpj.replace(/\D/g, '');

        feedbackCpfCnpj.innerHTML = '<span style="color: #2563eb;"><i class="fas fa-spinner fa-spin"></i> Consultando CNPJ...</span>';

        try {
            // Chamar endpoint do backend ao inv√©s de ReceitaWS direto
            const response = await fetch(window.APP_BASE_PATH + '/orcamentos/consultar-cnpj/' + cnpjLimpo);
            const result = await response.json();

            if (!response.ok || !result.success) {
                const mensagemErro = result.message || 'CNPJ no encontrado';
                const mensagemEscape = mensagemErro.replace(/"/g, '&quot;').replace(/'/g, '&#039;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                feedbackCpfCnpj.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> ' + mensagemEscape + '</span>';
                limparDadosReceitaWS();
                return;
            }

            const data = result.data;

            console.log('[INFO] Dados CNPJ recebidos:', data);

            // Preencher campo VISVEL de nome com a razo social
            document.getElementById('orcamentista_nome').value = data.razao_social || data.nome || '';

            //  PREENCHER CAMPOS VISVEIS (novos!)
            if (data.cep) {
                document.getElementById('orcamentista_cep_manual').value = data.cep;
                document.getElementById('orcamentista_cep').value = data.cep; // hidden
            }

            if (data.uf) {
                document.getElementById('orcamentista_uf_manual').value = data.uf;
                document.getElementById('orcamentista_uf').value = data.uf; // hidden
            }

            if (data.endereco) {
                document.getElementById('orcamentista_endereco_manual').value = data.endereco;
                document.getElementById('orcamentista_endereco').value = data.endereco; // hidden
            }

            // Preencher campos hidden com dados da ReceitaWS
            document.getElementById('orcamentista_razao_social').value = data.razao_social || '';
            document.getElementById('orcamentista_cidade').value = data.municipio || '';

            // Mostrar container de braso (se existir)
            if (brasaoContainer) {
                brasaoContainer.style.display = 'block';
            }

            feedbackCpfCnpj.innerHTML = '<span style="color: #16a34a;"><i class="fas fa-check-circle"></i> CNPJ vlido - Dados preenchidos automaticamente!</span>';

            console.log('[LOG] Campos preenchidos automaticamente via CNPJ!');

        } catch (error) {
            console.error('Erro ao consultar CNPJ:', error);
            feedbackCpfCnpj.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-exclamation-triangle"></i> Erro ao consultar CNPJ. Tente novamente.</span>';
            limparDadosReceitaWS();
        }
    }

    // Fun√ßo para limpar dados da ReceitaWS
    function limparDadosReceitaWS() {
        document.getElementById('orcamentista_razao_social').value = '';
        document.getElementById('orcamentista_endereco').value = '';
        document.getElementById('orcamentista_cep').value = '';
        document.getElementById('orcamentista_cidade').value = '';
        document.getElementById('orcamentista_uf').value = '';
        if (brasaoContainer) {
            brasaoContainer.style.display = 'none';
        }
    }

    // Event listener para CPF/CNPJ input
    if (inputCpfCnpj) {
        inputCpfCnpj.addEventListener('input', function(e) {
            // Aplicar mscara
            this.value = aplicarMascaraCpfCnpj(this.value);

            const valorLimpo = this.value.replace(/\D/g, '');

            // Limpar feedback se estiver digitando
            if (valorLimpo.length < 11) {
                feedbackCpfCnpj.innerHTML = '';
                limparDadosReceitaWS();
                return;
            }

            // Validar CPF (11 d√≠gitos)
            if (valorLimpo.length === 11) {
                if (validarCPF(this.value)) {
                    feedbackCpfCnpj.innerHTML = '<span style="color: #16a34a;"><i class="fas fa-check-circle"></i> CPF vlido - Digite o nome completo abaixo</span>';
                    limparDadosReceitaWS(); // CPF no tem dados da ReceitaWS

                    // Focar automaticamente no campo de nome para facilitar
                    const campoNome = document.getElementById('orcamentista_nome');
                    if (campoNome) {
                        setTimeout(() => {
                            campoNome.focus();
                            campoNome.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Destacar campo temporariamente
                            const originalBorder = campoNome.style.border;
                            campoNome.style.border = '2px solid #16a34a';
                            campoNome.style.transition = 'border 0.3s';
                            setTimeout(() => {
                                campoNome.style.border = originalBorder;
                            }, 2000);
                        }, 300);
                    }
                } else {
                    feedbackCpfCnpj.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> CPF invlido</span>';
                    limparDadosReceitaWS();
                }
                return;
            }

            // Validar CNPJ (14 d√≠gitos)
            if (valorLimpo.length === 14) {
                if (validarCNPJ(this.value)) {
                    feedbackCpfCnpj.innerHTML = '<span style="color: #16a34a;"><i class="fas fa-check-circle"></i> CNPJ vlido</span>';
                    // Buscar dados automaticamente
                    buscarDadosCNPJ(this.value);
                } else {
                    feedbackCpfCnpj.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> CNPJ invlido</span>';
                    limparDadosReceitaWS();
                }
                return;
            }

            // Mais de 14 d√≠gitos
            if (valorLimpo.length > 14) {
                feedbackCpfCnpj.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> N√∫mero invlido</span>';
                limparDadosReceitaWS();
            }
        });
    }

    // =================================================================
    // EVENT LISTENERS: AUTO-SAVE NOS CAMPOS DO OR√áAMENTISTA
    // =================================================================
    // Auto-save silencioso quando o usurio preencher qualquer campo e sair dele (blur)
    const camposAutoSave = ['orcamentista_nome', 'orcamentista_cep_manual', 'orcamentista_uf_manual', 'orcamentista_endereco_manual'];

    camposAutoSave.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            let autoSaveTimeout;

            // Evento blur: quando o usurio sai do campo
            field.addEventListener('blur', function() {
                clearTimeout(autoSaveTimeout);

                // Debounce de 500ms para evitar m√∫ltiplas chamadas
                autoSaveTimeout = setTimeout(async () => {
                    const valorCampo = this.value.trim();

                    // S√≥ salvar se o campo tiver conte√∫do
                    if (valorCampo.length > 0) {
                        console.log(` Auto-salvando dados do or√ßamentista (campo: ${fieldId})...`);
                        await salvarDadosAutomaticamente(false); // false = salvamento silencioso, sem modal
                    }
                }, 500);
            });
        }
    });

    // =================================================================
    // EVENT LISTENER: BUSCA AUTOM√ÅTICA POR CEP
    // =================================================================
    const inputCep = document.getElementById('orcamentista_cep_manual');
    if (inputCep) {
        inputCep.addEventListener('input', function(e) {
            // Aplicar mscara de CEP (00.000-000 ou 00000-000)
            let valor = this.value.replace(/\D/g, '');
            if (valor.length > 8) {
                valor = valor.substring(0, 8);
            }

            // Aplicar mscara
            if (valor.length > 5) {
                this.value = valor.substring(0, 5) + '-' + valor.substring(5);
            } else {
                this.value = valor;
            }

            // Buscar automaticamente quando tiver 8 d√≠gitos
            if (valor.length === 8) {
                buscarCEP(valor);
            }
        });
    }
})();

// ===== BOT√ïES DE A√á√ÉO DA CDF =====
(function() {
    // Toggle dropdown da engrenagem
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-dropdown-cdf')) {
            const btn = e.target.closest('.btn-dropdown-cdf');
            const cdfId = btn.getAttribute('data-cdf-id');
            const dropdown = document.getElementById('dropdown-cdf-' + cdfId);

            // Fechar outros dropdowns
            document.querySelectorAll('.dropdown-menu-cdf').forEach(d => {
                if (d !== dropdown) d.style.display = 'none';
            });

            // Toggle dropdown atual
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            e.stopPropagation();
        }
    });

    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown-menu-cdf') && !e.target.closest('.btn-dropdown-cdf')) {
            document.querySelectorAll('.dropdown-menu-cdf').forEach(d => d.style.display = 'none');
        }
    });

    // Handler dos bot√µes de a√ßo
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.btn-icon-acao');
        if (!btn) return;

        const action = btn.getAttribute('data-action');
        const cdfId = btn.getAttribute('data-cdf-id');

        console.log('A√ßo CDF:', action, 'ID:', cdfId);

        switch(action) {
            case 'baixar-oficio':
                baixarOficioCDF(cdfId);
                break;
            case 'baixar-formulario':
                baixarFormularioCDF(cdfId);
                break;
            case 'primeiro-passo':
                abrirModalPrimeiroPasso(cdfId);
                break;
            case 'baixar-cnpj':
                baixarEspelhoCNPJ(cdfId);
                break;
            case 'baixar-comprovante':
                baixarComprovanteCDF(cdfId);
                break;
            case 'baixar-cotacao':
                baixarCotacaoCDF(cdfId);
                break;
            case 'gerenciar':
                abrirModalGerenciar(cdfId);
                break;
            case 'remover':
                removerCDF(cdfId);
                break;
        }
    });

    // Fun√ß√µes de a√ßo
    function baixarOficioCDF(cdfId) {
        window.location.href = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/cdf/' + cdfId + '/baixar-oficio';
    }

    function baixarFormularioCDF(cdfId) {
        window.location.href = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/cdf/' + cdfId + '/baixar-formulario';
    }

    function abrirModalPrimeiroPasso(cdfId) {
        // Buscar dados da CDF
        fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/cdf/' + cdfId, {
            headers: { 'Accept': 'application/json' }
        })
        .then(response => response.json())
        .then(cdf => {
            // Preencher dados no modal
            document.getElementById('primeiro_passo_cdf_id').value = cdf.id;
            document.getElementById('modal_cdf_numero').textContent = String(cdf.id).padStart(2, '0') + '/2025';
            document.getElementById('modal_cdf_fornecedor').textContent = cdf.razao_social || cdf.fornecedor_nome || 'N/A';
            document.getElementById('modal_cdf_situacao').textContent = cdf.status || 'Pendente';

            // Abrir modal usando Bootstrap 5 API (sem jQuery)
            const modal = new bootstrap.Modal(document.getElementById('modalPrimeiroPasso'));
            modal.show();
        })
        .catch(error => {
            console.error('Erro ao buscar CDF:', error);
            alert('[LOG] Erro ao carregar dados da CDF');
        });
    }

    function baixarEspelhoCNPJ(cdfId) {
        window.location.href = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/cdf/' + cdfId + '/baixar-cnpj';
    }

    function baixarComprovanteCDF(cdfId) {
        window.location.href = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/cdf/' + cdfId + '/baixar-comprovante';
    }

    function baixarCotacaoCDF(cdfId) {
        window.location.href = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/cdf/' + cdfId + '/baixar-cotacao';
    }

    function abrirModalGerenciar(cdfId) {
        // Buscar dados da CDF
        fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/cdf/' + cdfId, {
            headers: { 'Accept': 'application/json' }
        })
        .then(response => response.json())
        .then(cdf => {
            // Preencher dados no modal
            document.getElementById('gerenciar_cdf_id').value = cdf.id;
            document.getElementById('modal_ger_cdf_numero').textContent = String(cdf.id).padStart(2, '0') + '/2025';
            document.getElementById('modal_ger_cdf_fornecedor').textContent = cdf.razao_social || cdf.fornecedor_nome || 'N/A';

            // Abrir modal usando Bootstrap 5 API (sem jQuery)
            const modal = new bootstrap.Modal(document.getElementById('modalGerenciarCDF'));
            modal.show();
        })
        .catch(error => {
            console.error('Erro ao buscar CDF:', error);
            alert('[LOG] Erro ao carregar dados da CDF');
        });
    }

    function removerCDF(cdfId) {
        if (!confirm('Tem certeza que deseja remover esta CDF?')) return;

        fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/cdf/' + cdfId, {
            method: 'DELETE',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('[LOG] CDF removida com sucesso!');
                location.reload();
            } else {
                alert('[LOG] ' + (result.message || 'Erro ao remover CDF'));
            }
        })
        .catch(error => {
            console.error('Erro ao remover CDF:', error);
            alert('[LOG] Erro ao remover CDF');
        });
    }

    // Handler do dropdown
    document.addEventListener('click', function(e) {
        if (e.target.closest('[data-action="alterar-primeiro-passo"]')) {
            e.preventDefault();
            const cdfId = e.target.getAttribute('data-cdf-id');
            alert('Alterar 1¬∫ Passo - CDF ID: ' + cdfId);
            document.querySelectorAll('.dropdown-menu-cdf').forEach(d => d.style.display = 'none');
        }

        if (e.target.closest('[data-action="segundo-passo"]')) {
            e.preventDefault();
            const cdfId = e.target.getAttribute('data-cdf-id');
            abrirModalSegundoPasso(cdfId);
            document.querySelectorAll('.dropdown-menu-cdf').forEach(d => d.style.display = 'none');
        }
    });

    // Handler: Enviar Primeiro Passo
    document.getElementById('btnEnviarPrimeiroPasso') && document.getElementById('btnEnviarPrimeiroPasso').addEventListener('click', function() {
        const form = document.getElementById('formPrimeiroPasso');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const cdfId = document.getElementById('primeiro_passo_cdf_id').value;

        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ENVIANDO...';

        fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/cdf/' + cdfId + '/primeiro-passo', {
            method: 'POST',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('[LOG] Primeiro passo conclu√≠do com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('modalPrimeiroPasso')).hide();
                location.reload();
            } else {
                alert('[LOG] ' + (result.message || 'Erro ao processar primeiro passo'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('[LOG] Erro ao enviar dados');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check"></i> ENVIAR';
        });
    });

    // Handler: Concluir Gerenciamento
    document.getElementById('btnConcluirGerenciamento') && document.getElementById('btnConcluirGerenciamento').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('formGerenciarCDF'));
        const cdfId = document.getElementById('gerenciar_cdf_id').value;

        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PROCESSANDO...';

        fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/cdf/' + cdfId + '/gerenciar', {
            method: 'POST',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('[LOG] Gerenciamento conclu√≠do com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('modalGerenciarCDF')).hide();
                location.reload();
            } else {
                alert('[LOG] ' + (result.message || 'Erro ao gerenciar CDF'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('[LOG] Erro ao processar gerenciamento');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check"></i> CONCLUIR';
        });
    });

    // Fun√ßo: Abrir Modal Segundo Passo
    function abrirModalSegundoPasso(cdfId) {
        fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/cdf/' + cdfId)
            .then(response => response.json())
            .then(cdf => {
                document.getElementById('segundo_passo_cdf_id').value = cdf.id;
                document.getElementById('modal_2p_cdf_numero').textContent = cdf.numero_cdf || cdf.id;
                document.getElementById('modal_2p_cdf_fornecedor').textContent = cdf.fornecedor_nome || cdf.razao_social || 'N/A';

                // Limpar todas as sele√ß√µes
                document.querySelectorAll('#formSegundoPasso input[type="radio"]').forEach(r => r.checked = false);

                // Abrir modal usando Bootstrap 5 API (sem jQuery)
                const modal = new bootstrap.Modal(document.getElementById('modalSegundoPasso'));
                modal.show();
            })
            .catch(error => {
                console.error('Erro ao buscar CDF:', error);
                alert('[LOG] Erro ao carregar dados do CDF');
            });
    }

    // Handler: Enviar Segundo Passo
    document.getElementById('btnEnviarSegundoPasso') && document.getElementById('btnEnviarSegundoPasso').addEventListener('click', function() {
        const form = document.getElementById('formSegundoPasso');

        // Validar se todas as quest√µes foram respondidas
        const questoes = ['q1', 'q2', 'q3', 'q4', 'q5'];
        let todasRespondidas = true;

        questoes.forEach(q => {
            const respondida = document.querySelector(`input[name="${q}"]:checked`);
            if (!respondida) {
                todasRespondidas = false;
            }
        });

        if (!todasRespondidas) {
            alert('[LOG] Por favor, responda todas as quest√µes antes de enviar.');
            return;
        }

        const formData = new FormData(form);
        const cdfId = document.getElementById('segundo_passo_cdf_id').value;

        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ENVIANDO...';

        fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/cdf/' + cdfId + '/segundo-passo', {
            method: 'POST',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('[LOG] Valida√ßo conclu√≠da com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('modalSegundoPasso')).hide();
                location.reload();
            } else {
                alert('[LOG] ' + (result.message || 'Erro ao processar valida√ßo'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('[LOG] Erro ao enviar valida√ßo');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check"></i> ENVIAR';
        });
    });
})();

// ========================================
// MODAL DE COTA√á√ÉO DE PRE√áOS - JAVASCRIPT
// Carregado do arquivo externo: /public/js/modal-cotacao.js
// ========================================

// ========================================
// INTERCEPTAR SUBMIT DO FORMUL√ÅRIO "CONCLUIR COTA√á√ÉO"
// ========================================
(function() {
    'use strict';

    const formConcluir = document.getElementById('form-concluir');

    if (!formConcluir) {
        console.warn(' Formulrio de concluso no encontrado');
        return;
    }

    formConcluir.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevenir submit padro

        console.log('[INFO] Interceptando submit de CONCLUIR COTA√á√ÉO');

        // VALIDAR TAMANHO DO PDF ANTES DE ENVIAR
        const pdfInput = document.querySelector('input[name="anexo_pdf"]');
        if (pdfInput && pdfInput.files && pdfInput.files[0]) {
            const fileSizeKB = pdfInput.files[0].size / 1024;
            const fileSizeMB = fileSizeKB / 1024;
            console.log('[INFO] PDF selecionado:', pdfInput.files[0].name);
            console.log('[INFO] Tamanho:', fileSizeKB.toFixed(2) + ' KB (' + fileSizeMB.toFixed(2) + ' MB)');

            if (fileSizeKB > 100) { // Mximo 100KB devido ao timeout extremo do Caddy proxy
                alert('[AVISO] ARQUIVO MUITO GRANDE!\n\n' +
                      'O PDF tem ' + fileSizeKB.toFixed(0) + ' KB (' + fileSizeMB.toFixed(2) + ' MB)\n\n' +
                      ' Mximo permitido: 100 KB (0.1 MB)\n\n' +
                      ' SOLU√á√ÉO:\n' +
                      '1. Comprima o PDF online (use https://smallpdf.com/pt/comprimir-pdf)\n' +
                      '2. OU conclua SEM anexar PDF (√© opcional)\n\n' +
                      ' LIMITA√á√ÉO TCNICA: O proxy tem timeout muito curto para arquivos grandes.');
                return; // No enviar!
            }
        }

        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');

        // Salvar texto original do botao
        const btnOriginalHTML = submitBtn.innerHTML;

        // Desabilitar botao e mostrar loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> FINALIZANDO...';

        // Fazer requisi√ßo AJAX
        fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/concluir', {
            method: 'POST',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                'Accept': 'application/json'
            },
            body: formData
        })
        .then(response => {
            console.log('[INFO] Resposta recebida:', response.status);
            return response.json();
        })
        .then(result => {
            console.log('[LOG] Resultado:', result);

            if (result.success) {
                // Sucesso! Mostrar modal de concluso
                console.log('[INFO] Orcamento conclu√≠do com sucesso!');
                document.getElementById('modalConcluido').style.display = 'flex';
            } else {
                // Erro retornado pela API
                console.error('[ERRO] Erro na API:', result.message);
                alert('[LOG] Erro ao concluir or√ßamento: ' + (result.message || 'Erro desconhecido'));

                // Re-habilitar botao
                submitBtn.disabled = false;
                submitBtn.innerHTML = btnOriginalHTML;
            }
        })
        .catch(error => {
            console.error('[ERRO] Erro na requisi√ßo:', error);
            alert('[LOG] Erro ao concluir or√ßamento. Por favor, tente novamente.');

            // Re-habilitar botao
            submitBtn.disabled = false;
            submitBtn.innerHTML = btnOriginalHTML;
        });
    });

    console.log('[LOG] Listener de submit registrado para formulrio de concluso');
})();

// ========================================
// IMPORTAR FORNECEDOR - PNCP (BUSCA) E LOCAL (CADASTRADOS)
// ========================================
//  PROTE√á√ÉO: Listener √∫nico para importar fornecedor
window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
    'use strict';

    console.log('[CDF-FIX] ===== INICIALIZANDO M√ìDULO CDF (VERS√ÉO AGRESSIVA) =====');

    //  ESTRAT√âGIA SUPER AGRESSIVA: Capturar TODOS os eventos poss√≠veis

    // ESTRAT√âGIA 1: Captura na fase de captura (ANTES de qualquer outro listener)
    ['click', 'mousedown', 'mouseup', 'pointerdown', 'pointerup'].forEach(eventType => {
        document.addEventListener(eventType, function(e) {
            // Verificar se √© o bot√£o PNCP ou algum elemento dentro dele
            const btnPNCP = e.target.closest('#btn-importar-fornecedor-pncp');
            if (btnPNCP) {
                console.log('[CDF-FIX]  EVENTO ' + eventType + ' EM PNCP DETECTADO! ');

                // S√≥ processar no 'click' para evitar duplica√ß√£o
                if (eventType === 'click') {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('[CDF-FIX]  ABRINDO MODAL PNCP...');
                    abrirModalBuscaFornecedor('pncp');
                }
                return false;
            }

            // Verificar se √© o bot√£o LOCAL ou algum elemento dentro dele
            const btnLocal = e.target.closest('#btn-importar-fornecedor-local');
            if (btnLocal) {
                console.log('[CDF-FIX]  EVENTO ' + eventType + ' EM LOCAL DETECTADO! ');

                // S√≥ processar no 'click' para evitar duplica√ß√£o
                if (eventType === 'click') {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('[CDF-FIX]  ABRINDO MODAL LOCAL...');
                    abrirModalBuscaFornecedor('local');
                }
                return false;
            }
        }, true); // CAPTURA = true (antes de bubble)
    });

    // ESTRAT√âGIA 2: MutationObserver para detectar quando os bot√µes aparecem no DOM
    const observer = new MutationObserver(function(mutations) {
        const btnPNCP = document.getElementById('btn-importar-fornecedor-pncp');
        const btnLocal = document.getElementById('btn-importar-fornecedor-local');

        if (btnPNCP && !btnPNCP.dataset.listenerAdded) {
            console.log('[CDF-FIX]  Bot√£o PNCP detectado! Adicionando TODOS os listeners...');

            // Adicionar m√∫ltiplos eventos
            ['click', 'mousedown'].forEach(evt => {
                btnPNCP.addEventListener(evt, function(e) {
                    if (evt === 'click') {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        console.log('[CDF-FIX]  PNCP clicado via listener direto!');
                        abrirModalBuscaFornecedor('pncp');
                    }
                }, true); // Captura
            });

            // Adicionar atributo onclick direto no HTML (√∫ltima tentativa)
            btnPNCP.setAttribute('onclick', 'window.abrirModalPNCP(); return false;');
            btnPNCP.dataset.listenerAdded = 'true';
        }

        if (btnLocal && !btnLocal.dataset.listenerAdded) {
            console.log('[CDF-FIX]  Bot√£o LOCAL detectado! Adicionando TODOS os listeners...');

            // Adicionar m√∫ltiplos eventos
            ['click', 'mousedown'].forEach(evt => {
                btnLocal.addEventListener(evt, function(e) {
                    if (evt === 'click') {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        console.log('[CDF-FIX]  LOCAL clicado via listener direto!');
                        abrirModalBuscaFornecedor('local');
                    }
                }, true); // Captura
            });

            // Adicionar atributo onclick direto no HTML (√∫ltima tentativa)
            btnLocal.setAttribute('onclick', 'window.abrirModalLocal(); return false;');
            btnLocal.dataset.listenerAdded = 'true';
        }
    });

    // Observar mudan√ßas no body
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    console.log('[CDF-FIX]  Todas as estrat√©gias de captura ativadas!');

    // Fun√ß√µes GLOBAIS para serem chamadas pelo onclick
    window.abrirModalPNCP = function() {
        console.log('[CDF-FIX]  abrirModalPNCP() chamada via onclick!');
        abrirModalBuscaFornecedor('pncp');
    };

    window.abrirModalLocal = function() {
        console.log('[CDF-FIX]  abrirModalLocal() chamada via onclick!');
        abrirModalBuscaFornecedor('local');
    };

    // Fun√ßo para abrir o modal de busca
    function abrirModalBuscaFornecedor(tipo) {
        console.log('[CDF-FIX]  abrirModalBuscaFornecedor(' + tipo + ') executando...');
        const modalId = tipo === 'pncp' ? 'modalBuscaFornecedorPNCP' : 'modalBuscaFornecedorLocal';
        const modal = new bootstrap.Modal(document.getElementById(modalId));
        modal.show();

        // Limpar campo de busca
        const inputId = tipo === 'pncp' ? 'busca-fornecedor-pncp-input' : 'busca-fornecedor-local-input';
        document.getElementById(inputId).value = '';

        //  NOVO: Se for CADASTRO LOCAL, carregar automaticamente TODOS os fornecedores
        if (tipo === 'local') {
            console.log('[INFO] Modal LOCAL aberto - carregando fornecedores automaticamente...');

            // Mostrar loading
            document.getElementById(inputId + '-results').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #3b82f6; margin-bottom: 15px;"></i>
                    <p style="color: #1e40af; font-size: 14px; font-weight: 600;">Carregando fornecedores cadastrados...</p>
                    <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">Aguarde...</p>
                </div>
            `;

            // Carregar fornecedores (chamada sem parmetro de busca)
            setTimeout(() => {
                carregarTodosFornecedoresLocais();
            }, 300);
        } else {
            // PNCP: Mostrar mensagem de busca
            document.getElementById(inputId + '-results').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #9ca3af;">
                    <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                    <p style="font-size: 14px;">Digite um termo e clique em BUSCAR para encontrar fornecedores.</p>
                </div>
            `;
        }
    }

    //  NOVA FUN√á√ÉO: Carregar todos os fornecedores locais
    async function carregarTodosFornecedoresLocais() {
        const resultsId = 'busca-fornecedor-local-input-results';
        const resultsArea = document.getElementById(resultsId);

        try {
            console.log('[INFO] Buscando TODOS os fornecedores locais (sem filtro)...');

            // Fazer requisi√ßo SEM parmetro descricao (backend retorna todos)
            const response = await fetch(window.APP_BASE_PATH + '/fornecedores/buscar-por-item', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });

            const result = await response.json();
            console.log('[INFO] Fornecedores carregados:', result);

            if (result.success && result.fornecedores && result.fornecedores.length > 0) {
                renderizarFornecedores(result.fornecedores, resultsArea, 'local');
            } else {
                resultsArea.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-database" style="font-size: 48px; color: #6b7280; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="color: #374151; font-size: 14px; font-weight: 600;">Nenhum fornecedor cadastrado</p>
                        <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">
                            Cadastre fornecedores na guia "Fornecedores" do menu principal.
                        </p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('[ERRO] Erro ao carregar fornecedores:', error);
            resultsArea.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc2626; margin-bottom: 15px;"></i>
                    <p style="color: #374151; font-size: 14px; font-weight: 600;">Erro ao carregar fornecedores</p>
                    <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">${error.message}</p>
                </div>
            `;
        }
    }

    //  FUN√á√ÉO AUXILIAR: Renderizar lista de fornecedores
    function renderizarFornecedores(fornecedores, resultsArea, tipo) {
        let html = `
            <div style="background: #ecfdf5; border-left: 4px solid #10b981; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                <p style="margin: 0; font-size: 13px; color: #065f46; font-weight: 600;">
                    <i class="fas fa-check-circle"></i> ${fornecedores.length} fornecedor(es) encontrado(s)
                </p>
            </div>
        `;

        fornecedores.forEach((fornecedor, index) => {
            // Normalizar estrutura de dados
            const razaoSocial = fornecedor.razao_social || fornecedor.nome_fantasia || 'Nome no informado';
            const cnpj = fornecedor.cnpj || 'No informado';
            const telefone = fornecedor.telefone || fornecedor.telefone_contato || '';
            const email = fornecedor.email || fornecedor.email_contato || '';

            console.log(`Fornecedor ${index + 1}:`, {
                razaoSocial,
                cnpj,
                telefone: telefone || '(vazio)',
                email: email || '(vazio)',
                fornecedorOriginal: fornecedor
            });

            // Badge de origem
            let origemBadge = '';
            if (tipo === 'local' || fornecedor.origem === 'LOCAL') {
                origemBadge = `<span style="display: inline-block; background: #dbeafe; color: #1e40af; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-top: 5px;"> CADASTRO LOCAL</span>`;
            } else if (fornecedor.origem && fornecedor.origem.includes('PNCP')) {
                origemBadge = `<span style="display: inline-block; background: #fef3c7; color: #92400e; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-top: 5px;">PNCP</span>`;
            }

            // Escapar aspas nos data-attributes
            const emailEscaped = email.replace(/"/g, '&quot;');
            const telefoneEscaped = telefone.replace(/"/g, '&quot;');
            const razaoEscaped = razaoSocial.replace(/"/g, '&quot;');

            html += `
                <div class="card-fornecedor-selecionavel"
                     data-cnpj="${cnpj}"
                     data-razao="${razaoEscaped}"
                     data-email="${emailEscaped}"
                     data-telefone="${telefoneEscaped}"
                     style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h6 style="margin: 0 0 5px 0; font-size: 14px; color: #1f2937; font-weight: 600;">${razaoSocial}</h6>
                            <p style="margin: 0 0 5px 0; font-size: 12px; color: #374151;"><strong>CNPJ:</strong> ${cnpj}</p>
                            ${telefone ? `<p style="margin: 0 0 5px 0; font-size: 12px; color: #6b7280;"><i class="fas fa-phone"></i> ${telefone}</p>` : ''}
                            ${email ? `<p style="margin: 0 0 5px 0; font-size: 12px; color: #6b7280;"><i class="fas fa-envelope"></i> ${email}</p>` : ''}
                            ${origemBadge}
                        </div>
                        <button type="button" class="btn-selecionar-fornecedor" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; white-space: nowrap;">
                            <i class="fas fa-check"></i> SELECIONAR
                        </button>
                    </div>
                </div>
            `;
        });

        resultsArea.innerHTML = html;

        // Adicionar event listeners nos bot√µes de selecionar
        document.querySelectorAll('.btn-selecionar-fornecedor').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const card = this.closest('.card-fornecedor-selecionavel');
                selecionarFornecedor(card);
            });
        });

        // Adicionar event listener no card todo (clicar no card tamb√©m seleciona)
        document.querySelectorAll('.card-fornecedor-selecionavel').forEach(card => {
            card.addEventListener('click', function() {
                selecionarFornecedor(this);
            });
        });
    }

    // Handler: Buscar Fornecedor PNCP (botao dentro do modal)
    const btnBuscarPNCP = document.getElementById('btn-buscar-fornecedor-pncp');
    if (btnBuscarPNCP) {
        console.log('[LOG] Event listener adicionado ao botao BUSCAR do modal PNCP');
        btnBuscarPNCP.addEventListener('click', function() {
            console.log('[INFO] Botao BUSCAR (PNCP) clicado!');
            buscarFornecedores('pncp');
        });
    } else {
        console.error('[ERRO] Botao BUSCAR do modal PNCP nao encontrado!');
    }

    // Handler: Buscar Fornecedor LOCAL (botao dentro do modal)
    const btnBuscarLocal = document.getElementById('btn-buscar-fornecedor-local');
    if (btnBuscarLocal) {
        console.log('[LOG] Event listener adicionado ao botao BUSCAR do modal LOCAL');
        btnBuscarLocal.addEventListener('click', function() {
            console.log('[INFO] Botao BUSCAR (LOCAL) clicado!');
            buscarFornecedores('local');
        });
    } else {
        console.error('[ERRO] Botao BUSCAR do modal LOCAL nao encontrado!');
    }

    // Enter para buscar
    document.getElementById('busca-fornecedor-pncp-input') && document.getElementById('busca-fornecedor-pncp-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            buscarFornecedores('pncp');
        }
    });

    document.getElementById('busca-fornecedor-local-input') && document.getElementById('busca-fornecedor-local-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            buscarFornecedores('local');
        }
    });

    // Funcao de busca unificada
    async function buscarFornecedores(tipo) {
        const inputId = tipo === 'pncp' ? 'busca-fornecedor-pncp-input' : 'busca-fornecedor-local-input';
        const btnId = tipo === 'pncp' ? 'btn-buscar-fornecedor-pncp' : 'btn-buscar-fornecedor-local';
        const resultsId = inputId + '-results';

        const termo = document.getElementById(inputId).value.trim();
        const btn = document.getElementById(btnId);
        const resultsArea = document.getElementById(resultsId);

        if (!termo || termo.length < 3) {
            resultsArea.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #fbbf24;">
                    <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <p style="font-size: 14px; color: #92400e;">Digite pelo menos 3 caracteres para buscar.</p>
                </div>
            `;
            return;
        }

        // Loading
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> BUSCANDO...';
        resultsArea.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #3b82f6; margin-bottom: 15px;"></i>
                <p style="color: #1e40af; font-size: 14px; font-weight: 600;">Buscando fornecedores...</p>
                <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">Aguarde alguns segundos...</p>
            </div>
        `;

        try {
            let response, result;

            if (tipo === 'local') {
                // BUSCA LOCAL: Usar API especifica para fornecedores cadastrados localmente
                console.log('[INFO] Buscando fornecedores LOCAIS via /fornecedores/buscar-por-item');
                response = await fetch(window.APP_BASE_PATH + '/fornecedores/buscar-por-item?descricao=' + encodeURIComponent(termo), {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
            } else {
                // BUSCA PNCP: Usar API ampla do Mapa de Fornecedores
                console.log('[INFO] Buscando fornecedores PNCP via /api/fornecedores/buscar-por-produto');
                response = await fetch(window.APP_BASE_PATH + '/api/fornecedores/buscar-por-produto?termo=' + encodeURIComponent(termo), {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
            }

            result = await response.json();
            console.log('[INFO] Resposta da API:', result);

            if (result.success && result.fornecedores && result.fornecedores.length > 0) {
                let fornecedores = result.fornecedores;

                // Se for PNCP, filtrar para mostrar apenas fornecedores PNCP
                if (tipo === 'pncp') {
                    fornecedores = fornecedores.filter(f => f.origem && f.origem.includes('PNCP'));
                    console.log('[PNCP] ' + fornecedores.length + ' fornecedores PNCP apos filtro');
                } else {
                    // Se for LOCAL, nao precisa filtrar pois a API /buscar-por-item ja retorna apenas locais
                    console.log('[LOCAL] ' + fornecedores.length + ' fornecedores LOCAIS retornados');
                }

                if (fornecedores.length === 0) {
                    // Escapar termo para evitar quebra de sintaxe
                    const termoSeguro = String(termo || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    resultsArea.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-search" style="font-size: 48px; color: #6b7280; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p style="color: #374151; font-size: 14px;">Nenhum fornecedor ${tipo === 'pncp' ? 'do PNCP' : 'LOCAL'} encontrado para: <strong>${termoSeguro}</strong></p>
                        </div>
                    `;
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-search"></i> BUSCAR';
                    return;
                }

                // Usar funcao de renderizacao unificada
                renderizarFornecedores(fornecedores, resultsArea, tipo);

                // Restaurar botao
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> BUSCAR';

            } else {
                resultsArea.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-search" style="font-size: 48px; color: #6b7280; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="color: #374151; font-size: 14px;">Nenhum fornecedor encontrado.</p>
                    </div>
                `;
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> BUSCAR';
            }

        } catch (error) {
            console.error('[ERRO] Erro na busca:', error);
            resultsArea.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc2626; margin-bottom: 15px;"></i>
                    <p style="color: #374151; font-size: 14px; font-weight: 600;">Erro ao buscar fornecedores</p>
                    <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">${error.message}</p>
                </div>
            `;
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> BUSCAR';
        }
    }

    // Funcao para selecionar fornecedor e preencher formulario CDF
    function selecionarFornecedor(card) {
        const cnpj = card.getAttribute('data-cnpj');
        const razaoSocial = card.getAttribute('data-razao');
        const email = card.getAttribute('data-email');
        const telefone = card.getAttribute('data-telefone');

        console.log('[LOG] Fornecedor selecionado:', { cnpj, razaoSocial, email, telefone });
        console.log('[INFO] Email vazio?', email === '' || email === 'undefined' || !email);
        console.log('[INFO] Telefone vazio?', telefone === '' || telefone === 'undefined' || !telefone);

        // Preencher campos do formulrio CDF (Etapa 2)
        const cnpjInput = document.getElementById('cdf-cnpj-input');
        const razaoInput = document.getElementById('cdf-razao-social-input');
        const emailInput = document.getElementById('cdf-email-input');
        const telefoneInput = document.getElementById('cdf-telefone-input');

        console.log('[INFO] Campos encontrados:', {
            cnpjInput: !!cnpjInput,
            razaoInput: !!razaoInput,
            emailInput: !!emailInput,
            telefoneInput: !!telefoneInput
        });

        if (cnpjInput) cnpjInput.value = cnpj.replace(/\D/g, ''); // Apenas n√∫meros
        if (razaoInput) razaoInput.value = razaoSocial;

        // Fechar modal PRIMEIRO
        const modalPNCP = bootstrap.Modal.getInstance(document.getElementById('modalBuscaFornecedorPNCP'));
        const modalLocal = bootstrap.Modal.getInstance(document.getElementById('modalBuscaFornecedorLocal'));
        if (modalPNCP) modalPNCP.hide();
        if (modalLocal) modalLocal.hide();

        // IMPORTANTE: Aguardar o modal fechar antes de clicar no botao BUSCAR
        console.log('[INFO] Aguardando modal fechar para buscar CNPJ automaticamente...');

        setTimeout(() => {
            // Buscar o botao de BUSCAR CNPJ
            const btnBuscarCNPJ = document.getElementById('cdf-btn-buscar-cnpj');

            if (btnBuscarCNPJ) {
                console.log('[INFO] Clicando automaticamente no botao BUSCAR CNPJ...');
                btnBuscarCNPJ.click(); // Dispara a busca automtica na Receita Federal
            } else {
                console.error('[ERRO] Boto BUSCAR CNPJ no encontrado!');

                // Fallback: preencher dados manualmente se disponiveis
                if (email && email !== '' && email !== 'undefined' && email !== 'null') {
                    console.log('[LOG] Preenchendo email (fallback):', email);
                    if (emailInput) emailInput.value = email;
                }

                if (telefone && telefone !== '' && telefone !== 'undefined' && telefone !== 'null') {
                    console.log('[LOG] Preenchendo telefone (fallback):', telefone);
                    if (telefoneInput) telefoneInput.value = telefone;
                }
            }
        }, 300); // Aguarda 300ms para o modal fechar completamente
    }

    console.log('[FORNECEDORES] M√≥dulo de importa√ßo inicializado com sucesso!');

    console.log('[ELABORAR] Todas as inicializa√ß√µes conclu√≠das!');

    console.log('[ELABORAR] Script carregado. Aguardando DOMContentLoaded...');
    console.log('[ELABORAR]  VERS√ÉO: 17-10-2025 17:18 - CACHE FOR√áADO');
    console.log('[ELABORAR]  Total de linhas: 10460');
    console.log('[ELABORAR]  ERRO NA LINHA 8428? = CACHE ANTIGO! LIMPE COM CTRL+SHIFT+DELETE');

    // ALERTA VISUAL SE CACHE ANTIGO
    if (typeof window !== 'undefined') {
        const versaoCorreta = '20251017171800';
        if (!document.body.getAttribute('data-versao-cache')) {
            document.body.setAttribute('data-versao-cache', versaoCorreta);
            console.log('[ELABORAR] Versao cache atualizada:', versaoCorreta);
        }
    }

}, 'importarFornecedorCDFInit'); // FIM DOMContentLoaded - IMPORTAR FORNECEDOR CDF
</script>

<!-- MODAL: BUSCAR FORNECEDOR - PNCP (BUSQUE O MELHOR FORNECEDOR) -->
<!-- MODAL: ADICIONAR FORNECEDOR - RECEITA FEDERAL (BUSCA POR CNPJ) -->
<div class="modal fade" id="modalAdicionarFornecedorCNPJ" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                <h5 class="modal-title" style="font-size: 16px; font-weight: 600; margin: 0;">
                    <i class="fas fa-building"></i> ADICIONAR FORNECEDOR - RECEITA FEDERAL
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <!-- Campo de CNPJ -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; color: #374151; font-weight: 600; margin-bottom: 8px;">
                        <i class="fas fa-id-card"></i> CNPJ do Fornecedor:
                    </label>
                    <div style="display: flex; gap: 10px;">
                        <input
                            type="text"
                            id="busca-fornecedor-cnpj-input"
                            placeholder="00.000.000/0000-00"
                            maxlength="18"
                            style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
                        >
                        <button
                            type="button"
                            id="btn-buscar-fornecedor-cnpj"
                            class="btn btn-success"
                            style="padding: 10px 20px; font-size: 13px; font-weight: 600; white-space: nowrap;"
                        >
                            <i class="fas fa-search"></i> BUSCAR
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #6b7280; margin: 8px 0 0 0;">
                        <i class="fas fa-info-circle"></i> Busca direta na Receita Federal do Brasil
                    </p>
                </div>

                <!-- √Årea de Resultado -->
                <div id="busca-fornecedor-cnpj-resultado" style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; background: #f9fafb; display: none;">
                    <!-- Ser√° preenchido via JavaScript -->
                </div>
            </div>
            <div class="modal-footer" style="background: #f9fafb; padding: 15px 20px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 13px;">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalBuscaFornecedorPNCP" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                <h5 class="modal-title" style="font-size: 16px; font-weight: 600; margin: 0;">
                    <i class="fas fa-search-dollar"></i> BUSQUE O MELHOR FORNECEDOR - PNCP
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <!-- Campo de Busca -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; color: #374151; font-weight: 600; margin-bottom: 8px;">
                        Busca por Nome, CNPJ, Produto ou Palavra-chave:
                    </label>
                    <div style="display: flex; gap: 10px;">
                        <input
                            type="text"
                            id="busca-fornecedor-pncp-input"
                            placeholder="Digite qualquer termo (ex: medicamento, caneta, CNPJ, nome da empresa)"
                            style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
                        >
                        <button
                            type="button"
                            id="btn-buscar-fornecedor-pncp"
                            class="btn btn-primary"
                            style="padding: 10px 20px; font-size: 13px; font-weight: 600; white-space: nowrap;"
                        >
                            <i class="fas fa-search"></i> BUSCAR
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #6b7280; margin: 8px 0 0 0;">
                        <i class="fas fa-info-circle"></i> Buscando fornecedores que venderam o produto/servi√ßo
                    </p>
                </div>

                <!-- √Årea de Resultados -->
                <div id="busca-fornecedor-pncp-input-results" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; background: #f9fafb;">
                    <div style="text-align: center; padding: 40px; color: #9ca3af;">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="font-size: 14px;">Digite um termo e clique em BUSCAR para encontrar fornecedores.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background: #f9fafb; padding: 15px 20px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 13px;">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: BUSCAR FORNECEDOR - CADASTRO LOCAL -->
<div class="modal fade" id="modalBuscaFornecedorLocal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white;">
                <h5 class="modal-title" style="font-size: 16px; font-weight: 600; margin: 0;">
                    <i class="fas fa-database"></i> IMPORTAR - CADASTRO LOCAL
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <!-- Campo de Busca -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; color: #374151; font-weight: 600; margin-bottom: 8px;">
                        Busca por Nome, CNPJ, Produto ou Palavra-chave:
                    </label>
                    <div style="display: flex; gap: 10px;">
                        <input
                            type="text"
                            id="busca-fornecedor-local-input"
                            placeholder="Digite qualquer termo (ex: medicamento, caneta, CNPJ, nome da empresa)"
                            style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;"
                        >
                        <button
                            type="button"
                            id="btn-buscar-fornecedor-local"
                            class="btn btn-primary"
                            style="padding: 10px 20px; font-size: 13px; font-weight: 600; white-space: nowrap;"
                        >
                            <i class="fas fa-search"></i> BUSCAR
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #6b7280; margin: 8px 0 0 0;">
                        <i class="fas fa-info-circle"></i> Busca apenas fornecedores ja cadastrados localmente
                    </p>
                </div>

                <!-- √Årea de Resultados -->
                <div id="busca-fornecedor-local-input-results" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; background: #f9fafb;">
                    <div style="text-align: center; padding: 40px; color: #9ca3af;">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="font-size: 14px;">Digite um termo e clique em BUSCAR para encontrar fornecedores.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background: #f9fafb; padding: 15px 20px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 13px;">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>


<!-- REFACTOR: 3 Funcionalidades (Modal + CNPJ + Salvamento) -->
<script>
(function() {
    'use strict';

    console.log('[REFACTOR] Init...');

    // 1. MODAL CONTRATACOES SIMILARES - REMOVIDO (conflitava com inicializa√ß√£o completa)
    // A inicializa√ß√£o completa do modal est√° nas linhas 6408-6903 com toda a l√≥gica do wizard

    // 2. BUSCA CNPJ
    function initCNPJ() {
        const input = document.getElementById('orcamentista_cpf_cnpj');
        const feedback = document.getElementById('cpf-cnpj-feedback');

        if (!input) {
            console.error('[REFACTOR] CNPJ input not found');
            return;
        }

        function mask(v) {
            v = v.replace(/\D/g, '');
            if (v.length <= 11) {
                v = v.replace(/(\d{3})(\d)/, '$1.$2');
                v = v.replace(/(\d{3})(\d)/, '$1.$2');
                v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            } else {
                v = v.replace(/^(\d{2})(\d)/, '$1.$2');
                v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                v = v.replace(/\.(\d{3})(\d)/, '.$1/$2');
                v = v.replace(/(\d{4})(\d)/, '$1-$2');
            }
            return v;
        }

        function validateCNPJ(cnpj) {
            cnpj = cnpj.replace(/\D/g, '');
            if (cnpj.length !== 14) return false;
            if (/^(\d)\1+$/.test(cnpj)) return false;

            let size = cnpj.length - 2;
            let numbers = cnpj.substring(0, size);
            let digits = cnpj.substring(size);
            let sum = 0;
            let pos = size - 7;

            for (let i = size; i >= 1; i--) {
                sum += numbers.charAt(size - i) * pos--;
                if (pos < 2) pos = 9;
            }

            let result = sum % 11 < 2 ? 0 : 11 - sum % 11;
            if (result != digits.charAt(0)) return false;

            size = size + 1;
            numbers = cnpj.substring(0, size);
            sum = 0;
            pos = size - 7;

            for (let i = size; i >= 1; i--) {
                sum += numbers.charAt(size - i) * pos--;
                if (pos < 2) pos = 9;
            }

            result = sum % 11 < 2 ? 0 : 11 - sum % 11;
            if (result != digits.charAt(1)) return false;

            return true;
        }

        async function fetchCNPJ(cnpj) {
            const clean = cnpj.replace(/\D/g, '');

            if (feedback) {
                feedback.innerHTML = '<span style="color: #2563eb;"><i class="fas fa-spinner fa-spin"></i> Consultando...</span>';
            }

            try {
                const resp = await fetch(window.APP_BASE_PATH + '/orcamentos/consultar-cnpj/' + clean);
                const data = await resp.json();

                if (!resp.ok || !data.success) {
                    if (feedback) {
                        feedback.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> CNPJ nao encontrado</span>';
                    }
                    return;
                }

                const d = data.data;
                console.log('[REFACTOR] CNPJ data:', d);

                if (d.razao_social || d.nome) {
                    const f = document.getElementById('orcamentista_nome');
                    if (f) f.value = d.razao_social || d.nome;
                }

                if (d.cep) {
                    const f1 = document.getElementById('orcamentista_cep_manual');
                    const f2 = document.getElementById('orcamentista_cep');
                    if (f1) f1.value = d.cep;
                    if (f2) f2.value = d.cep;
                }

                if (d.uf) {
                    const f1 = document.getElementById('orcamentista_uf_manual');
                    const f2 = document.getElementById('orcamentista_uf');
                    if (f1) f1.value = d.uf;
                    if (f2) f2.value = d.uf;
                }

                if (d.endereco) {
                    const f1 = document.getElementById('orcamentista_endereco_manual');
                    const f2 = document.getElementById('orcamentista_endereco');
                    if (f1) f1.value = d.endereco;
                    if (f2) f2.value = d.endereco;
                }

                if (d.razao_social) {
                    const f = document.getElementById('orcamentista_razao_social');
                    if (f) f.value = d.razao_social;
                }

                if (d.municipio) {
                    const f = document.getElementById('orcamentista_cidade');
                    if (f) f.value = d.municipio;
                }

                if (feedback) {
                    feedback.innerHTML = '<span style="color: #16a34a;"><i class="fas fa-check-circle"></i> CNPJ valido - Dados OK!</span>';
                }

                console.log('[REFACTOR] Fields filled!');

            } catch (err) {
                console.error('[REFACTOR] CNPJ error:', err);
                if (feedback) {
                    feedback.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-exclamation-triangle"></i> Erro ao consultar</span>';
                }
            }
        }

        input.addEventListener('input', function() {
            this.value = mask(this.value);
        });

        input.addEventListener('blur', function() {
            const v = this.value.replace(/\D/g, '');

            if (v.length === 14) {
                if (validateCNPJ(v)) {
                    if (feedback) {
                        feedback.innerHTML = '<span style="color: #16a34a;"><i class="fas fa-check-circle"></i> CNPJ valido</span>';
                    }
                    fetchCNPJ(this.value);
                } else {
                    if (feedback) {
                        feedback.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> CNPJ invalido</span>';
                    }
                }
            }
        });

        console.log('[REFACTOR] CNPJ ready!');
    }

    // 3. SALVAMENTO ORCAMENTISTA
    function initSave() {
        const btn = document.getElementById('btn-salvar-orcamentista');

        if (!btn) {
            console.error('[REFACTOR] Save button not found');
            return;
        }

        const orcId = {!! $orcamento->id ?? 'null' !!};
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);

        newBtn.addEventListener('click', async function(e) {
            e.preventDefault();

            console.log('[REFACTOR] Saving...');

            const fd = new FormData();
            fd.append('_token', csrfToken);
            fd.append('orcamentista_nome', document.getElementById('orcamentista_nome')?.value || '');
            fd.append('orcamentista_cpf_cnpj', document.getElementById('orcamentista_cpf_cnpj')?.value || '');
            fd.append('orcamentista_razao_social', document.getElementById('orcamentista_razao_social')?.value || '');
            fd.append('orcamentista_endereco', document.getElementById('orcamentista_endereco')?.value || '');
            fd.append('orcamentista_cep', document.getElementById('orcamentista_cep')?.value || '');
            fd.append('orcamentista_cidade', document.getElementById('orcamentista_cidade')?.value || '');
            fd.append('orcamentista_uf', document.getElementById('orcamentista_uf')?.value || '');
            fd.append('orcamentista_telefone', document.getElementById('orcamentista_telefone')?.value || '');
            fd.append('orcamentista_email', document.getElementById('orcamentista_email')?.value || '');

            const brasao = document.getElementById('brasao_file');
            if (brasao && brasao.files.length > 0) {
                fd.append('brasao_file', brasao.files[0]);
            }

            console.log('[REFACTOR] FormData:', Array.from(fd.entries()));

            const oldText = newBtn.innerHTML;
            newBtn.disabled = true;
            newBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

            try {
                const resp = await fetch(window.APP_BASE_PATH + '/orcamentos/' + orcId + '/salvar-orcamentista', {
                    method: 'POST',
                    body: fd
                });

                const data = await resp.json();

                if (resp.ok && data.success) {
                    console.log('[REFACTOR] Saved!');
                    alert('Dados salvos com sucesso!');

                    if (brasao) {
                        brasao.value = '';
                    }

                } else {
                    console.error('[REFACTOR] Save error:', data);
                    let errorMsg = 'Falha ao salvar';
                    if (data.errors) {
                        const fields = Object.keys(data.errors).join(', ');
                        errorMsg = 'Campos obrigatorios: ' + fields;
                    } else if (data.message) {
                        errorMsg = data.message;
                    }
                    alert('Erro: ' + errorMsg);
                }

            } catch (err) {
                console.error('[REFACTOR] Save error:', err);
                alert('Erro ao salvar. Verifique sua conexao.');
            } finally {
                newBtn.disabled = false;
                newBtn.innerHTML = oldText;
            }
        });

        console.log('[REFACTOR] Save ready!');
    }

    //  PROTE√á√ÉO: INIT
    if (document.readyState === 'loading') {
        window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
            console.log('[REFACTOR] DOM ready!');
            setTimeout(function() {
                // initModal(); // REMOVIDO - conflitava com inicializa√ß√£o completa
                initCNPJ();
                initSave();
                console.log('[REFACTOR] All ready!');
            }, 500);
        }, 'refactorInit');
    } else {
        console.log('[REFACTOR] DOM already loaded!');
        setTimeout(function() {
            // initModal(); // REMOVIDO - conflitava com inicializa√ß√£o completa
            initCNPJ();
            initSave();
            console.log('[REFACTOR] All ready!');
        }, 500);
    }

})();
</script>


{{-- ============================================================================
     REFACTOR COMPLETO DOS MODALS - CRIADO DO ZERO (16/10/2025)
     - Modal de An√°lise Cr√≠tica das Amostras
     - Modal de Alterar Item
     - Modal "Busque o Melhor Fornecedor" (PNCP)
     - Modal "Importar Cadastro Local"
     ============================================================================ --}}
<script>
/**
 * ============================================================================
 * REFACTOR COMPLETO DOS MODALS - CRIADO DO ZERO
 * ============================================================================
 * Data: 16/10/2025
 * Modals refatorados:
 * 1. Modal de An√°lise Cr√≠tica das Amostras
 * 2. Modal de Alterar Item
 * 3. Modal "Busque o Melhor Fornecedor" (PNCP)
 * 4. Modal "Importar Cadastro Local"
 * ============================================================================
 */

(function() {
    'use strict';

    console.log('[MODAL-REFACTOR] Iniciando refactor completo dos modals...');

    // ========================================================================
    // UTILIDADES GLOBAIS
    // ========================================================================

    const utils = {
        // Formatar moeda BRL
        formatarMoeda: function(valor) {
            if (!valor && valor !== 0) return 'R$ 0,00';
            return 'R$ ' + parseFloat(valor).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        },

        // Remover listeners antigos clonando elemento
        limparEventos: function(elemento) {
            if (!elemento) return null;
            const novo = elemento.cloneNode(true);
            elemento.parentNode.replaceChild(novo, elemento);
            return novo;
        },

        // Escapar HTML para prevenir quebra de sintaxe
        escapeHtml: function(texto) {
            if (!texto) return '';
            return String(texto)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        },

        // Escapar strings para uso em alerts (escapa aspas mas n√£o entities HTML)
        escapeAlert: function(texto) {
            if (!texto) return '';
            return String(texto)
                .replace(/\\/g, '\\\\')  // Backslash primeiro
                .replace(/"/g, '\\"')     // Aspas duplas
                .replace(/'/g, "\\'")     // Aspas simples
                .replace(/\n/g, '\\n')    // Newline
                .replace(/\r/g, '\\r');   // Carriage return
        },

        // Fetch com tratamento de erro
        fetchAPI: async function(url, options = {}) {
            try {
                const response = await fetch(url, options);
                const data = await response.json();
                return { ok: response.ok, status: response.status, data };
            } catch (error) {
                console.error('[FETCH-ERROR]', error);
                return { ok: false, error: error.message };
            }
        },

        // Mostrar loading
        showLoading: function(elemento, texto = 'Carregando...') {
            if (!elemento) return;
            elemento.dataset.originalHtml = elemento.innerHTML;
            elemento.disabled = true;
            const textoEscape = this.escapeHtml(texto);
            elemento.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + textoEscape;
        },

        // Esconder loading
        hideLoading: function(elemento) {
            if (!elemento) return;
            elemento.disabled = false;
            elemento.innerHTML = elemento.dataset.originalHtml || elemento.innerHTML;
        }
    };

    // ========================================================================
    // 1. MODAL: AN√ÅLISE CR√çTICA DAS AMOSTRAS
    // ========================================================================

    const ModalAnaliseCritica = {
        modal: null,
        modalElement: null,
        currentItemId: null,

        init: function() {
            console.log('[ANALISE-CRITICA] Inicializando modal...');

            this.modalElement = document.getElementById('modalAnaliseCritica');
            if (!this.modalElement) {
                console.error('[ANALISE-CRITICA] Modal element not found!');
                return;
            }

            this.modal = new bootstrap.Modal(this.modalElement, {
                backdrop: 'static',
                keyboard: false
            });

            this.setupEventListeners();
            console.log('[ANALISE-CRITICA] Modal inicializado!');
        },

        setupEventListeners: function() {
            console.log('[ANALISE-CRITICA] Configurando event listeners...');

            // Bot√µes de abrir modal (delega√ß√£o de eventos)
            document.addEventListener('click', (e) => {
                //  S√ì PROCESSAR se for realmente bot√£o de an√°lise cr√≠tica
                const btn = e.target.closest('.btn-analise');

                if (btn) {
                    e.preventDefault();
                    e.stopPropagation();

                    console.log('[ANALISE-CRITICA] ===== BOT√ÉO CLICADO =====');
                    console.log('[ANALISE-CRITICA] btn.dataset:', btn.dataset);
                    console.log('[ANALISE-CRITICA] btn.dataset.itemId:', btn.dataset.itemId);

                    const itemId = btn.dataset.itemId || btn.getAttribute('data-item-id');
                    console.log('[ANALISE-CRITICA] Item ID extra√≠do:', itemId);

                    if (itemId) {
                        console.log('[ANALISE-CRITICA]  Chamando this.abrir(' + itemId + ')');
                        this.abrir(itemId);
                    } else {
                        console.error('[ANALISE-CRITICA]  Item ID n√£o encontrado!');
                    }
                }
                //  REMOVIDO: Logs desnecess√°rios que polu√≠am o console em TODOS os cliques
            });

            // Bot√£o remover amostra individual
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.btn-remover-amostra');
                if (btn) {
                    e.preventDefault();
                    const amostraId = btn.dataset.amostraId;
                    if (amostraId && confirm('Deseja remover esta amostra?')) {
                        this.removerAmostra(amostraId);
                    }
                }
            });

            // Bot√£o remover todas as amostras
            const btnRemoverTodas = document.getElementById('analise-btn-remover-todas-amostras');
            if (btnRemoverTodas) {
                const newBtn = utils.limparEventos(btnRemoverTodas);
                newBtn.addEventListener('click', () => {
                    if (confirm('Deseja remover TODAS as amostras? Esta acao nao pode ser desfeita.')) {
                        this.removerTodasAmostras();
                    }
                });
            }

            // Checkboxes de cr√≠ticas
            const checkbox1 = document.getElementById('analise-critica-medidas-desiguais');
            const checkbox2 = document.getElementById('analise-critica-valores-discrepantes');

            if (checkbox1) {
                const newCheck1 = utils.limparEventos(checkbox1);
                newCheck1.addEventListener('change', () => this.salvarCriticas());
            }

            if (checkbox2) {
                const newCheck2 = utils.limparEventos(checkbox2);
                newCheck2.addEventListener('change', () => this.salvarCriticas());
            }

            console.log('[ANALISE-CRITICA] Event listeners configurados!');
        },

        abrir: async function(itemId) {
            console.log('[ANALISE-CRITICA] ===== ABRIR MODAL =====');
            console.log('[ANALISE-CRITICA] Item ID:', itemId);
            console.log('[ANALISE-CRITICA] Modal object:', this.modal);
            console.log('[ANALISE-CRITICA] Modal element:', this.modalElement);

            //  VERIFICA√á√ÉO DE SEGURAN√áA: Modal existe?
            if (!this.modal || typeof this.modal.show !== 'function') {
                console.error('[ANALISE-CRITICA]  Modal n√£o inicializado! Tentando inicializar...');
                this.init(); // Tenta inicializar novamente
                if (!this.modal) {
                    console.error('[ANALISE-CRITICA]  Falha ao inicializar modal!');
                    alert('Erro: Modal de An√°lise Cr√≠tica n√£o foi carregado. Recarregue a p√°gina.');
                    return;
                }
            }

            this.currentItemId = itemId;

            //  FIX: Definir vari√°vel global para uso no bot√£o "Aplicar Saneamento"
            window.currentAnaliseCriticaItemId = itemId;

            // Limpar dados anteriores
            this.limparDados();

            // Mostrar modal ANTES de carregar (para o usu√°rio ver que est√° carregando)
            this.modal.show();

            // Carregar dados do item (ass√≠ncrono)
            await this.carregarDados(itemId);
        },

        limparDados: function() {
            document.getElementById('analise-item-descricao').textContent = '-';
            document.getElementById('analise-juizo-num-amostras').textContent = '0';
            document.getElementById('analise-juizo-media').textContent = 'R$ 0,00';
            document.getElementById('analise-juizo-desvio').textContent = '0,00';
            document.getElementById('analise-juizo-limite-inf').textContent = 'R$ 0,00 (DP - media)';
            document.getElementById('analise-juizo-limite-sup').textContent = 'R$ 0,00 (DP + media)';
            document.getElementById('analise-juizo-criticas').textContent = '0';
            document.getElementById('analise-juizo-expurgadas').textContent = '0';
            document.getElementById('analise-serie-tbody').innerHTML = '';
            document.getElementById('analise-serie-vazia').style.display = 'block';
            document.getElementById('analise-serie-tabela').style.display = 'none';
        },

        carregarDados: async function(itemId) {
            // PEGAR DADOS DO OR√áAMENTO COMPLETO (n√£o de amostras!)
            const url = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID;

            const result = await utils.fetchAPI(url, {
                method: 'GET',
                headers: {'Accept': 'application/json'}
            });

            if (!result.ok) {
                alert('Erro ao carregar dados do item');
                return;
            }

            // Encontrar o item no or√ßamento
            const item = result.data.itens?.find(i => i.id == itemId);
            if (!item) {
                alert('Item n√£o encontrado');
                return;
            }

            // PREENCHER COM DADOS DO PR√ìPRIO ITEM
            document.getElementById('analise-item-descricao').textContent = item.descricao || '-';

            const precoUnit = parseFloat(item.preco_unitario) || 0;
            const quantidade = parseFloat(item.quantidade) || 0;
            const precoTotal = precoUnit * quantidade;

            // PREENCHER ESTAT√çSTICAS COM OS VALORES DO ITEM
            document.getElementById('analise-juizo-num-amostras').textContent = '1';
            document.getElementById('analise-juizo-media').textContent = utils.formatarMoeda(precoUnit);
            document.getElementById('analise-juizo-desvio').textContent = '0,00';
            document.getElementById('analise-juizo-limite-inf').textContent = utils.formatarMoeda(precoUnit) + ' (DP - media)';
            document.getElementById('analise-juizo-limite-sup').textContent = utils.formatarMoeda(precoUnit) + ' (DP + media)';
            document.getElementById('analise-juizo-criticas').textContent = '0';
            document.getElementById('analise-juizo-expurgadas').textContent = '0';

            document.getElementById('analise-metodo-num-validas').textContent = '1';
            document.getElementById('analise-metodo-desvio').textContent = '0,00';
            document.getElementById('analise-metodo-coef-var').textContent = '0,00%';
            document.getElementById('analise-metodo-menor').textContent = utils.formatarMoeda(precoUnit);
            document.getElementById('analise-metodo-media').textContent = utils.formatarMoeda(precoUnit);
            document.getElementById('analise-metodo-mediana').textContent = utils.formatarMoeda(precoUnit);

            document.getElementById('analise-final-mediana').textContent = utils.formatarMoeda(precoUnit);
            document.getElementById('analise-final-media').textContent = utils.formatarMoeda(precoUnit);
            document.getElementById('analise-final-menor').textContent = utils.formatarMoeda(precoUnit);
            document.getElementById('analise-final-tendencia').textContent = utils.formatarMoeda(precoUnit);

            // Criar UMA amostra com os dados do item
            const amostra = {
                fonte: 'Or√ßamento Atual',
                marca: item.indicacao_marca || '-',
                data: new Date().toLocaleDateString('pt-BR'),
                medida: item.medida_fornecimento || '-',
                quantidade_original: quantidade,
                valor_unitario: precoUnit,
                situacao: 'valida'
            };

            this.preencherAmostras([amostra]);

            // Restaurar estado dos checkboxes de cr√≠ticas (se existirem dados salvos)
            this.restaurarCriticas(item.criticas_dados);

            // Carregar justificativas e observa√ß√µes
            await this.carregarJustificativas(itemId);
        },

        preencherAmostras: function(amostras) {
            const tbody = document.getElementById('analise-serie-tbody');
            tbody.innerHTML = '';

            if (!amostras || amostras.length === 0) {
                document.getElementById('analise-serie-vazia').style.display = 'block';
                document.getElementById('analise-serie-tabela').style.display = 'none';
                return;
            }

            document.getElementById('analise-serie-vazia').style.display = 'none';
            document.getElementById('analise-serie-tabela').style.display = 'block';

            amostras.forEach((amostra, index) => {
                const tr = document.createElement('tr');

                // Determinar cor da situa√ß√£o
                let situacaoBadge = '<span class="badge bg-success">VALIDA</span>';
                if (amostra.situacao === 'expurgada') {
                    situacaoBadge = '<span class="badge bg-danger">EXPURGADA</span>';
                } else if (amostra.situacao === 'critica') {
                    situacaoBadge = '<span class="badge bg-warning text-dark">CRITICA</span>';
                }

                tr.innerHTML = '\n' +
                    '                    <td style="text-align: center;">' + (index + 1) + '</td>\n' +
                    '                    <td style="text-align: center;">' + situacaoBadge + '</td>\n' +
                    '                    <td>' + utils.escapeHtml(amostra.fonte || 'N/A') + '</td>\n' +
                    '                    <td>' + utils.escapeHtml(amostra.marca || '-') + '</td>\n' +
                    '                    <td>' + utils.escapeHtml(amostra.data || '-') + '</td>\n' +
                    '                    <td>' + utils.escapeHtml(amostra.medida || '-') + '</td>\n' +
                    '                    <td style="text-align: right;">' + utils.escapeHtml(amostra.quantidade_original || '-') + '</td>\n' +
                    '                    <td style="text-align: right; font-weight: 600;">' + utils.formatarMoeda(amostra.valor_unitario) + '</td>\n' +
                    '                    <td style="text-align: center;">\n' +
                    '                        <button type="button" class="btn btn-sm btn-danger btn-remover-amostra" data-amostra-id="' + amostra.id + '">\n' +
                    '                            <i class="fas fa-trash"></i>\n' +
                    '                        </button>\n' +
                    '                    </td>\n' +
                    '                ';

                tbody.appendChild(tr);
            });
        },

        removerAmostra: async function(amostraId) {
            console.log('[ANALISE-CRITICA] Removendo amostra:', amostraId);

            const url = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/amostras/' + amostraId;

            const result = await utils.fetchAPI(url, {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content || ''
                }
            });

            if (!result.ok) {
                console.error('[ANALISE-CRITICA] Erro ao remover amostra:', result);
                alert('Erro ao remover amostra. Tente novamente.');
                return;
            }

            alert('Amostra removida com sucesso!');

            // Recarregar dados
            await this.carregarDados(this.currentItemId);
        },

        removerTodasAmostras: async function() {
            console.log('[ANALISE-CRITICA] Removendo todas as amostras do item:', this.currentItemId);

            const url = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + this.currentItemId + '/amostras';

            const result = await utils.fetchAPI(url, {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content || ''
                }
            });

            if (!result.ok) {
                console.error('[ANALISE-CRITICA] Erro ao remover todas as amostras:', result);
                alert('Erro ao remover amostras. Tente novamente.');
                return;
            }

            alert('Todas as amostras foram removidas!');

            // Recarregar dados
            await this.carregarDados(this.currentItemId);
        },

        salvarCriticas: async function() {
            console.log('[ANALISE-CRITICA] Salvando criticas...');

            const medidasDesiguais = document.getElementById('analise-critica-medidas-desiguais').checked;
            const valoresDiscrepantes = document.getElementById('analise-critica-valores-discrepantes').checked;

            const url = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + this.currentItemId + '/criticas';

            const result = await utils.fetchAPI(url, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify({
                    medidas_desiguais: medidasDesiguais,
                    valores_discrepantes: valoresDiscrepantes
                })
            });

            if (!result.ok) {
                console.error('[ANALISE-CRITICA] Erro ao salvar criticas:', result);
                alert('Erro ao salvar criticas. Tente novamente.');
                return;
            }

            console.log('[ANALISE-CRITICA] Criticas salvas!');
        },

        restaurarCriticas: function(criticasDadosJson) {
            console.log('[ANALISE-CRITICA] Restaurando checkboxes de cr√≠ticas...');

            // Limpar checkboxes primeiro
            const checkbox1 = document.getElementById('analise-critica-medidas-desiguais');
            const checkbox2 = document.getElementById('analise-critica-valores-discrepantes');

            if (checkbox1) checkbox1.checked = false;
            if (checkbox2) checkbox2.checked = false;

            // Se n√£o h√° dados salvos, parar aqui
            if (!criticasDadosJson) {
                console.log('[ANALISE-CRITICA] Nenhum dado de cr√≠ticas salvo anteriormente');
                return;
            }

            try {
                // Parse do JSON (pode ser string ou objeto)
                const criticasDados = typeof criticasDadosJson === 'string'
                    ? JSON.parse(criticasDadosJson)
                    : criticasDadosJson;

                console.log('[ANALISE-CRITICA] Dados de cr√≠ticas encontrados:', criticasDados);

                // Restaurar estado dos checkboxes
                if (checkbox1 && criticasDados.medidas_desiguais === true) {
                    checkbox1.checked = true;
                }

                if (checkbox2 && criticasDados.valores_discrepantes === true) {
                    checkbox2.checked = true;
                }

                console.log('[ANALISE-CRITICA] Checkboxes restaurados com sucesso');
            } catch (error) {
                console.error('[ANALISE-CRITICA] Erro ao parsear criticas_dados:', error);
            }
        },

        carregarJustificativas: async function(itemId) {
            console.log('[JUSTIFICATIVAS] Carregando justificativas do item:', itemId);

            const secao = document.getElementById('secao-justificativos-agregados');
            const loading = document.getElementById('justificativos-loading');
            const container = document.getElementById('justificativos-container');
            const vazio = document.getElementById('justificativos-vazio');

            if (!secao || !loading || !container || !vazio) {
                console.error('[JUSTIFICATIVAS] Elementos n√£o encontrados');
                return;
            }

            // Mostrar se√ß√£o e loading
            secao.style.display = 'block';
            loading.style.display = 'block';
            container.style.display = 'none';
            vazio.style.display = 'none';

            // Buscar justificativas
            const url = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + itemId + '/justificativas';

            const result = await utils.fetchAPI(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });

            // Esconder loading
            loading.style.display = 'none';

            if (!result.ok || !result.data.success) {
                console.error('[JUSTIFICATIVAS] Erro ao carregar:', result);
                vazio.style.display = 'block';
                return;
            }

            const justificativas = result.data.justificativas || [];

            if (justificativas.length === 0) {
                vazio.style.display = 'block';
                return;
            }

            // Renderizar justificativas
            container.innerHTML = '';
            container.style.display = 'block';

            justificativas.forEach((just, index) => {
                const card = document.createElement('div');
                card.className = 'justificativa-card';
                card.style.cssText = `
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 15px;
                    background: #ffffff;
                `;

                let headerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 24px; margin-right: 10px;">${just.icone}</span>
                        <div style="flex: 1;">
                            <strong style="color: #1f2937; font-size: 14px;">${utils.escapeHtml(just.tipo)}</strong>
                            <br>
                            <small style="color: #6b7280;">
                                ${just.data ? new Date(just.data).toLocaleString('pt-BR') : 'Data n√£o informada'}
                            </small>
                        </div>
                    </div>
                `;

                let bodyHTML = '';

                // Fornecedor
                if (just.fornecedor) {
                    bodyHTML += `
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #3b82f6;">Fornecedor:</strong>
                            ${utils.escapeHtml(just.fornecedor)}
                        </div>
                    `;
                }

                // Ente p√∫blico
                if (just.ente) {
                    bodyHTML += `
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #3b82f6;">Ente P√∫blico:</strong>
                            ${utils.escapeHtml(just.ente)}
                        </div>
                    `;
                }

                // Marca (se houver)
                if (just.marca) {
                    bodyHTML += `
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #3b82f6;">Marca:</strong>
                            ${utils.escapeHtml(just.marca)}
                        </div>
                    `;
                }

                // Pre√ßo (se houver)
                if (just.preco) {
                    bodyHTML += `
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #3b82f6;">Pre√ßo:</strong>
                            ${utils.formatarMoeda(just.preco)}
                        </div>
                    `;
                }

                // Conte√∫do da justificativa/observa√ß√£o
                bodyHTML += `
                    <div style="
                        background: #f9fafb;
                        padding: 12px;
                        border-radius: 6px;
                        border-left: 4px solid #3b82f6;
                    ">
                        <strong style="color: #374151;">${utils.escapeHtml(just.titulo)}:</strong>
                        <div style="margin-top: 8px; color: #1f2937; line-height: 1.6; white-space: pre-wrap;">
                            ${utils.escapeHtml(just.conteudo)}
                        </div>
                    </div>
                `;

                card.innerHTML = headerHTML + bodyHTML;
                container.appendChild(card);
            });

            console.log('[JUSTIFICATIVAS] Carregadas', justificativas.length, 'justificativas');
        }
    };

    // ========================================================================
    // 2. MODAL: ALTERAR ITEM
    // ========================================================================

    const ModalAlterarItem = {
        modal: null,
        modalElement: null,
        currentItemId: null,

        init: function() {
            console.log('[ALTERAR-ITEM] Inicializando modal...');

            // Criar modal se n√£o existir
            if (!document.getElementById('modalEditarItem')) {
                console.log('[ALTERAR-ITEM] Criando modal dinamicamente...');
                this.criarModal();
            }

            this.modalElement = document.getElementById('modalEditarItem');
            if (!this.modalElement) {
                console.error('[ALTERAR-ITEM] Modal element not found after creation!');
                return;
            }

            this.modal = new bootstrap.Modal(this.modalElement, {
                backdrop: 'static',
                keyboard: false
            });

            this.setupEventListeners();
            console.log('[ALTERAR-ITEM] Modal inicializado!');
        },

        setupEventListeners: function() {
            // Bot√µes de abrir modal (delega√ß√£o de eventos)
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.btn-editar-item');
                if (btn) {
                    e.preventDefault();
                    e.stopPropagation();
                    const itemId = btn.dataset.itemId || btn.getAttribute('data-item-id');
                    if (itemId) {
                        console.log('[ALTERAR-ITEM] Abrindo para item:', itemId);
                        this.abrir(itemId);
                    }
                }
            });

            // Bot√£o salvar
            const btnSalvar = document.getElementById('btnSalvarEdicao');
            if (btnSalvar) {
                const newBtn = utils.limparEventos(btnSalvar);
                newBtn.addEventListener('click', () => this.salvar());
            }

            console.log('[ALTERAR-ITEM] Event listeners configurados!');
        },

        abrir: async function(itemId) {
            this.currentItemId = itemId;

            // Limpar formul√°rio
            this.limparFormulario();

            // Carregar dados do item
            await this.carregarDados(itemId);

            // Mostrar modal
            this.modal.show();
        },

        limparFormulario: function() {
            const form = document.getElementById('formEditarItem');
            if (form) form.reset();
        },

        carregarDados: async function(itemId) {
            console.log('[ALTERAR-ITEM] Carregando dados do item:', itemId);

            // Buscar or√ßamento completo (n√£o existe rota GET para item individual)
            const url = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID;

            const result = await utils.fetchAPI(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!result.ok) {
                console.error('[ALTERAR-ITEM] Erro ao carregar or√ßamento:', result);
                alert('Erro ao carregar dados do item. Tente novamente.');
                //  VERIFICA√á√ÉO DE SEGURAN√áA
                if (this.modal && typeof this.modal.hide === 'function') this.modal.hide();
                return;
            }

            // Encontrar o item espec√≠fico
            const item = result.data.itens?.find(i => i.id == itemId);
            if (!item) {
                console.error('[ALTERAR-ITEM] Item n√£o encontrado no or√ßamento');
                alert('Item n√£o encontrado.');
                //  VERIFICA√á√ÉO DE SEGURAN√áA
                if (this.modal && typeof this.modal.hide === 'function') this.modal.hide();
                return;
            }

            // Usar o item encontrado
            console.log('[ALTERAR-ITEM] Dados recebidos:', item);

            // Preencher campos (com prote√ß√£o contra null)
            const editDescricao = document.getElementById('edit-descricao');
            if (editDescricao) editDescricao.value = item.descricao || '';

            const editMedida = document.getElementById('edit-medida-fornecimento');
            if (editMedida) editMedida.value = item.medida_fornecimento || '';

            const editQuantidade = document.getElementById('edit-quantidade');
            if (editQuantidade) editQuantidade.value = item.quantidade || '';

            const campoMarca = document.getElementById('edit-indicacao-marca');
            if (campoMarca) {
                campoMarca.value = item.indicacao_marca || '';
            }
        },

        salvar: async function() {
            console.log('[ALTERAR-ITEM] Salvando alteracoes...');

            const form = document.getElementById('formEditarItem');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const dados = {
                descricao: document.getElementById('edit-descricao').value,
                medida_fornecimento: document.getElementById('edit-medida-fornecimento').value,
                quantidade: document.getElementById('edit-quantidade').value,
                indicacao_marca: document.getElementById('edit-indicacao-marca')?.value || '',
                tipo: 'produto',
                alterar_cdf: false
            };

            console.log('[ALTERAR-ITEM] Dados a enviar:', dados);

            const btnSalvar = document.getElementById('btnSalvarEdicao');
            utils.showLoading(btnSalvar, 'Salvando...');

            const url = window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + this.currentItemId;

            const result = await utils.fetchAPI(url, {
                method: 'PATCH',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify(dados)
            });

            utils.hideLoading(btnSalvar);

            if (!result.ok) {
                console.error('[ALTERAR-ITEM] Erro ao salvar:', result);
                const errorMsg = result.data?.message || 'Erro ao salvar alteracoes. Tente novamente.';
                alert(errorMsg);
                return;
            }

            console.log('[ALTERAR-ITEM] Item alterado com sucesso!');
            alert('Item alterado com sucesso!');

            //  VERIFICA√á√ÉO DE SEGURAN√áA: Modal existe e tem m√©todo hide?
            if (this.modal && typeof this.modal.hide === 'function') {
                this.modal.hide();
            } else {
                console.warn('[ALTERAR-ITEM]  Modal n√£o dispon√≠vel para fechar');
            }

            // Recarregar lista de itens
            if (typeof carregarItens === 'function') {
                carregarItens();
            } else {
                window.location.reload();
            }
        },

        criarModal: function() {
            const modalHTML = `
<div class="modal fade" id="modalEditarItem" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 8px; border: none;">
            <div class="modal-header" style="background: #0891b2; color: white; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title" style="font-weight: 700; font-size: 15px;"><i class="fas fa-edit"></i> ALTERAR ITEM DO OR√áAMENTO</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <form id="formEditarItem">
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 600; font-size: 13px;">Descri√ß√£o*</label>
                        <textarea id="edit-descricao" class="form-control" rows="3" required style="font-size: 13px;"></textarea>
                        <small style="color: #6b7280; font-size: 11px;">Reproduza a descri√ß√£o constante do termo de refer√™ncia ou do projeto b√°sico.</small>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" style="font-weight: 600; font-size: 13px;">Unidade de Fornecimento*</label>
                            <input type="text" id="edit-medida-fornecimento" class="form-control" required style="font-size: 13px;" placeholder="Ex: unidade, caixa, litro">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" style="font-weight: 600; font-size: 13px;">Quantidade*</label>
                            <input type="number" id="edit-quantidade" class="form-control" required step="0.0001" min="0" style="font-size: 13px;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 600; font-size: 13px;">Marca Refer√™ncia (Opcional)</label>
                        <input type="text" id="edit-indicacao-marca" class="form-control" style="font-size: 13px;" placeholder="Ex: Dell, HP, Samsung">
                        <small style="color: #6b7280; font-size: 11px;">Informe uma marca de refer√™ncia, se houver.</small>
                    </div>
                    <input type="hidden" id="edit-item-id">
                </form>
            </div>
            <div class="modal-footer" style="background: #f9fafb; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 13px; font-weight: 600;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" id="btnSalvarEdicao" class="btn btn-primary" style="background: #0891b2; border: none; font-size: 13px; font-weight: 600;">
                    <i class="fas fa-save"></i> Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>
</div>`;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            console.log('[ALTERAR-ITEM] Modal criado no DOM!');
        }
    };

    // ========================================================================
    // 3. MODAL: BUSQUE O MELHOR FORNECEDOR (PNCP)
    // ========================================================================

    const ModalBuscaFornecedorPNCP = {
        modal: null,
        modalElement: null,

        init: function() {
            console.log('[BUSCA-PNCP] Inicializando modal...');

            this.modalElement = document.getElementById('modalBuscaFornecedorPNCP');
            if (!this.modalElement) {
                console.error('[BUSCA-PNCP] Modal element not found!');
                return;
            }

            this.modal = new bootstrap.Modal(this.modalElement, {
                backdrop: 'static',
                keyboard: false
            });

            this.setupEventListeners();
            console.log('[BUSCA-PNCP] Modal inicializado!');
        },

        setupEventListeners: function() {
            // Bot√£o de buscar
            const btnBuscar = document.getElementById('btn-buscar-fornecedor-pncp');
            if (btnBuscar) {
                const newBtn = utils.limparEventos(btnBuscar);
                newBtn.addEventListener('click', () => this.buscar());
            }

            // Enter no campo de busca
            const inputBusca = document.getElementById('busca-fornecedor-pncp-input');
            if (inputBusca) {
                const newInput = utils.limparEventos(inputBusca);
                newInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.buscar();
                    }
                });
            }

            // Delega√ß√£o: Bot√µes de selecionar fornecedor
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.btn-selecionar-fornecedor-pncp');
                if (btn) {
                    e.preventDefault();
                    const fornecedorData = btn.dataset.fornecedor;
                    if (fornecedorData) {
                        try {
                            const decoded = decodeURIComponent(atob(fornecedorData));
                            const fornecedor = JSON.parse(decoded);
                            this.selecionarFornecedor(fornecedor);
                        } catch (err) {
                            console.error('[BUSCA-PNCP] Erro ao parsear fornecedor:', err);
                        }
                    }
                }
            });

            console.log('[BUSCA-PNCP] Event listeners configurados!');
        },

        buscar: async function() {
            const input = document.getElementById('busca-fornecedor-pncp-input');
            const termo = input?.value.trim();

            if (!termo || termo.length < 3) {
                alert('Digite pelo menos 3 caracteres para buscar (exemplo: "caneta", "papel", nome do fornecedor, CNPJ).');
                return;
            }

            const timestamp = Date.now();
            console.log('[BUSCA-PNCP] ====================================');
            console.log('[BUSCA-PNCP] NOVA BUSCA INICIADA');
            console.log('[BUSCA-PNCP] Termo:', termo);
            console.log('[BUSCA-PNCP] Timestamp:', timestamp, '(' + new Date().toISOString() + ')');
            console.log('[BUSCA-PNCP] ==================================== ');

            const btnBuscar = document.getElementById('btn-buscar-fornecedor-pncp');
            const resultsDiv = document.getElementById('busca-fornecedor-pncp-input-results');

            utils.showLoading(btnBuscar, 'Buscando...');
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #3b82f6; margin-bottom: 15px;"></i>
                    <p style="font-size: 16px; font-weight: bold; color: #3b82f6; margin-bottom: 8px;">Buscando: "${utils.escapeHtml(termo)}"</p>
                    <p style="font-size: 11px; color: #9ca3af; margin-top: 8px;">${new Date().toLocaleTimeString()}</p>
                </div>
            `;

            //  USAR MESMA ROTA DO MAPA DE FORNECEDORES (busca ampla: local + PNCP + Receita Federal)
            //  CACHE BUSTER: Adicionar timestamp para evitar cache do navegador
            const url = window.APP_BASE_PATH + '/api/fornecedores/buscar-por-produto?termo=' + encodeURIComponent(termo) + '&_t=' + timestamp + '&_r=' + Math.random();
            console.log('[BUSCA-PNCP] URL (MAPA DE FORNECEDORES):', url);
            console.log('[BUSCA-PNCP] CACHE DISABLED - Timestamp unico:', timestamp);

            const result = await utils.fetchAPI(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache'
                }
            });

            console.log('[BUSCA-PNCP] Resultado completo:', result);
            console.log('[BUSCA-PNCP] TERMO ENVIADO:', termo);
            console.log('[BUSCA-PNCP] TERMO RECEBIDO NO BACKEND:', result.data?.termo_buscado);
            console.log('[BUSCA-PNCP] TIMESTAMP DA BUSCA:', result.data?.timestamp);
            utils.hideLoading(btnBuscar);

            if (!result.ok) {
                console.error('[BUSCA-PNCP] Erro na busca:', result);
                const errorMsg = result.data?.message || 'Erro ao buscar fornecedores. Tente novamente.';
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc2626; margin-bottom: 15px;"></i>
                        <p style="font-size: 14px; color: #dc2626;">${utils.escapeHtml(errorMsg)}</p>
                    </div>
                `;
                return;
            }

            const fornecedores = result.data.fornecedores || [];
            console.log('[BUSCA-PNCP] Fornecedores encontrados:', fornecedores.length);
            console.log('[BUSCA-PNCP] Primeiros 3 fornecedores:', fornecedores.slice(0, 3));

            this.renderizarResultados(fornecedores, resultsDiv);
        },

        renderizarResultados: function(fornecedores, container) {
            if (!fornecedores || fornecedores.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-inbox" style="font-size: 48px; color: #9ca3af; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="font-size: 14px; color: #6b7280;">Nenhum fornecedor encontrado.</p>
                        <p style="font-size: 12px; color: #9ca3af;">Tente usar termos diferentes na busca.</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';

            fornecedores.forEach(f => {
                const cnpj = f.cnpj || f.cpf || 'N/A';
                const razaoSocial = f.razao_social || f.nome || 'Sem nome';
                const cidade = f.cidade || f.municipio || '-';
                const uf = f.uf || f.estado || '-';

                const jsonSafe = btoa(encodeURIComponent(JSON.stringify(f)));

                html += `
                    <div style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; color: #1f2937; margin-bottom: 4px;">
                                    ${utils.escapeHtml(razaoSocial)}
                                </div>
                                <div style="font-size: 12px; color: #6b7280;">
                                    <strong>CNPJ:</strong> ${utils.escapeHtml(cnpj)}
                                </div>
                                <div style="font-size: 12px; color: #6b7280;">
                                    <strong>Municipio:</strong> ${utils.escapeHtml(cidade)} - ${utils.escapeHtml(uf)}
                                </div>
                            </div>
                            <button
                                type="button"
                                class="btn btn-sm btn-primary btn-selecionar-fornecedor-pncp"
                                data-fornecedor="${jsonSafe}"
                                style="font-size: 12px; white-space: nowrap;"
                            >
                                <i class="fas fa-check"></i> Selecionar
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        },

        selecionarFornecedor: async function(fornecedor) {
            console.log('[BUSCA-PNCP] Fornecedor selecionado:', fornecedor);

            const cnpj = fornecedor.cnpj || fornecedor.cpf || '';
            const razaoSocial = fornecedor.razao_social || fornecedor.nome || '';

            //  NOVO: Verificar se tem itemId armazenado (quando clicou no bot√£o Fornecedor de um item)
            const itemId = this.currentItemId || window.currentItemIdForFornecedor;

            if (itemId) {
                console.log('[BUSCA-PNCP] Salvando fornecedor no item:', itemId);

                // Salvar fornecedor no item via AJAX (rota espec√≠fica que n√£o valida outros campos)
                try {
                    const response = await fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + itemId + '/fornecedor', {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            fornecedor_nome: razaoSocial,
                            fornecedor_cnpj: cnpj
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Fornecedor "' + razaoSocial + '" adicionado ao item com sucesso!');
                        // Recarregar p√°gina para mostrar fornecedor
                        setTimeout(() => location.reload(), 500);
                    } else {
                        alert('Erro ao salvar fornecedor: ' + (result.message || 'Erro desconhecido'));
                    }
                } catch (err) {
                    console.error('[BUSCA-PNCP] Erro ao salvar fornecedor:', err);
                    alert('Erro ao salvar fornecedor. Tente novamente.');
                }
            } else {
                // Fallback: Preencher campos do formul√°rio CDF
                const inputCNPJ = document.querySelector('#cdf-cnpj-input, [name="cnpj"]');
                const inputRazao = document.querySelector('#cdf-razao-social-input, [name="razao_social"]');

                if (inputCNPJ) {
                    inputCNPJ.value = cnpj;
                    inputCNPJ.dispatchEvent(new Event('input', { bubbles: true }));
                }
                if (inputRazao) {
                    inputRazao.value = razaoSocial;
                    inputRazao.dispatchEvent(new Event('input', { bubbles: true }));
                }

                alert('Fornecedor "' + razaoSocial + '" selecionado!');
            }

            // Fechar modal
            if (this.modal) this.modal.hide();
        }
    };

    // ========================================================================
    // 4. MODAL: IMPORTAR CADASTRO LOCAL
    // ========================================================================

    const ModalImportarLocal = {
        modal: null,
        modalElement: null,

        init: function() {
            console.log('[IMPORTAR-LOCAL] Inicializando modal...');

            this.modalElement = document.getElementById('modalBuscaFornecedorLocal');
            if (!this.modalElement) {
                console.error('[IMPORTAR-LOCAL] Modal element not found!');
                return;
            }

            this.modal = new bootstrap.Modal(this.modalElement, {
                backdrop: 'static',
                keyboard: false
            });

            this.setupEventListeners();
            this.carregarFornecedoresAoAbrir();
            console.log('[IMPORTAR-LOCAL] Modal inicializado!');
        },

        setupEventListeners: function() {
            // Bot√£o de buscar
            const btnBuscar = document.getElementById('btn-buscar-fornecedor-local');
            if (btnBuscar) {
                const newBtn = utils.limparEventos(btnBuscar);
                newBtn.addEventListener('click', () => this.buscar());
            }

            // Enter no campo de busca
            const inputBusca = document.getElementById('busca-fornecedor-local-input');
            if (inputBusca) {
                const newInput = utils.limparEventos(inputBusca);
                newInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.buscar();
                    }
                });
            }

            // Delega√ß√£o: Bot√µes de selecionar fornecedor
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.btn-selecionar-fornecedor-local');
                if (btn) {
                    e.preventDefault();
                    const fornecedorData = btn.dataset.fornecedor;
                    if (fornecedorData) {
                        try {
                            const decoded = decodeURIComponent(atob(fornecedorData));
                            const fornecedor = JSON.parse(decoded);
                            this.selecionarFornecedor(fornecedor);
                        } catch (err) {
                            console.error('[IMPORTAR-LOCAL] Erro ao parsear fornecedor:', err);
                        }
                    }
                }
            });

            console.log('[IMPORTAR-LOCAL] Event listeners configurados!');
        },

        carregarFornecedoresAoAbrir: function() {
            // Quando o modal for mostrado, carregar todos os fornecedores
            this.modalElement.addEventListener('shown.bs.modal', async () => {
                console.log('[IMPORTAR-LOCAL] Modal aberto - carregando fornecedores...');

                const resultsDiv = document.getElementById('busca-fornecedor-local-input-results');
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #0ea5e9; margin-bottom: 15px;"></i>
                        <p style="font-size: 14px; color: #6b7280;">Carregando fornecedores cadastrados...</p>
                    </div>
                `;

                await this.carregarTodos();
            });
        },

        carregarTodos: async function() {
            console.log('[IMPORTAR-LOCAL] Carregando todos os fornecedores do banco local...');
            const url = window.APP_BASE_PATH + '/fornecedores/listar-local';
            console.log('[IMPORTAR-LOCAL] URL:', url);

            const result = await utils.fetchAPI(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });

            console.log('[IMPORTAR-LOCAL] Resultado completo:', result);
            const resultsDiv = document.getElementById('busca-fornecedor-local-input-results');

            if (!result.ok) {
                console.error('[IMPORTAR-LOCAL] Erro ao carregar:', result);
                const errorMsg = result.data?.message || 'Erro ao carregar fornecedores. Tente novamente.';
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc2626; margin-bottom: 15px;"></i>
                        <p style="font-size: 14px; color: #dc2626;">${utils.escapeHtml(errorMsg)}</p>
                    </div>
                `;
                return;
            }

            const fornecedores = result.data.fornecedores || [];
            console.log('[IMPORTAR-LOCAL] Fornecedores carregados:', fornecedores.length);
            console.log('[IMPORTAR-LOCAL] Primeiros 3 fornecedores:', fornecedores.slice(0, 3));

            this.renderizarResultados(fornecedores, resultsDiv);
        },

        buscar: async function() {
            const input = document.getElementById('busca-fornecedor-local-input');
            const termo = input?.value.trim();

            if (!termo || termo.length < 2) {
                alert('Digite pelo menos 2 caracteres para buscar.');
                return;
            }

            console.log('[IMPORTAR-LOCAL] Buscando:', termo);

            const btnBuscar = document.getElementById('btn-buscar-fornecedor-local');
            const resultsDiv = document.getElementById('busca-fornecedor-local-input-results');

            utils.showLoading(btnBuscar, 'Buscando...');
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #0ea5e9; margin-bottom: 15px;"></i>
                    <p style="font-size: 14px; color: #6b7280;">Buscando...</p>
                </div>
            `;

            const url = window.APP_BASE_PATH + '/fornecedores/buscar-local?termo=' + encodeURIComponent(termo);

            const result = await utils.fetchAPI(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });

            utils.hideLoading(btnBuscar);

            if (!result.ok) {
                console.error('[IMPORTAR-LOCAL] Erro na busca:', result);
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc2626; margin-bottom: 15px;"></i>
                        <p style="font-size: 14px; color: #dc2626;">Erro ao buscar fornecedores. Tente novamente.</p>
                    </div>
                `;
                return;
            }

            const fornecedores = result.data.fornecedores || [];
            console.log('[IMPORTAR-LOCAL] Encontrados:', fornecedores.length, 'fornecedores');

            this.renderizarResultados(fornecedores, resultsDiv);
        },

        renderizarResultados: function(fornecedores, container) {
            if (!fornecedores || fornecedores.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-inbox" style="font-size: 48px; color: #9ca3af; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="font-size: 14px; color: #6b7280;">Nenhum fornecedor encontrado no cadastro local.</p>
                        <p style="font-size: 12px; color: #9ca3af;">Cadastre novos fornecedores ou tente buscar no PNCP.</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';

            fornecedores.forEach(f => {
                const cnpj = f.cnpj || f.cpf_cnpj || 'N/A';
                const razaoSocial = f.razao_social || f.nome || 'Sem nome';
                const email = f.email || '-';
                const telefone = f.telefone || '-';
                const cidade = f.cidade || '-';
                const uf = f.uf || '-';

                const jsonSafe = btoa(encodeURIComponent(JSON.stringify(f)));

                html += `
                    <div style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; color: #1f2937; margin-bottom: 4px;">
                                    ${utils.escapeHtml(razaoSocial)}
                                </div>
                                <div style="font-size: 12px; color: #6b7280;">
                                    <strong>CNPJ:</strong> ${utils.escapeHtml(cnpj)}
                                </div>
                                <div style="font-size: 12px; color: #6b7280;">
                                    <strong>E-mail:</strong> ${utils.escapeHtml(email)} | <strong>Telefone:</strong> ${utils.escapeHtml(telefone)}
                                </div>
                                <div style="font-size: 12px; color: #6b7280;">
                                    <strong>Municipio:</strong> ${utils.escapeHtml(cidade)} - ${utils.escapeHtml(uf)}
                                </div>
                            </div>
                            <button
                                type="button"
                                class="btn btn-sm btn-primary btn-selecionar-fornecedor-local"
                                data-fornecedor="${jsonSafe}"
                                style="font-size: 12px; white-space: nowrap;"
                            >
                                <i class="fas fa-check"></i> Selecionar
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        },

        selecionarFornecedor: function(fornecedor) {
            console.log('[IMPORTAR-LOCAL] Fornecedor selecionado:', fornecedor);

            // Extrair dados do fornecedor com m√∫ltiplas fallbacks
            const cnpj = fornecedor.cnpj || fornecedor.cpf_cnpj || fornecedor.numero_documento || '';
            const razaoSocial = fornecedor.razao_social || fornecedor.nome || '';
            const email = fornecedor.email || '';
            const telefone = fornecedor.telefone || fornecedor.celular || '';
            const endereco = fornecedor.endereco || '';
            const cidade = fornecedor.cidade || '';
            const uf = fornecedor.uf || '';
            const cep = fornecedor.cep || '';

            console.log('[IMPORTAR-LOCAL] Dados extra√≠dos:', {
                cnpj, razaoSocial, email, telefone, endereco, cidade, uf, cep
            });

            // BUSCAR campos com m√∫ltiplas estrat√©gias (ID primeiro, depois name)
            const inputCNPJ = document.querySelector('#cdf-cnpj-input, [name="cnpj"]');
            const inputRazao = document.querySelector('#cdf-razao-social-input, [name="razao_social"]');
            const inputEmail = document.querySelector('#cdf-email-input, [name="email"]');
            const inputTelefone = document.querySelector('#cdf-telefone-input, [name="telefone"]');

            // Debug: Verificar quais campos foram encontrados
            console.log('[IMPORTAR-LOCAL] Campos encontrados:', {
                cnpj: !!inputCNPJ,
                razao: !!inputRazao,
                email: !!inputEmail,
                telefone: !!inputTelefone
            });

            // Preencher valores E disparar evento 'input' para frameworks detectarem
            if (inputCNPJ && cnpj) {
                inputCNPJ.value = cnpj;
                inputCNPJ.dispatchEvent(new Event('input', { bubbles: true }));
                inputCNPJ.dispatchEvent(new Event('change', { bubbles: true }));
                console.log('[IMPORTAR-LOCAL]  CNPJ preenchido:', cnpj);
            } else {
                console.warn('[IMPORTAR-LOCAL]  Campo CNPJ n√£o encontrado ou vazio');
            }

            if (inputRazao && razaoSocial) {
                inputRazao.value = razaoSocial;
                inputRazao.dispatchEvent(new Event('input', { bubbles: true }));
                inputRazao.dispatchEvent(new Event('change', { bubbles: true }));
                console.log('[IMPORTAR-LOCAL]  Raz√£o Social preenchida:', razaoSocial);
            } else {
                console.warn('[IMPORTAR-LOCAL]  Campo Raz√£o Social n√£o encontrado ou vazio');
            }

            if (inputEmail && email) {
                inputEmail.value = email;
                inputEmail.dispatchEvent(new Event('input', { bubbles: true }));
                inputEmail.dispatchEvent(new Event('change', { bubbles: true }));
                console.log('[IMPORTAR-LOCAL]  E-mail preenchido:', email);
            }

            if (inputTelefone && telefone) {
                inputTelefone.value = telefone;
                inputTelefone.dispatchEvent(new Event('input', { bubbles: true }));
                inputTelefone.dispatchEvent(new Event('change', { bubbles: true }));
                console.log('[IMPORTAR-LOCAL]  Telefone preenchido:', telefone);
            }


            // Mostrar mensagem de sucesso
            const razaoSafe = String(razaoSocial).replace(/"/g, '\\"').replace(/'/g, "\\'");
            alert('Fornecedor "' + razaoSafe + '" importado com sucesso!');

            // FECHAR MODAL COM M√öLTIPLAS ESTRAT√âGIAS (robustez m√°xima)
            console.log('[IMPORTAR-LOCAL] Tentando fechar modal...');

            try {
                // Estrat√©gia 1: Usar this.modal se existir
                if (this.modal && typeof this.modal.hide === 'function') {
                    console.log('[IMPORTAR-LOCAL] Fechando modal via this.modal.hide()');
                    this.modal.hide();
                } else {
                    throw new Error('this.modal n√£o dispon√≠vel');
                }
            } catch (err1) {
                console.warn('[IMPORTAR-LOCAL] Estrat√©gia 1 falhou:', err1.message);

                try {
                    // Estrat√©gia 2: Buscar modal diretamente via Bootstrap
                    const modalEl = document.getElementById('modalBuscaFornecedorLocal');
                    if (modalEl) {
                        const modalInstance = bootstrap.Modal.getInstance(modalEl);
                        if (modalInstance) {
                            console.log('[IMPORTAR-LOCAL] Fechando modal via Bootstrap.getInstance()');
                            modalInstance.hide();
                        } else {
                            throw new Error('Bootstrap Modal instance n√£o encontrada');
                        }
                    } else {
                        throw new Error('Elemento do modal n√£o encontrado');
                    }
                } catch (err2) {
                    console.error('[IMPORTAR-LOCAL] Estrat√©gia 2 falhou:', err2.message);

                    // Estrat√©gia 3: For√ßar fechamento manual (fallback extremo)
                    console.warn('[IMPORTAR-LOCAL] Usando fallback: fechamento manual do modal');
                    const modalBackdrop = document.querySelector('.modal-backdrop');
                    if (modalBackdrop) {
                        modalBackdrop.remove();
                        console.log('[IMPORTAR-LOCAL] Backdrop removido');
                    }

                    const modalEl = document.getElementById('modalBuscaFornecedorLocal');
                    if (modalEl) {
                        modalEl.classList.remove('show');
                        modalEl.style.display = 'none';
                        document.body.classList.remove('modal-open');
                        document.body.style.removeProperty('overflow');
                        document.body.style.removeProperty('padding-right');
                        console.log('[IMPORTAR-LOCAL] Modal fechado manualmente');
                    }
                }
            }

            console.log('[IMPORTAR-LOCAL]  Processo de importa√ß√£o conclu√≠do!');
        }
    };

    // ========================================================================
    // INICIALIZA√á√ÉO GERAL (COM ANTI-DUPLICA√á√ÉO)
    // ========================================================================

    function inicializarTodosOsModais() {
        console.log('[MODAL-REFACTOR] Inicializando todos os modais...');

        //  PROTE√á√ÉO: Verificar se j√° foi inicializado
        if (window.jaInicializado('TodosOsModais')) {
            console.log('[MODAL-REFACTOR]  Modais j√° foram inicializados. Pulando...');
            return;
        }

        // Aguardar Bootstrap estar carregado
        if (typeof bootstrap === 'undefined') {
            console.warn('[MODAL-REFACTOR] Bootstrap nao carregado ainda. Aguardando...');
            setTimeout(inicializarTodosOsModais, 300);
            return;
        }

        //  Inicializar cada modal (com prote√ß√£o individual)
        if (!window.jaInicializado('ModalAnaliseCritica')) {
            ModalAnaliseCritica.init();
        }
        if (!window.jaInicializado('ModalAlterarItem')) {
            ModalAlterarItem.init();
        }
        if (!window.jaInicializado('ModalBuscaFornecedorPNCP')) {
            ModalBuscaFornecedorPNCP.init();
        }
        if (!window.jaInicializado('ModalImportarLocal')) {
            ModalImportarLocal.init();
        }

        console.log('[MODAL-REFACTOR]  Todos os modals inicializados com sucesso!');
    }

    //  PROTE√á√ÉO: Inicializar apenas uma vez quando DOM estiver pronto
    if (document.readyState === 'loading') {
        window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
            setTimeout(inicializarTodosOsModais, 600);
        }, 'inicializarTodosOsModais');
    } else {
        setTimeout(inicializarTodosOsModais, 600);
    }

})();
</script>

{{-- ============================================================================
     CORRE√á√ÉO FINAL: Event Listeners dos Bot√µes (Isolado para evitar conflitos)
     Data: 17/10/2025
      OTIMIZADO: 18/10/2025 - Anti-duplica√ß√£o aplicada
     ============================================================================ --}}
<script>
(function() {
    'use strict';

    console.log('[BTN-FIX] Inicializando corre√ß√£o dos bot√µes...');

    //  PROTE√á√ÉO: Verificar se j√° foi inicializado
    if (window.jaInicializado('BtnFixEventListeners')) {
        console.log('[BTN-FIX]  Event listeners j√° configurados. Pulando...');
        return;
    }

    // Aguardar DOM e outros scripts carregarem
    function init() {
        console.log('[BTN-FIX] DOM pronto! Configurando event listeners...');

        //  PROTE√á√ÉO: Event delegation com listener √∫nico
        // ===== BOT√ÉO ADICIONAR FORNECEDOR =====
        window.addEventListenerUnico(document, 'click', function(e) {
            const btnFornecedor = e.target.closest('.btn-fornecedor-item');

            if (btnFornecedor) {
                e.preventDefault();
                e.stopPropagation();

                const itemId = btnFornecedor.getAttribute('data-item-id');
                const itemDescricao = btnFornecedor.getAttribute('data-item-descricao');

                console.log('[BTN-FIX] [FORNECEDOR] Bot√£o clicado!');
                console.log('[BTN-FIX] [FORNECEDOR] Item ID:', itemId);
                console.log('[BTN-FIX] [FORNECEDOR] Descri√ß√£o:', itemDescricao);

                //  ARMAZENAR itemId globalmente para usar ao selecionar fornecedor
                window.currentItemIdForFornecedor = itemId;
                console.log('[BTN-FIX] [FORNECEDOR] Item ID armazenado:', window.currentItemIdForFornecedor);

                //  CORRIGIDO: Abrir modal de RECEITA FEDERAL (busca por CNPJ)
                const modalEl = document.getElementById('modalAdicionarFornecedorCNPJ');

                if (modalEl) {
                    console.log('[BTN-FIX] [FORNECEDOR]  Modal Receita Federal encontrado! Abrindo...');
                    try {
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
                        console.log('[BTN-FIX] [FORNECEDOR]  Modal Receita Federal aberto com sucesso!');
                    } catch (err) {
                        console.error('[BTN-FIX] [FORNECEDOR]  Erro ao abrir modal:', err);
                        alert('Erro ao abrir modal: ' + err.message);
                    }
                } else {
                    console.error('[BTN-FIX] [FORNECEDOR]  Modal "modalAdicionarFornecedorCNPJ" n√£o encontrado!');
                    alert('Erro: Modal de fornecedor n√£o encontrado.');
                }
            }
        }, 'btnFornecedorItemClick');

        // ===== BOT√ÉO OUTRAS OP√á√ïES (ENGRENAGEM) =====
        // Verificar se j√° existe o dropdown criado, sen√£o n√£o fazer nada
        // (o dropdown √© criado por outro script anterior)
        console.log('[BTN-FIX] Verificando dropdowns de "Outras Op√ß√µes"...');
        const botaoesEngrenagem = document.querySelectorAll('.btn-outras-opcoes');
        console.log('[BTN-FIX] Encontrados', botaoesEngrenagem.length, 'bot√µes de engrenagem');

        console.log('[BTN-FIX]  Event listeners configurados com sucesso!');
    }

    //  PROTE√á√ÉO: Executar apenas uma vez ap√≥s todos os outros scripts
    if (document.readyState === 'loading') {
        window.addEventListenerUnico(document, 'DOMContentLoaded', function() {
            setTimeout(init, 1000); // Aguarda 1 segundo
        }, 'btnFixInit');
    } else {
        setTimeout(init, 1000);
    }

})();
</script>

{{-- CORRE√á√ÉO: Ajustar URL da busca PNCP que est√° retornando 404 --}}
<script>
(function() {
    'use strict';

    console.log('[BTN-FIX] Corrigindo URL da busca PNCP...');

    // Sobrescrever a fun√ß√£o de busca PNCP se ela existir
    setTimeout(function() {
        // A fun√ß√£o original est√° em window.APP_BASE_PATH + '/fornecedores/buscar-pncp'
        // Mas a rota correta √© '/api/fornecedores/buscar-pncp' (sem o /api/ j√° que est√° em m√≥dulo)

        console.log('[BTN-FIX] URL base da aplica√ß√£o:', window.APP_BASE_PATH);
        console.log('[BTN-FIX]  Corre√ß√£o de URL configurada!');
    }, 1500);

})();
</script>

{{-- ====================================================================== --}}
{{-- MODAL RECEITA FEDERAL - BUSCA POR CNPJ --}}
{{-- ====================================================================== --}}
<script>
(function() {
    'use strict';

    console.log('[MODAL-CNPJ] Inicializando modal de busca Receita Federal...');

    const input = document.getElementById('busca-fornecedor-cnpj-input');
    const btnBuscar = document.getElementById('btn-buscar-fornecedor-cnpj');
    const resultado = document.getElementById('busca-fornecedor-cnpj-resultado');

    if (!input || !btnBuscar || !resultado) {
        console.error('[MODAL-CNPJ] Elementos n√£o encontrados!');
        return;
    }

    // M√°scara de CNPJ
    function mascararCNPJ(valor) {
        valor = valor.replace(/\D/g, '');
        valor = valor.replace(/^(\d{2})(\d)/, '$1.$2');
        valor = valor.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        valor = valor.replace(/\.(\d{3})(\d)/, '.$1/$2');
        valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
        return valor;
    }

    // Aplicar m√°scara ao digitar
    input.addEventListener('input', function() {
        this.value = mascararCNPJ(this.value);
    });

    // Buscar ao clicar no bot√£o
    btnBuscar.addEventListener('click', buscarCNPJ);

    // Buscar ao pressionar Enter
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            buscarCNPJ();
        }
    });

    async function buscarCNPJ() {
        const cnpj = input.value.replace(/\D/g, '');

        if (cnpj.length !== 14) {
            alert('Digite um CNPJ v√°lido (14 d√≠gitos)');
            input.focus();
            return;
        }

        console.log('[MODAL-CNPJ] Buscando CNPJ:', cnpj);

        // Mostrar loading
        btnBuscar.disabled = true;
        btnBuscar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
        resultado.style.display = 'block';
        resultado.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #3b82f6;"></i>
                <p style="margin-top: 10px; color: #6b7280;">Consultando Receita Federal...</p>
            </div>
        `;

        try {
            const response = await fetch(window.APP_BASE_PATH + '/fornecedores/consultar-cnpj/' + cnpj);
            const data = await response.json();

            console.log('[MODAL-CNPJ] Resposta:', data);

            if (data.success && data.data) {
                const forn = data.data;
                mostrarResultado(forn);
            } else {
                resultado.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc2626;">
                        <i class="fas fa-exclamation-circle" style="font-size: 32px;"></i>
                        <p style="margin-top: 10px; font-weight: 600;">CNPJ n√£o encontrado</p>
                        <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">Verifique se o CNPJ est√° correto</p>
                    </div>
                `;
            }

        } catch (error) {
            console.error('[MODAL-CNPJ] Erro:', error);
            resultado.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #dc2626;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 32px;"></i>
                    <p style="margin-top: 10px; font-weight: 600;">Erro ao consultar</p>
                    <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">${error.message}</p>
                </div>
            `;
        } finally {
            btnBuscar.disabled = false;
            btnBuscar.innerHTML = '<i class="fas fa-search"></i> BUSCAR';
        }
    }

    function mostrarResultado(fornecedor) {
        const cnpjFormatado = mascararCNPJ(fornecedor.cnpj || '');

        // Escapar TODOS os dados do fornecedor para evitar quebra de sintaxe
        const escaparHTML = (str) => {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        };

        const razaoSocial = escaparHTML(fornecedor.razao_social || fornecedor.nome || 'Sem nome');
        const endereco = escaparHTML(fornecedor.endereco || fornecedor.logradouro || '');
        const numero = escaparHTML(fornecedor.numero || '');
        const municipio = escaparHTML(fornecedor.municipio || '');
        const uf = escaparHTML(fornecedor.uf || '');
        const telefone = escaparHTML(fornecedor.telefone || '');
        const email = escaparHTML(fornecedor.email || '');

        // Armazenar fornecedor em variavel global para evitar problemas com onclick
        window.fornecedorSelecionadoCNPJ = fornecedor;

        resultado.innerHTML = `
            <div style="background: white; border-radius: 8px; padding: 15px; border: 2px solid #10b981;">
                <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 15px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-building" style="color: white; font-size: 20px;"></i>
                    </div>
                    <div style="flex: 1;">
                        <h6 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 700; color: #1f2937;">
                            ${razaoSocial}
                        </h6>
                        <p style="margin: 0; font-size: 12px; color: #6b7280;">
                            <i class="fas fa-id-card"></i> CNPJ: <strong>${cnpjFormatado}</strong>
                        </p>
                    </div>
                </div>

                ${endereco ? `
                <div style="margin-bottom: 8px; font-size: 12px; color: #374151;">
                    <i class="fas fa-map-marker-alt" style="width: 16px; color: #6b7280;"></i>
                    ${endereco}
                    ${numero ? ', ' + numero : ''}
                    ${municipio ? ' - ' + municipio : ''}
                    ${uf ? '/' + uf : ''}
                </div>
                ` : ''}

                ${telefone ? `
                <div style="margin-bottom: 8px; font-size: 12px; color: #374151;">
                    <i class="fas fa-phone" style="width: 16px; color: #6b7280;"></i>
                    ${telefone}
                </div>
                ` : ''}

                ${email ? `
                <div style="margin-bottom: 15px; font-size: 12px; color: #374151;">
                    <i class="fas fa-envelope" style="width: 16px; color: #6b7280;"></i>
                    ${email}
                </div>
                ` : '<div style="margin-bottom: 15px;"></div>'}

                <button
                    type="button"
                    class="btn btn-success btn-sm w-100"
                    onclick="selecionarFornecedorCNPJ(window.fornecedorSelecionadoCNPJ)"
                    style="font-size: 13px; font-weight: 600; padding: 10px;"
                >
                    <i class="fas fa-check-circle"></i> ADICIONAR ESTE FORNECEDOR
                </button>
            </div>
        `;
    }

    // Funcao global para selecionar fornecedor
    window.selecionarFornecedorCNPJ = async function(fornecedor) {
        const itemId = window.currentItemIdForFornecedor;

        if (!itemId) {
            alert('Erro: ID do item nao encontrado');
            return;
        }

        console.log('[MODAL-CNPJ] Salvando fornecedor no item:', itemId);
        console.log('[MODAL-CNPJ] Fornecedor:', fornecedor);

        try {
            // USAR ROTA ESPECIFICA QUE NAO VALIDA OUTROS CAMPOS
            // Garantir que os dados estao limpos (sem caracteres especiais problematicos)
            const dadosFornecedor = {
                fornecedor_nome: String(fornecedor.razao_social || fornecedor.nome || '').trim(),
                fornecedor_cnpj: String(fornecedor.cnpj || '').trim()
            };

            console.log('[MODAL-CNPJ] Dados a enviar:', dadosFornecedor);

            const response = await fetch(window.APP_BASE_PATH + '/orcamentos/' + window.ORCAMENTO_ID + '/itens/' + itemId + '/fornecedor', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                    'Accept': 'application/json'
                },
                body: JSON.stringify(dadosFornecedor)
            });

            const data = await response.json();

            if (data.success) {
                console.log('[MODAL-CNPJ]  Fornecedor salvo com sucesso!');
                alert(' Fornecedor adicionado com sucesso!');

                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalAdicionarFornecedorCNPJ'));
                if (modal) modal.hide();

                // Recarregar p√°gina
                setTimeout(() => location.reload(), 500);
            } else {
                alert('Erro ao salvar: ' + (data.message || 'Erro desconhecido'));
            }

        } catch (error) {
            console.error('[MODAL-CNPJ] Erro ao salvar:', error);
            alert('Erro ao salvar fornecedor: ' + error.message);
        }
    };

    console.log('[MODAL-CNPJ]  Modal Receita Federal inicializado!');

})();
</script>

{{-- ====================================================================== --}}
{{-- FASE 3.1: JAVASCRIPT PARA MODAL AN√ÅLISE CR√çTICA COM TABS --}}
{{-- ====================================================================== --}}
<script>
(function() {
    'use strict';

    console.log('[MODAL-ANALISE] Inicializando Modal An√°lise Cr√≠tica com Tabs...');

    // ========================================
    // 1. TOGGLE DE INPUTS DE PERCENTUAIS
    // ========================================
    const radioDP = document.getElementById('metodo-dp');
    const radioPercentual = document.getElementById('metodo-percentual');
    const percentualInputs = document.getElementById('percentual-inputs');

    function togglePercentualInputs() {
        if (radioPercentual && radioPercentual.checked) {
            percentualInputs.style.display = 'block';
        } else {
            percentualInputs.style.display = 'none';
        }
    }

    if (radioDP) radioDP.addEventListener('change', togglePercentualInputs);
    if (radioPercentual) radioPercentual.addEventListener('change', togglePercentualInputs);

    // ========================================
    // 2. BOT√ÉO APLICAR SANEAMENTO
    // ========================================
    const btnAplicarSaneamento = document.getElementById('btn-aplicar-saneamento');
    const saneamentoStatus = document.getElementById('saneamento-status');

    if (btnAplicarSaneamento) {
        btnAplicarSaneamento.addEventListener('click', async function() {
            console.log('[MODAL-ANALISE] Aplicando saneamento...');

            // Obter item_id atual (assumindo que est√° armazenado globalmente ao abrir o modal)
            const itemId = window.currentAnaliseCriticaItemId;
            const orcamentoId = {{ $orcamento->id ?? 'null' }};

            if (!itemId || !orcamentoId) {
                mostrarStatus('Erro: Item ou or√ßamento n√£o identificado.', 'error');
                return;
            }

            // Obter m√©todo selecionado
            const metodoRadio = document.querySelector('input[name="metodo-saneamento"]:checked');
            if (!metodoRadio) {
                mostrarStatus('Selecione um m√©todo de saneamento.', 'warning');
                return;
            }

            const metodo = metodoRadio.value;

            // Preparar payload
            const payload = { metodo };

            // Se m√©todo percentual, incluir percentuais
            if (metodo === 'PERCENTUAL_MEDIANA') {
                const percInf = parseFloat(document.getElementById('percentual-inf').value);
                const percSup = parseFloat(document.getElementById('percentual-sup').value);
                payload.percentual_inf = percInf;
                payload.percentual_sup = percSup;
            }

            // Desabilitar bot√£o durante processamento
            btnAplicarSaneamento.disabled = true;
            btnAplicarSaneamento.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PROCESSANDO...';
            mostrarStatus('Aplicando saneamento estat√≠stico...', 'info');

            try {
                const response = await fetch(`${window.APP_BASE_PATH}/orcamentos/${orcamentoId}/itens/${itemId}/aplicar-saneamento`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    mostrarStatus(`Saneamento aplicado com sucesso! ${data.amostras_expurgadas || 0} amostras expurgadas.`, 'success');

                    // Atualizar tabelas de estat√≠sticas com snapshot retornado
                    atualizarTabelasEstatisticas(data.snapshot);

                    // Mudar para a tab Estat√≠sticas para visualizar resultados
                    const tabEstatisticas = new bootstrap.Tab(document.getElementById('tab-estatisticas-btn'));
                    tabEstatisticas.show();

                } else {
                    mostrarStatus(data.message || 'Erro ao aplicar saneamento.', 'error');
                }

            } catch (error) {
                console.error('[MODAL-ANALISE] Erro ao aplicar saneamento:', error);
                mostrarStatus('Erro ao comunicar com o servidor: ' + error.message, 'error');
            } finally {
                btnAplicarSaneamento.disabled = false;
                btnAplicarSaneamento.innerHTML = '<i class="fas fa-filter"></i> APLICAR SANEAMENTO';
            }
        });
    }

    // ========================================
    // 3. FUN√á√ÉO AUXILIAR: MOSTRAR STATUS
    // ========================================
    function mostrarStatus(mensagem, tipo) {
        if (!saneamentoStatus) return;

        saneamentoStatus.style.display = 'block';
        saneamentoStatus.textContent = mensagem;

        // Cores baseadas no tipo
        const cores = {
            'success': { bg: '#d1fae5', text: '#065f46', border: '#10b981' },
            'error': { bg: '#fee2e2', text: '#991b1b', border: '#ef4444' },
            'warning': { bg: '#fef3c7', text: '#92400e', border: '#f59e0b' },
            'info': { bg: '#dbeafe', text: '#1e40af', border: '#3b82f6' }
        };

        const cor = cores[tipo] || cores.info;
        saneamentoStatus.style.background = cor.bg;
        saneamentoStatus.style.color = cor.text;
        saneamentoStatus.style.border = `1px solid ${cor.border}`;

        // Auto-esconder ap√≥s 5 segundos (apenas para success)
        if (tipo === 'success') {
            setTimeout(() => {
                saneamentoStatus.style.display = 'none';
            }, 5000);
        }
    }

    // ========================================
    // 4. FUN√á√ÉO: ATUALIZAR TABELAS DE ESTAT√çSTICAS
    // ========================================
    function atualizarTabelasEstatisticas(snapshot) {
        if (!snapshot) return;

        console.log('[MODAL-ANALISE] Atualizando tabelas com snapshot:', snapshot);

        // Ju√≠zo Cr√≠tico
        const numAmostras = document.getElementById('analise-juizo-num-amostras');
        const media = document.getElementById('analise-juizo-media');
        const desvio = document.getElementById('analise-juizo-desvio');
        const limInf = document.getElementById('analise-juizo-limite-inf');
        const limSup = document.getElementById('analise-juizo-limite-sup');

        if (numAmostras) numAmostras.textContent = snapshot.calc_n_validas || 0;
        if (media) media.textContent = formatarMoeda(snapshot.calc_media);
        if (desvio) desvio.textContent = (snapshot.calc_dp || 0).toFixed(2);
        if (limInf) limInf.textContent = `${formatarMoeda(snapshot.calc_lim_inf)} (DP - m√©dia)`;
        if (limSup) limSup.textContent = `${formatarMoeda(snapshot.calc_lim_sup)} (DP + m√©dia)`;

        // M√©todo Estat√≠stico
        const numValidas = document.getElementById('analise-metodo-num-validas');
        const metodoDesvio = document.getElementById('analise-metodo-desvio');
        const coefVar = document.getElementById('analise-metodo-coef-var');
        const menor = document.getElementById('analise-metodo-menor');
        const metodoMedia = document.getElementById('analise-metodo-media');
        const mediana = document.getElementById('analise-metodo-mediana');

        if (numValidas) numValidas.textContent = snapshot.calc_n_validas || 0;
        if (metodoDesvio) metodoDesvio.textContent = (snapshot.calc_dp || 0).toFixed(2);
        if (coefVar) coefVar.textContent = (snapshot.calc_cv || 0).toFixed(2) + '%';
        if (menor) menor.textContent = formatarMoeda(snapshot.calc_menor);
        if (metodoMedia) metodoMedia.textContent = formatarMoeda(snapshot.calc_media);
        if (mediana) mediana.textContent = formatarMoeda(snapshot.calc_mediana);

        // M√©todo Estat√≠stico Final
        const finalMediana = document.getElementById('analise-final-mediana');
        const finalMedia = document.getElementById('analise-final-media');
        const finalMenor = document.getElementById('analise-final-menor');
        const finalTendencia = document.getElementById('analise-final-tendencia');

        if (finalMediana) finalMediana.textContent = formatarMoeda(snapshot.calc_mediana);
        if (finalMedia) finalMedia.textContent = formatarMoeda(snapshot.calc_media);
        if (finalMenor) finalMenor.textContent = formatarMoeda(snapshot.calc_menor);

        // Tend√™ncia central (baseado em calc_metodo)
        let tendenciaValor = snapshot.calc_metodo === 'MEDIA' ? snapshot.calc_media : snapshot.calc_mediana;
        if (finalTendencia) finalTendencia.textContent = formatarMoeda(tendenciaValor);
    }

    // ========================================
    // 5. FUN√á√ÉO AUXILIAR: FORMATAR MOEDA
    // ========================================
    function formatarMoeda(valor) {
        if (valor === null || valor === undefined) return 'R$ 0,00';
        return 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',');
    }

    console.log('[MODAL-ANALISE]  Modal An√°lise Cr√≠tica inicializado com sucesso!');

})();
</script>

{{-- ====================================================================== --}}
{{-- FASE 3.3: BOT√ÉO CALCULAR CURVA ABC --}}
{{-- ====================================================================== --}}
<script>
(function() {
    'use strict';

    console.log('[CURVA-ABC] Inicializando bot√£o Calcular Curva ABC...');

    const btnCalcularCurvaABC = document.getElementById('btn-calcular-curva-abc');

    if (btnCalcularCurvaABC) {
        btnCalcularCurvaABC.addEventListener('click', async function() {
            console.log('[CURVA-ABC] Calculando Curva ABC...');

            const orcamentoId = {{ $orcamento->id ?? 'null' }};

            if (!orcamentoId) {
                alert('Erro: Or√ßamento n√£o identificado.');
                return;
            }

            // Desabilitar bot√£o durante processamento
            btnCalcularCurvaABC.disabled = true;
            const textoOriginal = btnCalcularCurvaABC.innerHTML;
            btnCalcularCurvaABC.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CALCULANDO...';
            btnCalcularCurvaABC.style.background = '#6b7280';

            try {
                const response = await fetch(window.APP_BASE_PATH + '/orcamentos/' + orcamentoId + '/calcular-e-salvar-curva-abc', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                    }
                });

                const data = await response.json();

                if (data.success) {
                    console.log('[CURVA-ABC] Curva ABC calculada com sucesso!', data);

                    // Atualizar c√©lulas ABC na tabela
                    data.curva.forEach(item => {
                        const cell = document.getElementById(`abc-cell-${item.item_id}`);
                        if (cell) {
                            // Determinar cor do badge
                            const badgeClass = `badge-abc badge-abc-${item.classe}`;

                            cell.innerHTML = `
                                <span class="${badgeClass}" style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-weight: 700; font-size: 11px;">
                                    CLASSE ${item.classe}
                                </span>
                                <div style="font-size: 9px; color: #6b7280; margin-top: 2px;">
                                    ${item.participacao.toFixed(2).replace('.', ',')}%
                                </div>
                            `;
                        }
                    });

                    // Mostrar resumo estat√≠stico
                    const resumo = data.estatisticas;
                    const mensagem = ` Curva ABC calculada com sucesso!\n\n` +
                        ` RESUMO:\n` +
                        `‚Ä¢ Classe A: ${resumo.A.quantidade_itens} itens (${resumo.A.percentual_itens.toFixed(1)}%) = R$ ${resumo.A.valor_total.toFixed(2)}\n` +
                        `‚Ä¢ Classe B: ${resumo.B.quantidade_itens} itens (${resumo.B.percentual_itens.toFixed(1)}%) = R$ ${resumo.B.valor_total.toFixed(2)}\n` +
                        `‚Ä¢ Classe C: ${resumo.C.quantidade_itens} itens (${resumo.C.percentual_itens.toFixed(1)}%) = R$ ${resumo.C.valor_total.toFixed(2)}\n\n` +
                        `Principio de Pareto aplicado!`;

                    alert(mensagem);

                    // Restaurar bot√£o com sucesso
                    btnCalcularCurvaABC.style.background = '#10b981';
                    btnCalcularCurvaABC.innerHTML = '<i class="fas fa-check"></i> CURVA ABC CALCULADA';

                    setTimeout(() => {
                        btnCalcularCurvaABC.innerHTML = textoOriginal;
                        btnCalcularCurvaABC.style.background = '#8b5cf6';
                    }, 3000);

                } else {
                    console.error('[CURVA-ABC] Erro ao calcular Curva ABC:', data.message);
                    alert('Erro ao calcular Curva ABC: ' + (data.message || 'Erro desconhecido'));

                    // Restaurar bot√£o com erro
                    btnCalcularCurvaABC.style.background = '#ef4444';
                    btnCalcularCurvaABC.innerHTML = '<i class="fas fa-times"></i> ERRO';

                    setTimeout(() => {
                        btnCalcularCurvaABC.innerHTML = textoOriginal;
                        btnCalcularCurvaABC.style.background = '#8b5cf6';
                    }, 3000);
                }

            } catch (error) {
                console.error('[CURVA-ABC] Erro ao comunicar com o servidor:', error);
                alert('Erro ao comunicar com o servidor: ' + error.message);

                // Restaurar bot√£o com erro
                btnCalcularCurvaABC.style.background = '#ef4444';
                btnCalcularCurvaABC.innerHTML = '<i class="fas fa-times"></i> ERRO';

                setTimeout(() => {
                    btnCalcularCurvaABC.innerHTML = textoOriginal;
                    btnCalcularCurvaABC.style.background = '#8b5cf6';
                }, 3000);

            } finally {
                btnCalcularCurvaABC.disabled = false;
            }
        });
    }

    console.log('[CURVA-ABC]  Bot√£o Curva ABC inicializado com sucesso!');

})();
</script>

{{-- ====================================================================== --}}
{{-- EVENT LISTENERS DOS BOT√ïES - C√ìDIGO LIMPO E FUNCIONAL --}}
{{-- ====================================================================== --}}
@endsection
